<!DOCTYPE html>
<html lang="en" xml:lang="en">

  <head>
  
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>Creating a Rabbit MQ Container | Western Devs</title>
  <meta name="description" content="I bought a new laptop, a Dell XPS 15 and my oh my is it snazzy. The thing I was most excited about was that I&#39;d get to play with Windows containers again. I have 3 other machines in the house but they">
<meta property="og:type" content="article">
<meta property="og:title" content="Creating a Rabbit MQ Container">
<meta property="og:url" content="https://westerndevs.com/docker/RabbitContainer/index.html">
<meta property="og:site_name" content="Western Devs">
<meta property="og:description" content="I bought a new laptop, a Dell XPS 15 and my oh my is it snazzy. The thing I was most excited about was that I&#39;d get to play with Windows containers again. I have 3 other machines in the house but they">
<meta property="og:image" content="http://i.imgur.com/KvDVTb9.png">
<meta property="article:published_time" content="2017-03-16T11:36:36.000Z">
<meta property="article:modified_time" content="2024-09-02T18:35:42.356Z">
<meta property="article:author" content="Western Devs">
<meta property="article:tag" content="docker">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://i.imgur.com/KvDVTb9.png">
<meta name="twitter:creator" content="@westerndevs">

    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="title" content="WesternDevs">   
    <meta name="keywords" content="software development,software,asp.net,blog">
    <meta name="description" content="We're all west of somewhere">
    <meta name="copyright" content="WesternDevs">
    <meta name="revisit-after" content="15 days">
    <meta name="robots" content="all">
    <meta name="MSSmartTagsPreventParsing" content="true">
  
    <link rel="canonical" href="https://aspnetmonsters.com/2017/03/2017-03-09-rabbitmq/">
  
  
    <link rel="alternate" href="/feed.xml" title="Western Devs" type="application/atom+xml">
  
  
<link rel="stylesheet" href="/css/style.css">

      
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <script src="//code.jquery.com/jquery-1.11.3.min.js"></script>  
  <meta name="generator" content="Hexo 4.2.1"></head>

<body>

<!-- FIXED HEADER BECAUSE SCROLLING -->
<!--HEADER STARTS-->
<div class="WrapperHeader">
<div style="display:inline-block; text-align: center;">
<div class="Header">

  <div class="HeaderLogo">
    <a href="/"><img src="/images/header_logo_transparent.png" alt="WesternDevs" title="WesternDevs" border="0" style="width: 206px; height: 64px;" width="206" height="64"></a>
  </div>

  <div class="HeaderLinks">
      <a href="/posts" class="nav">POSTS</a>       
      <a href="/podcasts" class="nav">PODCASTS</a>       
      <a href="/whoweare" class="nav">ABOUT</a>  
      <a href="/whatwevedone" class="nav">WHAT WE'VE DONE</a>  
      <a href="/speaking" class="nav">SPEAKING</a>
      <div class="HeaderIcons">
        <a href="mailto:info@westerndevs.com"><img src="/images/icon_email.png" border="0" alt="Email" title="Email" height="26" width="26"></a>
        <a href="/feed.xml"><img src="/images/icon_subscribe.png" border="0" alt="Subscribe" title="Subscribe" height="26" width="27"></a>
        <a href="http://twitter.com/westerndevs" target="_blank"><img src="/images/icon_twitter.png" border="0" alt="Twitter" title="Twitter" height="26" width="27"></a>
        <a href="http://github.com/westerndevs" target="_blank"><img src="/images/icon_github.png" border="0" alt="GitHub" title="GitHub" height="26" width="27"></a>     
      </div>
  </div>
  
</div>
</div>
</div>
<!--HEADER ENDS-->    



<!--WRAPPER STARTS-->
<div class="Wrapper" style="">

<!--SUBHEAD STARTS-->
<div class="WrapperSubHeaderSubpage">
<center>
	<div class="SubHeader">
		<H1 class="title"><img class="icon" src="/images/icon_posts.png" alt="POST" title="POST" border="0"> POST</H1>
	</div>
</center>
</div>
<!--SUBHEAD ENDS-->

<!--PAGE CONTENT STARTS-->
<center>
<div class="WrapperContent">

<!--MAIN CONTENT STARTS-->
	<div class="SubpageBoxSubLrg">
		<div class="SubpageBoxSubLrgContent">
		    <div class='postTitle'>
  <div class="ListLrgDateBG">
    <div class="ListLrgDateMonth">MAR</div>
    <div class="ListLrgDateDay">16</div>
    <div class="ListLrgDateYear">2017</div>
  </div>
  <h2>Creating a Rabbit MQ Container</h2>
</div>

		    

<p class="TXTsm">ORIGINALLY POSTED TO: <a href="https://aspnetmonsters.com/2017/03/2017-03-09-rabbitmq/" target="_blank" rel="noopener" class='originalurl'>https://aspnetmonsters.com/2017/03/2017-03-09-rabbitmq/</a></p>



			<div id="mainPostContent">
	        <p>I bought a new laptop, a Dell XPS 15 and my oh my is it snazzy. The thing I was most excited about was that I'd get to play with Windows containers again. I have 3 other machines in the house but they're either unsuitable for containers (OSX running Windows in parallels) or I've so toally borked them playing with early betas of containers they need to be formatted and reinstalled - possibly also thrown into the sun.</p>
<p>So when I found myself presented with the question &quot;how can we get into messaging in our apps for free?&quot; I figured I'd crack open the laptop and build something with MassTransit. I found that MassTransit supports running on RabbitMQ. Why that sounds like a perfect opportunity to deploy RabbitMQ to a container. Only problem was that I didn't really know how to do that.</p>
<a id="more"></a>
<p>In my heart I felt like running the installer wasn't quite the right way to go. I'd just copy the installation file into their destination. Problem is that RabbitMQ relies on erlang so I'd have to install that too. I build a docker file which looked something like</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> microsoft/windowsservercore</span><br><span class="line"><span class="keyword">ENV</span> rabbitSourceDir <span class="string">"RabbitMQ Server"</span></span><br><span class="line"><span class="keyword">ENV</span> erlngDir <span class="string">"C:/program files/erl8.2/"</span></span><br><span class="line"><span class="keyword">ENV</span> rabbitDir <span class="string">"C:/program files/RabbitMQ Server/"</span></span><br><span class="line"><span class="keyword">ADD</span><span class="bash"> <span class="variable">$&#123;rabbitSourceDir&#125;</span> <span class="variable">$&#123;rabbitDir&#125;</span></span></span><br><span class="line"><span class="keyword">ADD</span><span class="bash"> erl8.2 <span class="variable">$&#123;erlngDir&#125;</span></span></span><br><span class="line"><span class="keyword">ENV</span> ERLANG_HOME <span class="string">"c:\program files\erl8.2\erts-8.2"</span></span><br></pre></td></tr></table></figure>
<p>In the erlngDir and rabbitDir I dumped the contents of an install of erlang and rabbitmq. Then I built the container with</p>
<p><code>docker build -t monsters/rabbitmq .</code></p>
<p>Didn't work. There must be something useful the installer actually does as part of installing files. So next I considered putting in the installers and running them when building the container. That seemed like a huge pain so I got to thinking about using chocolatey. At first I was pretty deadset against using choco my reasoning being that containers should be lightweight and have only one purpose. Having one time software like chocolatey on there which wouldn't ever be used seemed like it would make... whoever invented containers mad.</p>
<p>So attempt number two:</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> microsoft/windowsservercore</span><br><span class="line"></span><br><span class="line"><span class="comment">#install chocolatey</span></span><br><span class="line"><span class="builtin-name">RUN</span> @powershell -NoProfile -ExecutionPolicy Bypass -Command <span class="string">"iex ((New-Object System.Net.WebClient).DownloadString('https://chocolatey.org/install.ps1'))"</span> &amp;&amp; <span class="builtin-name">SET</span> <span class="string">"PATH=%PATH%;%ALLUSERSPROFILE%\chocolatey\bin"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#install rabbitmq</span></span><br><span class="line"><span class="builtin-name">RUN</span> choco install -y rabbitmq</span><br></pre></td></tr></table></figure>
<p>That was enough to get Rabbit MQ installed. I still needed to expose some ports for RabbitMQ so I added</p>
<figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">####### PORTS ########</span><br><span class="line">#Main rabbitmq port</span><br><span class="line">EXPOSE <span class="number">5672</span></span><br><span class="line">#port mapper daemon (epmd)</span><br><span class="line">EXPOSE <span class="number">4369</span></span><br><span class="line">#inet_dist_listen</span><br><span class="line">EXPOSE <span class="number">35197</span></span><br><span class="line">#rabbitmq management console</span><br><span class="line">EXPOSE <span class="number">15672</span></span><br></pre></td></tr></table></figure>
<p>Rabbit also likes to know where Erlang lives so some environmental variables for that aren't going to hurt.</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#set the home directory for erlang so rabbit can find it easily</span></span><br><span class="line"><span class="keyword">ENV</span> ERLANG_HOME <span class="string">"c:\program files\erl8.2\erts-8.2"</span></span><br><span class="line"><span class="keyword">ENV</span> ERLANG_SERVICE_MANAGER_PATH <span class="string">"c:\program files\erl8.2\erts-8.2"</span></span><br></pre></td></tr></table></figure>
<p>We could forward the RabbitMQ ports to our local machine but I like the idea of using the container as if it were a distinct machine so let's also enable the management UI from anywhere on the network. To do that we'll replace the default config file with one that has</p>
<figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="template-variable">&#123;loopback_users, []&#125;</span><span class="xml">,</span></span><br></pre></td></tr></table></figure>
<p>in it. We can copy our new config file over the one in the container from the dockerfile and set up a variable to point Rabbit at it.</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ENV</span> RABBITMQ_CONFIG_FILE <span class="string">"C:\rabbitmq"</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> [<span class="string">"rabbitmq.config"</span>,<span class="string">" C:/"</span>]</span></span><br></pre></td></tr></table></figure>
<p>The config file looks like</p>
<figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[&#123;rabbit, [&#123;loopback_users, []&#125;]&#125;].</span><br></pre></td></tr></table></figure>
<p>Finally we'll start the actual rabbit process as the default action of the container</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ENV</span> RABBIT_MQ_HOME <span class="string">"C:\Program Files\RabbitMQ Server\rabbitmq_server-3.6.5"</span></span><br><span class="line"><span class="keyword">CMD</span><span class="bash"> <span class="string">"<span class="variable">$&#123;RABBIT_MQ_HOME&#125;</span>/sbin/rabbitmq-server.bat"</span></span></span><br></pre></td></tr></table></figure>
<p>Now you can log into the management portal using the guest/guest account.</p>
<p><img src="http://i.imgur.com/KvDVTb9.png" alt="Admin login"></p>
<p>It takes quite a while to start up the container and it took me close to 40 years to figure out building the container but it does save me installing rabbitmq on my local machine and makes experimenting with multiple instances pretty jolly easy.</p>
<p>The complete docker file is here:</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> microsoft/windowsservercore</span><br><span class="line"></span><br><span class="line"><span class="comment">####### PORTS ########</span></span><br><span class="line"><span class="comment">#Main rabbitmq port</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">5672</span></span><br><span class="line"><span class="comment">#port mapper daemon (epmd)</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">4369</span></span><br><span class="line"><span class="comment">#inet_dist_listen</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">35197</span></span><br><span class="line"><span class="comment">#rabbitmq management console</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">15672</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#set the home directory for erlang so rabbit can find it easily</span></span><br><span class="line"><span class="keyword">ENV</span> ERLANG_HOME <span class="string">"c:\program files\erl8.2\erts-8.2"</span></span><br><span class="line"><span class="keyword">ENV</span> ERLANG_SERVICE_MANAGER_PATH <span class="string">"c:\program files\erl8.2\erts-8.2"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#install chocolatey</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> @powershell -NoProfile -ExecutionPolicy Bypass -Command <span class="string">"iex ((New-Object System.Net.WebClient).DownloadString('https://chocolatey.org/install.ps1'))"</span> &amp;&amp; SET <span class="string">"PATH=%PATH%;%ALLUSERSPROFILE%\chocolatey\bin"</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">#install rabbitmq</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> choco install -y rabbitmq</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#set up the path to the config file</span></span><br><span class="line"><span class="keyword">ENV</span> RABBITMQ_CONFIG_FILE <span class="string">"C:\rabbitmq"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#copy a config file over</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> [<span class="string">"rabbitmq.config"</span>,<span class="string">" C:/"</span>]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#set the startup command to be rabbit</span></span><br><span class="line"><span class="keyword">CMD</span><span class="bash"> [<span class="string">"C:/Program Files/RabbitMQ Server/rabbitmq_server-3.6.5/sbin/rabbitmq-server.bat"</span>]</span></span><br></pre></td></tr></table></figure>
<p>In my next post I'll get around to actually using Rabbit MQ because all the yaks are shaved now... I hope.</p>

	        </div>

            
            <section id="comments">
            <div id="disqus_thread">
                <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript" target="_blank" rel="noopener">comments powered by Disqus.</a></noscript>
            </div>
            </section>
            
		</div>
	</div>
<!--MAIN CONTENT ENDS-->

<!--SIDEBAR CONTENT STARTS-->
	<div class="SubpageBoxSubSm">
		<div class="SubpageBoxSubSmContent">
			
			

			<div class="ProfileImg">
				
				<a href="/bios/simon_timms">
				
					<img src='/images/avatars/simon.jpg' />
				
				</a>
				
			</div>

			<BR clear="all">

			<h2><a href="/bios/simon_timms">Simon Timms</a></h2>
			
			<a href="mailto:stimms@gmail.com"><img class="ProfileIcon" src="/images/icon_email.png" border="0" alt="Email" title="Email"> Email</a><BR>
			
			
			<a href="http://blog.simontimms.com/" target="_blank"><img class="ProfileIcon" src="/images/icon_web.png" border="0" alt="Web" title="Web"> Web</a><BR>
			
			
			<a href="http://twitter.com/stimms" target="_blank"><img class="ProfileIcon" src="/images/icon_twitter.png" border="0" alt="Twitter" title="Twitter"> Twitter</a><BR>
			
			
			<a href="https://github.com/stimms" target="_blank"><img class="ProfileIcon" src="/images/icon_github.png" border="0" alt="GitHub" title="GitHub"> GitHub</a><br>
			
			
			
 			<a href="/feeds/simon_timms.xml"><img class="ProfileIcon" src="/images/icon_subscribe.png" /> RSS</a>
			

			<hr />
			<h4>Looking for someone else?</h4>
			<p>You can find the rest of the Western Devs Crew <a href="/whoweare">here</a>.</p>
		</div>
	</div>
<!--SIDEBAR CONTENT ENDS-->


</div>
</center>
<!--PAGE CONTENT ENDS-->


<!--FOOTER STARTS-->
<center>
  <div class="FooterBarTxt">&copy; 2015 Western Devs. All Rights Reserved. Design by <a href="http://www.karenchudobiak.ca" target="_blank">Karen Chudobiak, Graphic Designer</a></div>
</center>
<!--FOOTER ENDS-->

<!-- NAV FOOTER STARTS -->
<div class="NavFooter">
  <a href="/posts" alt="Posts"><i class="fa fa-newspaper-o fa-2x"></i><span>Posts</span></a>
  <a href="/podcasts" alt="Podcasts"><i class="fa fa-volume-up fa-2x"></i><span>Podcasts</span></a>
  <a href="/whoweare" alt="About"><i class="fa fa-star fa-2x"></i><span>About</span></a>
  <a href="/whatwevedone" alt="What We've Done"><i class="fa fa-trophy fa-2x"></i><span>Work</span></a>
  <a href="/speaking" alt="Speaking"><i class="fa fa-comment-o fa-2x fa-flip-horizontal"></i><span>Speaking</span></a>
</div>
<!-- NAV FOOTER ENDS -->




</div>
<!--WRAPPER ENDS-->


<script>
  var disqus_shortname = 'westerndevs';
  
  var disqus_url = 'https://westerndevs.com/docker/RabbitContainer/'.replace(".com//", ".com/");
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
  
function shuffle(array) {
  var currentIndex = array.length, temporaryValue, randomIndex;

  // While there remain elements to shuffle...
  while (0 !== currentIndex) {

    // Pick a remaining element...
    randomIndex = Math.floor(Math.random() * currentIndex);
    currentIndex -= 1;

    // And swap it with the current element.
    temporaryValue = array[currentIndex];
    array[currentIndex] = array[randomIndex];
    array[randomIndex] = temporaryValue;
  }

  return array;
}

</script>


</body>

  
<!-- Google Analytics -->
<script type="text/javascript">
if (document.location.hostname.search("westerndevs.com") !== -1 || document.location.hostname.search("www.westerndevs.com") !== -1) {
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-37617956-2', 'auto');

ga('set', 'contentGroup1', 'simon_timms');

ga('send', 'pageview');
}
</script>
<!-- End Google Analytics -->



</html>
