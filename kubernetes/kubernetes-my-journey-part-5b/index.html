<!DOCTYPE html>
<html lang="en" xml:lang="en">

  <head>
  
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>Kubernetes - My Journey - Part 5b | Western Devs</title>
  <meta name="description" content="Series Table of Contents Previously: Getting Started with Kubernetes - Minikube - Part A Getting Started with Kubernetes - Minikube - Part B We&#39;re finally getting to the part of the series where we ha">
<meta property="og:type" content="article">
<meta property="og:title" content="Kubernetes - My Journey - Part 5b">
<meta property="og:url" content="https://westerndevs.com/kubernetes/kubernetes-my-journey-part-5b/index.html">
<meta property="og:site_name" content="Western Devs">
<meta property="og:description" content="Series Table of Contents Previously: Getting Started with Kubernetes - Minikube - Part A Getting Started with Kubernetes - Minikube - Part B We&#39;re finally getting to the part of the series where we ha">
<meta property="og:image" content="https://westerndevs.com/images/dwhite/azure-container-registry-create.png">
<meta property="og:image" content="https://westerndevs.com/images/dwhite/azure-container-registry-created.png">
<meta property="og:image" content="https://westerndevs.com/images/dwhite/azure-container-registry-credentials.png">
<meta property="og:image" content="https://westerndevs.com/images/dwhite/azure-pipelines-create.png">
<meta property="og:image" content="https://westerndevs.com/images/dwhite/azure-pipelines-configure-pipeline.png">
<meta property="og:image" content="https://westerndevs.com/images/dwhite/azure-pipelines-select-azure-subscription.png">
<meta property="og:image" content="https://westerndevs.com/images/dwhite/azure-pipelines-select-acr.png">
<meta property="og:image" content="https://westerndevs.com/images/dwhite/azure-pipelines-acr-success.png">
<meta property="og:image" content="https://westerndevs.com/images/dwhite/octant-started.png">
<meta property="og:image" content="https://westerndevs.com/images/dwhite/octant-pods-running.png">
<meta property="og:image" content="https://westerndevs.com/images/dwhite/octant-image-pull-backoff-sts-pending.png">
<meta property="og:image" content="https://westerndevs.com/images/dwhite/octant-image-pull-backoff.png">
<meta property="article:published_time" content="2020-05-22T11:00:00.000Z">
<meta property="article:modified_time" content="2021-08-18T21:12:42.237Z">
<meta property="article:author" content="Western Devs">
<meta property="article:tag" content="kubernetes, azure, aks, identityserver, docker, containers">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://westerndevs.com/images/dwhite/azure-container-registry-create.png">
<meta name="twitter:creator" content="@westerndevs">

    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="title" content="WesternDevs">   
    <meta name="keywords" content="software development,software,asp.net,blog">
    <meta name="description" content="We're all west of somewhere">
    <meta name="copyright" content="WesternDevs">
    <meta name="revisit-after" content="15 days">
    <meta name="robots" content="all">
    <meta name="MSSmartTagsPreventParsing" content="true">
  
  
    <link rel="alternate" href="/feed.xml" title="Western Devs" type="application/atom+xml">
  
  
<link rel="stylesheet" href="/css/style.css">

      
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <script src="//code.jquery.com/jquery-1.11.3.min.js"></script>  
  <meta name="generator" content="Hexo 4.2.1"></head>

<body>

<!-- FIXED HEADER BECAUSE SCROLLING -->
<!--HEADER STARTS-->
<div class="WrapperHeader">
<div style="display:inline-block; text-align: center;">
<div class="Header">

  <div class="HeaderLogo">
    <a href="/"><img src="/images/header_logo_transparent.png" alt="WesternDevs" title="WesternDevs" border="0" style="width: 206px; height: 64px;" width="206" height="64"></a>
  </div>

  <div class="HeaderLinks">
      <a href="/posts" class="nav">POSTS</a>       
      <a href="/podcasts" class="nav">PODCASTS</a>       
      <a href="/whoweare" class="nav">ABOUT</a>  
      <a href="/whatwevedone" class="nav">WHAT WE'VE DONE</a>  
      <a href="/speaking" class="nav">SPEAKING</a>
      <div class="HeaderIcons">
        <a href="mailto:info@westerndevs.com"><img src="/images/icon_email.png" border="0" alt="Email" title="Email" height="26" width="26"></a>
        <a href="/feed.xml"><img src="/images/icon_subscribe.png" border="0" alt="Subscribe" title="Subscribe" height="26" width="27"></a>
        <a href="http://twitter.com/westerndevs" target="_blank"><img src="/images/icon_twitter.png" border="0" alt="Twitter" title="Twitter" height="26" width="27"></a>
        <a href="http://github.com/westerndevs" target="_blank"><img src="/images/icon_github.png" border="0" alt="GitHub" title="GitHub" height="26" width="27"></a>     
      </div>
  </div>
  
</div>
</div>
</div>
<!--HEADER ENDS-->    



<!--WRAPPER STARTS-->
<div class="Wrapper" style="">

<!--SUBHEAD STARTS-->
<div class="WrapperSubHeaderSubpage">
<center>
	<div class="SubHeader">
		<H1 class="title"><img class="icon" src="/images/icon_posts.png" alt="POST" title="POST" border="0"> POST</H1>
	</div>
</center>
</div>
<!--SUBHEAD ENDS-->

<!--PAGE CONTENT STARTS-->
<center>
<div class="WrapperContent">

<!--MAIN CONTENT STARTS-->
	<div class="SubpageBoxSubLrg">
		<div class="SubpageBoxSubLrgContent">
		    <div class='postTitle'>
  <div class="ListLrgDateBG">
    <div class="ListLrgDateMonth">MAY</div>
    <div class="ListLrgDateDay">22</div>
    <div class="ListLrgDateYear">2020</div>
  </div>
  <h2>Kubernetes - My Journey - Part 5b</h2>
</div>

		    

			<div id="mainPostContent">
	        <p><a href="/kubernetes/kubernetes-my-journey">Series Table of Contents</a></p>
<p><strong>Previously:</strong>
<a href="/kubernetes/kubernetes-my-journey-part-5a">Getting Started with Kubernetes - Minikube - Part A</a></p>
<h1>Getting Started with Kubernetes - Minikube - Part B</h1>
<p>We're finally getting to the part of the series where we have a group of applications and we want to have them live in <strong>Kubernetes (k8s)</strong>. In order to do that, we need to have <strong>k8s</strong> on our local development machine and we are going to use <strong>Minikube</strong> to do that.</p>
<h2>Important Caveat</h2>
<p>I'm going to make an assumption that at a minimum, you've reviewed various types of <strong>k8s</strong> resources on kubernetes.io and in a best case scenario, you've watched Nigel Poulton's Pluralsight course <a href="https://app.pluralsight.com/library/courses/getting-started-kubernetes/table-of-contents" target="_blank" rel="noopener">Getting Started with Kubernetes</a>. If you haven't, some of the stuff I discuss will not have sufficient detail in this post to close the gap.</p>
<p>Also, my understanding of Kubernetes is certainly not as extensive as I'd like. I'm not sure I'd hazzard calling myself an expert. I've got a working cluster and applications in that cluster but I am not going to make the statement that I've done it all right or with the current best practices in place. This is a learning exercise for me (and you) and while I want to get you with a cluster up and running as soon as possible, I expect you to learn/challenge/grow your <strong>k8s</strong> cluster knowledge as well.</p>
<h2>Continuing on...</h2>
<p>So we've now deployed all of our backend services into minikube. There is a little detail that probably went un-noticed until now. Where did minikube get the container images from? In this case, it pulled the postgres, pgAdmin4, and Seq container images from <a href="https://hub.docker.com/" target="_blank" rel="noopener">DockerHub</a>, a public container registry. So if you want to publish your custom-built Skoruba templates to DockerHub, everything will keep on working without any changes. But chances are, your going to want to publish those images to a private container registry such a DockerHub (private) or in my case, an Azure Container Registry hosted in our Azure subscription.</p>
<h3>What about my local docker repository?</h3>
<p>You may be asking, you've built your app locally and deployed it to Docker Desktop registry, why can't I just get it from there?</p>
<p>Minikube (<strong>k8s</strong> in the VM) has it's own docker daemon instance running, so now you have two docker daemons running on your machine. One in Docker Desktop and one in minikube. And the one in minikube didn't build/deploy your applications, the Docker Desktop one did. But minikube doesn't use that one. It uses its own internal docker container registry or a public/private one from the internet. I've read that you can use minikube's docker daemon for builds, but I don't want to make any adjustments to your environment that might break the Docker Desktop experience so we'll just continue on with creating a private container registry. We need to get there eventually no matter what, so let's keep going!</p>
<h2>Azure Container Registry (ACR)</h2>
<p>For this part of the journey, we are going to leave Visual Studio and the comfort of C# and yaml and journey to the <a href="https://portal.azure.com" target="_blank" rel="noopener">Azure Subscription</a> that we want to host our private container registry in!</p>
<p>At this point, you'll need to have access to a Azure subscription. Microsoft has made it very easy to create them (they are free) and use them (there are lots of free services)! The ACR service is not free, but it is pretty inexpensive for the Basic SKU which holds up to 10gb of container images.</p>
<p>If an Azure ACR is not in the cards for you, you can continue (without my help for the moment) with a free DockerHub public registry, or a private container registry that you may already have access to.</p>
<p>For this part of the project, I'll be using my Depth Consulting Azure Subscription and Azure DevOps Service instance. My client, who has the identity management business problem, also has Azure DevOps Server 2019 and an Azure subscription that holds their private ACR.</p>
<h3>Creating the ACR</h3>
<p>Creating a ACR is very easy.</p>
<ol>
<li>Log into the <a href="https://portal.azure.com" target="_blank" rel="noopener">Azure Portal</a></li>
<li>Create a new ACR Resource<br/>
<img src="/images/dwhite/azure-container-registry-create.png" alt="Create an Azure Container Registry" height="250px"></li>
<li>Follow the wizard and complete the creation of your ACR
<ul>
<li>pick the <strong>Basic</strong> SKU. It is more than enough for now and you can upgrade later.</li>
<li>The Basic ACR costs about $0.17 per day for 10GiB of storage.</li>
</ul>
</li>
</ol>
<p>Tada! ACR created!</p>
<img src="/images/dwhite/azure-container-registry-created.png" alt="Azure Container Registry Created" height="250px">
<blockquote>
<p>I could create the ACR via Pulumi but it is a one-and-done kind of activity, so I didn't do that. It's just easier to create it in the portal.</p>
</blockquote>
<h3>Secrets! Secrets! Secrets!</h3>
<p>In order to access a private container registry, you need credentials! And more specifically, your <strong>k8s</strong> <em>cluster</em> needs the credentials for your private container registry. And it isn't just <strong>k8s</strong> that needs those credentials, your DevOps pipeline will need those credentials as well in order to publish container images into the registry.</p>
<p>Our ACR credentials are available in the Azure Portal. You can find the ones we'll need there.</p>
<img src="/images/dwhite/azure-container-registry-credentials.png" alt="Azure Container Registry Created" height="250px">
<p>Remember where they are. When we get back to manifest land, we'll need them.</p>
<h2>Azure DevOps Service (Server 2019)</h2>
<p>Now that we have a private container registry, we need to build our IdentityServer4 applications and publish those container images to our ACR. If you do not have an Azure DevOps Service instance, you can <a href="https://azure.microsoft.com/en-ca/services/devops/" target="_blank" rel="noopener">create one for free</a>.</p>
<blockquote>
<p>I will try to create blog post sometime doing something like this from <a href="https://github.com/" target="_blank" rel="noopener">GitHub</a>, using <a href="https://github.com/features/actions" target="_blank" rel="noopener">GitHub Actions</a> with a public <a href="https://hub.docker.com/" target="_blank" rel="noopener">DockerHub</a> Registry.</p>
</blockquote>
<h3>Assumptions</h3>
<p>I'm progressing on the assumption that your IdentityServer4 implementation projects have been checked into a git repository somewhere. If this is in an Azure DevOps Services instance, that's great, but it can be GitHub or any other repository that Azure DevOps Pipelines can monitor for changes.</p>
<h3>Build and Publish in one Pipeline</h3>
<p>The next step is to build and publish our applications. For this, we're going to leverage Azure DevOps Pipelines that contain a couple DockerCompose tasks. Thankfully, this is very easy to setup in thanks to the pipeline templates and the integration between Azure Portal and Azure DevOps Services.</p>
<ol>
<li>
<p>Go to your Pipelines in Azure DevOps Service instance</p>
</li>
<li>
<p>Create a new Pipeline
<img src="/images/dwhite/azure-pipelines-create.png" alt="Create new Azure Pipeline" height="180px"></p>
</li>
<li>
<p>Connect the pipeline to your repository</p>
</li>
<li>
<p>On the <em>Configure your pipeline</em> wizard step, select <strong>Docker - Build and Push an Image to Azure Container Registry</strong>
<img src="/images/dwhite/azure-pipelines-configure-pipeline.png" alt="Configure the pipeline" height="250px"></p>
</li>
<li>
<p>Select your Azure subscription with the ACR in it
<img src="/images/dwhite/azure-pipelines-select-azure-subscription.png" alt="Select your Azure Subscription" height="250px"></p>
</li>
<li>
<p>Select your ACR that you want the images in
<img src="/images/dwhite/azure-pipelines-select-acr.png" alt="Select your ACR in the subscription" height="250px"></p>
<ul>
<li>don't worry about the <strong>image name</strong> or <strong>Dockerfile</strong> parameters. They'll be deleted in a moment</li>
</ul>
</li>
<li>
<p>Create the new pipeline</p>
</li>
<li>
<p>Delete the whole Docker@2 task</p>
 <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">stages:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">stage:</span> <span class="string">Build</span></span><br><span class="line">  <span class="attr">displayName:</span> <span class="string">Build</span> <span class="string">and</span> <span class="string">push</span> <span class="string">stage</span></span><br><span class="line">  <span class="attr">jobs:</span>  </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job:</span> <span class="string">Build</span></span><br><span class="line">    <span class="attr">displayName:</span> <span class="string">Build</span></span><br><span class="line">    <span class="attr">pool:</span></span><br><span class="line">      <span class="attr">vmImage:</span> <span class="string">$(vmImageName)</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">task:</span> <span class="string">Docker@2</span> <span class="comment"># &lt;-- remove this whole task</span></span><br><span class="line">      <span class="attr">displayName:</span> <span class="string">Build</span> <span class="string">and</span> <span class="string">push</span> <span class="string">an</span> <span class="string">image</span> <span class="string">to</span> <span class="string">container</span> <span class="string">registry</span></span><br><span class="line">      <span class="attr">inputs:</span></span><br><span class="line">        <span class="attr">command:</span> <span class="string">buildAndPush</span></span><br><span class="line">        <span class="attr">repository:</span> <span class="string">$(imageRepository)</span></span><br><span class="line">        <span class="attr">dockerfile:</span> <span class="string">$(dockerfilePath)</span></span><br><span class="line">        <span class="attr">containerRegistry:</span> <span class="string">$(dockerRegistryServiceConnection)</span></span><br><span class="line">        <span class="attr">tags:</span> <span class="string">|</span></span><br><span class="line">          <span class="string">$(tag)</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>Delete the Docker@2 task variables</p>
 <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">variables:</span></span><br><span class="line">  <span class="comment"># Container registry service connection established during pipeline creation</span></span><br><span class="line">  <span class="attr">dockerRegistryServiceConnection:</span> <span class="string">'&lt;your service connection Id&gt;'</span></span><br><span class="line">  <span class="attr">imageRepository:</span> <span class="string">'identityserver'</span> <span class="comment"># &lt;-- delete</span></span><br><span class="line">  <span class="attr">containerRegistry:</span> <span class="string">'depthconsulting.azurecr.io'</span> <span class="comment"># &lt;-- delete</span></span><br><span class="line">  <span class="attr">dockerfilePath:</span> <span class="string">'$(Build.SourcesDirectory)/src/DepthConsulting.Identity.Admin.Api/Dockerfile'</span> <span class="comment"># &lt;-- delete</span></span><br><span class="line">  <span class="attr">tag:</span> <span class="string">'$(Build.BuildId)'</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>With your cursor under the <strong>steps</strong> yaml entry, Add a Docker Compose task</p>
<ul>
<li>Work through the wizard and the Command is <strong>build</strong></li>
</ul>
</li>
<li>
<p>With your cursor under the last DockerCompose@0 task, Add another Docker Compose task</p>
<ul>
<li>Work through the wizard again and the Command is <strong>push</strong></li>
</ul>
</li>
<li>
<p>Save the pipeline and run it!</p>
<ul>
<li>You may need to give your pipeline permission to use a service principal to connect to the ACR. If you see that your pipeline is queued and waiting for persmission, go ahead and give it permission.</li>
</ul>
</li>
</ol>
<p>Your final pipeline yaml should look something like this.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Docker</span></span><br><span class="line"><span class="comment"># Build and push an image to Azure Container Registry</span></span><br><span class="line"><span class="comment"># https://docs.microsoft.com/azure/devops/pipelines/languages/docker</span></span><br><span class="line"></span><br><span class="line"><span class="attr">trigger:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">master</span></span><br><span class="line"></span><br><span class="line"><span class="attr">resources:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">repo:</span> <span class="string">self</span></span><br><span class="line"></span><br><span class="line"><span class="attr">variables:</span></span><br><span class="line">  <span class="comment"># Container registry service connection established during pipeline creation</span></span><br><span class="line">  <span class="attr">dockerRegistryServiceConnection:</span> <span class="string">'&lt;your service connection guid here&gt;'</span></span><br><span class="line">  <span class="attr">tag:</span> <span class="string">'$(Build.BuildId)'</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># Agent VM image name</span></span><br><span class="line">  <span class="attr">vmImageName:</span> <span class="string">'ubuntu-latest'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">stages:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">stage:</span> <span class="string">Build</span></span><br><span class="line">  <span class="attr">displayName:</span> <span class="string">Build</span> <span class="string">and</span> <span class="string">push</span> <span class="string">stage</span></span><br><span class="line">  <span class="attr">jobs:</span>  </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job:</span> <span class="string">Build</span></span><br><span class="line">    <span class="attr">displayName:</span> <span class="string">Build</span></span><br><span class="line">    <span class="attr">pool:</span></span><br><span class="line">      <span class="attr">vmImage:</span> <span class="string">$(vmImageName)</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">task:</span> <span class="string">DockerCompose@0</span></span><br><span class="line">      <span class="attr">inputs:</span></span><br><span class="line">        <span class="attr">containerregistrytype:</span> <span class="string">'Azure Container Registry'</span></span><br><span class="line">        <span class="attr">azureSubscription:</span> <span class="string">'&lt;your subscription id here&gt;'</span></span><br><span class="line">        <span class="attr">azureContainerRegistry:</span> <span class="string">'&#123;"loginServer":"depthconsulting.azurecr.io", "id" : "/subscriptions/&lt;your subscription id here&gt;/resourceGroups/&lt;your resource group here&gt;/providers/Microsoft.ContainerRegistry/registries/depthconsulting"&#125;'</span></span><br><span class="line">        <span class="attr">dockerComposeFile:</span> <span class="string">'**/docker-compose.yml'</span></span><br><span class="line">        <span class="attr">action:</span> <span class="string">'Run a Docker Compose command'</span></span><br><span class="line">        <span class="attr">dockerComposeCommand:</span> <span class="string">'build'</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">task:</span> <span class="string">DockerCompose@0</span></span><br><span class="line">      <span class="attr">inputs:</span></span><br><span class="line">        <span class="attr">containerregistrytype:</span> <span class="string">'Azure Container Registry'</span></span><br><span class="line">        <span class="attr">azureSubscription:</span> <span class="string">'&lt;your subscription id here&gt;'</span></span><br><span class="line">        <span class="attr">azureContainerRegistry:</span> <span class="string">'&#123;"loginServer":"depthconsulting.azurecr.io", "id" : "/subscriptions/&lt;your subscription id here&gt;/resourceGroups/&lt;your resource group here&gt;/providers/Microsoft.ContainerRegistry/registries/depthconsulting"&#125;'</span></span><br><span class="line">        <span class="attr">dockerComposeFile:</span> <span class="string">'**/docker-compose.yml'</span></span><br><span class="line">        <span class="attr">action:</span> <span class="string">'Run a Docker Compose command'</span></span><br><span class="line">        <span class="attr">dockerComposeCommand:</span> <span class="string">'push'</span></span><br></pre></td></tr></table></figure>
<p>After the build has run, we should now see our IdentityServer4 container images in the ACR!</p>
<img src="/images/dwhite/azure-pipelines-acr-success.png" alt="Successfully pushed container images to ACR" height="250px">
<p>You should navigate the ACR repositories and look at what images are in each repository. Also, all of our images were tagged as <strong>latest</strong> so every time the build runs, we'll have new a <strong>latest</strong> image that will be pulled down as needed by the <strong>k8s</strong> cluster. I'll leave container image tag management to another blog post. We're just trying to get to <strong>k8s</strong> today.</p>
<h2>Adding our ACR Secrets to minikube</h2>
<p>Now that we have our IdentityServer4 applications published to a container registery, we need to give our <strong>k8s</strong> cluster the credentials that will allow it to pull those images down from the ACR into the cluster. To do that, we will create a <strong>k8s</strong> Secret resource.</p>
<p><a href="https://kubernetes.io/docs/concepts/configuration/secret/" target="_blank" rel="noopener">Secrets</a></p>
<p>For this step in the process, the easiest way to do this is to use <strong>kubectl</strong> to create a secret in the cluster.</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubectl -<span class="literal">-namespace</span> default create secret docker<span class="literal">-registry</span> docker<span class="literal">-credentials</span> `</span><br><span class="line">-<span class="literal">-docker</span><span class="literal">-server</span>=&lt;acr url&gt; `</span><br><span class="line">-<span class="literal">-docker</span><span class="literal">-username</span>=&lt;acr username&gt; `</span><br><span class="line">-<span class="literal">-docker</span><span class="literal">-password</span>=&lt;acr password&gt; `</span><br><span class="line">-<span class="literal">-docker</span><span class="literal">-email</span>=&lt;your@email.address.com&gt;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Put this command in your start-up.ps1 file for now</p>
</blockquote>
<p>This will create a Secret resource in the <strong>k8s</strong> cluster that it's docker daemon will use to access your private container registry. You can look at the secret that was created using kubectl.</p>
<p><code>kubectl get secrets</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">NAME                  TYPE                                  DATA   AGE</span><br><span class="line">default-token-7n4h4   kubernetes.io/service-account-token   3      26h</span><br><span class="line">docker-credentials    kubernetes.io/dockerconfigjson        1      17s</span><br></pre></td></tr></table></figure>
<p>And you can look at the specific secret in yaml with kubectl as well.</p>
<p><code>kubectl get secret docker-credentials -o yaml</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="string">.dockerconfigjson:</span> <span class="string">&lt;snipped&gt;</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="string">"2020-04-30T16:15:02Z"</span></span><br><span class="line">  <span class="attr">managedFields:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line">    <span class="attr">fieldsType:</span> <span class="string">FieldsV1</span></span><br><span class="line">    <span class="attr">fieldsV1:</span></span><br><span class="line">      <span class="attr">f:data:</span></span><br><span class="line">        <span class="string">.:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">        <span class="attr">f:.dockerconfigjson:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">      <span class="attr">f:type:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">    <span class="attr">manager:</span> <span class="string">kubectl.exe</span></span><br><span class="line">    <span class="attr">operation:</span> <span class="string">Update</span></span><br><span class="line">    <span class="attr">time:</span> <span class="string">"2020-04-30T16:15:02Z"</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">docker-credentials</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">resourceVersion:</span> <span class="string">"207328"</span></span><br><span class="line">  <span class="attr">selfLink:</span> <span class="string">/api/v1/namespaces/default/secrets/docker-credentials</span></span><br><span class="line">  <span class="attr">uid:</span> <span class="string">419c553b-bcaa-49e5-831e-1388c9fad5fe</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">kubernetes.io/dockerconfigjson</span></span><br></pre></td></tr></table></figure>
<p>You could take this yaml and create a <code>docker-secret.yml</code> manifest file and declaratively create your secret. I'll leave that to you as homework.</p>
<p>Now our <strong>k8s</strong> cluster should be able to get the container images. We'll prove that in the next section!</p>
<h2>Deploying our IdentityServer4 applications to minikube</h2>
<p>Now that we have our applications in our container registry, we can build up the manifest files for these applications and we can reasonablly expect our <strong>k8s</strong> to be able to fulfill the Deployments that we have in those manifest files.</p>
<h3>STS</h3>
<p>Here is the deployment and service manifests for the STS.</p>
<h4>Deployment Manifest</h4>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">identity-sts-dep</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">identity-sts</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">revisionHistoryLimit:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">identity-sts</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">identity-sts</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">identity-sts</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">depthconsulting.azurecr.io/depthconsulting.identity.sts:latest</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ASPNETCORE_ENVIRONMENT</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">"Development"</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SEQ_URL</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">"http://seq-svc"</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">AdminConfiguration__IdentityAdminBaseUrl</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">http://127.0.0.1.xip.io:9000</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ASPNETCORE_URLS</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">"http://+:80"</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">imagePullSecrets:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">docker-credentials</span></span><br></pre></td></tr></table></figure>
<p>Interesting entries in this manifest are:</p>
<ul>
<li>Labels are important. They match a Service to a Deployment</li>
<li>We are telling the deployment where to get the container images from</li>
<li>our Seq url is the DNS entry created for the Seq post in the cluster</li>
<li>we are telling <strong>k8s</strong> to use the <strong>docker-credentials</strong> secret when trying to pull down the container images from our ACR
<ul>
<li>this allows us to pull images from multiple private repositories if needed</li>
</ul>
</li>
</ul>
<h4>Service Manifest</h4>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">identity-sts-svc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">identity-sts</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">nodePort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>
<p>A simple Service manifest telling us that:</p>
<ul>
<li>use the <strong>type: NodePort</strong> to expose the STS service to the external network on port 80</li>
<li>the label will hook this Service up with the pods with the matching label</li>
</ul>
<h3>Admin</h3>
<h4>Deployment Manifest</h4>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">identity-admin-dep</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">identity-admin</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">revisionHistoryLimit:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">identity-admin</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">identity-admin</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">identity-admin</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">depthconsulting.azurecr.io/depthconsulting.identity.admin:latest</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ASPNETCORE_ENVIRONMENT</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">"Development"</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SEQ_URL</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">"http://seq-svc"</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">AdminConfiguration__IdentityServerBaseUrl</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">http://127.0.0.1.xip.io</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">AdminConfiguration__IdentityAdminRedirectUri</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">http://127.0.0.1.xip.io:9000/signin-oidc</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ASPNETCORE_URLS</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">"http://+:9000"</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">imagePullSecrets:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">docker-credentials</span></span><br></pre></td></tr></table></figure>
<h4>Service Manifest</h4>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">identity-admin-svc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">identity-admin</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">nodePort:</span> <span class="number">9000</span></span><br></pre></td></tr></table></figure>
<h3>Admin Api</h3>
<h4>Deployment Manifest</h4>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">identity-admin-api-dep</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">identity-admin-api</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">revisionHistoryLimit:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">identity-admin-api</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">identity-admin-api</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">identity-admin-api</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">depthconsulting.azurecr.io/depthconsulting.identity.adminapi:latest</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ASPNETCORE_ENVIRONMENT</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">"Development"</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SEQ_URL</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">"http://seq-svc"</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">AdminApiConfiguration__IdentityServerBaseUrl</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">http://127.0.0.1.xip.io</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">AdminApiConfiguration__ApiBaseUrl</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">http://127.0.0.1.xip.io:5000</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ASPNETCORE_URLS</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">"http://+:80"</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">imagePullSecrets:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">docker-credentials</span></span><br></pre></td></tr></table></figure>
<h4>Service manifest</h4>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span>  <span class="string">identity-admin-api-svc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span>  <span class="string">identity-admin-api</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">nodePort:</span> <span class="number">5002</span></span><br></pre></td></tr></table></figure>
<p>Now we can kubectl all of these manifests into our <strong>k8s</strong> cluster and we should see them all appear in the Web UI.</p>
<ul>
<li>
<p><code>kubectl create -f .\sts-dep.yml</code></p>
</li>
<li>
<p><code>kubectl create -f .\sts-svc.yml</code></p>
</li>
<li>
<p><code>kubectl create -f .\admin-dep.yml</code></p>
</li>
<li>
<p><code>kubectl create -f .\admin-svc.yml</code></p>
</li>
<li>
<p><code>kubectl create -f .\adminapi-dep.yml</code></p>
</li>
<li>
<p><code>kubectl create -f .\adminapi-svc.yml</code></p>
</li>
</ul>
<blockquote>
<p>Feel free to put put these into a single manifest file or any other combination that makes sense to you.</p>
</blockquote>
<p>Now expose all of the services from minikube.</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># expose the services from minikube</span></span><br><span class="line">minikube service identity<span class="literal">-sts</span><span class="literal">-svc</span></span><br><span class="line">minikube service identity<span class="literal">-admin</span><span class="literal">-svc</span></span><br><span class="line">minikube service identity<span class="literal">-admin</span><span class="literal">-api</span><span class="literal">-svc</span></span><br></pre></td></tr></table></figure>
<h4>Inspect The Pods In Kubernetes</h4>
<p>Now is a good time, before we go try to use these applications, to see if the Pods are up and healthy in your <strong>k8s</strong> cluster in minikube. If you haven't yes, you can use the <code>minikube dashboard</code> command to get to the <strong>Kubernetes Web UI</strong> or you can go to a command prompt and type <code>octant</code> to start that tool if you've installed it.</p>
<h5>Octant</h5>
<img src="/images/dwhite/octant-started.png" alt="Start Octant" height="200px">
<p>We're taking a look at the state of the pods now because with our approach to putting pod resources into <strong>k8s</strong>, we are taking an indirect path to getting actual pods running. Our approach is to:</p>
<ul>
<li>create a <code>Deployment</code> resource
<ul>
<li>which creates a <code>ReplicateSet</code> resource
<ul>
<li>which creates <code>Pod</code> resource(s) as necessary</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>In our previous steps, the backend infrastructure resources that we wanted running came from DockerHub (a public repository) and they are pretty easy to get started, so we were unlikely to see any Pod start-up failures. With our own Skoruba-based applications in a private repository, there is a greater chance that our pods will fail to start up, and we'd like to see that now.</p>
<p>Hopefully, everything worked and what you see in Octant is this:</p>
<img src="/images/dwhite/octant-pods-running.png" alt="Pods running in as seen in Octant" height="250px">
<p>What we see in this image is all the pods having fulfilled their ReplicaSet <code>replicas:</code> pod count and that they are all <code>running</code>.</p>
<p>When I did this the first time, my <strong>Pods</strong> did <em>not</em> all end up running. I encountered for the first time the dreaded <strong>ImagePullBackoff</strong> error condition! This is a condition where the <strong>k8es</strong> control plane is having troubles acquiring an image, for any of a number of reasons, and is now slowing down the rate that it tries to acquire the image.</p>
<img src="/images/dwhite/octant-image-pull-backoff-sts-pending.png" alt="STS pod cannot run" height="90px">
<img src="/images/dwhite/octant-image-pull-backoff.png" alt="Image Pull Backoff Condition" height="150px">
<p>In this case, I've simply changed the image that the Deployment is trying to pull to create this error condition. If the image name is incorrect, this error condition will occur.</p>
<p>Another reason that it occurred for me was because I had my <em>private container registry</em> credentials wrong. If you are missing the docker-secret or you have the wrong username/password in that secret, you will also get an <strong>ImagePullBackoff</strong> error condition.</p>
<p>I'd encourage you to give this a try! You only need to <code>kubectl apply -f .\identity-sts-dep.yml</code> with an incorrect image name and you'll see this error. Change it back and apply again and you'll see it fixed. You could also remove the <strong>docker-secret</strong> to see how that affects things.</p>
<p>It should go without saying, that if you have this problem, you have to resolve this prior to continuing.</p>
<h2>We need DNS entries for IdentityServer4</h2>
<p>The combination of hosting our <strong>k8s</strong> cluster on minikube and running this all on our local machine and the fact that this is an bunch of Identity applications where the <code>hostname</code> is really important, we have to do a little extra work. You're going to want to put this into your <strong>start-up.ps1</strong> file.</p>
<h3>Update your Windows host file</h3>
<p>We need to be able to use hostnames for our web applications, so we are going to have to alter our <strong>host</strong> file in order to make that happen. Here is a powershell script (<strong>that you should 100% review yourself!</strong>) that will udpate your <strong>host</strong> file to make this work with the <strong>127.0.0.1.xip.io</strong> DNS/hostname. This should not damage your existing host file entries, but <strong>please back-up your hosts file first.</strong></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># edit your workstations host file to add minikube ip and DNS alias</span></span><br><span class="line"><span class="variable">$hostFileLocation</span> = <span class="string">"C:\Windows\System32\drivers\etc\hosts"</span></span><br><span class="line"><span class="variable">$ip</span> = minikube ip <span class="comment"># get the minikube IP adddress put the address in a variable call $ip</span></span><br><span class="line"><span class="variable">$localDnsEntry</span> = <span class="string">"127.0.0.1.xip.io"</span> <span class="comment"># our fake DNS entry/hostname</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">Write-Host</span> <span class="string">"We are going to set the minikube IP address <span class="variable">$ip</span> to DNS entry of <span class="variable">$localDnsEntry</span>"</span></span><br><span class="line"><span class="variable">$dump</span> =  <span class="built_in">Get-Content</span> <span class="literal">-Path</span> <span class="variable">$hostFileLocation</span></span><br><span class="line"><span class="variable">$hostFile</span> = [<span class="type">System.Collections.Generic.List</span>[<span class="built_in">string</span>]] <span class="variable">$dump</span></span><br><span class="line"><span class="variable">$entriesCount</span> = <span class="variable">$hostFile</span>.Count</span><br><span class="line"><span class="built_in">Write-host</span> <span class="string">"Found <span class="variable">$entriesCount</span> entries in the hosts file"</span></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$hostFile</span>.Contains(<span class="string">"# minikube section"</span>))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">Write-Host</span> <span class="string">"Found a minikube section... replacing it."</span></span><br><span class="line">    <span class="variable">$hostFile</span>.Remove(<span class="string">"# minikube section"</span>) | <span class="built_in">Out-Null</span></span><br><span class="line">    <span class="variable">$hostFile</span>.FindAll(&#123;<span class="keyword">param</span>(<span class="variable">$line</span>) <span class="variable">$line</span>.Contains(<span class="variable">$localDnsEntry</span>)&#125;) | % &#123; <span class="variable">$hostFile</span>.Remove(<span class="variable">$_</span>) | <span class="built_in">Out-Null</span> &#125;</span><br><span class="line">    <span class="variable">$hostFile</span>.Remove(<span class="string">"# minikube end section"</span>) | <span class="built_in">Out-Null</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$hostFile</span>.Add(<span class="string">"# minikube section"</span>)</span><br><span class="line"><span class="variable">$hostFile</span>.Add(<span class="string">"<span class="variable">$ip</span>`t<span class="variable">$localDnsEntry</span>"</span>)</span><br><span class="line"><span class="variable">$hostFile</span>.Add(<span class="string">"# minikube end section"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$hostFile</span>.Count <span class="operator">-ge</span> <span class="variable">$entriesCount</span>) <span class="comment"># test to ensure we don't put fewer entries back in host file</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">Write-Host</span> <span class="string">"Updating our hosts file with <span class="variable">$</span>(<span class="variable">$hostFile</span>.Count) entries."</span></span><br><span class="line">  <span class="built_in">Set-Content</span> <span class="literal">-path</span> C:\Windows\System32\drivers\etc\hosts <span class="variable">$hostFile</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">Write-Host</span> <span class="string">"Done"</span></span><br></pre></td></tr></table></figure>
<p>This powershell script <strong>will</strong> change the way that the DNS system works on your Windows workstation. The <strong>hosts</strong> file takes precedence over a DNS query to the internet, so once we do this, our Windows machine will resolve the IP address we've stated and not the one that would have been return by xip.io. This will break our ability to use DockerCompose. Comment out the entry to use DockerCompose again. The alternative is to create separate domains/configurations for each environment (Docker &amp; minikube) on your local workstation. This is a bit cumbersome with the way seed data is handled today, but it is a problem that could be solved.</p>
<p>You should now be able to visit the following URLs and only be challenged for your username/password once and you will be asked for consent from each set that you visit.</p>
<ul>
<li><a href="http://127.0.0.1.xip.io" target="_blank" rel="noopener">http://127.0.0.1.xip.io</a> - STS Landing page</li>
<li><a href="http://127.0.0.1.xip.io:9000" target="_blank" rel="noopener">http://127.0.0.1.xip.io:9000</a> - Admin Application</li>
<li><a href="http://127.0.0.1.xip.io:5000/swagger" target="_blank" rel="noopener">http://127.0.0.1.xip.io:5000/swagger</a> - Admin API Swagger Api Explorer</li>
</ul>
<p>With the Admin Application, if you have not already logged in, you should be re-directed to the STS login page, hence the single-sign on aspect of our authentication ecosystem!</p>
<h2>Victory!!</h2>
<p>So! I'm crossing my fingers (virtually and into perpetuity) that you've arrived at a place that you can test the IdentityServer4 applications (all three), running in a minikube-based <strong>K8S</strong> cluster! If you can't, you'll have to work at it a bit and if you really get stuck, try reaching out to me on Twitter! I'm usually paying attention to notifications there!</p>
<p>I certainly encourage you to explore and experiment with <strong>k8s</strong> and IdentityServer4 in this environment. With these instructions, your manifests, and a little bit of luck, you should be able to always get back to a known working state, even if that means a little bit of lost data.</p>
<p>You can always start from scratch very easily from a minikube <strong>k8s</strong> cluster perspective. The following commands will tear down and re-build you minikube cluster. This destroys everything and gives you a totally clean slate.</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">minikube stop</span><br><span class="line">minikube destroy</span><br><span class="line">minikube start -<span class="literal">-vm</span><span class="literal">-driver</span>=hyperv -<span class="literal">-cpus</span>=<span class="number">4</span> -<span class="literal">-memory</span>=<span class="number">16</span>g -<span class="literal">-extra</span><span class="literal">-config</span>=apiserver.service<span class="literal">-node</span><span class="literal">-port</span><span class="literal">-range</span>=<span class="number">80</span><span class="literal">-33000</span></span><br></pre></td></tr></table></figure>
<p>Our next stop will be a bit of a reflection point, and then, on to AKS!!</p>
<p><strong>Next up:</strong>
<a href="/kubernetes/kubernetes-my-journey-part-6">Pause to reflect</a></p>
<style>
    h1, h2, h3, h4, h5, h6 {
       margin-top: 25px;
    }
    figure.highlight{
        background-color: #E8EEFE;
    }
    figure.highlight .gutter{
        color: #0033CD;
    }
    figure.highlight pre {
        font-family: 'Cascadia Code PL', monospace;
    }
    code {
        font-family: 'Cascadia Code PL', sans-serif;
        border-width: 0.1em;
        border-color: #E8EEFE;
        border-style: solid;
        border-radius: 0.3em;
        background-color: #E8EEFE;
        color: #0033CD;
        padding: 0em 0.4em;
        white-space: nowrap;
    }
</style>
<link  href="https://cdnjs.cloudflare.com/ajax/libs/viewerjs/1.5.0/viewer.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/viewerjs/1.5.0/viewer.min.js"></script>
<script>
// View an image
const gallery = new Viewer(document.getElementById('mainPostContent', {
    "navbar": false,
    "toolbar": false
}));
</script>
	        </div>

            
            <section id="comments">
            <div id="disqus_thread">
                <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript" target="_blank" rel="noopener">comments powered by Disqus.</a></noscript>
            </div>
            </section>
            
		</div>
	</div>
<!--MAIN CONTENT ENDS-->

<!--SIDEBAR CONTENT STARTS-->
	<div class="SubpageBoxSubSm">
		<div class="SubpageBoxSubSmContent">
			
			

			<div class="ProfileImg">
				
				<a href="/bios/dave_white">
				
					<img src='https://www.gravatar.com/avatar/4b7708d2ae7f7bb866446e0459e3e156?s=200' />
				
				</a>
				
			</div>

			<BR clear="all">

			<h2><a href="/bios/dave_white">Dave White</a></h2>
			
			<a href="mailto:dmhwhite@gmail.com"><img class="ProfileIcon" src="/images/icon_email.png" border="0" alt="Email" title="Email"> Email</a><BR>
			
			
			<a href="http://agileramblings.com/" target="_blank"><img class="ProfileIcon" src="/images/icon_web.png" border="0" alt="Web" title="Web"> Web</a><BR>
			
			
			<a href="http://twitter.com/AgileRamblings" target="_blank"><img class="ProfileIcon" src="/images/icon_twitter.png" border="0" alt="Twitter" title="Twitter"> Twitter</a><BR>
			
			
			<a href="https://github.com/agileramblings" target="_blank"><img class="ProfileIcon" src="/images/icon_github.png" border="0" alt="GitHub" title="GitHub"> GitHub</a><br>
			
			
			<a href="https://www.linkedin.com/in/dave-white" target="_blank"><img class="ProfileIcon" src="/images/icon_linkedin.png" border="0" alt="LinkedIN" title="LinkedIN"> LinkedIn</a><br>
			
			
 			<a href="/feeds/dave_white.xml"><img class="ProfileIcon" src="/images/icon_subscribe.png" /> RSS</a>
			

			<hr />
			<h4>Looking for someone else?</h4>
			<p>You can find the rest of the Western Devs Crew <a href="/whoweare">here</a>.</p>
		</div>
	</div>
<!--SIDEBAR CONTENT ENDS-->


</div>
</center>
<!--PAGE CONTENT ENDS-->


<!--FOOTER STARTS-->
<center>
  <div class="FooterBarTxt">&copy; 2015 Western Devs. All Rights Reserved. Design by <a href="http://www.karenchudobiak.ca" target="_blank">Karen Chudobiak, Graphic Designer</a></div>
</center>
<!--FOOTER ENDS-->

<!-- NAV FOOTER STARTS -->
<div class="NavFooter">
  <a href="/posts" alt="Posts"><i class="fa fa-newspaper-o fa-2x"></i><span>Posts</span></a>
  <a href="/podcasts" alt="Podcasts"><i class="fa fa-volume-up fa-2x"></i><span>Podcasts</span></a>
  <a href="/whoweare" alt="About"><i class="fa fa-star fa-2x"></i><span>About</span></a>
  <a href="/whatwevedone" alt="What We've Done"><i class="fa fa-trophy fa-2x"></i><span>Work</span></a>
  <a href="/speaking" alt="Speaking"><i class="fa fa-comment-o fa-2x fa-flip-horizontal"></i><span>Speaking</span></a>
</div>
<!-- NAV FOOTER ENDS -->




</div>
<!--WRAPPER ENDS-->


<script>
  var disqus_shortname = 'westerndevs';
  
  var disqus_url = 'https://westerndevs.com/kubernetes/kubernetes-my-journey-part-5b/'.replace(".com//", ".com/");
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
  
function shuffle(array) {
  var currentIndex = array.length, temporaryValue, randomIndex;

  // While there remain elements to shuffle...
  while (0 !== currentIndex) {

    // Pick a remaining element...
    randomIndex = Math.floor(Math.random() * currentIndex);
    currentIndex -= 1;

    // And swap it with the current element.
    temporaryValue = array[currentIndex];
    array[currentIndex] = array[randomIndex];
    array[randomIndex] = temporaryValue;
  }

  return array;
}

</script>


</body>

  
<!-- Google Analytics -->
<script type="text/javascript">
if (document.location.hostname.search("westerndevs.com") !== -1 || document.location.hostname.search("www.westerndevs.com") !== -1) {
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-37617956-2', 'auto');

ga('set', 'contentGroup1', 'dave_white');

ga('send', 'pageview');
}
</script>
<!-- End Google Analytics -->



</html>
