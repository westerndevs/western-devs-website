<!DOCTYPE html>
<html lang="en" xml:lang="en">

  <head>
  
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>Kubernetes - My Journey - Part 7a | Western Devs</title>
  <meta name="description" content="Series Table of Contents Previously: Pause to reflect Moving to Azure Kubernetes Service - Part A It would be great if we could get this all working in minikube and call it done, but we&#39;re not quite t">
<meta property="og:type" content="article">
<meta property="og:title" content="Kubernetes - My Journey - Part 7a">
<meta property="og:url" content="https://westerndevs.com/kubernetes/kubernetes-my-journey-part-7a/index.html">
<meta property="og:site_name" content="Western Devs">
<meta property="og:description" content="Series Table of Contents Previously: Pause to reflect Moving to Azure Kubernetes Service - Part A It would be great if we could get this all working in minikube and call it done, but we&#39;re not quite t">
<meta property="og:image" content="https://westerndevs.com/images/dwhite/azure-basic-aks-resources.png">
<meta property="og:image" content="https://westerndevs.com/images/dwhite/pulumi-login-cli.png">
<meta property="og:image" content="https://westerndevs.com/images/dwhite/pulumi-create-new-stack.png">
<meta property="og:image" content="https://westerndevs.com/images/dwhite/pulumi-created-dev-stack.png">
<meta property="og:image" content="https://westerndevs.com/images/dwhite/pulumi-new-project-in-web.png">
<meta property="og:image" content="https://westerndevs.com/images/dwhite/pulumi-first-up.png">
<meta property="og:image" content="https://westerndevs.com/images/dwhite/pulumi-first-up-completed.png">
<meta property="og:image" content="https://westerndevs.com/images/dwhite/pulumi-first-up-completed-web.png">
<meta property="og:image" content="https://westerndevs.com/images/dwhite/pulumi-first-stack-history.png">
<meta property="og:image" content="https://westerndevs.com/images/dwhite/pulumi-first-up-azure-storage-account.png">
<meta property="og:image" content="https://westerndevs.com/images/dwhite/pulumi-set-config-password.png">
<meta property="og:image" content="https://westerndevs.com/images/dwhite/pulumi-set-config-sshPublicKey.png">
<meta property="og:image" content="https://westerndevs.com/images/dwhite/pulumi-set-config-done.png">
<meta property="og:image" content="https://westerndevs.com/images/dwhite/pulumi-set-config-outputs.png">
<meta property="og:image" content="https://westerndevs.com/images/dwhite/pulumi-secrets-output.png">
<meta property="article:published_time" content="2020-05-22T09:00:00.000Z">
<meta property="article:modified_time" content="2021-08-13T03:26:11.405Z">
<meta property="article:author" content="Western Devs">
<meta property="article:tag" content="kubernetes, azure, aks, identityserver, docker, containers">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://westerndevs.com/images/dwhite/azure-basic-aks-resources.png">
<meta name="twitter:creator" content="@westerndevs">

    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="title" content="WesternDevs">   
    <meta name="keywords" content="software development,software,asp.net,blog">
    <meta name="description" content="We're all west of somewhere">
    <meta name="copyright" content="WesternDevs">
    <meta name="revisit-after" content="15 days">
    <meta name="robots" content="all">
    <meta name="MSSmartTagsPreventParsing" content="true">
  
  
    <link rel="alternate" href="/feed.xml" title="Western Devs" type="application/atom+xml">
  
  
<link rel="stylesheet" href="/css/style.css">

      
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <script src="//code.jquery.com/jquery-1.11.3.min.js"></script>  
  <meta name="generator" content="Hexo 4.2.0"></head>

<body>

<!-- FIXED HEADER BECAUSE SCROLLING -->
<!--HEADER STARTS-->
<div class="WrapperHeader">
<div style="display:inline-block; text-align: center;">
<div class="Header">

  <div class="HeaderLogo">
    <a href="/"><img src="/images/header_logo_transparent.png" alt="WesternDevs" title="WesternDevs" border="0" style="width: 206px; height: 64px;" width="206" height="64"></a>
  </div>

  <div class="HeaderLinks">
      <a href="/posts" class="nav">POSTS</a>       
      <a href="/podcasts" class="nav">PODCASTS</a>       
      <a href="/whoweare" class="nav">ABOUT</a>  
      <a href="/whatwevedone" class="nav">WHAT WE'VE DONE</a>  
      <a href="/speaking" class="nav">SPEAKING</a>
      <div class="HeaderIcons">
        <a href="mailto:info@westerndevs.com"><img src="/images/icon_email.png" border="0" alt="Email" title="Email" height="26" width="26"></a>
        <a href="/feed.xml"><img src="/images/icon_subscribe.png" border="0" alt="Subscribe" title="Subscribe" height="26" width="27"></a>
        <a href="http://twitter.com/westerndevs" target="_blank"><img src="/images/icon_twitter.png" border="0" alt="Twitter" title="Twitter" height="26" width="27"></a>
        <a href="http://github.com/westerndevs" target="_blank"><img src="/images/icon_github.png" border="0" alt="GitHub" title="GitHub" height="26" width="27"></a>     
      </div>
  </div>
  
</div>
</div>
</div>
<!--HEADER ENDS-->    



<!--WRAPPER STARTS-->
<div class="Wrapper" style="">

<!--SUBHEAD STARTS-->
<div class="WrapperSubHeaderSubpage">
<center>
	<div class="SubHeader">
		<H1 class="title"><img class="icon" src="/images/icon_posts.png" alt="POST" title="POST" border="0"> POST</H1>
	</div>
</center>
</div>
<!--SUBHEAD ENDS-->

<!--PAGE CONTENT STARTS-->
<center>
<div class="WrapperContent">

<!--MAIN CONTENT STARTS-->
	<div class="SubpageBoxSubLrg">
		<div class="SubpageBoxSubLrgContent">
		    <div class='postTitle'>
  <div class="ListLrgDateBG">
    <div class="ListLrgDateMonth">MAY</div>
    <div class="ListLrgDateDay">22</div>
    <div class="ListLrgDateYear">2020</div>
  </div>
  <h2>Kubernetes - My Journey - Part 7a</h2>
</div>

		    

			<div id="mainPostContent">
	        <p><a href="/kubernetes/kubernetes-my-journey">Series Table of Contents</a></p>
<p><strong>Previously:</strong>
<a href="/kubernetes/kubernetes-my-journey-part-6">Pause to reflect</a></p>
<h1>Moving to Azure Kubernetes Service - Part A</h1>
<p>It would be great if we could get this all working in minikube and call it done, but we're not quite that lucky! We're probably going to need a platform with a bit more breathing room and additional capabilities to run our production workloads, so we'll have to figure out a way to move all of this into that platform. In our case, that platform is going to be <strong>Azure</strong> and the <strong>Azure Kubernetes Services (AKS)</strong>.</p>
<p>With the desire to move our resources into a new <strong>k8s</strong> cluster in the cloud, there are a lot of moving parts in the infrastructure as compared to what minikube has. Here is a picture of the basic resources we'll have in Azure after we stand up this <strong>k8s</strong> cluster.</p>
<img src="/images/dwhite/azure-basic-aks-resources.png" alt="Basic Azure Kubernetes Services Resources" height="400px">
<p>I also had to consider managing the <strong>k8s</strong> resources (apps in manifests). I want that to be a part of any automation as well.</p>
<p>With all of this in mind, I knew I was going to want something more than a collection of PowerShell scripts to manage the <strong>AKS</strong> resources <em>and</em> the <strong>k8s</strong> resources in our cluster. Thankfully, a new product called <a href="https://www.pulumi.com" target="_blank" rel="noopener">Pulumi</a> had recently joined the market that looked like it would fit the bill as far as ease of use, community support, and a full IaC ecosystem for me to work with.</p>
<p>This part of the series is mostly going to be about Pulumi, with side discussions about the specific Azure resources that we will instantiate with Pulumi.</p>
<h2>Important Assumption</h2>
<p>Now that we are moving our activites off of our development machines and into the cloud, it is very important that you have all of the required permissions to act (or for Pulumi to act on your behalf) in your Azure subscription. We will be creating many resources in Azure and you <strong>must</strong> have permission to create these resources.</p>
<h2>Pulumi - Getting Started</h2>
<p><a href="https://www.pulumi.com" target="_blank" rel="noopener">Pulumi</a> is a platform that includes:</p>
<ol>
<li>A cloud-platform that stores data about your preferences, your settings for projects (stacks), and the results of your executions.</li>
<li>Multiple language-specific SDKs (see languages below) that allow you to create a Pulumi application that will run and deploy your infrastructure. You can choose the language you are most comfortable with to write <em>your</em> application.</li>
<li>The Pulumi CLI tool that will allow you to manage your infrastructure and run your application to stand-up, tear down, or manage your project (stack).</li>
</ol>
<p>In addition to the actual tooling, there is a tremendous amount of documentation and community support. I've generally been happy with the documentation even though I think it is still lacking in a couple places, but the community support has been really good. <a href="https://slack.pulumi.com/" target="_blank" rel="noopener">Pulumi has a Slack</a> that anyone can join; it has logical channels that will generally meet your needs, and the Pulumi team have been very responsive in this slack whenever I encountered a problem.</p>
<blockquote>
<p>I don't know about you, but when I have a programming problem, I skip all of the &quot;conceptual&quot; stuff, dive in, and thrash around a bunch. But, if you are inclined to understand the core Pulumi architecture and concepts, you should <a href="https://www.pulumi.com/docs/intro/concepts/" target="_blank" rel="noopener">start reading here.</a></p>
</blockquote>
<h3>Creating an Account</h3>
<p>Pulumi is a platform and a part of that platform are cloud-based services, associated to an account, that stores your settings, secrets, and outcomes from deployments. Pulumi has 4 pricing tiers, the first of which is Community and is free! This is the one I'm currently using. In the Community edition, your user is basically mapped one to one with an <em>Organization</em> and this organziation can have <em>stacks</em> which are (sort of) the Pulumi term for a deployment target. These stacks are associated with deployment projects so a project can have <em>n</em> stacks in it. The Community SKU of Pulumi is free and so far, it has been everything I needed.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Pulumi Organization</span><br><span class="line">  |- User Account(s)</span><br><span class="line">  |- Project A</span><br><span class="line">  |   |- Pulumi application</span><br><span class="line">  |   |- stack (dev)</span><br><span class="line">  |      |- config, history, etc</span><br><span class="line">  |   |- stack (prod)</span><br><span class="line">  |      |- config, history, etc</span><br><span class="line">  |</span><br><span class="line">  |-Project B</span><br><span class="line">      |_ Pulumi application</span><br><span class="line">      |- stack (dev)</span><br><span class="line">         |- config, history, etc</span><br><span class="line">      |- stack (prod)</span><br><span class="line">         |- config, history, etc</span><br></pre></td></tr></table></figure>
<p>You may already know that you need to have more than one person working on this or you may be concerned that you'll outgrow the Community edition, but you shouldn't be concerned. It looks like Pulumi has a seamless upgrade path (that I haven't used) and Pulumi also has a feature that allows you to transfer a stack to another account, so you aren't going to be stuck as you grow with the platform. Additionally, everything that you create to use Pulumi (apps and scripts) is <strong>yours</strong> and can be version controlled, shared, and re-used as you see fit. It would be quite easy to re-create a stack in a new organization as needed.</p>
<p>So, unless you know you are going to have multiple people involved in the IaC part of the project, you can just create a Community-based account and start deploying!</p>
<h3>Install the Tools</h3>
<p>Pulumi has a great set of tutorials <a href="https://www.pulumi.com/docs/get-started/azure/" target="_blank" rel="noopener">here</a> for getting started with Azure. I'm going to repeat some of it, but you should definitely check out their learning resources.</p>
<p>Now that you've created an account, it is time to start building your application! First, you'll need to install the Pulumi CLI in your development environment and sign into your cloud account.</p>
<h4>Pulumi CLI</h4>
<p>You have a couple choices to get the Pulumi CLI!</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">choco install pulumi <span class="comment"># requires chocolatey</span></span><br><span class="line"><span class="comment"># -or-</span></span><br><span class="line"><span class="comment"># plain powershell</span></span><br><span class="line">iex ((<span class="built_in">New-Object</span> System.Net.WebClient).DownloadString(<span class="string">'https://get.pulumi.com/install.ps1'</span>))</span><br></pre></td></tr></table></figure>
<p>Once you have the CLI, you can login via a username/password redirect to a browser or you can use an access token that you've created in the web admin pages for your Pulumi account.</p>
<img src="/images/dwhite/pulumi-login-cli.png" alt="Logging into Pulumi" height="150px">
<p>You can use the <code>pulumi whoami</code> to see if you are currently logged in (or who you are logged in as) as well.</p>
<h4>Language-specific SDKs</h4>
<p>Next, you'll need to consider what <a href="https://www.pulumi.com/docs/intro/languages/" target="_blank" rel="noopener">language</a> you are going to use when creating your Pulumi application. There are many choices. <strong>Typescript/JavaScript, Go, .NET Core (C#, F#, VB), and Python</strong>. Pick whichever one your organization has the most skills in. I like Typescript so that is what I picked and what my code will be written in. If you want, you can write an SDK in your favorite language. This is all open-source.</p>
<h4>Project Structure</h4>
<p>Once you've selected a language, you can use the Pulumi <strong>CLI</strong> to create your first <strong>deployment project and stack</strong>. I treat a stack as a deployment that I want to put in a specific environment. For example, I would have 2 stacks for my <strong>k8s</strong> infrastructure. One is the dev infrastructure in our Development Azure subscription, and the other is the production infrastructure which would be in the Production Azure subscription. These 2 stacks stand-up all of the Azure <strong>AKS</strong> resources. I would also have 2 stacks for the <strong>k8s</strong> resources that go into those <strong>k8s</strong> clusters.</p>
<p>Projects are mostly containers for stacks (configuration, history) and an application. Stacks have specific configuration settings and histories that are important. The application that you run for the project can use each stack for specific deployment details.</p>
<blockquote>
<p>A monolithic stack with a single app is a good way to learn and this is how most of the tutorials work. However, I found that it wasn't how I wanted to manage my deployments.</p>
</blockquote>
<p>I originally created a single monolithic project with a single stack and one application but have since changed this to two projects with a single application and a dev/prod stack each. The first project for the <strong>AKS</strong> infrastructure was less volatile and I didn't need to tear it all down all the time. It takes about 18 minutes to stand-up our cluster and 10 minutes to tear it all down. The second project for the <strong>k8s</strong> resources changed much more frequently and I would often want to clear out the <strong>k8s</strong> cluster and start from a clean slate. <strong>k8s</strong> resources can be added or removed from the cluster quickly and frequently. This series will only show the multi-project approach.</p>
<p>First, using the Pulumi CLI, we are going to create a deployment application, in the Typescript language, for the Azure cloud, for only the AKS infrastructure. We'll do our <strong>k8s</strong> resource deployment application later.</p>
<p>Let's create a folder in our infrastructure folder for the <strong>AKS</strong> deployment stack.</p>
<img src="/images/dwhite/pulumi-create-new-stack.png" alt="Create a new Pulumi stack" height="450px">
<p>Once that is done, we can use the Pulumi CLI to build our new project with its initial stack.</p>
<p><code>pulumi new azure-typescript --secrets-provider=passphrase</code></p>
<p>This will kick off the workflow to acquire some details before it creates the stack. In my case, I answered the workflow questions with:</p>
<ol>
<li>project name (aks) &lt;-- hit enter and accepted default</li>
<li>project description: <strong>Deploy our kubernetes infrastructure</strong></li>
<li>stack name: (dev) &lt;-- hit enter and accepted default</li>
<li>Enter your passphrase to protect config/secrets: <strong>P@ssw0rd!</strong></li>
<li>azure:environment: (public) &lt;-- hit enter and accept default</li>
<li>azure:location: (WestUS) <strong>WestUS</strong></li>
</ol>
<p>After answering those questions, the CLI will finish off by:</p>
<ul>
<li>creating your project and first stack
<ul>
<li>saving them in the cloud - this happens automatically</li>
</ul>
</li>
<li>scaffolding out the initial application files locally
<ul>
<li>pulling down all of the correct npm modules based on your cloud provider selection and language choices.</li>
</ul>
</li>
</ul>
<img src="/images/dwhite/pulumi-created-dev-stack.png" alt="Create a new Pulumi stack" height="300px">
<p>We can also look in the web portal for our Pulumi account and see the new stack is available there!</p>
<img src="/images/dwhite/pulumi-new-project-in-web.png" alt="The new stack in the web portal" height="300px">
<p>You can click the the stack to see what information has been published to the Pulumi cloud. There isn't much there yet, but there are some instructions on how to get more information there. We'll see that shortly.</p>
<h5>A Note about --secrets-provider</h5>
<p>You should have noticed that I've used the <code>--secrets-provider</code> parameter in the pulumi CLI invocation. If you are going to be building a single stack like many of the pulumi examples you'll find, you will not use or see this parameter. By default, each stack as a unique secrets provider and stacks <strong>cannot</strong> read each other's secrets. I already plan to have multiple stacks that I want to be able to share secrets between so I need to use this parameter in order to create secrets providers that can reach each other's secrets.</p>
<p>Passphrase is the simplest to use and get working so I'm using that for this article, but you can also use external 3rd party secrets providers. Support providers include:</p>
<ul>
<li>awskms: AWS Key Management Service (KMS)</li>
<li>azurekeyvault: Azure Key Vault</li>
<li>gcpkms: Google Cloud Key Management Service (KMS)</li>
<li>hashivault: HashiCorp Vault Transit Secrets Engine</li>
</ul>
<p>More details about how to use these encryption providers can be found <a href="https://www.pulumi.com/docs/intro/concepts/config/" target="_blank" rel="noopener">here -- Alternate Secrets Encryption.</a></p>
<p>We will re-visit secrets in a little while. Now back to our new project.</p>
<h4>Scaffolded Files</h4>
<p>If we inspect the scaffolded application in the aks folder, we'll see the following:</p>
<table>
<thead>
<tr>
<th style="text-align:left"></th>
<th style="text-align:left"></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><strong>node_modules</strong></td>
<td style="text-align:left">This is where our SDK lives, we use NPM to add SDK components</td>
</tr>
<tr>
<td style="text-align:left"><strong>.gitignore</strong></td>
<td style="text-align:left">Version controlled application development, just like you already do!</td>
</tr>
<tr>
<td style="text-align:left"><strong>index.ts</strong></td>
<td style="text-align:left">the entry-point for our TypeScript-based IaC application</td>
</tr>
<tr>
<td style="text-align:left"><strong>packages.json</strong></td>
<td style="text-align:left">The list of packages used in our application</td>
</tr>
<tr>
<td style="text-align:left"><strong>Pulumi.dev.yaml</strong></td>
<td style="text-align:left">stack-specific configuration values</td>
</tr>
<tr>
<td style="text-align:left"><strong>Pulumi.yaml</strong></td>
<td style="text-align:left">project-specific values</td>
</tr>
<tr>
<td style="text-align:left"><strong>tsconfig.json</strong></td>
<td style="text-align:left">TypeScript application configuration</td>
</tr>
</tbody>
</table>
<h2>More Tooling - azure-cli</h2>
<p>So, we have the Pulumi CLI, maybe git CLI, and now we need to make sure we have one more tool in place. We need the <strong>azure-cli</strong> command line tool. Pulumi will use the <strong>azure-cli</strong> to actually do all of the work in the correct subscription.</p>
<p>You'll need to install the <strong>azure-cli</strong> with <a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli-windows?view=azure-cli-latest#install-or-update" target="_blank" rel="noopener">instructions here</a>. I like the little PowerShell script that does it for you myself.</p>
<p>Once the azure-cli is installed, you'll need to log into your Azure subscription that you want to work with.</p>
<p><code>az login</code> will open a browser window and help you log into your subscription.</p>
<p><code>az account list</code> will list all of the available subscriptions (if there is more than one)</p>
<p><code>az account set &lt;subscription name&gt;</code> will set the current context to the desired subscription</p>
<blockquote>
<p>If you have multiple subscriptions, you'll probably spend a bit of time switching back and forth. One thing I would suggest is to be careful when working with multiple subscriptions. Pulumi, via the current azure-cli context, will happily deploy or tear-down your infrastructure when asked. There are some safe-guards in place with regard to tear-down or changing, but I've found Pulumi is always happy to stand new things up into a subscription! I accidentally installed a minecraft server into my client's development subscription this way once! Ok, maybe twice!</p>
</blockquote>
<p>With Pulumi ready and azure-cli ready, we should be ready to start coding! If you haven't done this already, it's time to open VS Code or your favorite text editor!</p>
<h2>Your first Pulumi Application</h2>
<p>I like to open VS Code right away for a couple reasons. It is a nice text editor with excellent TypeScript support and it also has a built-in terminal window that I can set to use PowerShell Core and I can leave the directory set to the one that holds the files I'm working in.</p>
<p>Open your <strong>index.ts</strong> file and take a look at what the Pulumi CLI scaffolded.</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> pulumi <span class="keyword">from</span> <span class="string">"@pulumi/pulumi"</span>; <span class="comment">// Add the Pulumi core SDK module to your application</span></span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> azure <span class="keyword">from</span> <span class="string">"@pulumi/azure"</span>;   <span class="comment">// Add the Azure core SDK module to your application</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Create an Azure Resource Group</span></span><br><span class="line"><span class="keyword">const</span> resourceGroup = <span class="keyword">new</span> azure.core.ResourceGroup(<span class="string">"resourceGroup"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Create an Azure resource (Storage Account)</span></span><br><span class="line"><span class="keyword">const</span> account = <span class="keyword">new</span> azure.storage.Account(<span class="string">"storage"</span>, &#123;</span><br><span class="line">    <span class="comment">// The location for the storage account will be derived automatically from the resource group.</span></span><br><span class="line">    resourceGroupName: resourceGroup.name,</span><br><span class="line">    accountTier: <span class="string">"Standard"</span>,</span><br><span class="line">    accountReplicationType: <span class="string">"LRS"</span>,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Export the connection string for the storage account</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> connectionString = account.primaryConnectionString;</span><br></pre></td></tr></table></figure>
<p>At the top, you'll see that two modules have been added for you. The Pulumi Core SDK module and the Azure Core SDK module. Depending on what you need, you only add the modules to your application that you are actually using. If you need additional modules, we can use <code>npm install @pulumi/&lt;module name&gt;</code> to get those SDK modules.</p>
<p>Next, we see code that is creating a new ResourceGroup in Azure to hold all of our new resources.</p>
<p>Then, we see code that is creating a new Storage account.</p>
<p>And finally, we have a snippet of code that is going to export the storage account's connection string for use later.</p>
<blockquote>
<p>Anything that you <code>export</code> in your TypeScript will be published to the cloud for review or use by another Pulumi stack/application at a later date. If you don't want these properties publicly accessible, do not export them. We will demonstrate this later. This is important to understand when working with stacks that are dependent on other stacks.</p>
</blockquote>
<p>The next step is deploying this stack! Go ahead! Type:</p>
<p><code>pulumi up</code></p>
<p>You will see the Pulumi CLI kick off your IaC application. It builds the app, does some analysis of what it wants to do, and then asks you if you'd like to continue!</p>
<blockquote>
<p>If your TypeScript application won't build, the process stops here, and you have to fix it.</p>
</blockquote>
<img src="/images/dwhite/pulumi-first-up.png" alt="Logging into Pulumi" height="250px">
<p>Once you accept, it finishes doing what you've coded, and it deploys your new Azure infrastructure to your subscription.</p>
<img src="/images/dwhite/pulumi-first-up-completed.png" alt="Logging into Pulumi" height="250px">
<p>And it also publishes details into your Pulumi cloud account for this project/stack. You can see the exported connnectionString. Also available in the cloud is a historical log of what has happened in this stack in the <strong>Activity</strong> tab.</p>
<img src="/images/dwhite/pulumi-first-up-completed-web.png" alt="Logging into Pulumi" height="600px">
<img src="/images/dwhite/pulumi-first-stack-history.png" alt="Logging into Pulumi" height="300px">
<p>And here are the Azure resources that were created.</p>
<img src="/images/dwhite/pulumi-first-up-azure-storage-account.png" alt="Azure Storage Account" height="300px">
<blockquote>
<p>Notice that Pulumi has appended a segment of characters on your resource names to try and ensure they are unique within the subscription. I haven't tried to alter that behaviour. You can create a resource directly in Azure and import it into your stack and Pulumi will respect the name it was given.</p>
</blockquote>
<p>That's pretty cool! The only problem is, I don't want a lone storage account in my Azure subscription.</p>
<p>So, what do we do now? Tear it all down and let Pulumi clean up everything it created.</p>
<p><code>pulumi destroy</code></p>
<p>This will ask you for confirmation, so you are protected that way. Just let the Pulumi CLI finish it's work and go look in your Azure subscriptions! It will be clean as a whistle!</p>
<h2>Deploying an AKS</h2>
<p>I hope that was a good introduction to Pulumi, but what we really wanted to do was build an application that would deploy our <strong>AKS</strong> into our subscription. Let's get to that.</p>
<p>Before getting started, <strong>delete all of the existing lines of code in your index.ts</strong>. We will not be using anything created during the initial scaffolding.</p>
<h3>Importing more Pulumi SDK modules</h3>
<p>Standing up an <strong>AKS</strong> service cluster is move involved that a simple storage account. We will need more SDK modules in our application in order to make that happen. Let's add some import statements into our Pulumi application.</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> azure <span class="keyword">from</span> <span class="string">"@pulumi/azure"</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> pulumi <span class="keyword">from</span> <span class="string">"@pulumi/pulumi"</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> k8s <span class="keyword">from</span> <span class="string">"@pulumi/kubernetes"</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> azuread <span class="keyword">from</span> <span class="string">"@pulumi/azuread"</span>;</span><br></pre></td></tr></table></figure>
<p>This is what the top of you <strong>index.ts</strong> should look like. If you are doing this in VS Code, you probably have some red squiggly lines under the bottom two imports. This is where we ask NPM to go get those modules for us!</p>
<p><code>npm install @pulumi/kubernetes</code> <strong>Get kubernetes module of the SDK</strong>
<code>npm install @pulumi/azuread</code>  <strong>Get Azure ActiveDirectory module of the SDK</strong></p>
<p>Once that is done, the red squiggly lines should go away and you'll see that you can use those SDK modules in your application now.</p>
<h3>Initial Configuration Values</h3>
<p>The next part of our app initializes and exports configuration variables that we'll need for the <strong>AKS</strong> provisioning. The names for these variables are intended to be informative, but they are names that I've chosen. The values are determined by the intended usage. Azure expects some of these values to be specific, such as <strong>location</strong> or <strong>nodeSize</strong>. The <strong>nodeCount</strong> variable needs to be an int. The string <strong>const</strong> values that I export are for consistency in the same way that you would have an <strong>enum</strong> or a class containing <strong>consts</strong> values in a C# application. I believe this initial list of variables are the bare minimum you need to create a cluster. You may eventually have many more in your application.</p>
<p>This is what the configuration section will look like <em>when it is complete</em>. We will add these lines of code into the application as we work though the configuration setup so that we can <code>pulumi up</code> multiple times and see the incremental changes.</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Acquire stack configuration values and export application-defined configuration variables</span></span><br><span class="line"><span class="keyword">const</span> config = <span class="keyword">new</span> pulumi.Config();</span><br><span class="line"><span class="keyword">const</span> password = config.requireSecret(<span class="string">"password"</span>);</span><br><span class="line"><span class="keyword">const</span> sshPublicKey = config.require(<span class="string">"sshPublicKey"</span>);</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> location = config.get(<span class="string">"stackLocation"</span>) || (config.get(<span class="string">"azure:location"</span>) || <span class="string">"WestUS"</span>);</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> nodeCount = config.getNumber(<span class="string">"nodeCount"</span>) || <span class="number">2</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> nodeSize = config.get(<span class="string">"nodeSize"</span>) || <span class="string">"Standard_B2s"</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> storageClassName = <span class="string">"managed-premium"</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> resourceGroupName = <span class="string">"rg_identity_dev_zwus_aks"</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> publicIpAddressName = <span class="string">"pip_identity_dev_zwus_aks"</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> k8sDnsName = <span class="string">"identity-auth-dev"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> clientConfig = azure.core.getClientConfig();</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> subscriptionId = clientConfig.subscriptionId;</span><br></pre></td></tr></table></figure>
<h4>Pulumi Config Object</h4>
<p><code>const config = new pulumi.Config();</code></p>
<p>The first thing we do is ask the Pulumi SDK to get our stacks configuration in the form of an object of type <strong>pulumi.Config</strong>. This object lets us get configuration values (secret/non-secret) for our application, specific to this stack, from the Pulumi cloud. You're probably wondering how they got there though?</p>
<p>The Pulumi CLI has a number of methods that allow us to manage our stack configuration values. In this case, we need to get 5 different values from the cloud.</p>
<h4>Passwords and Secrets</h4>
<p>Here we get to meet another part of the Pulumi cloud infrastructure. Stacks can contain plaintext configuration information, and they can also contain secret configuration information. We can acquire this configuration information from the cloud when our application runs in order to provision our cluster. Let's work through this for a moment.</p>
<p>This password will be used for our administrative user in our <strong>AKS</strong> cluster. We probably don't want this to be saved as plaintext anywhere, so we're going to use the <strong>--secret</strong> flag when we use the Pulumi CLI to set this configuration value in our stack.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pulumi config <span class="built_in">set</span> password --secret [your-cluster-password-here] <span class="comment"># P@ssw0rd!</span></span><br></pre></td></tr></table></figure>
<p>This command tells the Pulumi CLI to set a property on our stack configuration called <strong>password</strong> to the value provided and make sure it is treated securely.</p>
<p>Since we delete all of the text, let's <code>pulumi up</code> and get that value into the cloud to see what happens.</p>
<img src="/images/dwhite/pulumi-set-config-password.png" alt="Set the admin password in the configuration" height="450px">
<blockquote>
<p>Other than the initial <strong>pulumi new azure-typescript</strong> CLI command, any changes we make to our local context wil not be available in the web portal until we use the <code>pulumi up</code> command.</p>
</blockquote>
<p>In order to access this secret from the pulumi.Config object, we add this line of code to our application.</p>
<p><code>const password = config.require(&quot;password&quot;);</code></p>
<blockquote>
<p>You can use config.requireSecret(&quot;password&quot;) to mark a variable as secret and at that point it's safe to export because it will always be encrypted/masked (in the state as well as CLI and console)</p>
</blockquote>
<h4>SSH Public Key</h4>
<p>If you'd like to be able to SSH into your linux nodes (VMs) that are in the cluster, you'll need to provide an SSH key that is provisioned into your nodes. Using a tool called <code>ssh-keygen</code> we can create an SSH key and then we can put that key into our Pulumi stack config for use anytime we create the cluster.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t rsa -f key.rsa</span><br><span class="line">pulumi config <span class="built_in">set</span> sshPublicKey &lt; key.rsa.pub</span><br></pre></td></tr></table></figure>
<p><code>ssh-keygen</code> will walk you through the process of creating an SSH key.</p>
<p>Then we will use the Pulumi config to set the sshPublicKey configuration variable on the stack. If you are running a PowerShell terminal, this won't work. PowerShell doesn't like the <strong>&lt;</strong> operator. You can get around that by using this command.</p>
<p><code>cmd.exe /c &quot;pulumi config set sshPublicKey &lt; key.rsa.pub&quot;</code></p>
<p>Now you can <code>pulumi up</code> and go take a look at your configuration in the web portal again.</p>
<p>In order to use this variable in our application, add this line of code to our application.</p>
<p><code>const sshPublicKey = config.require(&quot;sshPublicKey&quot;);</code></p>
<img src="/images/dwhite/pulumi-set-config-sshPublicKey.png" alt="Set the SSH Public Key in the configuration" height="225px">
<h4>Location, NodeCount, NodeSize</h4>
<p>Azure is going to want to know:</p>
<ol>
<li>What region to create your resources in</li>
<li>How many nodes do we want in our cluster</li>
<li>What VMs SKUs (size) do we want to use for our cluster</li>
</ol>
<p>The location configuration value is interesting!</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> stackLocation = config.get(<span class="string">"stackLocation"</span>) || (config.get(<span class="string">"azure:location"</span>) || <span class="string">"WestUS"</span>);</span><br></pre></td></tr></table></figure>
<p>In this code, we look for a configuration value called <strong>stackLocation</strong> that we can set if we want. This supports DR/HA-specific stack scenarios that I'll discuss later. If it isn't present, we can use the the default location set in the <strong>azure:location</strong> configuration value that was set for us when we created the project. You can take a look again with the Pulumi CLI command <code>pulumi config get &quot;azure:location&quot;</code> or you can look in the web portal as well. In the event that there is no configuration values, we've provided a fallback value of <strong>WestUS</strong>.</p>
<p>I love being able to use programmatic logic in my infrastructure deployments!!</p>
<blockquote>
<p><strong>az account list-locations</strong> will list supported regions for the current subscription. It will spit out a JSON blob of regions and you can use the name property. It seems that commands that take a region parameter name are case-insensitive.</p>
</blockquote>
<p>In order to create a <strong>k8s</strong> cluster, we need VMs (nodes) in the cluster. We can configure how big we want cluster to be and store that data in the stack configuration. Our fallback value is <strong>2</strong>.</p>
<p><code>pulumi config set nodeCount 2</code></p>
<blockquote>
<p>A <strong>k8</strong> cluster only needs 1 node to operate. This is certainly sufficient for dev contexts, but you probably want 3+ nodes in production.</p>
</blockquote>
<p>Add <code>export const nodeCount = config.getNumber(&quot;nodeCount&quot;) || 2;</code> to the application.</p>
<p>Azure also needs to know what SKU our nodes (VMs) should be.</p>
<blockquote>
<p><code>az vm list-skus</code> is the azure-cli command that will list out all of the SKUs you can pick from but it spews an enormous JSON blob that lists them all and their capabilities. You're probably better off visiting <a href="https://azure.microsoft.com/en-us/pricing/details/virtual-machines/linux/" target="_blank" rel="noopener">here</a> to help you decide what SKU to use.</p>
</blockquote>
<p><code>pulumi config set nodeSize Standard_B2s</code></p>
<p>Add <code>export const nodeSize = config.get(&quot;nodeSize&quot;) || &quot;Standard_B2s&quot;;</code> to the application.</p>
<p>Again, we provided a fallback value in the application.</p>
<p><code>pulumi up</code> and look at the configuration values in the web portal.</p>
<img src="/images/dwhite/pulumi-set-config-done.png" alt="All Configurations Set" height="350px">
<h4>Exports From Your Application</h4>
<p>Finally, we want to provide some <strong>const</strong> values that will be available in the stack, displayed in the web portal, and also available to any other stack that belongs to the Pulumi organization.</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> storageClassName = <span class="string">"managed-premium"</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> resourceGroupName = <span class="string">"rg_identity_dev_zncu_aks"</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> publicIpAddressName = <span class="string">"pip_identity_dev_zncu_aks"</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> k8sDnsName = <span class="string">"identity-auth-dev"</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> acrSecretName = <span class="string">"docker-credentials"</span>;</span><br></pre></td></tr></table></figure>
<p><code>pulumi up</code> and you'll see all the rest of our configuration values in the web portal. Exports are shown in a different group in the web portal. The are considered <strong>outputs</strong> of the stack.</p>
<img src="/images/dwhite/pulumi-set-config-outputs.png" alt="Outputs from the application" height="400px">
<blockquote>
<p>You should recognize when you export a value that you will get a value in the <strong>outputs</strong> section of the web portal and it also be in the <strong>config</strong>. You don't have to export <code>const</code> values if you want to avoid that confusion.</p>
</blockquote>
<h4>Getting the Azure Subscription Id</h4>
<p>We need one more value for our application and that is the <strong>subscriptionId</strong>. In this case, we could use the <code>pulumi config set</code> command to manually set it, but we can get the subscription from the Azure context that we are already connected to. This is exposed via an SDK component.</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// getClientConfig is an async call, so wrap in pulumi.output</span></span><br><span class="line"><span class="keyword">const</span> clientConfig = pulumi.output(azure.core.getClientConfig());</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> subscriptionId = clientConfig.subscriptionId;</span><br></pre></td></tr></table></figure>
<h2>Add AKS resources to Azure</h2>
<p>Now that we have the basic configuration values that are required for our <strong>AKS</strong> cluster resources, we can start to add them into our Pulumi application.</p>
<blockquote>
<p>After each section, you can <code>pulumi up</code> and see what happens. When you are done that increment, you can <code>pulumi destroy</code> to clean up the resources.</p>
</blockquote>
<h4>A Pre-Defined ResourceGroup</h4>
<p>While Pulumi is quite capable of building a ResourceGroup from scratch, you may want to use one that already exists in your Azure subscription. Financial reporting, permissions, operational activities, etc may be leveraging ResourceGroups in this way. For this example, we are going to use a pre-existing ResourceGroup. This code is also the reason that we acquired the <strong>subscriptionId</strong> and set the <strong>resourceGroupName</strong> in our configuration section.</p>
<p>You will need to create this ResourceGroup in Azure via the <strong>azure-cli</strong> or in the Azure Portal. The `azure-cli command is</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># this resourceGroupName matches our const value in the config section</span></span><br><span class="line">az group create -<span class="literal">-location</span> WestUs -<span class="literal">-name</span> rg_identity_dev_zwus_aks</span><br></pre></td></tr></table></figure>
<p>Here is the code to get the resourceGroup object for using in the application code.</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// get the Azure Resource Group</span></span><br><span class="line"><span class="keyword">var</span> resouceGroupId = pulumi.interpolate <span class="string">`/subscriptions/<span class="subst">$&#123;subscriptionId&#125;</span>/resourceGroups/<span class="subst">$&#123;resourceGroupName&#125;</span>`</span>;</span><br><span class="line"><span class="keyword">const</span> resourceGroup = azure.core.ResourceGroup.get(resourceGroupName, resouceGroupId);</span><br></pre></td></tr></table></figure>
<blockquote>
<p>TypeScript <strong>string interpolation</strong> doesn't work very good with Pulumi Output<T> objects. You need to use the <strong>pulumi.interpolate</strong> syntax to create strings from Output<T></p>
</blockquote>
<h4>Creating an Azure Service Principal</h4>
<p>Your new <strong>AKS</strong> service instance is going to need to be able to create a lot of Azure resources. It will do all of this for you, but in order to create these resources, it will need to log in as a Service Principal that you've created in your subscription. The first thing we'll do is get our application to create that Service Principal.</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Original example: https://github.com/pulumi/examples/blob/master/azure-ts-aks-helm/README.md</span></span><br><span class="line"><span class="comment">// Create an Azure AD Application</span></span><br><span class="line"><span class="keyword">const</span> adApp = <span class="keyword">new</span> azuread.Application(<span class="string">"aksSSO"</span>);</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> adAppId = adApp.applicationId;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Create an Azure Service Principal for that application</span></span><br><span class="line"><span class="keyword">const</span> adSp = <span class="keyword">new</span> azuread.ServicePrincipal(<span class="string">"aksSSOSp"</span>, &#123; applicationId: adApp.applicationId &#125;);</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> adSpId = adSp.id;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Assign the password from our configuration values to the Service Principal</span></span><br><span class="line"><span class="keyword">const</span> adSpPassword:<span class="built_in">any</span> = <span class="keyword">new</span> azuread.ServicePrincipalPassword(<span class="string">"aksSpPassword"</span>, &#123;</span><br><span class="line">    servicePrincipalId: adSpId,</span><br><span class="line">    value: password,</span><br><span class="line">    endDate: <span class="string">"2099-01-01T00:00:00Z"</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>We are not exporting any of these values. We won't need to see them in the Pulumi web portal or use them in any other project or stack. You can see this application and Service Principal in the AAD that your subscription is connected to.</p>
<blockquote>
<p>Creating an AAD Service Principal sometimes takes a bit of time. Operations that depend on the SP being created (the AKS Service creation code) may fail until the SP is finished being created. If this happens, simply <code>pulumi up</code> again.</p>
</blockquote>
<h4>Storage Account for Database backups</h4>
<p>Our business problem requires a database and a good thing to do once in a while is backup that database and put those backups somewhere. For this activity, we are creating an Azure Storage Account, in our <strong>AKS</strong> specific resource group, that we will use as a volume in the pgAdmin4 pod.</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Create storage account for Azure Files</span></span><br><span class="line"><span class="keyword">const</span> storageAccountK8s = <span class="keyword">new</span> azure.storage.Account(<span class="string">"Identity"</span>,&#123;</span><br><span class="line">    resourceGroupName: resourceGroupName,</span><br><span class="line">    accountTier: <span class="string">"Standard"</span>,</span><br><span class="line">    accountReplicationType: <span class="string">"LRS"</span>,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> storageAccountName = storageAccountK8s.name;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> storageAccountKeyPrimary = pulumi.secret(storageAccountK8s.primaryAccessKey);</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> storageAccountKeySecondary = pulumi.secret(storageAccountK8s.secondaryAccessKey);</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> storageAccountConnectionStringPrimary = pulumi.secret(storageAccountK8s.primaryConnectionString);</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> storageAccountConnectionStringSecondary = pulumi.secret(storageAccountK8s.secondaryConnectionString);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> fileShare = <span class="keyword">new</span> azure.storage.Share(<span class="string">"k8sFileShare"</span>, &#123;</span><br><span class="line">    name: <span class="string">"k8s-file-share"</span>,</span><br><span class="line">    storageAccountName: storageAccountK8s.name,</span><br><span class="line">    quota: <span class="number">10</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> fileShareName = fileShare.name;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> fileShareUrl = fileShare.url;</span><br></pre></td></tr></table></figure>
<p>You'll notice that during the creation of the storage account, we get back the connection strings and keys which we'll need to use later on. We can use the <code>pulumi.secret()</code> method to ensure that these are treated as secrets by the Pulumi cloud infrastructure.</p>
<img src="/images/dwhite/pulumi-secrets-output.png" alt="Outputs as secrets" height="200px">
<h4>Azure Kubernetes Service</h4>
<p>We are finally going to create our <strong>Azure Kubernetes Service (AKS)</strong> instance! w00 h00!! Or I should say, we're going to code it up in Pulumi and we'll let Pulumi take care of creating it!</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Creates an AKS cluster.</span></span><br><span class="line"><span class="keyword">const</span> k8sCluster = <span class="keyword">new</span> azure.containerservice.KubernetesCluster(<span class="string">"aksCluster"</span>, &#123;</span><br><span class="line">    resourceGroupName: resourceGroupName,</span><br><span class="line">    kubernetesVersion: <span class="string">"1.17.3"</span>,</span><br><span class="line">    location: stackLocation,</span><br><span class="line">    defaultNodePool:&#123;</span><br><span class="line">        name: <span class="string">"aksagentpool"</span>,</span><br><span class="line">        nodeCount: nodeCount,</span><br><span class="line">        enableAutoScaling: <span class="literal">false</span>,</span><br><span class="line">        vmSize: nodeSize</span><br><span class="line">    &#125;,</span><br><span class="line">    dnsPrefix: k8sDnsName,</span><br><span class="line">    linuxProfile: &#123;</span><br><span class="line">        adminUsername: <span class="string">"aksuser"</span>,</span><br><span class="line">        sshKey: &#123; keyData: sshPublicKey &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    servicePrincipal: &#123;</span><br><span class="line">        clientId: adAppId,</span><br><span class="line">        clientSecret: password,</span><br><span class="line">    &#125;,</span><br><span class="line"><span class="comment">/* This is commented out because we do not want to do this. Please see my</span></span><br><span class="line"><span class="comment">   blurb about LogAnalytics at the bottom of this post.</span></span><br><span class="line"><span class="comment">    addonProfile: &#123;</span></span><br><span class="line"><span class="comment">        omsAgent: &#123;</span></span><br><span class="line"><span class="comment">            enabled: true,</span></span><br><span class="line"><span class="comment">            logAnalyticsWorkspaceId: loganalytics.id,</span></span><br><span class="line"><span class="comment">        &#125;,</span></span><br><span class="line"><span class="comment">    &#125; */</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> nodeResourceGroup = k8sCluster.nodeResourceGroup;</span><br></pre></td></tr></table></figure>
<p>This is a pretty simple pulumi declaration given everything it took to get here. You'll notice the following parameters are mostly using our configuration. This is important when we add additional stacks (deployment target environments):</p>
<ul>
<li>resourceGroupName</li>
<li>kubernetesVersion: &quot;1.17.3&quot;
<ul>
<li>you can only use kubernetes versions supported by Azure. This is the most recent at the time of writing</li>
</ul>
</li>
<li>location</li>
<li>nodeCount</li>
<li>vmSize</li>
<li>dnsPrefix</li>
<li>sshKey</li>
<li>servicePrincpal
<ul>
<li>generated during creation</li>
</ul>
</li>
</ul>
<p>One of the things that does happen when Azure creates this <strong>AKS</strong> instance is that the cluster will use the Service Principal to create all of the resources and that all of the cluster resources will be placed in a in an auto-generated ResourceGroup. I haven't discovered to how to alter this behaviour. The name of the resource group that you create the <strong>AKS</strong> service in will be a component of this auto-generated ResourceGroup's name.</p>
<blockquote>
<p>If you <code>pulumi up</code> after this section be aware that creating a cluster takes time and requires the Service Principal to exist as well. <code>pulumi destroy</code> also takes a few minutes to run when an <strong>AKS</strong> instance is involved.</p>
</blockquote>
<h4>Interacting with Kubernetes in our Cluster</h4>
<p>Now that we have an <strong>k8s</strong> cluster running, we need to start interacting with the cluster and not Azure. In order to do that, we need a Pulumi object that is comparable to <code>kubectl</code>. In Pulumi, this is the <strong>k8s.Provider</strong> object.</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Expose a k8s provider instance using our custom cluster instance.</span></span><br><span class="line"><span class="keyword">const</span> k8sProvider = <span class="keyword">new</span> k8s.Provider(<span class="string">"aksK8s"</span>, &#123;</span><br><span class="line">    kubeconfig: k8sCluster.kubeConfigRaw,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// put our new clusterName in Pulumi service</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> clusterName = k8sCluster.name;</span><br><span class="line"><span class="comment">// put the az aks get-credentials command in Pulumi service</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> kubeCtrlCredentialsCommand = pulumi.interpolate <span class="string">`az aks get-credentials --resource-group <span class="subst">$&#123;resourceGroupName&#125;</span> --name <span class="subst">$&#123;clusterName&#125;</span> --context "MyProject.Identity"`</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Export the kubeConfig</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> kubeConfig = pulumi.secret(k8sCluster.kubeConfigRaw);</span><br></pre></td></tr></table></figure>
<p>In this code, you can see that we create a k8s.Provider instance using the kubeConfig that we can get from our <strong>AKS</strong> cluster instance. We also want to export that kubeConfig so that we can use it in our next Pulumi application that will create all of the <strong>k8s</strong> resources in the cluster. Remember, the kubeConfig is credentials to get into your cluster, so you should treat it as a very important <strong>secret</strong>.</p>
<p>I've also exported the new clusterName and a helper output value of the <code>az aks get-credentials</code> command that will help you put your new <strong>k8s</strong> credentials in your local kubeConfig file.</p>
<p>We will use the <strong>k8sProvider</strong> object in the remainder of this script to interact with our <strong>k8s</strong> cluster.</p>
<h4>Kubernetes Secrets</h4>
<p>The finish our basic <strong>AKS</strong> deployment, I am going to install a couple secrets that our <strong>k8s</strong> cluster will need to operate.</p>
<p>For our Azure Container Registry secrets, we need to get the ACR instance, ask it for it's secrets, and put them into <strong>k8s</strong>. This is the safest way to manage these secrets since we don't want them in our code base.</p>
<blockquote>
<p>Please treat these and all other secrets with all due care.</p>
</blockquote>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> acrInstanceName = <span class="string">"depthconsulting"</span>;</span><br><span class="line"><span class="keyword">const</span> acrIdentifier:<span class="built_in">string</span> =  <span class="string">"/subscriptions/&lt;your subscriptionId&gt;/resourceGroups/&lt;your resourceGroup&gt;/providers/Microsoft.ContainerRegistry/registries/&lt;your RegistryName&gt;"</span>;</span><br><span class="line"><span class="keyword">const</span> privateACRInstance = azure.containerservice.Registry.get(acrInstanceName, myAcrIdentifier);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> k8sDockerSecret = helpers.createImagePullSecret(</span><br><span class="line">    acrSecretName, <span class="comment">// secret name</span></span><br><span class="line">    privateACRInstance.adminUsername,</span><br><span class="line">    privateACRInstance.adminPassword,</span><br><span class="line">    privateACRInstance.loginServer,</span><br><span class="line">    k8sProvider);</span><br></pre></td></tr></table></figure>
<p>There is a help function that we are using that hides the complexity of this.</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createImagePullSecret</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    secretName: <span class="built_in">string</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    username: pulumi.Output&lt;<span class="built_in">string</span>&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">    password: pulumi.Output&lt;<span class="built_in">string</span>&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">    registry : pulumi.Output&lt;<span class="built_in">string</span>&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">    k8sProvider : k8s.Provider</span>): <span class="title">k8s</span>.<span class="title">core</span>.<span class="title">v1</span>.<span class="title">Secret</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Put the username password into dockerconfigjson format.</span></span><br><span class="line">    <span class="keyword">let</span> base64JsonEncodedCredentials : pulumi.Output&lt;<span class="built_in">string</span>&gt; = </span><br><span class="line">        pulumi.all([username, password, registry])</span><br><span class="line">        .apply(<span class="function">(<span class="params">[username, password, registry]</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> base64Credentials = Buffer.from(username + <span class="string">':'</span> + password).toString(<span class="string">'base64'</span>)</span><br><span class="line">            <span class="keyword">const</span> json =  <span class="string">`&#123;"auths":&#123;"<span class="subst">$&#123;registry&#125;</span>":&#123;"auth":"<span class="subst">$&#123;base64Credentials&#125;</span>"&#125;&#125;&#125;`</span></span><br><span class="line">            <span class="built_in">console</span>.log(json)</span><br><span class="line">            <span class="keyword">return</span> Buffer.from(json).toString(<span class="string">'base64'</span>)</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> k8s.core.v1.Secret(secretName, &#123;</span><br><span class="line">        metadata: &#123;</span><br><span class="line">            name: secretName,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="keyword">type</span>: <span class="string">'kubernetes.io/dockerconfigjson'</span>,</span><br><span class="line">        data: &#123;</span><br><span class="line">            <span class="string">".dockerconfigjson"</span>: base64JsonEncodedCredentials,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;, &#123; provider: k8sProvider &#125;)</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>We will also need to create a way for our <strong>k8s</strong> cluster to connect to the various storage providers that are available to us in Azure. In this case, we want to enable <strong>k8s</strong> to connect to the file storage we are going to use for our database backups. This uses some of the variables that we captured when creating our Storage Account as well as a helper function.</p>
<p><a href="https://docs.microsoft.com/en-us/azure/aks/azure-files-volume" target="_blank" rel="noopener">Microsoft Documentation</a></p>
<p>This is the <strong>kubectl</strong> command that would create this secret.</p>
<p><code>kubectl create secret generic azure-secret --from-literal=azurestorageaccountname=$AKS_PERS_STORAGE_ACCOUNT_NAME --from-literal=azurestorageaccountkey=$STORAGE_KEY</code></p>
<p>Now we convert that into a TypeScript function.</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> azureStorageSecret = helpers.createAzureFileSecret(</span><br><span class="line">    azureStorageSecretName,</span><br><span class="line">    storageAccountName,</span><br><span class="line">    storageAccountKeyPrimary,</span><br><span class="line">    k8sProvider);</span><br></pre></td></tr></table></figure>
<p>Here is a helper function that will create the secret properly for us.</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createAzureFileSecret</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    secretName: <span class="built_in">string</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    storageAccountName: pulumi.Output&lt;<span class="built_in">string</span>&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">    storageAccountKey: pulumi.Output&lt;<span class="built_in">string</span>&gt;, </span></span></span><br><span class="line"><span class="function"><span class="params">    k8sProvider : k8s.Provider</span>): <span class="title">k8s</span>.<span class="title">core</span>.<span class="title">v1</span>.<span class="title">Secret</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> dataValue = pulumi</span><br><span class="line">        .all([storageAccountName, storageAccountKey])</span><br><span class="line">        .apply(<span class="function">(<span class="params">[san,sak]</span>) =&gt;</span>&#123;</span><br><span class="line">            <span class="keyword">const</span> b64SAN = Buffer.from(san).toString(<span class="string">'base64'</span>);</span><br><span class="line">            <span class="keyword">const</span> b64SAK = Buffer.from(sak).toString(<span class="string">'base64'</span>);</span><br><span class="line">            <span class="keyword">return</span> &#123; azurestorageaccountname: b64SAN, azurestorageaccountkey: b64SAK &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> k8s.core.v1.Secret(secretName, &#123;</span><br><span class="line">        <span class="keyword">type</span>: <span class="string">"kubernetes.io/generic"</span>,</span><br><span class="line">        metadata: &#123;</span><br><span class="line">            name: secretName,</span><br><span class="line">            <span class="keyword">namespace</span>: <span class="string">"default"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        data: dataValue</span><br><span class="line">    &#125;,&#123;provider: k8sProvider&#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>I'll eventually make this a more generic mechanism for creating secrets.</p>
</blockquote>
<h3>Our Full AKS Application</h3>
<p>We have now completed our whole Pulumi application that will stand up a basic <strong>AKS</strong> cluster in Azure. Here is the entire script for completeness.</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> azure <span class="keyword">from</span> <span class="string">"@pulumi/azure"</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> pulumi <span class="keyword">from</span> <span class="string">"@pulumi/pulumi"</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> k8s <span class="keyword">from</span> <span class="string">"@pulumi/kubernetes"</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> azuread <span class="keyword">from</span> <span class="string">"@pulumi/azuread"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Import some stack configuration and export used configuration variables for the AKS stack.</span></span><br><span class="line"><span class="keyword">const</span> config = <span class="keyword">new</span> pulumi.Config();</span><br><span class="line"><span class="keyword">const</span> password = config.requireSecret(<span class="string">"password"</span>);</span><br><span class="line"><span class="keyword">const</span> sshPublicKey = config.require(<span class="string">"sshPublicKey"</span>);</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> stackLocation = config.get(<span class="string">"stackLocation"</span>) || (config.get(<span class="string">"azure:location"</span>) || <span class="string">"WestUS"</span>);</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> nodeCount = config.getNumber(<span class="string">"nodeCount"</span>) || <span class="number">2</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> nodeSize = config.get(<span class="string">"nodeSize"</span>) || <span class="string">"Standard_B2s"</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> storageClassName = <span class="string">"managed-premium"</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> resourceGroupName = <span class="string">"rg_identity_dev_zwus_aks"</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> publicIpAddressName = <span class="string">"pip_identity_dev_zwus_aks"</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> k8sDnsName = <span class="string">"identity-auth-dev"</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> acrSecretName = <span class="string">"docker-credentials"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> clientConfig = pulumi.output(azure.core.getClientConfig());</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> subscriptionId = clientConfig.subscriptionId;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Get reference to pre-existing Azure ResourceGroup</span></span><br><span class="line"><span class="comment">// get the Azure Resource Group</span></span><br><span class="line"><span class="keyword">var</span> resouceGroupId:pulumi.Output&lt;<span class="built_in">string</span>&gt; = pulumi.interpolate <span class="string">`/subscriptions/<span class="subst">$&#123;subscriptionId&#125;</span>/resourceGroups/<span class="subst">$&#123;resourceGroupName&#125;</span>`</span>;</span><br><span class="line"><span class="keyword">const</span> resourceGroup = azure.core.ResourceGroup.get(resourceGroupName, resouceGroupId);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Create AAD Application and Service Principal for AKS Cluster to use to create resources in the subscription</span></span><br><span class="line"><span class="comment">// https://github.com/pulumi/examples/blob/master/azure-ts-aks-helm/README.md</span></span><br><span class="line"><span class="comment">// Create the AD service principal for the k8s cluster.</span></span><br><span class="line"><span class="keyword">const</span> adApp = <span class="keyword">new</span> azuread.Application(<span class="string">"aksSSO"</span>);</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> adAppId = adApp.applicationId;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> adSp = <span class="keyword">new</span> azuread.ServicePrincipal(<span class="string">"aksSSOSp"</span>, &#123; applicationId: adApp.applicationId &#125;);</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> adSpId = adSp.id;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> adSpPassword:<span class="built_in">any</span> = <span class="keyword">new</span> azuread.ServicePrincipalPassword(<span class="string">"aksSpPassword"</span>, &#123;</span><br><span class="line">    servicePrincipalId: adSpId,</span><br><span class="line">    value: password,</span><br><span class="line">    endDate: <span class="string">"2099-01-01T00:00:00Z"</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Create storage account for Azure Files</span></span><br><span class="line"><span class="keyword">const</span> storageAccountK8s = <span class="keyword">new</span> azure.storage.Account(<span class="string">"Identity"</span>,&#123;</span><br><span class="line">    resourceGroupName: resourceGroupName,</span><br><span class="line">    accountTier: <span class="string">"Standard"</span>,</span><br><span class="line">    accountReplicationType: <span class="string">"LRS"</span>,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> storageAccountName = storageAccountK8s.name;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> storageAccountKeyPrimary = pulumi.secret(storageAccountK8s.primaryAccessKey);</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> storageAccountKeySecondary = pulumi.secret(storageAccountK8s.secondaryAccessKey);</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> storageAccountConnectionStringPrimary = pulumi.secret(storageAccountK8s.primaryConnectionString);</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> storageAccountConnectionStringSecondary = pulumi.secret(storageAccountK8s.secondaryConnectionString);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> fileShare = <span class="keyword">new</span> azure.storage.Share(<span class="string">"k8sFileShare"</span>, &#123;</span><br><span class="line">    name: <span class="string">"k8s-file-share"</span>,</span><br><span class="line">    storageAccountName: storageAccountK8s.name,</span><br><span class="line">    quota: <span class="number">10</span></span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> fileShareName = fileShare.name;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> fileShareUrl = pulumi.secret(fileShare.url);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Create AKS Cluster</span></span><br><span class="line"><span class="keyword">const</span> k8sCluster = <span class="keyword">new</span> azure.containerservice.KubernetesCluster(<span class="string">"aksCluster"</span>, &#123;</span><br><span class="line">    resourceGroupName: resourceGroupName,</span><br><span class="line">    kubernetesVersion: <span class="string">"1.17.3"</span>,</span><br><span class="line">    location: stackLocation,</span><br><span class="line">    defaultNodePool:&#123;</span><br><span class="line">        name: <span class="string">"aksagentpool"</span>,</span><br><span class="line">        nodeCount: nodeCount,</span><br><span class="line">        enableAutoScaling: <span class="literal">false</span>,</span><br><span class="line">        vmSize: nodeSize</span><br><span class="line">    &#125;,</span><br><span class="line">    dnsPrefix: k8sDnsName,</span><br><span class="line">    linuxProfile: &#123;</span><br><span class="line">        adminUsername: <span class="string">"aksuser"</span>,</span><br><span class="line">        sshKey: &#123; keyData: sshPublicKey &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    servicePrincipal: &#123;</span><br><span class="line">        clientId: adAppId,</span><br><span class="line">        clientSecret: password,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Expose a k8s provider instance using our custom cluster instance.</span></span><br><span class="line"><span class="keyword">const</span> k8sProvider = <span class="keyword">new</span> k8s.Provider(<span class="string">"aksK8s"</span>, &#123;</span><br><span class="line">    kubeconfig: k8sCluster.kubeConfigRaw,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// put our new clusterName in Pulumi service</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> clusterName = k8sCluster.name;</span><br><span class="line"><span class="comment">// put the az aks get-credentials command in Pulumi service</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> kubeCtrlCredentialsCommand = pulumi.interpolate <span class="string">`az aks get-credentials --resource-group <span class="subst">$&#123;resourceGroupName&#125;</span> --name <span class="subst">$&#123;clusterName&#125;</span> --context "MyProject.Identity"`</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Export the kubeConfig as a secret</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> kubeConfig = pulumi.secret(k8sCluster.kubeConfigRaw);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Create secrets in **k8s** cluster to allow certain operations</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Docker Registry credentials</span></span><br><span class="line"><span class="keyword">const</span> acrInstanceName = <span class="string">"&lt;your ACR name here&gt;"</span>;</span><br><span class="line"><span class="comment">//const acrIdentifier = config.requireSecret("acrIdentifier");</span></span><br><span class="line"><span class="keyword">const</span> acrIdentifier:<span class="built_in">string</span> =  <span class="string">"/&lt;your ACR ID (uri) here&gt;"</span>;</span><br><span class="line"><span class="keyword">let</span> myAcrIdentifier = pulumi.output(acrIdentifier);</span><br><span class="line"><span class="keyword">const</span> privateACRInstance = azure.containerservice.Registry.get(acrInstanceName, myAcrIdentifier);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> k8sDockerSecret = helpers.createImagePullSecret(</span><br><span class="line">    <span class="string">"docker-credentials"</span>,</span><br><span class="line">    privateACRInstance.adminUsername,</span><br><span class="line">    privateACRInstance.adminPassword,</span><br><span class="line">    privateACRInstance.loginServer,</span><br><span class="line">    k8sProvider);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// Azure Storage Account Credentials</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> azureStorageSecretName = <span class="string">"azure-storage-secret"</span>;</span><br><span class="line"><span class="keyword">const</span> azureStorageSecret = <span class="keyword">new</span> k8s.core.v1.Secret(azureStorageSecretName, &#123;</span><br><span class="line">    <span class="keyword">type</span>: <span class="string">"kubernetes.io/generic"</span>,</span><br><span class="line">    metadata: &#123;</span><br><span class="line">        name: azureStorageSecretName,</span><br><span class="line">        <span class="keyword">namespace</span>: <span class="string">"default"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    data:&#123;</span><br><span class="line">        azurestorageaccountname: storageAccountName,</span><br><span class="line">        azurestorageaccountkey: storageAccountK8s.primaryAccessKey</span><br><span class="line">    &#125;</span><br><span class="line">&#125;,&#123;provider: k8sProvider&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createImagePullSecret</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    secretName: <span class="built_in">string</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    username: pulumi.Output&lt;<span class="built_in">string</span>&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">    password: pulumi.Output&lt;<span class="built_in">string</span>&gt;, </span></span></span><br><span class="line"><span class="function"><span class="params">    registry : pulumi.Output&lt;<span class="built_in">string</span>&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">    k8sProvider : k8s.Provider</span>): <span class="title">k8s</span>.<span class="title">core</span>.<span class="title">v1</span>.<span class="title">Secret</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Put the username password into dockerconfigjson format.</span></span><br><span class="line">    <span class="keyword">let</span> base64JsonEncodedCredentials : pulumi.Output&lt;<span class="built_in">string</span>&gt; = </span><br><span class="line">        pulumi.all([username, password, registry])</span><br><span class="line">        .apply(<span class="function">(<span class="params">[username, password, registry]</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> base64Credentials = Buffer.from(username + <span class="string">':'</span> + password).toString(<span class="string">'base64'</span>);</span><br><span class="line">            <span class="keyword">const</span> json =  <span class="string">`&#123;"auths":&#123;"<span class="subst">$&#123;registry&#125;</span>":&#123;"auth":"<span class="subst">$&#123;base64Credentials&#125;</span>"&#125;&#125;&#125;`</span>;</span><br><span class="line">            <span class="built_in">console</span>.log(json);</span><br><span class="line">            <span class="keyword">return</span> Buffer.from(json).toString(<span class="string">'base64'</span>);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> k8s.core.v1.Secret(secretName, &#123;</span><br><span class="line">        metadata: &#123;</span><br><span class="line">            name: secretName,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="keyword">type</span>: <span class="string">'kubernetes.io/dockerconfigjson'</span>,</span><br><span class="line">        data: &#123;</span><br><span class="line">            <span class="string">".dockerconfigjson"</span>: base64JsonEncodedCredentials,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;, &#123; provider: k8sProvider &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>A last <code>pulumi up</code> and you should have your <strong>AKS</strong> cluster completely provisioned in your Azure subscription.</p>
<h2>Creating a Production Stack</h2>
<p>One of the things about using a Pulumi application with multiple stacks is that each stack holds environment-specific configuration, so we can re-use our application for different environments via stacks. You will probably create your <strong>dev</strong> and <strong>prod</strong> stacks, but you could also manage your <strong>Disaster Recover(DR)</strong> or <strong>High-Availability (HA)</strong> (different region) as stacks as well.</p>
<p>In this case, we're going to use the Pulumi CLI <a href="https://www.pulumi.com/docs/intro/concepts/stack/" target="_blank" rel="noopener">to create a prod stack</a> for our <strong>k8s</strong> infrastructure. To create a new stack, the command is:</p>
<p><code>pulumi stack init prod</code></p>
<p>We can list all available stacks in a project using:</p>
<p><code>pulumi stack ls</code> and selecting a different stack is <code>pulumi stack select &lt;stack-name&gt;</code></p>
<p>Once our production stack is created, we can set all of the <code>pulumi config</code> variables that are required for the stack to operate and voila! We can create a <strong>prod</strong> deployment of our <strong>AKS</strong> infrastructure that should look exactly like our <strong>dev</strong> stack infrastructure.</p>
<h2>Summary</h2>
<p>This has been a very long post! I hope you've been able to successfully deploy your <strong>AKS</strong> instance. We will need it for the next article in this series where we put our resources into that <strong>k8s</strong> cluster!</p>
<h2>A Note about Log Analytics</h2>
<p>In your research about <strong>AKS</strong> you will probably come across examples that show attaching Log Analytics instances to your <strong>AKS</strong> cluster.</p>
<p>I did this and a week or so later, I was looking at costs in my Azure subscription and I saw that our <strong>AKS</strong> resource group had cost way more than I expected! Digging into the reasons, I found that Log Analytics actually cost <strong>more</strong> than our <strong>AKS</strong> VM resources! I immediately turned it off. Log Analytics is too expensive for us at this point in time. Perhaps when you have a large Kubernetes installation it is worth it, but right now, our Log Analytics bill couldn't be justified!</p>
<p>When I was turning it off, I wanted to make sure that we removed all traces of it from our subscription and the <strong>AKS</strong> cluster. First, I deleted the Log Analytics components in Azure. The cluster still worked! Great! Stop the billing and keep everything working. Then I wanted to clean out all of the <code>omsagents</code> from the cluster, but those pods/deployments/services are impossible to remove from the AKS Cluster. I'm guessing that something on the outside that is managing the cluster is watching them and putting them in there all the time. I had to do something else, which lead me to this document.</p>
<p><a href="https://docs.microsoft.com/en-us/azure/azure-monitor/insights/container-insights-optout" target="_blank" rel="noopener">Link to Microsoft Documents</a></p>
<p>For the time being, because I have a lot of internal logging happening in the cluster and I don't want to spend more money on monitoring than the cluster itself, I'll just leave it off and recommend that you start without it.</p>
<p>If you do want Log Analytics in your <strong>AKS</strong> cluster, you can add this code into your application...</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Setup log analytics for k8s</span></span><br><span class="line"><span class="keyword">const</span> loganalytics = <span class="keyword">new</span> azure.operationalinsights.AnalyticsWorkspace(<span class="string">"aksloganalytics"</span>, &#123;</span><br><span class="line">    resourceGroupName: resourceGroupName,</span><br><span class="line">    location: location,</span><br><span class="line">    sku: <span class="string">"PerGB2018"</span>,</span><br><span class="line">    retentionInDays: <span class="number">30</span>,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>... and un-comment out these JSON parameters in the <strong>AKS</strong> cluster creation method.</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* This is commented out because we do not want to do this. Please see my</span></span><br><span class="line"><span class="comment">   blurb about LogAnalytics at the bottom of this post.</span></span><br><span class="line"><span class="comment">    addonProfile: &#123;</span></span><br><span class="line"><span class="comment">        omsAgent: &#123;</span></span><br><span class="line"><span class="comment">            enabled: true,</span></span><br><span class="line"><span class="comment">            logAnalyticsWorkspaceId: loganalytics.id,</span></span><br><span class="line"><span class="comment">        &#125;,</span></span><br><span class="line"><span class="comment">    &#125; */</span></span><br></pre></td></tr></table></figure>
<p><strong>Next up:</strong>
<a href="/kubernetes/kubernetes-my-journey-part-7b">Moving to Azure Kubernetes Service - Part B</a></p>
<style>
    h1, h2, h3, h4, h5, h6 {
       margin-top: 25px;
    }

    img {
       margin: 25px 0px;
    }
    figure.highlight{
        background-color: #E8EEFE;
    }
    figure.highlight .gutter{
        color: #0033CD;
    }
    figure.highlight pre {
        font-family: 'Cascadia Code PL', monospace;
    }
    code {
        font-family: 'Cascadia Code PL', sans-serif;
        border-width: 0.1em;
        border-color: #E8EEFE;
        border-style: solid;
        border-radius: 0.3em;
        background-color: #E8EEFE;
        color: #0033CD;
        padding: 0em 0.4em;
        white-space: nowrap;
    }
</style>
<link  href="https://cdnjs.cloudflare.com/ajax/libs/viewerjs/1.5.0/viewer.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/viewerjs/1.5.0/viewer.min.js"></script>
<script>
// View an image
const gallery = new Viewer(document.getElementById('mainPostContent', {
    "navbar": false,
    "toolbar": false
}));
</script>
	        </div>

            
            <section id="comments">
            <div id="disqus_thread">
                <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript" target="_blank" rel="noopener">comments powered by Disqus.</a></noscript>
            </div>
            </section>
            
		</div>
	</div>
<!--MAIN CONTENT ENDS-->

<!--SIDEBAR CONTENT STARTS-->
	<div class="SubpageBoxSubSm">
		<div class="SubpageBoxSubSmContent">
			
			

			<div class="ProfileImg">
				
				<a href="/bios/dave_white">
				
					<img src='https://www.gravatar.com/avatar/4b7708d2ae7f7bb866446e0459e3e156?s=200' />
				
				</a>
				
			</div>

			<BR clear="all">

			<h2><a href="/bios/dave_white">Dave White</a></h2>
			
			<a href="mailto:dmhwhite@gmail.com"><img class="ProfileIcon" src="/images/icon_email.png" border="0" alt="Email" title="Email"> Email</a><BR>
			
			
			<a href="http://agileramblings.com/" target="_blank"><img class="ProfileIcon" src="/images/icon_web.png" border="0" alt="Web" title="Web"> Web</a><BR>
			
			
			<a href="http://twitter.com/AgileRamblings" target="_blank"><img class="ProfileIcon" src="/images/icon_twitter.png" border="0" alt="Twitter" title="Twitter"> Twitter</a><BR>
			
			
			<a href="https://github.com/agileramblings" target="_blank"><img class="ProfileIcon" src="/images/icon_github.png" border="0" alt="GitHub" title="GitHub"> GitHub</a><br>
			
			
			<a href="https://www.linkedin.com/in/dave-white" target="_blank"><img class="ProfileIcon" src="/images/icon_linkedin.png" border="0" alt="LinkedIN" title="LinkedIN"> LinkedIn</a><br>
			
			
 			<a href="/feeds/dave_white.xml"><img class="ProfileIcon" src="/images/icon_subscribe.png" /> RSS</a>
			

			<hr />
			<h4>Looking for someone else?</h4>
			<p>You can find the rest of the Western Devs Crew <a href="/whoweare">here</a>.</p>
		</div>
	</div>
<!--SIDEBAR CONTENT ENDS-->


</div>
</center>
<!--PAGE CONTENT ENDS-->


<!--FOOTER STARTS-->
<center>
  <div class="FooterBarTxt">&copy; 2015 Western Devs. All Rights Reserved. Design by <a href="http://www.karenchudobiak.ca" target="_blank">Karen Chudobiak, Graphic Designer</a></div>
</center>
<!--FOOTER ENDS-->

<!-- NAV FOOTER STARTS -->
<div class="NavFooter">
  <a href="/posts" alt="Posts"><i class="fa fa-newspaper-o fa-2x"></i><span>Posts</span></a>
  <a href="/podcasts" alt="Podcasts"><i class="fa fa-volume-up fa-2x"></i><span>Podcasts</span></a>
  <a href="/whoweare" alt="About"><i class="fa fa-star fa-2x"></i><span>About</span></a>
  <a href="/whatwevedone" alt="What We've Done"><i class="fa fa-trophy fa-2x"></i><span>Work</span></a>
  <a href="/speaking" alt="Speaking"><i class="fa fa-comment-o fa-2x fa-flip-horizontal"></i><span>Speaking</span></a>
</div>
<!-- NAV FOOTER ENDS -->




</div>
<!--WRAPPER ENDS-->


<script>
  var disqus_shortname = 'westerndevs';
  
  var disqus_url = 'https://westerndevs.com/kubernetes/kubernetes-my-journey-part-7a/'.replace(".com//", ".com/");
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
  
function shuffle(array) {
  var currentIndex = array.length, temporaryValue, randomIndex;

  // While there remain elements to shuffle...
  while (0 !== currentIndex) {

    // Pick a remaining element...
    randomIndex = Math.floor(Math.random() * currentIndex);
    currentIndex -= 1;

    // And swap it with the current element.
    temporaryValue = array[currentIndex];
    array[currentIndex] = array[randomIndex];
    array[randomIndex] = temporaryValue;
  }

  return array;
}

</script>


</body>

  
<!-- Google Analytics -->
<script type="text/javascript">
if (document.location.hostname.search("westerndevs.com") !== -1 || document.location.hostname.search("www.westerndevs.com") !== -1) {
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-37617956-2', 'auto');

ga('set', 'contentGroup1', 'dave_white');

ga('send', 'pageview');
}
</script>
<!-- End Google Analytics -->



</html>
