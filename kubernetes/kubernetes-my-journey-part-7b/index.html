<!DOCTYPE html>
<html lang="en" xml:lang="en">

  <head>
  
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>Kubernetes - My Journey - Part 7b | Western Devs</title>
  <meta name="description" content="Series Table of Contents Previously: Moving to Azure Kubernetes Service - Part A Moving to Azure Kubernetes Service - Part B We&#39;re really making some progress! We should have our AKS cluster running n">
<meta property="og:type" content="article">
<meta property="og:title" content="Kubernetes - My Journey - Part 7b">
<meta property="og:url" content="https://westerndevs.com/kubernetes/kubernetes-my-journey-part-7b/index.html">
<meta property="og:site_name" content="Western Devs">
<meta property="og:description" content="Series Table of Contents Previously: Moving to Azure Kubernetes Service - Part A Moving to Azure Kubernetes Service - Part B We&#39;re really making some progress! We should have our AKS cluster running n">
<meta property="og:image" content="https://westerndevs.com/images/dwhite/octant-azure-pods-running.png">
<meta property="og:image" content="https://westerndevs.com/images/dwhite/octant-azure-pgadmin-portforward.png">
<meta property="og:image" content="https://westerndevs.com/images/dwhite/octant-azure-pgadmin-portforward-started.png">
<meta property="og:image" content="https://westerndevs.com/images/dwhite/octant-azure-pgadmin-running.png">
<meta property="og:image" content="https://westerndevs.com/images/dwhite/octant-azure-pgadmin-log.png">
<meta property="og:image" content="https://westerndevs.com/images/dwhite/octant-azure-pgadmin-terminal.png">
<meta property="article:published_time" content="2020-05-22T08:00:00.000Z">
<meta property="article:modified_time" content="2023-08-17T21:50:48.998Z">
<meta property="article:author" content="Western Devs">
<meta property="article:tag" content="kubernetes, azure, aks, identityserver, docker, containers">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://westerndevs.com/images/dwhite/octant-azure-pods-running.png">
<meta name="twitter:creator" content="@westerndevs">

    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="title" content="WesternDevs">   
    <meta name="keywords" content="software development,software,asp.net,blog">
    <meta name="description" content="We're all west of somewhere">
    <meta name="copyright" content="WesternDevs">
    <meta name="revisit-after" content="15 days">
    <meta name="robots" content="all">
    <meta name="MSSmartTagsPreventParsing" content="true">
  
  
    <link rel="alternate" href="/feed.xml" title="Western Devs" type="application/atom+xml">
  
  
<link rel="stylesheet" href="/css/style.css">

      
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <script src="//code.jquery.com/jquery-1.11.3.min.js"></script>  
  <meta name="generator" content="Hexo 4.2.1"></head>

<body>

<!-- FIXED HEADER BECAUSE SCROLLING -->
<!--HEADER STARTS-->
<div class="WrapperHeader">
<div style="display:inline-block; text-align: center;">
<div class="Header">

  <div class="HeaderLogo">
    <a href="/"><img src="/images/header_logo_transparent.png" alt="WesternDevs" title="WesternDevs" border="0" style="width: 206px; height: 64px;" width="206" height="64"></a>
  </div>

  <div class="HeaderLinks">
      <a href="/posts" class="nav">POSTS</a>       
      <a href="/podcasts" class="nav">PODCASTS</a>       
      <a href="/whoweare" class="nav">ABOUT</a>  
      <a href="/whatwevedone" class="nav">WHAT WE'VE DONE</a>  
      <a href="/speaking" class="nav">SPEAKING</a>
      <div class="HeaderIcons">
        <a href="mailto:info@westerndevs.com"><img src="/images/icon_email.png" border="0" alt="Email" title="Email" height="26" width="26"></a>
        <a href="/feed.xml"><img src="/images/icon_subscribe.png" border="0" alt="Subscribe" title="Subscribe" height="26" width="27"></a>
        <a href="http://twitter.com/westerndevs" target="_blank"><img src="/images/icon_twitter.png" border="0" alt="Twitter" title="Twitter" height="26" width="27"></a>
        <a href="http://github.com/westerndevs" target="_blank"><img src="/images/icon_github.png" border="0" alt="GitHub" title="GitHub" height="26" width="27"></a>     
      </div>
  </div>
  
</div>
</div>
</div>
<!--HEADER ENDS-->    



<!--WRAPPER STARTS-->
<div class="Wrapper" style="">

<!--SUBHEAD STARTS-->
<div class="WrapperSubHeaderSubpage">
<center>
	<div class="SubHeader">
		<H1 class="title"><img class="icon" src="/images/icon_posts.png" alt="POST" title="POST" border="0"> POST</H1>
	</div>
</center>
</div>
<!--SUBHEAD ENDS-->

<!--PAGE CONTENT STARTS-->
<center>
<div class="WrapperContent">

<!--MAIN CONTENT STARTS-->
	<div class="SubpageBoxSubLrg">
		<div class="SubpageBoxSubLrgContent">
		    <div class='postTitle'>
  <div class="ListLrgDateBG">
    <div class="ListLrgDateMonth">MAY</div>
    <div class="ListLrgDateDay">22</div>
    <div class="ListLrgDateYear">2020</div>
  </div>
  <h2>Kubernetes - My Journey - Part 7b</h2>
</div>

		    

			<div id="mainPostContent">
	        <p><a href="/kubernetes/kubernetes-my-journey">Series Table of Contents</a></p>
<p><strong>Previously:</strong>
<a href="/kubernetes/kubernetes-my-journey-part-7a">Moving to Azure Kubernetes Service - Part A</a></p>
<h1>Moving to Azure Kubernetes Service - Part B</h1>
<p>We're really making some progress! We should have our <strong>AKS</strong> cluster running now and ready for use to start putting some resources into. If you don't, head on back to the previous article in the series and get your <strong>k8s</strong> standing up in Azure!</p>
<h2>Continuing with Pulumi</h2>
<p>In the prevoius article, we used Pulumi exclusively to describe what we wanted in our <strong>AKS</strong> infrastructure and we had the Pulumi CLI do all the hard work of provisioning our <strong>k8s</strong> cluster. Now we are going to ask Pulumi to do a little more work and help us get our <strong>k8s</strong> resources into the cluster.</p>
<p>First, let's create a new Pulumi Project and Stack to hold our resource specific configuration values, application, and history.</p>
<p>Let's create a folder in our infrastructure folder for the <strong>k8s</strong> deployment stack. Starting in your <code>infra</code> folder, run the command:</p>
<p><code>mkdir k8s &amp;&amp; cd k8s</code></p>
<p>Now use the Pulumi CLI to build our new project with its initial stack.</p>
<p><code>pulumi new azure-typescript --secrets-provider=passphrase</code></p>
<p>This will kick off the workflow to acquire some details before it creates the stack. In my case, I answered the workflow questions with:</p>
<ol>
<li>project name (k8s) &lt;-- hit enter and accepted default</li>
<li>project description: <strong>Deploy our kubernetes infrastructure</strong></li>
<li>stack name: (dev) &lt;-- hit enter and accepted default</li>
<li>Enter your passphrase to protect config/secrets: <strong>P@ssw0rd!</strong></li>
<li>azure:environment: (public) &lt;-- hit enter and accept default</li>
<li>azure:location: (WestUS) <strong>WestUS</strong></li>
</ol>
<p>This will scaffold our new project and submit the project and stack details to our Pulumi cloud. Let's open VS Code, open the <strong>index.ts</strong> and delete everything from the file.</p>
<p>We are going to need to add the Pulumi kubernetes SDK module to our project.</p>
<p><code>npm install @pulumi/kubernetes</code></p>
<p>Now, at the top of our empty <strong>index.ts</strong> file, we can add the following imports.</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> pulumi <span class="keyword">from</span> <span class="string">"@pulumi/pulumi"</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> k8s <span class="keyword">from</span> <span class="string">"@pulumi/kubernetes"</span>;</span><br></pre></td></tr></table></figure>
<h3>Getting Configuration Values</h3>
<p>In our <strong>AKS</strong> Pulumi project/stack, we had a number of configuration values that we stored in our Pulumi service. One of those important configuration values was the kubeConfig file that contains the credentials required to connect to our <strong>k8s</strong> instance. We are now going to use the Pulumi SDK to get that kubeConfig value so that we can use it in this project.</p>
<p><a href="https://www.pulumi.com/docs/intro/concepts/organizing-stacks-projects/#inter-stack-dependencies" target="_blank" rel="noopener">Inter-Stack Dependencies</a></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// setup config</span></span><br><span class="line"><span class="keyword">const</span> env = pulumi.getStack(); <span class="comment">// reference to this stack</span></span><br><span class="line"><span class="keyword">const</span> stackId = <span class="string">`dave/aks/<span class="subst">$&#123;env&#125;</span>`</span>;</span><br><span class="line"><span class="keyword">const</span> aksStack = <span class="keyword">new</span> pulumi.StackReference(stackId);</span><br><span class="line"><span class="keyword">const</span> kubeConfig = aksStack.getOutput(<span class="string">"kubeConfig"</span>);</span><br><span class="line"><span class="keyword">const</span> k8sProvider = <span class="keyword">new</span> k8s.Provider(<span class="string">"k8s"</span>, &#123; kubeconfig: kubeConfig  &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// output kubeConfig for debugging purposes</span></span><br><span class="line"><span class="keyword">let</span> _ = aksStack.getOutput(<span class="string">"kubeConfig"</span>).apply(<span class="function"><span class="params">unwrapped</span> =&gt;</span> <span class="built_in">console</span>.log(unwrapped));</span><br></pre></td></tr></table></figure>
<p>If we break down this fragment of Typescript, we see that:</p>
<ol>
<li>Get a reference to the current stack</li>
<li>Ask Pulumi for an object reference to our <strong>AKS</strong> stack variables. We want the kubeConfig secret from it.</li>
<li>Create a <strong>k8s.Provider</strong> using the acquired kubeConfig values
<ul>
<li>(Option) - Output the kubeConfig to the console for debugging</li>
</ul>
</li>
</ol>
<p><code>pulumi up</code> to test your application. It should simply compile, access our <strong>aks8</strong> stack, and output the kubeConfig!</p>
<h3>Labels</h3>
<p>Almost everything in <strong>k8s</strong> uses labels to perform important actions. For example, Services expose Deployments that match the selector labels. Also, you can use labels to do queries via <strong>kubectl</strong> or as filters in <strong>octant</strong>, <strong>k9s</strong>, or the <strong>Kubernetes Web UI</strong>. You'll see labels used throughout the manifests and the Pulumi code.</p>
<p>We will define some common label groups that we'll use throughout our application, merging them with service/deployment specific sets of labels as required. You can add to these groups as required for your situation.</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Common labels</span></span><br><span class="line"><span class="keyword">const</span> baseBackEndLabels = &#123; tier: <span class="string">"backend"</span>, group: <span class="string">"infrastructure"</span> &#125;;</span><br><span class="line"><span class="keyword">const</span> baseApplicationGroupLabels = &#123;tier: <span class="string">"frontend"</span>, group:<span class="string">"auth"</span>&#125;;</span><br></pre></td></tr></table></figure>
<h3>Moving Postgres from Manifest to Pulumi</h3>
<p>Now that we have a <strong>k8s.Provider</strong> that we can use to send instructions to our <strong>AKS</strong> cluster, we need to create the Pulumi instructions to start putting resources into our <strong>k8s</strong> cluster. Starting with postgres, let's take a look at our manifest that we used when putting resources into <strong>minikube</strong>.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">postgres-pv-volume</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">local</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">manual</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">1Gi</span></span><br><span class="line">  <span class="attr">hostPath:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/var/lib/postgresql/data</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">postgres-pv-claim</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">manual</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">1Gi</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">postgres-dep</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">postgres</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">backend</span></span><br><span class="line">    <span class="attr">group:</span> <span class="string">infrastructure</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">revisionHistoryLimit:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">postgres</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">postgres</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">postgres-pv-storage</span></span><br><span class="line">          <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">            <span class="attr">claimName:</span> <span class="string">postgres-pv-claim</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">postgres</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">postgres:alpine</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POSTGRES_USER</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">"admin"</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POSTGRES_PASSWORD</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">"P@ssw0rd!"</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POSTGRES_DB</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">"identity"</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">5432</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">"/var/lib/postgresql/data"</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">postgres-pv-storage</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># from postgres-svc.yml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">postgres-svc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">postgres</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">5432</span></span><br></pre></td></tr></table></figure>
<p>We're going to ignore the first resource in the manifest. Because we are using <strong>AKS</strong>, we are able to take advantage of the <em>dynamic persistent volume</em> mechanism that is provided. We simply need to create <strong>PersistentVolumeClaim</strong> with the correct <strong>storageClass</strong> and <strong>Azure/AKS</strong> will take care of provisioning an actual persistent volume for us and attaching it to the correct host/node.</p>
<p>The second resource is the PersistentVolumeClaim. The important differnce between the manifest and the Pulumi application is going to be the use of the <strong>storageClassName</strong> configuration value that is coming from our <strong>aksStack</strong> configuration. In the <strong>AKS</strong> stack, this value is set to <strong>managed-premium</strong>.</p>
<p>For our third resource, the actual Deployment, we mostly want to map the values from our manifest into the TypeScript/JSON notation.</p>
<p>Last but not least, we map the Service manifest settings that will give the postgres-dep resource some network (internal to cluster) configuration into our Pulumi application.</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Add Postgres to AKS Cluster</span></span><br><span class="line"><span class="keyword">const</span> postgresLabels = &#123;...&#123; app: <span class="string">"postgres"</span>, role: <span class="string">"db"</span> &#125;, ...baseBackEndLabels&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> postgresPVClaimName = <span class="string">"postgres-pv-claim"</span>;</span><br><span class="line"><span class="keyword">const</span> postgresPersistentVolumeClaim = <span class="keyword">new</span> k8s.core.v1.PersistentVolumeClaim(postgresPVClaimName,&#123;</span><br><span class="line">    metadata:&#123; name: postgresPVClaimName&#125;,</span><br><span class="line">    spec: &#123;</span><br><span class="line">        storageClassName: aksStack.getOutput(<span class="string">"storageClassName"</span>),</span><br><span class="line">        accessModes: [<span class="string">"ReadWriteOnce"</span>],</span><br><span class="line">        resources: &#123;</span><br><span class="line">            requests: &#123;</span><br><span class="line">                storage: <span class="string">"32Gi"</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;, &#123;provider: k8sProvider&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> postgresDepName = <span class="string">"postgres-dep"</span>;</span><br><span class="line"><span class="keyword">const</span> postgresDeployment = <span class="keyword">new</span> k8s.apps.v1.Deployment(postgresDepName, &#123;</span><br><span class="line">    metadata: &#123; </span><br><span class="line">        name: postgresDepName, </span><br><span class="line">        labels: postgresLabels</span><br><span class="line">    &#125;,</span><br><span class="line">    spec: &#123;</span><br><span class="line">        selector: &#123; matchLabels: postgresLabels &#125;,</span><br><span class="line">        replicas: <span class="number">1</span>,</span><br><span class="line">        revisionHistoryLimit: <span class="number">2</span>,</span><br><span class="line">        template: &#123;</span><br><span class="line">            metadata: &#123; labels: postgresLabels &#125;,</span><br><span class="line">            spec: &#123;</span><br><span class="line">                containers: [&#123;</span><br><span class="line">                    name: <span class="string">"postgres"</span>,</span><br><span class="line">                    image: <span class="string">"postgres:alpine"</span>,</span><br><span class="line">                    volumeMounts: [&#123;</span><br><span class="line">                        mountPath: <span class="string">"/var/lib/postgresql/data"</span>,</span><br><span class="line">                        name: <span class="string">"volume"</span></span><br><span class="line">                    &#125;],</span><br><span class="line">                    resources: &#123;</span><br><span class="line">                        requests: &#123;</span><br><span class="line">                            cpu: <span class="string">"100m"</span>,</span><br><span class="line">                            memory: <span class="string">"100Mi"</span>,</span><br><span class="line">                        &#125;,</span><br><span class="line">                    &#125;,</span><br><span class="line">                    ports: [&#123; containerPort: <span class="number">5432</span> &#125;],</span><br><span class="line">                    env: [</span><br><span class="line">                        &#123;name: <span class="string">"POSTGRES_USER"</span>, value: <span class="string">"admin"</span>&#125;,</span><br><span class="line">                        &#123;name: <span class="string">"POSTGRES_PASSWORD"</span>, value: <span class="string">"P@ssw0rd!"</span>&#125;,</span><br><span class="line">                        &#123;name: <span class="string">"POSTGRES_DB"</span>, value: <span class="string">"identity"</span>&#125;,</span><br><span class="line">                        &#123;name: <span class="string">"PGDATA"</span>, value: <span class="string">"/mnt/data/pgdata"</span>&#125;</span><br><span class="line">                    ]</span><br><span class="line">                &#125;],</span><br><span class="line">                volumes:[&#123;</span><br><span class="line">                    name: <span class="string">"volume"</span>,</span><br><span class="line">                    persistentVolumeClaim: &#123;</span><br><span class="line">                        claimName: postgresPVClaimName</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;]</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;, &#123;provider: k8sProvider&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> postgresServiceName = <span class="string">"postgres-svc"</span>;</span><br><span class="line"><span class="keyword">const</span> postgresService = <span class="keyword">new</span> k8s.core.v1.Service(postgresServiceName, </span><br><span class="line">    &#123;</span><br><span class="line">        metadata: &#123;</span><br><span class="line">            name: postgresServiceName,</span><br><span class="line">            labels: postgresLabels,</span><br><span class="line">        &#125;,</span><br><span class="line">        spec: &#123;</span><br><span class="line">            ports: [&#123; port: <span class="number">5432</span>, protocol: <span class="string">"TCP"</span>&#125;],</span><br><span class="line">            selector: postgresLabels,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;, &#123;provider: k8sProvider&#125;);</span><br></pre></td></tr></table></figure>
<p><code>pulumi up</code> to compile our application and deploy postgres into the <strong>k8s</strong> cluster!</p>
<h3>Moving pgAdmin4 from Manifest to Pulumi</h3>
<p>Our next step is to migrate the pgAdmin4 manifest settings into Pulumi. This is going to be mostly the same as the postgres migration. I'll point out a few differences below.</p>
<p>For brevity, I've already removed the PersistentVolume manifest declaration.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pgadmin4-pv-claim</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">manual</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">1Gi</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pgadmin4-dep</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">pgadmin4</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">revisionHistoryLimit:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">pgadmin4</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">pgadmin4</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">pgadmin4-pv-storage</span></span><br><span class="line">          <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">            <span class="attr">claimName:</span> <span class="string">pgadmin4-pv-claim</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">pgadmin4</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">dpage/pgadmin4</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">PGADMIN_DEFAULT_EMAIL</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">"admin@codingwithdave.xyz"</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">PGADMIN_DEFAULT_PASSWORD</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">"P@ssw0rd!"</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">"/var/lib/pgadmin/data"</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">pgadmin4-pv-storage</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># from pgadmin4-svc.yml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pgadmin4-svc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">pgadmin4</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">nodePort:</span> <span class="number">5050</span></span><br></pre></td></tr></table></figure>
<p>There are a few items that are different as we move to Pulumi because we are using Pulumi for the Azure production (eventually) environment and the operationalization of our stack. We will be using pgAdmin4 (the container, if not the application) to do database backups. The pgAdmin4 container has all of the tooling and settings required to do backups. What we need though is somewhere to put the backups. In this case, we will leverage another feature of <strong>AKS</strong> called azureFile storage provider for <strong>k8s</strong>. This bit of configuration instructs <strong>k8s</strong>, via Azure and <strong>AKS</strong>, to use a storage account file share as a volume in our pod.</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">name: pgAdminAzureVolumeName, <span class="comment">// &lt;-- This is "azure"</span></span><br><span class="line">  azureFile: &#123;</span><br><span class="line">    secretName: azureStorageSecretName,</span><br><span class="line">    shareName: azureFileShareName,</span><br><span class="line">    readOnly: <span class="literal">false</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>Recall that these resources were created in the <strong>AKS</strong> project so we need these values from our other stack configuration.</p>
<blockquote>
<p>Eventually, I expect we will move to a managed <a href="https://azure.microsoft.com/en-ca/services/postgresql/" target="_blank" rel="noopener">Azure Database for Postgres</a> SaaS offering, so all of this may eventually disappear. For now, we'll manage it all ourselves.</p>
</blockquote>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Add pgAdmin4 to AKS Cluster</span></span><br><span class="line"><span class="keyword">const</span> pgAdminLabels = &#123;...&#123; app: <span class="string">"pgAdmin4"</span>, role: <span class="string">"db"</span>&#125;, ...baseBackEndLabels &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> pgadminServiceName = <span class="string">"pgadmin-svc"</span>;</span><br><span class="line"><span class="keyword">const</span> pgAdminService = <span class="keyword">new</span> k8s.core.v1.Service(pgadminServiceName, &#123;</span><br><span class="line">    metadata: &#123;</span><br><span class="line">        name: pgadminServiceName,</span><br><span class="line">        labels: pgAdminLabels,</span><br><span class="line">    &#125;,</span><br><span class="line">    spec: &#123;</span><br><span class="line">        ports: [&#123; port: <span class="number">80</span>, targetPort: <span class="number">80</span>, protocol: <span class="string">"TCP"</span>&#125;],</span><br><span class="line">        selector: pgAdminLabels,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;, &#123;provider: k8sProvider&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> pgAdminAzureVolumeName = <span class="string">"azure"</span>;</span><br><span class="line"><span class="keyword">const</span> pgAdminDepName = <span class="string">"pgadmin-dep"</span>;</span><br><span class="line"><span class="keyword">const</span> pgAdminDeployment = <span class="keyword">new</span> k8s.apps.v1.Deployment(pgAdminDepName, &#123;</span><br><span class="line">    metadata: &#123; name: pgAdminDepName &#125;,</span><br><span class="line">    spec: &#123;</span><br><span class="line">        selector: &#123; matchLabels: pgAdminLabels &#125;,</span><br><span class="line">        replicas: <span class="number">1</span>,</span><br><span class="line">        revisionHistoryLimit: <span class="number">2</span>,</span><br><span class="line">        template: &#123;</span><br><span class="line">            metadata: &#123; labels: pgAdminLabels &#125;,</span><br><span class="line">            spec: &#123;</span><br><span class="line">                containers: [&#123;</span><br><span class="line">                    name: <span class="string">"pgadmin"</span>,</span><br><span class="line">                    image: <span class="string">"dpage/pgadmin4"</span>,</span><br><span class="line">                    resources: &#123;</span><br><span class="line">                        requests: &#123;</span><br><span class="line">                            cpu: <span class="string">"100m"</span>,</span><br><span class="line">                            memory: <span class="string">"150Mi"</span>,</span><br><span class="line">                        &#125;,</span><br><span class="line">                        limits: &#123;</span><br><span class="line">                            memory: <span class="string">"200Mi"</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    ports: [&#123; containerPort: <span class="number">80</span> &#125;],</span><br><span class="line">                    env: [</span><br><span class="line">                        &#123;name: <span class="string">"PGADMIN_DEFAULT_EMAIL"</span>, value: <span class="string">"admin@codingwithdave.xyz"</span>&#125;,</span><br><span class="line">                        &#123;name: <span class="string">"PGADMIN_DEFAULT_PASSWORD"</span>, value: <span class="string">"P@ssw0rd!"</span>&#125;,</span><br><span class="line">                        &#123;name: <span class="string">"POSTGRES_USER"</span>, value: <span class="string">"admin"</span>&#125;,</span><br><span class="line">                        &#123;name: <span class="string">"POSTGRES_PASSWORD"</span>, value: <span class="string">"P@ssw0rd!"</span>&#125;,</span><br><span class="line">                        &#123;name: <span class="string">"POSTGRES_DB"</span>, value: <span class="string">"identity"</span>&#125;</span><br><span class="line">                    ],</span><br><span class="line">                    volumeMounts:[</span><br><span class="line">                        &#123;name: pgAdminAzureVolumeName, mountPath: <span class="string">"/var/lib/pgadmin/azure"</span>&#125;</span><br><span class="line">                    ]</span><br><span class="line">                &#125;],</span><br><span class="line">                volumes: [&#123;</span><br><span class="line">                    name: pgAdminAzureVolumeName,</span><br><span class="line">                    azureFile: &#123;</span><br><span class="line">                        secretName: azureStorageSecretName,</span><br><span class="line">                        shareName: azureFileShareName,</span><br><span class="line">                        readOnly: <span class="literal">false</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;],</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;, &#123;provider: k8sProvider&#125;);</span><br></pre></td></tr></table></figure>
<p><code>pulumi up</code> will put the pgAdmin4 application/images into our <strong>k8s</strong> cluster. With the given configuration, it will be able to connect to the postgres database.</p>
<h3>Moving Seq from Manifest to Pulumi</h3>
<p>The final step (for now) of moving all of our infrastructure/backend components into pulumi is the Seq instance. This will be similar to the postgres instance as it also uses a PersistentVolumeClaim to get an azureDisk attached to the VM for saving our log data.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">seq-pv-volume</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">local</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">manual</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">3Gi</span></span><br><span class="line">  <span class="attr">hostPath:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/mnt/data/seqv6/</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">seq-pv-claim</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">manual</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">3Gi</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">seq-dep</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">seq</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">revisionHistoryLimit:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">seq</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">seq</span> </span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">seq-pv-storage</span></span><br><span class="line">          <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">            <span class="attr">claimName:</span> <span class="string">seq-pv-claim</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">seq</span> </span><br><span class="line">        <span class="attr">image:</span> <span class="string">datalust/seq:preview</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">"/data"</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">seq-pv-storage</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ACCEPT_EULA</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">"Y"</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># from seq-svc.yml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">seq-svc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">seq</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">nodePort:</span> <span class="number">5341</span></span><br></pre></td></tr></table></figure>
<p>There are two notable differences in Pulumi Application code that were not in the manifests.</p>
<p>First of all, we are adding a <a href="https://kubernetes.io/docs/concepts/workloads/pods/pod-overview/" target="_blank" rel="noopener">side-car container</a> to this pod now that we are moving to Azure. This means that there are two containers running in this Pod. They are separate images (applications) but they will share the same network space and be able to access each other at the DNS <strong>localhost</strong> with the appropriate port. The side-car container we are adding is a container image called <a href="https://hub.docker.com/r/datalust/sqelf" target="_blank" rel="noopener">sqelf</a> which is a product produced by <a href="https://www.datalust.co" target="_blank" rel="noopener">datalust.co</a> that allows use to ingest log events in the <code>graylog</code> message format and send them directly into Seq.</p>
<p>The second change is in the Service description. We need to expose the <strong>sqelf</strong> service on a UDP port so that eventually, <strong>fluentd</strong> will be able to send log event messages, in the <strong>graylog</strong> format, to the <strong>sqelf</strong> container. The <strong>squelf</strong> container then just sends it on to <strong>Seq</strong>. We'll discuss <strong>fluentd</strong> in another article.</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Add Seq to AKS Cluster</span></span><br><span class="line"><span class="keyword">const</span> seqLabels = &#123;...&#123; app: <span class="string">"seq"</span>, role: <span class="string">"logingestion"</span>&#125;, ...baseBackEndLabels&#125;;</span><br><span class="line"><span class="keyword">const</span> seqPersistentVolumeClaim = <span class="keyword">new</span> k8s.core.v1.PersistentVolumeClaim(<span class="string">"seq-pv-claim"</span>,&#123;</span><br><span class="line">    metadata:&#123; name: <span class="string">"seq-pv-claim"</span>&#125;,</span><br><span class="line">    spec: &#123;</span><br><span class="line">        storageClassName: aksStack.getOutput(<span class="string">"storageClassName"</span>),</span><br><span class="line">        accessModes: [<span class="string">"ReadWriteOnce"</span>],</span><br><span class="line">        resources: &#123;</span><br><span class="line">            requests: &#123;</span><br><span class="line">                storage: <span class="string">"32Gi"</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;, &#123;provider: k8sProvider&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> seqServiceName = <span class="string">"seq-svc"</span>;</span><br><span class="line"><span class="keyword">const</span> seqService = <span class="keyword">new</span> k8s.core.v1.Service(seqServiceName, &#123;</span><br><span class="line">    metadata: &#123;</span><br><span class="line">        name: seqServiceName,</span><br><span class="line">        labels: seqLabels,</span><br><span class="line">    &#125;,</span><br><span class="line">    spec: &#123;</span><br><span class="line">        ports: [</span><br><span class="line">            &#123; name: <span class="string">"http-seq"</span>, port: <span class="number">80</span>, targetPort: <span class="number">80</span>, protocol: <span class="string">"TCP"</span>&#125;,</span><br><span class="line">            &#123; name: <span class="string">"udp-sqelf"</span>, port: <span class="number">12201</span>, protocol: <span class="string">"UDP"</span>&#125;],</span><br><span class="line">        selector: seqLabels,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;,&#123;provider: k8sProvider&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> seqDeploymentName = <span class="string">"seq-dep"</span>;</span><br><span class="line"><span class="keyword">const</span> seqDeployment = <span class="keyword">new</span> k8s.apps.v1.Deployment(seqDeploymentName, &#123;</span><br><span class="line">    metadata: &#123; name: seqDeploymentName &#125;,</span><br><span class="line">    spec: &#123;</span><br><span class="line">        selector: &#123; matchLabels: seqLabels &#125;,</span><br><span class="line">        replicas: <span class="number">1</span>,</span><br><span class="line">        revisionHistoryLimit: <span class="number">2</span>,</span><br><span class="line">        template: &#123;</span><br><span class="line">            metadata: &#123; labels: seqLabels &#125;,</span><br><span class="line">            spec: &#123;</span><br><span class="line">                volumes: [&#123;</span><br><span class="line">                    name: <span class="string">"seq-pv-storage"</span>,</span><br><span class="line">                    persistentVolumeClaim: &#123;</span><br><span class="line">                        claimName: <span class="string">"seq-pv-claim"</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;],</span><br><span class="line">                containers: [&#123;</span><br><span class="line">                    name: <span class="string">"seq"</span>,</span><br><span class="line">                    image: <span class="string">"datalust/seq:preview"</span>,</span><br><span class="line">                    resources: &#123;</span><br><span class="line">                        requests: &#123;</span><br><span class="line">                            cpu: <span class="string">"100m"</span>,</span><br><span class="line">                            memory: <span class="string">"500Mi"</span>,</span><br><span class="line">                        &#125;,</span><br><span class="line">                        limits:&#123;</span><br><span class="line">                            memory: <span class="string">"1000Mi"</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    ports: [&#123; containerPort: <span class="number">80</span>, protocol: <span class="string">"TCP"</span> &#125;],</span><br><span class="line">                    volumeMounts: [&#123;</span><br><span class="line">                        mountPath: <span class="string">"/data"</span>,</span><br><span class="line">                        name: <span class="string">"seq-pv-storage"</span></span><br><span class="line">                    &#125;],</span><br><span class="line">                    env: [&#123;name: <span class="string">"ACCEPT_EULA"</span>, value: <span class="string">"Y"</span>&#125;]</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    name: <span class="string">"sqelf"</span>,</span><br><span class="line">                    image: <span class="string">"datalust/sqelf"</span>,</span><br><span class="line">                    resources: &#123;</span><br><span class="line">                        requests: &#123;</span><br><span class="line">                            cpu: <span class="string">"100m"</span>,</span><br><span class="line">                            memory: <span class="string">"100Mi"</span>,</span><br><span class="line">                        &#125;,</span><br><span class="line">                    &#125;,</span><br><span class="line">                    ports: [&#123;containerPort: <span class="number">12201</span>, protocol: <span class="string">"UDP"</span>&#125;],</span><br><span class="line">                    env: [</span><br><span class="line">                        &#123;name: <span class="string">"ACCEPT_EULA"</span>, value: <span class="string">"Y"</span>&#125;,</span><br><span class="line">                        &#123;name: <span class="string">"SEQ_ADDRESS"</span>, value: <span class="string">"http://localhost:80"</span>&#125;</span><br><span class="line">                    ]</span><br><span class="line">                &#125;</span><br><span class="line">            ],</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;, &#123;provider: k8sProvider&#125;);</span><br></pre></td></tr></table></figure>
<p><code>pulumi up</code> will get the Seq pod up and running, with 2 containers, in our <strong>k8s</strong> infrastructure.</p>
<h3>Moving IdentityServer4 from Manifest to Pulumi</h3>
<p>The final bit of work to get our platform moved from <strong>minikube</strong> to <strong>AKS</strong> is to move our applications. There is nothing terribly special or noteworthy from a container perspective in this mapping. None of these pods need durable storage. The only difference with these pods is that they indicate that they want to use <strong>docker-credentials</strong> secret to access the private ACR.</p>
<p>There is a particularly important difference for our application when it comes to networking and accessing our applications. Our <strong>k8s</strong> has a public IP address and all of our applications will eventually be accessed via a unique DNS entry, not a shared DNS entry with different ports. I imagine you could use the shared DNS/multiple ports approach, but I did not. I don't think it helps human beings understand what they are using or working on to hide the intention behind a port abstraction. So, we will give everything its own URL.</p>
<p>This has consequences on our initial database seed data. Once this is all deployed, we will have to go into pgAdmin4 and run a script to update our configuration. Otherwise, the authentication system won't work. The Admin needs to be able <em>and allowed</em> to access the STS from its hostname location so we'll need to change the STS seed data. We're also going to change the configuration that is stored in the environmental variables which are appsettings.json overrides.</p>
<h4>STS</h4>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">identity-sts-dep</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">identity-sts</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">revisionHistoryLimit:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">identity-sts</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">identity-sts</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">identity-sts</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">depthconsulting.azurecr.io/skoruba-identityserver4-sts-identity:latest</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ASPNETCORE_ENVIRONMENT</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">"Development"</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SEQ_URL</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">"http://seq-svc"</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ConnectionStrings__ConfigurationDbConnection</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">"User ID=admin;Password=P@ssw0rd!;Host=postgres-svc;Port=5432;Database=identity;Pooling=true;"</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ConnectionStrings__PersistedGrantDbConnection</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">"User ID=admin;Password=P@ssw0rd!;Host=postgres-svc;Port=5432;Database=identity;Pooling=true;"</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ConnectionStrings__IdentityDbConnection</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">"User ID=admin;Password=P@ssw0rd!;Host=postgres-svc;Port=5432;Database=identity;Pooling=true;"</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">AdminConfiguration__IdentityAdminBaseUrl</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">http://127.0.0.1.xip.io:9000</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ASPNETCORE_URLS</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">"http://+:80"</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">imagePullSecrets:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">docker-credentials</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># from identity-sts-svc.yml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">identity-sts-svc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">identity-sts</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">nodePort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>
<p>I'm so glad that Pulumi is a programatic IaC model. One thing I can do here before we get to far along is move my DB connection strings (and the list) into variables and then use them where needed.</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> dbConnectionString = <span class="string">"Server=postgres-svc; User Id=admin; Database=identity; Port=5432; Password=P@ssw0rd!; SSL Mode=Prefer; Trust Server Certificate=true;"</span>;</span><br><span class="line"><span class="keyword">const</span> dbConnectionStringList = [</span><br><span class="line">    &#123;name: <span class="string">"ConnectionStrings__ConfigurationDbConnection"</span>, value: dbConnectionString&#125;,</span><br><span class="line">    &#123;name: <span class="string">"ConnectionStrings__PersistedGrantDbConnection"</span>, value: dbConnectionString&#125;,</span><br><span class="line">    &#123;name: <span class="string">"ConnectionStrings__IdentityDbConnection"</span>, value: dbConnectionString&#125;,</span><br><span class="line">    &#123;name: <span class="string">"ConnectionStrings__AdminLogDbConnection"</span>, value: dbConnectionString&#125;,</span><br><span class="line">    &#123;name: <span class="string">"ConnectionStrings__AdminAuditLogDbConnection"</span>, value: dbConnectionString&#125;</span><br><span class="line">];</span><br></pre></td></tr></table></figure>
<p>Now to code the STS provisioning.</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Add Identity STS Service to AKS Cluster</span></span><br><span class="line"><span class="keyword">const</span> stsLabels = &#123;...&#123; app: <span class="string">"identity-sts"</span>, role: <span class="string">"authentication"</span>&#125;, ...baseApplicationGroupLabels&#125;;</span><br><span class="line"><span class="keyword">const</span> stsDepName = <span class="string">"identity-sts-dep"</span>;</span><br><span class="line"><span class="keyword">const</span> stsDeployment = <span class="keyword">new</span> k8s.apps.v1.Deployment(stsDepName, &#123;</span><br><span class="line">    metadata: &#123; </span><br><span class="line">        name: stsDepName,</span><br><span class="line">        labels: stsLabels</span><br><span class="line">    &#125;,</span><br><span class="line">    spec: &#123;</span><br><span class="line">        selector: &#123; matchLabels: &#123;app: <span class="string">"identity-sts"</span>&#125; &#125;,</span><br><span class="line">        replicas: <span class="number">1</span>,</span><br><span class="line">        revisionHistoryLimit: <span class="number">2</span>,</span><br><span class="line">        template: &#123;</span><br><span class="line">            metadata: &#123; labels: stsLabels &#125;,</span><br><span class="line">            spec: &#123;</span><br><span class="line">                containers: [&#123;</span><br><span class="line">                    name: <span class="string">"identity-sts"</span>,</span><br><span class="line">                    image: <span class="string">"depthconsulting.azurecr.io/skoruba-identityserver4-sts-identity:latest"</span>,</span><br><span class="line">                    resources: &#123;</span><br><span class="line">                        requests: &#123;</span><br><span class="line">                            cpu: <span class="string">"100m"</span>,</span><br><span class="line">                            memory: <span class="string">"200Mi"</span>,</span><br><span class="line">                        &#125;,</span><br><span class="line">                        limits:&#123;</span><br><span class="line">                            memory: <span class="string">"300Mi"</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    ports: [&#123; containerPort: <span class="number">80</span>, protocol: <span class="string">"TCP"</span> &#125;],</span><br><span class="line">                    env: [</span><br><span class="line">                        &#123;name: <span class="string">"ASPNETCORE_ENVIRONMENT"</span>, value: <span class="string">"Development"</span>&#125;,</span><br><span class="line">                        &#123;name: <span class="string">"SEQ_URL"</span>, value: <span class="string">"http://seq-svc:5341"</span>&#125;,</span><br><span class="line">                        &#123;name: <span class="string">"AdminConfiguration__IdentityAdminBaseUrl"</span>, value: <span class="string">"https://auth-admin.codingwithdave.xyz"</span>&#125;,</span><br><span class="line">                        &#123;name: <span class="string">"ASPNETCORE_URLS"</span>, value: <span class="string">"http://+:80"</span>&#125;</span><br><span class="line">                    ].concat(dbConnectionStringList)</span><br><span class="line">                &#125;],</span><br><span class="line">                imagePullSecrets: [&#123;name: acrSecretName &#125;]</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;, &#123;provider: k8sProvider&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> stsServiceName = <span class="string">"identity-sts-svc"</span>;</span><br><span class="line"><span class="keyword">const</span> stsService = <span class="keyword">new</span> k8s.core.v1.Service(stsServiceName, &#123;</span><br><span class="line">    metadata: &#123;</span><br><span class="line">        name: stsServiceName,</span><br><span class="line">        labels: &#123;app: <span class="string">"identity-sts"</span>&#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    spec: &#123;</span><br><span class="line">        ports: [</span><br><span class="line">            &#123; name: <span class="string">"http"</span>, port: <span class="number">80</span>, targetPort: <span class="number">80</span>, protocol: <span class="string">"TCP"</span>&#125;</span><br><span class="line">        ],</span><br><span class="line">        selector: &#123;app: <span class="string">"identity-sts"</span>&#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;,&#123;provider: k8sProvider&#125;);</span><br></pre></td></tr></table></figure>
<h4>IdentityServer4 Admin</h4>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">identity-admin-dep</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">identity-admin</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">revisionHistoryLimit:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">identity-admin</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">identity-admin</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">identity-admin</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">depthconsulting.azurecr.io/skoruba-identityserver4-admin:latest</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ASPNETCORE_ENVIRONMENT</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">"Development"</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SEQ_URL</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">"http://seq-svc"</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ConnectionStrings__ConfigurationDbConnection</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">"User ID=admin;Password=P@ssw0rd!;Host=postgres-svc;Port=5432;Database=identity;Pooling=true;"</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ConnectionStrings__PersistedGrantDbConnection</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">"User ID=admin;Password=P@ssw0rd!;Host=postgres-svc;Port=5432;Database=identity;Pooling=true;"</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ConnectionStrings__IdentityDbConnection</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">"User ID=admin;Password=P@ssw0rd!;Host=postgres-svc;Port=5432;Database=identity;Pooling=true;"</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ConnectionStrings__AdminLogDbConnection</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">"User ID=admin;Password=P@ssw0rd!;Host=postgres-svc;Port=5432;Database=identity;Pooling=true;"</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ConnectionStrings__AdminAuditLogDbConnection</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">"User ID=admin;Password=P@ssw0rd!;Host=postgres-svc;Port=5432;Database=identity;Pooling=true;"</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">AdminConfiguration__IdentityServerBaseUrl</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">http://127.0.0.1.xip.io</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">AdminConfiguration__IdentityAdminRedirectUri</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">http://127.0.0.1.xip.io:9000/signin-oidc</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ASPNETCORE_URLS</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">"http://+:80"</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">imagePullSecrets:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">docker-credentials</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># from identity-admin-svc.yml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">identity-admin-svc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">identity-admin</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">nodePort:</span> <span class="number">9000</span></span><br></pre></td></tr></table></figure>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Add Auth Admin Application to AKS Cluster</span></span><br><span class="line"><span class="keyword">const</span> adminLabels = &#123;...&#123; app: <span class="string">"identity-admin"</span>, role: <span class="string">"authentication"</span>&#125;, ...baseApplicationGroupLabels&#125;;</span><br><span class="line"><span class="keyword">const</span> adminDepName = <span class="string">"identity-admin-dep"</span>;</span><br><span class="line"><span class="keyword">const</span> adminDeployment = <span class="keyword">new</span> k8s.apps.v1.Deployment(adminDepName, &#123;</span><br><span class="line">    metadata: &#123;</span><br><span class="line">        name: adminDepName,</span><br><span class="line">        labels: adminLabels</span><br><span class="line">    &#125;,</span><br><span class="line">    spec: &#123;</span><br><span class="line">        selector: &#123; matchLabels: &#123;app: <span class="string">"identity-admin"</span>&#125; &#125;,</span><br><span class="line">        replicas: <span class="number">1</span>,</span><br><span class="line">        revisionHistoryLimit: <span class="number">2</span>,</span><br><span class="line">        template: &#123;</span><br><span class="line">            metadata: &#123; labels: adminLabels &#125;,</span><br><span class="line">            spec: &#123;</span><br><span class="line">                containers: [&#123;</span><br><span class="line">                    name: <span class="string">"identity-admin"</span>,</span><br><span class="line">                    image: <span class="string">"depthconsulting.azurecr.io/skoruba-identityserver4-admin:latest"</span>,</span><br><span class="line">                    resources: &#123;</span><br><span class="line">                        requests: &#123;</span><br><span class="line">                            cpu: <span class="string">"100m"</span>,</span><br><span class="line">                            memory: <span class="string">"200Mi"</span>,</span><br><span class="line">                        &#125;,</span><br><span class="line">                        limits:&#123;</span><br><span class="line">                            memory: <span class="string">"300Mi"</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    ports: [&#123; containerPort: <span class="number">80</span>, protocol: <span class="string">"TCP"</span> &#125;],</span><br><span class="line">                    env: [</span><br><span class="line">                        &#123;name: <span class="string">"ASPNETCORE_ENVIRONMENT"</span>, value: <span class="string">"Development"</span>&#125;,</span><br><span class="line">                        &#123;name: <span class="string">"SEQ_URL"</span>, value: <span class="string">"http://seq-svc:5341"</span>&#125;,</span><br><span class="line">                        &#123;name: <span class="string">"AdminConfiguration__IdentityServerBaseUrl"</span>, value: <span class="string">"https://auth.codingwithdave.xyz"</span>&#125;,</span><br><span class="line">                        &#123;name: <span class="string">"AdminConfiguration__IdentityAdminRedirectUri"</span>, value: <span class="string">"https://auth-admin.codingwithdave.xyz/signin-oidc"</span>&#125;,</span><br><span class="line">                        &#123;name: <span class="string">"AdminConfiguration__RequireHttpsMetadata"</span>, value: <span class="string">"true"</span>&#125;,</span><br><span class="line">                        &#123;name: <span class="string">"ASPNETCORE_URLS"</span>, value: <span class="string">"http://+:80"</span>&#125;</span><br><span class="line">                    ].concat(dbConnectionStringList)</span><br><span class="line">                &#125;],</span><br><span class="line">                imagePullSecrets: [&#123;name: acrSecretName &#125;]</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;, &#123;provider: k8sProvider&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> adminServiceName = <span class="string">"identity-admin-svc"</span>;</span><br><span class="line"><span class="keyword">const</span> adminService = <span class="keyword">new</span> k8s.core.v1.Service(adminServiceName, &#123;</span><br><span class="line">    metadata: &#123;</span><br><span class="line">        name: adminServiceName,</span><br><span class="line">        labels: &#123;app: <span class="string">"identity-admin"</span>&#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    spec: &#123;</span><br><span class="line">        ports: [&#123; port: <span class="number">80</span>, targetPort: <span class="number">80</span>, protocol: <span class="string">"TCP"</span>&#125;],</span><br><span class="line">        selector: &#123;app: <span class="string">"identity-admin"</span>&#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;,&#123;provider: k8sProvider&#125;);</span><br></pre></td></tr></table></figure>
<h4>IdentityServer4 Admin API</h4>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">identity-admin-api-dep</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">identity-admin-api</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">revisionHistoryLimit:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">identity-admin-api</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">identity-admin-api</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">identity-admin-api</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">depthconsulting.azurecr.io/skoruba-identityserver4-admin-api:latest</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ASPNETCORE_ENVIRONMENT</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">"Development"</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SEQ_URL</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">"http://seq-svc"</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ConnectionStrings__ConfigurationDbConnection</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">"User ID=admin;Password=P@ssw0rd!;Host=postgres-svc;Port=5432;Database=identity;Pooling=true;"</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ConnectionStrings__PersistedGrantDbConnection</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">"User ID=admin;Password=P@ssw0rd!;Host=postgres-svc;Port=5432;Database=identity;Pooling=true;"</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ConnectionStrings__IdentityDbConnection</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">"User ID=admin;Password=P@ssw0rd!;Host=postgres-svc;Port=5432;Database=identity;Pooling=true;"</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ConnectionStrings__AdminLogDbConnection</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">"User ID=admin;Password=P@ssw0rd!;Host=postgres-svc;Port=5432;Database=identity;Pooling=true;"</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ConnectionStrings__AdminAuditLogDbConnection</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">"User ID=admin;Password=P@ssw0rd!;Host=postgres-svc;Port=5432;Database=identity;Pooling=true;"</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">AdminApiConfiguration__IdentityServerBaseUrl</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">http://127.0.0.1.xip.io</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">AdminApiConfiguration__ApiBaseUrl</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">http://127.0.0.1.xip.io:5000</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ASPNETCORE_URLS</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">"http://+:80"</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">imagePullSecrets:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">docker-credentials</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># from identity-adminapi-svc.yml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span>  <span class="string">identity-admin-api-svc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span>  <span class="string">identity-admin-api</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">nodePort:</span> <span class="number">5000</span></span><br></pre></td></tr></table></figure>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Add Auth Admin API to AKS Cluster</span></span><br><span class="line"><span class="keyword">const</span> adminApiLabels = &#123;...&#123; app: <span class="string">"identity-admin-api"</span>, role: <span class="string">"authentication"</span>&#125;, ...baseApplicationGroupLabels&#125;;</span><br><span class="line"><span class="keyword">const</span> adminApiDepName = <span class="string">"identity-admin-api-dep"</span>;</span><br><span class="line"><span class="keyword">const</span> adminApiDeployment = <span class="keyword">new</span> k8s.apps.v1.Deployment(adminApiDepName, &#123;</span><br><span class="line">    metadata: &#123; </span><br><span class="line">      name: adminApiDepName,</span><br><span class="line">      labels: adminApiLabels</span><br><span class="line">    &#125;,</span><br><span class="line">    spec: &#123;</span><br><span class="line">        selector: &#123; matchLabels: &#123;app: <span class="string">"identity-admin-api"</span>&#125; &#125;,</span><br><span class="line">        replicas: <span class="number">1</span>,</span><br><span class="line">        revisionHistoryLimit: <span class="number">2</span>,</span><br><span class="line">        template: &#123;</span><br><span class="line">            metadata: &#123; labels: adminApiLabels &#125;,</span><br><span class="line">            spec: &#123;</span><br><span class="line">                containers: [&#123;</span><br><span class="line">                    name: <span class="string">"identity-admin-api"</span>,</span><br><span class="line">                    image: <span class="string">"depthconsulting.azurecr.io/skoruba-identityserver4-admin-api:latest"</span>,</span><br><span class="line">                    resources: &#123;</span><br><span class="line">                        requests: &#123;</span><br><span class="line">                            cpu: <span class="string">"100m"</span>,</span><br><span class="line">                            memory: <span class="string">"200Mi"</span>,</span><br><span class="line">                        &#125;,</span><br><span class="line">                        limits:&#123;</span><br><span class="line">                            memory: <span class="string">"300Mi"</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    ports: [&#123; containerPort: <span class="number">80</span>, protocol: <span class="string">"TCP"</span> &#125;],</span><br><span class="line">                    env: [</span><br><span class="line">                        &#123;name: <span class="string">"ASPNETCORE_ENVIRONMENT"</span>, value: <span class="string">"Development"</span>&#125;,</span><br><span class="line">                        &#123;name: <span class="string">"SEQ_URL"</span>, value: <span class="string">"http://seq-svc:5341"</span>&#125;,</span><br><span class="line">                        &#123;name: <span class="string">"AdminApiConfiguration__IdentityServerBaseUrl"</span>, value: <span class="string">"https://auth.codingwithdave.xyz"</span>&#125;,</span><br><span class="line">                        &#123;name: <span class="string">"AdminApiConfiguration__ApiBaseUrl"</span>, value: <span class="string">"https://auth-admin-api.codingwithdave.xyz"</span>&#125;,</span><br><span class="line">                        &#123;name: <span class="string">"ASPNETCORE_URLS"</span>, value: <span class="string">"http://+:80"</span>&#125;</span><br><span class="line">                    ].concat(dbConnectionStringList)</span><br><span class="line">                &#125;],</span><br><span class="line">                imagePullSecrets: [&#123;name: acrSecretName &#125;]</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;, &#123;provider: k8sProvider&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> adminApiServiceName = <span class="string">"identity-admin-api-svc"</span>;</span><br><span class="line"><span class="keyword">const</span> adminApiService = <span class="keyword">new</span> k8s.core.v1.Service(adminApiServiceName, &#123;</span><br><span class="line">    metadata: &#123;</span><br><span class="line">        name: adminApiServiceName,</span><br><span class="line">        labels: &#123;app: <span class="string">"identity-admin-api"</span>&#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    spec: &#123;</span><br><span class="line">        ports: [&#123; port: <span class="number">80</span>, targetPort: <span class="number">80</span>, protocol: <span class="string">"TCP"</span>&#125;],</span><br><span class="line">        selector: &#123;app: <span class="string">"identity-admin-api"</span>&#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;,&#123;provider: k8sProvider&#125;);</span><br></pre></td></tr></table></figure>
<p><code>pulumi up</code> will push all of your applications up into <strong>AKS</strong>.</p>
<h3>Verify all the Pods are Up and Running</h3>
<p>With our last <code>pulumi up</code> we should have all of our <strong>AKS</strong> infrastructure up and hosting our <strong>k8s</strong> cluster, and we should have all of our applications/services/resources from our second pulumi stack in the <strong>k8s</strong> cluster. We should now be able to go into a one of our tools and verify that the apps are running.</p>
<p>If you used the pulumi application in our previous post, you should have a <strong>az aks get-credentials ...</strong> in your pulumi output for that stack. It should look something like this:</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">az aks <span class="built_in">get-credentials</span> -<span class="literal">-resource</span><span class="literal">-group</span> rg_identity_dev_zwus_aks `</span><br><span class="line">-<span class="literal">-name</span> aksclusterfbfa950e -<span class="literal">-context</span> <span class="string">"MyProject.Identity"</span></span><br></pre></td></tr></table></figure>
<p>You can run that command, with your specific values, and have the <strong>azure-cli</strong> append this <strong>k8s</strong> context details into your kubeConfig file. Once that is done, we can type <code>octant</code> on the command line and look at our pods.</p>
<p>Using <strong>octant</strong> (v0.12.1), we can see that all of our pods are present in the cluster.</p>
<img src="/images/dwhite/octant-azure-pods-running.png" alt="Pods running in Azure" height="250px">
<p>We will click into the <strong>pgAdmin4</strong> pod as an example in the article, but you should eventually click into all of the pods to ensure they are functioning.</p>
<p>Looking at the pgAdmin4 pod, we can see that it is initialized and ready! If we go down a bit further, we'll see the port forward functionality of <strong>octant</strong> waiting for us to press the button.</p>
<img src="/images/dwhite/octant-azure-pgadmin-portforward.png" alt="PortForward function in Octant" height="250px">
<p>Once we press the button, we'll see that we now have an option to navigate to the port-forward URL.</p>
<img src="/images/dwhite/octant-azure-pgadmin-portforward-started.png" alt="PortForward to pgAdmin4 started" height="100px">
<p>When we click on that link, you'll see the pgAdmin4 log in screen and once you log in, you should be able to create a server entry in our list to our postgres pod. The <strong>k8s</strong> network DNS name for our postgres pod should be <strong>postgres-svc</strong> from our Service resource. Once the entry is connected, we should be able to see our postgres database!</p>
<img src="/images/dwhite/octant-azure-pgadmin-running.png" alt="pgAdmin4 running" height="250px">
<p>You should work your way through all of the pods. They should all be up and running. The whole authentication/authorization system won't be working yet. We'll wait until the next article to fix that up and test it out.</p>
<h4>Problems</h4>
<p>When you have problems in <strong>k8s</strong>, you have to start looking in two places. First, you have to look in the logs. <strong>octant</strong> has a nice screen for looking at the log files directly on a pod. Remember, we don't have log ingestion and tooling setup for the <strong>k8s</strong> cluster yet, so we have to go look in the pods themselves. Here you can see pgAdmin4 running just fine, but if it wasn't working, you'll find clues as to why here.</p>
<img src="/images/dwhite/octant-azure-pgadmin-log.png" alt="pgAdmin4 logs in the pod" height="250px">
<p>Once we have all of our log ingestion infrastructure in place, we will be able to go to Seq to look log entries across the cluster, but you should always be ready to go look directly in the pods for the log entries.</p>
<p>And the other place you will probably want to inspect is the running pod itself. You can use the <strong>terminal</strong> tab in <strong>octant</strong> to look at various settings in your pod.</p>
<img src="/images/dwhite/octant-azure-pgadmin-terminal.png" alt="pgAdmin4 terminal window" height="250px">
<h3>Not Quite Done Yet</h3>
<p>This article is going to end in a bit of a &quot;not quite working as I'd like&quot; state. All of the pods are up and running, but our IdentityServer4 needs some configuration changes in order to work. And in order to do that, we need to be able to access our <strong>k8s</strong> publicly, give it a DNS entry (hostname), and then configure our IdentityServer4 system to allow those hostnames to interact with the STS.</p>
<p>Our next stop will be adding an Ingress Controller to our <strong>k8s</strong> cluster and getting all of these services publicly available.</p>
<p><strong>Next up:</strong>
<a href="/kubernetes/kubernetes-my-journey-part-8">Making Your Kubernetes Cluster Publicly Accessible</a></p>
<style>
    h1, h2, h3, h4, h5, h6 {
       margin-top: 25px;
    }

    img {
       margin: 25px 0px;
    }
    figure.highlight{
        background-color: #E8EEFE;
    }
    figure.highlight .gutter{
        color: #0033CD;
    }
    figure.highlight pre {
        font-family: 'Cascadia Code PL', monospace;
    }
    code {
        font-family: 'Cascadia Code PL', sans-serif;
        border-width: 0.1em;
        border-color: #E8EEFE;
        border-style: solid;
        border-radius: 0.3em;
        background-color: #E8EEFE;
        color: #0033CD;
        padding: 0em 0.4em;
        white-space: nowrap;
    }
</style>
<link  href="https://cdnjs.cloudflare.com/ajax/libs/viewerjs/1.5.0/viewer.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/viewerjs/1.5.0/viewer.min.js"></script>
<script>
// View an image
const gallery = new Viewer(document.getElementById('mainPostContent', {
    "navbar": false,
    "toolbar": false
}));
</script>
	        </div>

            
            <section id="comments">
            <div id="disqus_thread">
                <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript" target="_blank" rel="noopener">comments powered by Disqus.</a></noscript>
            </div>
            </section>
            
		</div>
	</div>
<!--MAIN CONTENT ENDS-->

<!--SIDEBAR CONTENT STARTS-->
	<div class="SubpageBoxSubSm">
		<div class="SubpageBoxSubSmContent">
			
			

			<div class="ProfileImg">
				
				<a href="/bios/dave_white">
				
					<img src='https://www.gravatar.com/avatar/4b7708d2ae7f7bb866446e0459e3e156?s=200' />
				
				</a>
				
			</div>

			<BR clear="all">

			<h2><a href="/bios/dave_white">Dave White</a></h2>
			
			<a href="mailto:dmhwhite@gmail.com"><img class="ProfileIcon" src="/images/icon_email.png" border="0" alt="Email" title="Email"> Email</a><BR>
			
			
			<a href="http://agileramblings.com/" target="_blank"><img class="ProfileIcon" src="/images/icon_web.png" border="0" alt="Web" title="Web"> Web</a><BR>
			
			
			<a href="http://twitter.com/AgileRamblings" target="_blank"><img class="ProfileIcon" src="/images/icon_twitter.png" border="0" alt="Twitter" title="Twitter"> Twitter</a><BR>
			
			
			<a href="https://github.com/agileramblings" target="_blank"><img class="ProfileIcon" src="/images/icon_github.png" border="0" alt="GitHub" title="GitHub"> GitHub</a><br>
			
			
			<a href="https://www.linkedin.com/in/dave-white" target="_blank"><img class="ProfileIcon" src="/images/icon_linkedin.png" border="0" alt="LinkedIN" title="LinkedIN"> LinkedIn</a><br>
			
			
 			<a href="/feeds/dave_white.xml"><img class="ProfileIcon" src="/images/icon_subscribe.png" /> RSS</a>
			

			<hr />
			<h4>Looking for someone else?</h4>
			<p>You can find the rest of the Western Devs Crew <a href="/whoweare">here</a>.</p>
		</div>
	</div>
<!--SIDEBAR CONTENT ENDS-->


</div>
</center>
<!--PAGE CONTENT ENDS-->


<!--FOOTER STARTS-->
<center>
  <div class="FooterBarTxt">&copy; 2015 Western Devs. All Rights Reserved. Design by <a href="http://www.karenchudobiak.ca" target="_blank">Karen Chudobiak, Graphic Designer</a></div>
</center>
<!--FOOTER ENDS-->

<!-- NAV FOOTER STARTS -->
<div class="NavFooter">
  <a href="/posts" alt="Posts"><i class="fa fa-newspaper-o fa-2x"></i><span>Posts</span></a>
  <a href="/podcasts" alt="Podcasts"><i class="fa fa-volume-up fa-2x"></i><span>Podcasts</span></a>
  <a href="/whoweare" alt="About"><i class="fa fa-star fa-2x"></i><span>About</span></a>
  <a href="/whatwevedone" alt="What We've Done"><i class="fa fa-trophy fa-2x"></i><span>Work</span></a>
  <a href="/speaking" alt="Speaking"><i class="fa fa-comment-o fa-2x fa-flip-horizontal"></i><span>Speaking</span></a>
</div>
<!-- NAV FOOTER ENDS -->




</div>
<!--WRAPPER ENDS-->


<script>
  var disqus_shortname = 'westerndevs';
  
  var disqus_url = 'https://westerndevs.com/kubernetes/kubernetes-my-journey-part-7b/'.replace(".com//", ".com/");
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
  
function shuffle(array) {
  var currentIndex = array.length, temporaryValue, randomIndex;

  // While there remain elements to shuffle...
  while (0 !== currentIndex) {

    // Pick a remaining element...
    randomIndex = Math.floor(Math.random() * currentIndex);
    currentIndex -= 1;

    // And swap it with the current element.
    temporaryValue = array[currentIndex];
    array[currentIndex] = array[randomIndex];
    array[randomIndex] = temporaryValue;
  }

  return array;
}

</script>


</body>

  
<!-- Google Analytics -->
<script type="text/javascript">
if (document.location.hostname.search("westerndevs.com") !== -1 || document.location.hostname.search("www.westerndevs.com") !== -1) {
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-37617956-2', 'auto');

ga('set', 'contentGroup1', 'dave_white');

ga('send', 'pageview');
}
</script>
<!-- End Google Analytics -->



</html>
