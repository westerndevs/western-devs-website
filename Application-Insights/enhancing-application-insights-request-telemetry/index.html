<!DOCTYPE html>
<html lang="en" xml:lang="en">

  <head>
  
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>Enhancing Application Insights Request Telemetry | Western Devs</title>
  <meta name="description" content="A continuation in my series of love letters about Application Insights. Today I explore a method of enhancing the request telemetry that is automatically collected by the Application Insights SDK.">
<meta property="og:type" content="article">
<meta property="og:title" content="Enhancing Application Insights Request Telemetry">
<meta property="og:url" content="https://westerndevs.com/Application-Insights/enhancing-application-insights-request-telemetry/index.html">
<meta property="og:site_name" content="Western Devs">
<meta property="og:description" content="A continuation in my series of love letters about Application Insights. Today I explore a method of enhancing the request telemetry that is automatically collected by the Application Insights SDK.">
<meta property="og:image" content="https://www.davepaquette.com/images/app_insights/request_telemetry.png">
<meta property="og:image" content="https://www.davepaquette.com/images/app_insights/request_telemetry_custom_property.png">
<meta property="og:image" content="https://www.davepaquette.com/images/app_insights/filer_by_custom_property.png">
<meta property="og:image" content="https://www.davepaquette.com/images/app_insights/log_analytics_by_custom_property.png">
<meta property="article:published_time" content="2020-03-08T00:24:26.000Z">
<meta property="article:modified_time" content="2022-01-19T05:05:30.179Z">
<meta property="article:author" content="Western Devs">
<meta property="article:tag" content=".NET Core">
<meta property="article:tag" content=".NET">
<meta property="article:tag" content="Azure">
<meta property="article:tag" content="Application Insights">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://www.davepaquette.com/images/app_insights/request_telemetry.png">
<meta name="twitter:creator" content="@westerndevs">

    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="title" content="WesternDevs">   
    <meta name="keywords" content="software development,software,asp.net,blog">
    <meta name="description" content="We're all west of somewhere">
    <meta name="copyright" content="WesternDevs">
    <meta name="revisit-after" content="15 days">
    <meta name="robots" content="all">
    <meta name="MSSmartTagsPreventParsing" content="true">
  
    <link rel="canonical" href="https://www.davepaquette.com/archive/2020/03/07/enhancing-application-insights-request-telemetry.aspx">
  
  
    <link rel="alternate" href="/feed.xml" title="Western Devs" type="application/atom+xml">
  
  
<link rel="stylesheet" href="/css/style.css">

      
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <script src="//code.jquery.com/jquery-1.11.3.min.js"></script>  
  <meta name="generator" content="Hexo 4.2.1"></head>

<body>

<!-- FIXED HEADER BECAUSE SCROLLING -->
<!--HEADER STARTS-->
<div class="WrapperHeader">
<div style="display:inline-block; text-align: center;">
<div class="Header">

  <div class="HeaderLogo">
    <a href="/"><img src="/images/header_logo_transparent.png" alt="WesternDevs" title="WesternDevs" border="0" style="width: 206px; height: 64px;" width="206" height="64"></a>
  </div>

  <div class="HeaderLinks">
      <a href="/posts" class="nav">POSTS</a>       
      <a href="/podcasts" class="nav">PODCASTS</a>       
      <a href="/whoweare" class="nav">ABOUT</a>  
      <a href="/whatwevedone" class="nav">WHAT WE'VE DONE</a>  
      <a href="/speaking" class="nav">SPEAKING</a>
      <div class="HeaderIcons">
        <a href="mailto:info@westerndevs.com"><img src="/images/icon_email.png" border="0" alt="Email" title="Email" height="26" width="26"></a>
        <a href="/feed.xml"><img src="/images/icon_subscribe.png" border="0" alt="Subscribe" title="Subscribe" height="26" width="27"></a>
        <a href="http://twitter.com/westerndevs" target="_blank"><img src="/images/icon_twitter.png" border="0" alt="Twitter" title="Twitter" height="26" width="27"></a>
        <a href="http://github.com/westerndevs" target="_blank"><img src="/images/icon_github.png" border="0" alt="GitHub" title="GitHub" height="26" width="27"></a>     
      </div>
  </div>
  
</div>
</div>
</div>
<!--HEADER ENDS-->    



<!--WRAPPER STARTS-->
<div class="Wrapper" style="">

<!--SUBHEAD STARTS-->
<div class="WrapperSubHeaderSubpage">
<center>
	<div class="SubHeader">
		<H1 class="title"><img class="icon" src="/images/icon_posts.png" alt="POST" title="POST" border="0"> POST</H1>
	</div>
</center>
</div>
<!--SUBHEAD ENDS-->

<!--PAGE CONTENT STARTS-->
<center>
<div class="WrapperContent">

<!--MAIN CONTENT STARTS-->
	<div class="SubpageBoxSubLrg">
		<div class="SubpageBoxSubLrgContent">
		    <div class='postTitle'>
  <div class="ListLrgDateBG">
    <div class="ListLrgDateMonth">MAR</div>
    <div class="ListLrgDateDay">8</div>
    <div class="ListLrgDateYear">2020</div>
  </div>
  <h2>Enhancing Application Insights Request Telemetry</h2>
</div>

		    

<p class="TXTsm">ORIGINALLY POSTED TO: <a href="https://www.davepaquette.com/archive/2020/03/07/enhancing-application-insights-request-telemetry.aspx" target="_blank" rel="noopener" class='originalurl'>https://www.davepaquette.com/archive/2020/03/07/enhancing-application-insights-request-telemetry.aspx</a></p>



			<div id="mainPostContent">
	        <p>This post is a continuation of my series about using <a href="https://www.davepaquette.com/archive/2020/01/20/getting-the-most-out-of-application-insights-for-net-core-apps.aspx" target="_blank" rel="noopener">Application Insights in ASP.NET Core</a>. Today we will take a deeper dive into Request telemetry.</p>
<h1>Request Telemetry</h1>
<p>For an ASP.NET Core process, the Application Insights SDK will automatically collect data about every request that the server process receives. This specific type of telemetry is called <a href="https://docs.microsoft.com/azure/azure-monitor/app/data-model-request-telemetry" target="_blank" rel="noopener">Request telemetry</a> and it contains a ton of very useful data including: the request path, the HTTP verb, the response status code, the duration, the timestamp when the request was received.</p>
<p><img src="https://www.davepaquette.com/images/app_insights/request_telemetry.png" alt="Sample Request Telemetry"></p>
<p>The default data is great, but I often find myself wanting more information. For example, in a multi-tenant application, it would be very useful to track the tenant id as part of the request telemetry. This would allow us to filter data more effectively in the Application Insights portal and craft some very useful log analytics queries.</p>
<h1>Adding custom data to Request Telemetry</h1>
<p>All types of telemetry in Application Insights provide an option to store custom properties. In the <a href="https://www.davepaquette.com/archive/2020/02/05/setting-cloud-role-name-in-application-insights.aspx" target="_blank" rel="noopener">previous post</a>, we saw how to create an <code>ITelemetryInitializer</code> to set properties on a particular telemetry instance. We could easily add custom properties to our Request telemetry using a telemetry initializer.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CustomPropertyTelemetryInitializer</span> : <span class="title">ITelemetryInitializer</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Initialize</span>(<span class="params">ITelemetry telemetry</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">      requestTelemetry.Properties[<span class="string">"MyCustomProperty"</span>] = <span class="string">"Some Useful Value"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Any custom properties you add will be listed under Custom Properties in the Application Insights portal.</p>
<p><img src="https://www.davepaquette.com/images/app_insights/request_telemetry_custom_property.png" alt="Sample Request Telemetry with Custom Properties"></p>
<p>But telemetry initializers are singletons and often don't have access to the useful data that we want to add to request telemetry. Typically the data we want is related in some way to the current request and that data wouldn't be available in a singleton service. Fortunately, there is another easy way to get an instance of the request telemetry for the current request.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> requestTelemetry = HttpContext.Features.Get&lt;RequestTelemetry&gt;();</span><br><span class="line">requestTelemetry.Properties[<span class="string">"TenantId"</span>] = <span class="string">"ACME_CORP"</span>; </span><br></pre></td></tr></table></figure>
<p>You can do it anywhere you have access to an HTTP Context. Some examples I have seen include: <code>Middleware</code>, <code>ActionFilters</code>, <code>Controller</code> action methods, <code>OnActionExecuting</code> in a base <code>Controller</code> class and <code>PageModel</code> classes in Razor Pages.</p>
<h1>Filtering by Custom Properties in the Portal</h1>
<p>Once you've added custom properties to Request Telemetry, you can use those custom properties to filter data in the Application Insights portal. For example, you might want to investigate failures that are occurring for a specific tenant or investigate performance for a particular tenant.</p>
<p><img src="https://www.davepaquette.com/images/app_insights/filer_by_custom_property.png" alt="Filtering by Custom Property"></p>
<p>This type of filtering can be applied almost anywhere in the portal and can help narrow things down when investigating problems.</p>
<h1>Writing Useful Log Analytics Queries</h1>
<p>Now this is where things get really interesting for me. What if we had one particular tenant complaining about performance. Wouldn't it be interesting to plot out the average request duration for all tenants? We can easily accomplish this using a log analytics query.</p>
<figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">requests</span><br><span class="line">| <span class="type">summarize</span> avg(duration) <span class="built_in">by</span> tostring(customDimensions.TenantId), bin(timestamp, <span class="number">15</span>m)</span><br><span class="line">| <span class="type">render</span> timechart</span><br></pre></td></tr></table></figure>
<p>This simple query will produce the following chart:</p>
<p><img src="https://www.davepaquette.com/images/app_insights/log_analytics_by_custom_property.png" alt="Log Analytics Query Summarize by Custom Property"></p>
<p>Small variations on this query can be extremely useful in comparing response times, failure rates, usage and pretty much anything else you can think of.</p>
<h1>Wrapping it up</h1>
<p>TenantId is just an example of a custom property. The custom properties that are useful for a particular application tend to emerge naturally as you're investigating issues and sifting through telemetry in Application Insights. You will eventually find yourself saying &quot;I wish I knew what <code>xxx</code> was for this request`. When that happens, stop and add that as a custom property to the request telemetry. You'll thank yourself later.</p>

	        </div>

            
            <section id="comments">
            <div id="disqus_thread">
                <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript" target="_blank" rel="noopener">comments powered by Disqus.</a></noscript>
            </div>
            </section>
            
		</div>
	</div>
<!--MAIN CONTENT ENDS-->

<!--SIDEBAR CONTENT STARTS-->
	<div class="SubpageBoxSubSm">
		<div class="SubpageBoxSubSmContent">
			
			

			<div class="ProfileImg">
				
				<a href="/bios/dave_paquette">
				
					<img src='/images/avatars/DavePaquette_241x241.jpg' />
				
				</a>
				
			</div>

			<BR clear="all">

			<h2><a href="/bios/dave_paquette">Dave Paquette</a></h2>
			
			<a href="mailto:contactme@davepaquette.com"><img class="ProfileIcon" src="/images/icon_email.png" border="0" alt="Email" title="Email"> Email</a><BR>
			
			
			<a href="http://www.davepaquette.com/" target="_blank"><img class="ProfileIcon" src="/images/icon_web.png" border="0" alt="Web" title="Web"> Web</a><BR>
			
			
			<a href="http://twitter.com/Dave_Paquette" target="_blank"><img class="ProfileIcon" src="/images/icon_twitter.png" border="0" alt="Twitter" title="Twitter"> Twitter</a><BR>
			
			
			<a href="https://github.com/dpaquette" target="_blank"><img class="ProfileIcon" src="/images/icon_github.png" border="0" alt="GitHub" title="GitHub"> GitHub</a><br>
			
			
			
 			<a href="/feeds/dave_paquette.xml"><img class="ProfileIcon" src="/images/icon_subscribe.png" /> RSS</a>
			

			<hr />
			<h4>Looking for someone else?</h4>
			<p>You can find the rest of the Western Devs Crew <a href="/whoweare">here</a>.</p>
		</div>
	</div>
<!--SIDEBAR CONTENT ENDS-->


</div>
</center>
<!--PAGE CONTENT ENDS-->


<!--FOOTER STARTS-->
<center>
  <div class="FooterBarTxt">&copy; 2015 Western Devs. All Rights Reserved. Design by <a href="http://www.karenchudobiak.ca" target="_blank">Karen Chudobiak, Graphic Designer</a></div>
</center>
<!--FOOTER ENDS-->

<!-- NAV FOOTER STARTS -->
<div class="NavFooter">
  <a href="/posts" alt="Posts"><i class="fa fa-newspaper-o fa-2x"></i><span>Posts</span></a>
  <a href="/podcasts" alt="Podcasts"><i class="fa fa-volume-up fa-2x"></i><span>Podcasts</span></a>
  <a href="/whoweare" alt="About"><i class="fa fa-star fa-2x"></i><span>About</span></a>
  <a href="/whatwevedone" alt="What We've Done"><i class="fa fa-trophy fa-2x"></i><span>Work</span></a>
  <a href="/speaking" alt="Speaking"><i class="fa fa-comment-o fa-2x fa-flip-horizontal"></i><span>Speaking</span></a>
</div>
<!-- NAV FOOTER ENDS -->




</div>
<!--WRAPPER ENDS-->


<script>
  var disqus_shortname = 'westerndevs';
  
  var disqus_url = 'https://westerndevs.com/Application-Insights/enhancing-application-insights-request-telemetry/'.replace(".com//", ".com/");
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
  
function shuffle(array) {
  var currentIndex = array.length, temporaryValue, randomIndex;

  // While there remain elements to shuffle...
  while (0 !== currentIndex) {

    // Pick a remaining element...
    randomIndex = Math.floor(Math.random() * currentIndex);
    currentIndex -= 1;

    // And swap it with the current element.
    temporaryValue = array[currentIndex];
    array[currentIndex] = array[randomIndex];
    array[randomIndex] = temporaryValue;
  }

  return array;
}

</script>


</body>

  
<!-- Google Analytics -->
<script type="text/javascript">
if (document.location.hostname.search("westerndevs.com") !== -1 || document.location.hostname.search("www.westerndevs.com") !== -1) {
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-37617956-2', 'auto');

ga('set', 'contentGroup1', 'dave_paquette');

ga('send', 'pageview');
}
</script>
<!-- End Google Analytics -->



</html>
