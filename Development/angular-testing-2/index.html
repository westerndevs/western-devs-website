<!DOCTYPE html>
<html lang="en" xml:lang="en">

  <head>
  
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>Angular Testing Patterns - Leverage Observable | Western Devs</title>
  <meta name="description" content="One of the most challenging parts of testing is finding seams to reduce the scope of tests. Doing so is important because it make your tests smaller and cleaner which makes them more resilient to chan">
<meta property="og:type" content="article">
<meta property="og:title" content="Angular Testing Patterns - Leverage Observable">
<meta property="og:url" content="https://westerndevs.com/Development/angular-testing-2/index.html">
<meta property="og:site_name" content="Western Devs">
<meta property="og:description" content="One of the most challenging parts of testing is finding seams to reduce the scope of tests. Doing so is important because it make your tests smaller and cleaner which makes them more resilient to chan">
<meta property="article:published_time" content="2018-02-21T19:38:30.000Z">
<meta property="article:modified_time" content="2022-03-16T11:52:25.035Z">
<meta property="article:author" content="Western Devs">
<meta property="article:tag" content="Testing">
<meta property="article:tag" content="Angular">
<meta name="twitter:card" content="summary">
<meta name="twitter:creator" content="@westerndevs">

    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="title" content="WesternDevs">   
    <meta name="keywords" content="software development,software,asp.net,blog">
    <meta name="description" content="We're all west of somewhere">
    <meta name="copyright" content="WesternDevs">
    <meta name="revisit-after" content="15 days">
    <meta name="robots" content="all">
    <meta name="MSSmartTagsPreventParsing" content="true">
  
  
    <link rel="alternate" href="/feed.xml" title="Western Devs" type="application/atom+xml">
  
  
<link rel="stylesheet" href="/css/style.css">

      
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <script src="//code.jquery.com/jquery-1.11.3.min.js"></script>  
  <meta name="generator" content="Hexo 4.2.1"></head>

<body>

<!-- FIXED HEADER BECAUSE SCROLLING -->
<!--HEADER STARTS-->
<div class="WrapperHeader">
<div style="display:inline-block; text-align: center;">
<div class="Header">

  <div class="HeaderLogo">
    <a href="/"><img src="/images/header_logo_transparent.png" alt="WesternDevs" title="WesternDevs" border="0" style="width: 206px; height: 64px;" width="206" height="64"></a>
  </div>

  <div class="HeaderLinks">
      <a href="/posts" class="nav">POSTS</a>       
      <a href="/podcasts" class="nav">PODCASTS</a>       
      <a href="/whoweare" class="nav">ABOUT</a>  
      <a href="/whatwevedone" class="nav">WHAT WE'VE DONE</a>  
      <a href="/speaking" class="nav">SPEAKING</a>
      <div class="HeaderIcons">
        <a href="mailto:info@westerndevs.com"><img src="/images/icon_email.png" border="0" alt="Email" title="Email" height="26" width="26"></a>
        <a href="/feed.xml"><img src="/images/icon_subscribe.png" border="0" alt="Subscribe" title="Subscribe" height="26" width="27"></a>
        <a href="http://twitter.com/westerndevs" target="_blank"><img src="/images/icon_twitter.png" border="0" alt="Twitter" title="Twitter" height="26" width="27"></a>
        <a href="http://github.com/westerndevs" target="_blank"><img src="/images/icon_github.png" border="0" alt="GitHub" title="GitHub" height="26" width="27"></a>     
      </div>
  </div>
  
</div>
</div>
</div>
<!--HEADER ENDS-->    



<!--WRAPPER STARTS-->
<div class="Wrapper" style="">

<!--SUBHEAD STARTS-->
<div class="WrapperSubHeaderSubpage">
<center>
	<div class="SubHeader">
		<H1 class="title"><img class="icon" src="/images/icon_posts.png" alt="POST" title="POST" border="0"> POST</H1>
	</div>
</center>
</div>
<!--SUBHEAD ENDS-->

<!--PAGE CONTENT STARTS-->
<center>
<div class="WrapperContent">

<!--MAIN CONTENT STARTS-->
	<div class="SubpageBoxSubLrg">
		<div class="SubpageBoxSubLrgContent">
		    <div class='postTitle'>
  <div class="ListLrgDateBG">
    <div class="ListLrgDateMonth">FEB</div>
    <div class="ListLrgDateDay">21</div>
    <div class="ListLrgDateYear">2018</div>
  </div>
  <h2>Angular Testing Patterns - Leverage Observable</h2>
</div>

		    

			<div id="mainPostContent">
	        <p>One of the most challenging parts of testing is finding seams to reduce the scope of tests. Doing so is important because it make your tests smaller and cleaner which makes them more resilient to changes in the rest of your code base. Testing isn't helping you if every minor change breaks dozens of interconnected tests. Angular's heavy use of Observable provides us a great seam.</p>
<a id="more"></a>
<p>This post is part two of a series on angular testing. You can check out the other posts here:</p>
<ol>
<li><a href="/Development/angular-testing-1/">Keep the number of test bed tests to a minimum</a>.</li>
<li>Leverage <code>Observable</code> as a testing seam (this post)</li>
<li>Leverage monkey patching as a testing seam</li>
<li>No matter what anybody says e2e tests still need sleeps</li>
</ol>
<p>Reactive programming is a really nice paradigm which extend the Promise or Task patterns that have become quite popular over the last decade. Instead of returning a single value upon completion as Promises do an observable allows subscriptions which are handlers executed every time a value is returned from the observable.</p>
<p>I have seen a lot of people who ignore the complexity of observables by simply converting to a promise using <code>toPromise</code> but this ignores some of the really cool things you can do with promises. For instances if I have a component that requires talking to multiple HTTP endpoints I'll <a href="http://reactivex.io/documentation/operators/zip.html" target="_blank" rel="noopener">zip</a> the responses together so that the rendering doesn't happen until all the requests are complete. There are a ton of other cool patters you can use if you stick with observables.</p>
<p>Anyway, I'm not currently here to sell you on RxJS (it <em>is</em> awesome) but tell you how you can use observables to act as a good seam to limit the scope of your tests.</p>
<p>Let's look at a snippet of a component that makes use of observables and see how to shim in tests.</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">constructor</span>(<span class="params"><span class="keyword">private</span> vendorService: VendorService, </span></span><br><span class="line"><span class="params">            <span class="keyword">private</span> deviceViewService: DeviceViewService, </span></span><br><span class="line"><span class="params">            <span class="keyword">private</span> originsService: OriginsService</span>)&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ngOnInit() &#123;</span><br><span class="line">    <span class="keyword">this</span>.vendorService.get().subscribe(<span class="function">(<span class="params">v: Vendor[]</span>) =&gt;</span> <span class="keyword">this</span>.vendors = v);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.deviceViewService.getDevices().subscribe(<span class="function"><span class="params">devices</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.devices = devices;</span><br><span class="line">      activateDevices();</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> originsObservable = <span class="keyword">this</span>.originsService.getOrigins();</span><br><span class="line">    <span class="keyword">let</span> destinationsObservable = <span class="keyword">this</span>.originsService.getDestinations();</span><br><span class="line">    Observable.zip(originsObservable, destinationsObservable, <span class="function">(<span class="params">origins: Origin[], destinations: Destination[]</span>)=&gt;</span>[origins,destinations])</span><br><span class="line">        .subscribe(<span class="function">(<span class="params">result</span>)=&gt;</span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.setupOriginsAndDestinations(result);</span><br><span class="line">        &#125;);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>Here we have 4 observables which complete in various ways. The first, <code>vendorService.get()</code>, simply assigns vendors to an existing variable. The devices observable does the same but also calls a function and, finally, the last two observables are synchronized via a zip operator. It looks like a lot is going on here but we can isolate things to test easily.</p>
<p>First up we want to test to make sure that whatever is returned by the vendor service is properly assigned to the vendors collection. We can us a combination of mocks and observables to focus just on the vendor service like so
(I'm using <a href="https://github.com/NagRock/ts-mockito" target="_blank" rel="noopener">ts-mockito</a>'s mocking syntax here):</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">describe(<span class="string">'Demo Component'</span>, () =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    it(<span class="string">'should set vendors'</span>, () =&gt; &#123;</span><br><span class="line">        <span class="comment">//arrange</span></span><br><span class="line">        <span class="keyword">let</span> mockVendorService = mock(VendorService);</span><br><span class="line">        <span class="keyword">let</span> vendors = [&#123;<span class="string">'id'</span>: <span class="number">1</span>, <span class="attr">name</span>: <span class="string">'Vendor ABC'</span>&#125;];</span><br><span class="line">        when(mockVendorService.get()).thenReturn(Observable.from([vendors]));</span><br><span class="line">        <span class="keyword">let</span> mockDeviceViewService = mock(DeviceViewService);</span><br><span class="line">        when(mockDeviceViewService.getDevices()).thenReturn(Observable.from([]));</span><br><span class="line">        <span class="keyword">let</span> mockOriginsService = mock(OriginsService);</span><br><span class="line">        when(mockOriginsService.getOrigins()).thenReturn(Observable.from([]));</span><br><span class="line">        when(mockOriginsService.getDestinations()).thenReturn(Observable.from([]));</span><br><span class="line">        <span class="keyword">let</span> sut = <span class="keyword">new</span> DemoComponent(instance(mockVendorService), instance(mockDeviceService), instance(mockOriginsService));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//act</span></span><br><span class="line">        sut.ngOnInit();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//assert</span></span><br><span class="line">        expect(sut.vendors).to.equal(vendors);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>As you can see we set up the mocks to return either an <code>Observable</code> with a single result to test the code or with an empty result to never trigger the subscriptions to that observable. So even though the ngOnInit is quite complex the testing doesn't have to be.</p>
<p>Let's look at one more example for the zip case</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">it(<span class="string">'origins and destinations being complete should trigger setup'</span>, () =&gt; &#123;</span><br><span class="line">        <span class="comment">//arrange</span></span><br><span class="line">        <span class="keyword">let</span> mockVendorService = mock(VendorService);</span><br><span class="line">        when(mockVendorService.get()).thenReturn(Observable.from([]));</span><br><span class="line">        <span class="keyword">let</span> mockDeviceViewService = mock(DeviceViewService);</span><br><span class="line">        when(mockDeviceViewService.getDevices()).thenReturn(Observable.from([]));</span><br><span class="line">        <span class="keyword">let</span> mockOriginsService = mock(OriginsService);</span><br><span class="line">        <span class="keyword">let</span> origins = [&#123;<span class="string">'id'</span>: <span class="number">1</span>, <span class="attr">name</span>: <span class="string">'Origin ABC'</span>&#125;];</span><br><span class="line">        when(mockOriginsService.getOrigins()).thenReturn(Observable.from([origins]));</span><br><span class="line">        <span class="keyword">let</span> destinations = [&#123;<span class="string">'id'</span>: <span class="number">1</span>, <span class="attr">name</span>: <span class="string">'Destination ABC'</span>&#125;];</span><br><span class="line">        when(mockOriginsService.getDestinations()).thenReturn(Observable.from([destinations]));</span><br><span class="line">        <span class="keyword">let</span> sut = <span class="keyword">new</span> DemoComponent(instance(mockVendorService), instance(mockDeviceService), instance(mockOriginsService));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> didWork = <span class="literal">false</span>;</span><br><span class="line">        sut.setupOriginsAndDestinations = <span class="function">(<span class="params">passedOrigins, passedDestinations</span>) =&gt;</span> &#123;</span><br><span class="line">            didWork = passedOrigins === origins &amp;&amp; passedDestinations === destinations;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//act</span></span><br><span class="line">        sut.ngOnInit();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//assert</span></span><br><span class="line">        expect(didWork).to.be.true;</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>
<p>You might also have equivalent tests to ensure that just completing one or the other of <code>getOrigins</code> and <code>getDestinations</code> doesn't cause the setup to be fired.</p>
<p>The crux of this post is that observables provide for a nice place to hook into tests because you can use them to isolate large chunks of subscription code or exercise that code with arbitrary values. The more seams you have the easier testing becomes.</p>
<p>I already gave away a bit of the third post in this series when I overrode the setup method in the last example: this is called monkey patching and it is slick beans for isolating code to test.</p>

	        </div>

            
            <section id="comments">
            <div id="disqus_thread">
                <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript" target="_blank" rel="noopener">comments powered by Disqus.</a></noscript>
            </div>
            </section>
            
		</div>
	</div>
<!--MAIN CONTENT ENDS-->

<!--SIDEBAR CONTENT STARTS-->
	<div class="SubpageBoxSubSm">
		<div class="SubpageBoxSubSmContent">
			
			

			<div class="ProfileImg">
				
				<a href="/bios/simon_timms">
				
					<img src='/images/avatars/simon.jpg' />
				
				</a>
				
			</div>

			<BR clear="all">

			<h2><a href="/bios/simon_timms">Simon Timms</a></h2>
			
			<a href="mailto:stimms@gmail.com"><img class="ProfileIcon" src="/images/icon_email.png" border="0" alt="Email" title="Email"> Email</a><BR>
			
			
			<a href="http://blog.simontimms.com/" target="_blank"><img class="ProfileIcon" src="/images/icon_web.png" border="0" alt="Web" title="Web"> Web</a><BR>
			
			
			<a href="http://twitter.com/stimms" target="_blank"><img class="ProfileIcon" src="/images/icon_twitter.png" border="0" alt="Twitter" title="Twitter"> Twitter</a><BR>
			
			
			<a href="https://github.com/stimms" target="_blank"><img class="ProfileIcon" src="/images/icon_github.png" border="0" alt="GitHub" title="GitHub"> GitHub</a><br>
			
			
			
 			<a href="/feeds/simon_timms.xml"><img class="ProfileIcon" src="/images/icon_subscribe.png" /> RSS</a>
			

			<hr />
			<h4>Looking for someone else?</h4>
			<p>You can find the rest of the Western Devs Crew <a href="/whoweare">here</a>.</p>
		</div>
	</div>
<!--SIDEBAR CONTENT ENDS-->


</div>
</center>
<!--PAGE CONTENT ENDS-->


<!--FOOTER STARTS-->
<center>
  <div class="FooterBarTxt">&copy; 2015 Western Devs. All Rights Reserved. Design by <a href="http://www.karenchudobiak.ca" target="_blank">Karen Chudobiak, Graphic Designer</a></div>
</center>
<!--FOOTER ENDS-->

<!-- NAV FOOTER STARTS -->
<div class="NavFooter">
  <a href="/posts" alt="Posts"><i class="fa fa-newspaper-o fa-2x"></i><span>Posts</span></a>
  <a href="/podcasts" alt="Podcasts"><i class="fa fa-volume-up fa-2x"></i><span>Podcasts</span></a>
  <a href="/whoweare" alt="About"><i class="fa fa-star fa-2x"></i><span>About</span></a>
  <a href="/whatwevedone" alt="What We've Done"><i class="fa fa-trophy fa-2x"></i><span>Work</span></a>
  <a href="/speaking" alt="Speaking"><i class="fa fa-comment-o fa-2x fa-flip-horizontal"></i><span>Speaking</span></a>
</div>
<!-- NAV FOOTER ENDS -->




</div>
<!--WRAPPER ENDS-->


<script>
  var disqus_shortname = 'westerndevs';
  
  var disqus_url = 'https://westerndevs.com/Development/angular-testing-2/'.replace(".com//", ".com/");
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
  
function shuffle(array) {
  var currentIndex = array.length, temporaryValue, randomIndex;

  // While there remain elements to shuffle...
  while (0 !== currentIndex) {

    // Pick a remaining element...
    randomIndex = Math.floor(Math.random() * currentIndex);
    currentIndex -= 1;

    // And swap it with the current element.
    temporaryValue = array[currentIndex];
    array[currentIndex] = array[randomIndex];
    array[randomIndex] = temporaryValue;
  }

  return array;
}

</script>


</body>

  
<!-- Google Analytics -->
<script type="text/javascript">
if (document.location.hostname.search("westerndevs.com") !== -1 || document.location.hostname.search("www.westerndevs.com") !== -1) {
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-37617956-2', 'auto');

ga('set', 'contentGroup1', 'simon_timms');

ga('send', 'pageview');
}
</script>
<!-- End Google Analytics -->



</html>
