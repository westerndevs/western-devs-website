<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Western Devs</title>
  
  <link href="/feed.xml" rel="self" type="application/atom+xml"/>
  <link href="https://westerndevs.com" rel="alternate" type="application/atom+xml"/>
  
  <updated>2020-11-09T21:27:02.250Z</updated>
  <id>https://westerndevs.com/</id>
  
  <author>
    <name>Western Devs</name>
	<uri>https://westerndevs.com</uri>
    <email>info@westerndevs.com</email>
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title type="html">Running Stored Procedures Across Databases in Azure</title>
    <link href="https://westerndevs.com//cross-database-procs/" rel="alternate" type="text/html"/>
    <id>https://westerndevs.com//cross-database-procs/</id>
    <published>2020-11-09T19:00:00.000Z</published>
    <updated>2020-11-09T21:27:02.250Z</updated>
	<author>
	
	  
	  <name>Simon Timms</name>
	  <email>stimms@gmail.com</email>
	
	  <uri>https://westerndevs.com</uri>
	</author>
    
    <content type="html"><![CDATA[<p>In a <a href="https://blog.simontimms.com/2020/11/05/2020-11-05-cross-database-queries/" target="_blank" rel="noopener">previous article</a> I talked about how to run queries across database instances on Azure using ElasticQuery. One of the limitations I talked about was the in ability to update data in the source database. Well that isn't entirely accurate. You can do it if you make use of stored procedures.</p><a id="more"></a><p>Running a stored proc on a remote database is a little bit weird looking but once you get your head around that then it is perfectly usable. Let's go back to the same example we used before with a products database an an orders database. In the products database let's add a stored procedure to add a new product and return the count of products.</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> addProduct</span><br><span class="line"> @item <span class="keyword">nvarchar</span>(<span class="number">50</span>)</span><br><span class="line"><span class="keyword">as</span></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Products(<span class="keyword">name</span>) <span class="keyword">values</span>(@item);</span><br><span class="line"><span class="keyword">select</span> <span class="keyword">count</span>(*) cnt <span class="keyword">from</span> products;</span><br><span class="line">go</span><br></pre></td></tr></table></figure><p>Now over in our orders database we can use our existing database connection to call this stored proc</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sp_execute_remote ProductsSource, </span><br><span class="line">                  N'addProduct @item', </span><br><span class="line">                  @params = N'@item nvarchar(50)', </span><br><span class="line">                  @item = 'long sleeved shirts';</span><br></pre></td></tr></table></figure><p>At first glance this is a little confusing so let's break it down.</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sp_execute_remote ProductsSource,</span><br></pre></td></tr></table></figure><p>This line instructs that we want to run a stored procedure and that it should use the ProductsSource data connection.</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">N'addProduct @item',</span><br></pre></td></tr></table></figure><p>This line lists the stored proc to run and the parameters to pass to it. You'll notice that it is a NVarchar string passed as a single parameter.</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@params = N'@item nvarchar(50)',</span><br></pre></td></tr></table></figure><p>This line lists all the parameters to pass and their type. If you have multiple then you'd comma separate them here: <code>N'@item nvarchar(50), @price number(10,2)'</code></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">@item</span> = <span class="string">'long sleeved shirts'</span>;</span><br></pre></td></tr></table></figure><p>This final line is an args-style array of the values for the parameters. Again if you had a second parameter you'd pass it in as separate item here <code>@item = 'long sleeved shirts', @price=10.99</code></p><p>Running this command gets us something like</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cnt  <span class="variable">$ShardName</span></span><br><span class="line">6  [<span class="attribute">DataSource</span>=testias.database.windows.net <span class="attribute">Database</span>=testias]</span><br></pre></td></tr></table></figure><p>You'll notice that nifty ShardName colum which tells you about the source. This is because you can use a shard map to execute the stored procedure against lots of shards at once.</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;In a &lt;a href=&quot;https://blog.simontimms.com/2020/11/05/2020-11-05-cross-database-queries/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;previous article&lt;/a&gt; I talked about how to run queries across database instances on Azure using ElasticQuery. One of the limitations I talked about was the in ability to update data in the source database. Well that isn&#39;t entirely accurate. You can do it if you make use of stored procedures.&lt;/p&gt;
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title type="html">New Artwork and a Complete Rewrite...ish | Out the Door Devlog</title>
    <link href="https://westerndevs.com/devlog/out-the-door/out-the-door-post-jam-update/" rel="alternate" type="text/html"/>
    <id>https://westerndevs.com/devlog/out-the-door/out-the-door-post-jam-update/</id>
    <published>2020-11-09T14:00:00.000Z</published>
    <updated>2020-11-09T21:27:02.250Z</updated>
	<author>
	
	  
	  <name>David Wesst</name>
	  <email>questions@davidwesst.com</email>
	
	  <uri>https://westerndevs.com</uri>
	</author>
    
    <content type="html"><![CDATA[<p>My effort continues on Out the Door with some new artwork, a rewrite (of sorts) to fix the build process, which has led to something of a self-driven code review.</p><a id="more"></a><iframe width="560" height="315" src="https://www.youtube.com/embed/LLXO-6Pretk" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe><h2>Wanna Play?</h2><p>Sure you do! Head over to my <a href="https://davidwesst.itch.io/out-the-door" target="_blank" rel="noopener">davidwesst.itch.io/out-the-door</a> to give it a whirl in your browser (no install needed) or Windows! It's totally free, and feedback is always appreciated.</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;My effort continues on Out the Door with some new artwork, a rewrite (of sorts) to fix the build process, which has led to something of a self-driven code review.&lt;/p&gt;
    
    </summary>
    
      <category term="devlog" scheme="https://westerndevs.com/categories/devlog/"/>
    
      <category term="out the door" scheme="https://westerndevs.com/categories/devlog/out-the-door/"/>
    
    
      <category term="game development" scheme="https://westerndevs.com/tags/game-development/"/>
    
      <category term="gamejam" scheme="https://westerndevs.com/tags/gamejam/"/>
    
      <category term="ludum dare" scheme="https://westerndevs.com/tags/ludum-dare/"/>
    
      <category term="ludum dare 47" scheme="https://westerndevs.com/tags/ludum-dare-47/"/>
    
      <category term="game design" scheme="https://westerndevs.com/tags/game-design/"/>
    
      <category term="out the door" scheme="https://westerndevs.com/tags/out-the-door/"/>
    
  </entry>
  
  <entry>
    <title type="html">Azure Processor Limits</title>
    <link href="https://westerndevs.com//processor-limits/" rel="alternate" type="text/html"/>
    <id>https://westerndevs.com//processor-limits/</id>
    <published>2020-11-05T20:00:00.000Z</published>
    <updated>2020-11-09T21:27:02.250Z</updated>
	<author>
	
	  
	  <name>Simon Timms</name>
	  <email>stimms@gmail.com</email>
	
	  <uri>https://westerndevs.com</uri>
	</author>
    
    <content type="html"><![CDATA[<p>Ran into a fun little quirk in Azure today. We wanted to allocate a pretty beefy machine, an M32ms. Problem was that for the region we were looking at it wasn't showing up on our list of VM sizes. We checked and there were certainly VMs of that size available in the region we just couldn't see them. So we ran the command</p><figure class="highlight dsconfig"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">az </span><span class="string">vm </span><span class="built_in">list-usage</span> <span class="built_in">--location</span> <span class="string">"westus"</span> <span class="built_in">--output</span> <span class="string">table</span></span><br></pre></td></tr></table></figure><p>And that returned a bunch of information about the quota limits we had in place. Sure enough in there we had</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Name</span>                               <span class="keyword">Current</span> <span class="keyword">Value</span>   <span class="keyword">Limit</span></span><br><span class="line">Standard MS <span class="keyword">Family</span> vCPUs           <span class="number">0</span>               <span class="number">0</span></span><br></pre></td></tr></table></figure><p>We opened a support request to increase the quota on that CPU. We also had a weirdly low limit on CPUs in the region</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Total Regional vCPUs               <span class="number">0</span>               <span class="number">10</span></span><br></pre></td></tr></table></figure><p>Which support fixed for us too and we were then able to create the VM we were looking for.</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Ran into a fun little quirk in Azure today. We wanted to allocate a pretty beefy machine, an M32ms. Problem was that for the region we we
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title type="html">Querying Across Databases In SQL Azure</title>
    <link href="https://westerndevs.com//elasticquery/" rel="alternate" type="text/html"/>
    <id>https://westerndevs.com//elasticquery/</id>
    <published>2020-11-05T19:00:00.000Z</published>
    <updated>2020-11-09T21:27:02.250Z</updated>
	<author>
	
	  
	  <name>Simon Timms</name>
	  <email>stimms@gmail.com</email>
	
	  <uri>https://westerndevs.com</uri>
	</author>
    
    <content type="html"><![CDATA[<p>I seem to be picking up a few projects lately which require migrating data up to Azure SQL from an on premise database. One of the things that people tend to do when they have on premise databases is query across databases or link servers together. It is a really tempting prospect to be able to query the <code>orders</code> database from the <code>customers</code> database. There are, of course, numerous problems with taking this approach not the least of which is making it very difficult to change database schema. We have all heard that it is madness to integrate applications at the database level and that's one of the reasons.</p><a id="more"></a><p>Unfortunately, whacking developers with a ruler and making them rewrite their business logic to observe proper domain boundaries isn't always on the cards. This is a problem when migrating them to SQL Azure because querying across databases, even ones on the same server, isn't permitted.</p><p><img src="https://blog.simontimms.com/images/elasticquery/brokenQuery.png" alt="Broken query across databases"></p><p>This is where the new <a href="https://docs.microsoft.com/en-us/azure/azure-sql/database/elastic-query-overview" target="_blank" rel="noopener">Elastic Query</a> comes in. I should warn at this point that the functionality is still in preview but it's been in preview for a couple of years so I think it is pretty stable. I feel a little bit disingenuous describing it as &quot;new&quot; now but it is new to me. To use it is pretty easy and doesn't even need you to use the Azure portal.</p><p>Let's imagine that you have two databases one of which contains a collection of Products and a second database that contains a list of Orders which contain just the product id. Your mission is to query and get a list of orders and the product name. To start we can set up a couple of databases. I called mine <code>testias</code> and <code>testias2</code> and I had them both on the same instance of SQL Azure but you don't have to.</p><p><img src="https://blog.simontimms.com/images/elasticquery/setup.png" alt="Two databases on the same server"></p><h2>Product Database</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> Products( </span><br><span class="line"><span class="keyword">id</span> uniqueidentifier primary <span class="keyword">key</span> <span class="keyword">default</span> newid(),</span><br><span class="line"><span class="keyword">name</span> <span class="keyword">nvarchar</span>(<span class="number">50</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Products(<span class="keyword">name</span>) <span class="keyword">values</span>(<span class="string">'socks'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Products(<span class="keyword">name</span>) <span class="keyword">values</span>(<span class="string">'hats'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Products(<span class="keyword">name</span>) <span class="keyword">values</span>(<span class="string">'gloves'</span>);</span><br></pre></td></tr></table></figure><h2>Orders Database</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> orders(<span class="keyword">id</span> uniqueidentifier primary <span class="keyword">key</span> <span class="keyword">default</span> newid(),</span><br><span class="line"><span class="built_in">date</span> <span class="built_in">date</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> orderLineItems(<span class="keyword">id</span> uniqueidentifier primary <span class="keyword">key</span> <span class="keyword">default</span> newid(),</span><br><span class="line">orderId uniqueidentifier,</span><br><span class="line">productId uniqueidentifier,</span><br><span class="line">quantity <span class="built_in">int</span>,</span><br><span class="line"><span class="keyword">foreign</span> <span class="keyword">key</span> (orderId) <span class="keyword">references</span> orders(<span class="keyword">id</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">declare</span> @orderID uniqueidentifier = newid();</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> orders(<span class="keyword">id</span>, <span class="built_in">date</span>)</span><br><span class="line"><span class="keyword">values</span>(@orderID, <span class="string">'2020-11-01'</span>);</span><br><span class="line"> </span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> orderLineItems(orderId, productId, quantity) <span class="keyword">values</span>(@orderID, <span class="string">'3829A43D-FD2A-4B7C-9A09-23DBF030C1DC'</span>, <span class="number">10</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> orderLineItems(orderId, productId, quantity) <span class="keyword">values</span>(@orderID, <span class="string">'233BC430-BA3F-4F5C-B3EA-4B82867FC040'</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> orderLineItems(orderId, productId, quantity) <span class="keyword">values</span>(@orderID, <span class="string">'95A20D82-EC26-4769-8840-804B88630A01'</span>, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">set</span> @orderId = newid();</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> orders(<span class="keyword">id</span>, <span class="built_in">date</span>)</span><br><span class="line"><span class="keyword">values</span>(@orderID, <span class="string">'2020-11-02'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> orderLineItems(orderId, productId, quantity) <span class="keyword">values</span>(@orderID, <span class="string">'3829A43D-FD2A-4B7C-9A09-23DBF030C1DC'</span>, <span class="number">16</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> orderLineItems(orderId, productId, quantity) <span class="keyword">values</span>(@orderID, <span class="string">'233BC430-BA3F-4F5C-B3EA-4B82867FC040'</span>, <span class="number">99</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> orderLineItems(orderId, productId, quantity) <span class="keyword">values</span>(@orderID, <span class="string">'95A20D82-EC26-4769-8840-804B88630A01'</span>, <span class="number">0</span>);</span><br></pre></td></tr></table></figure><p>Now we need to hook up the databases to be able to see each other. We're actually just going to make products visible from the orders database. It makes more sense to me to run these queries in the database which contains the most data to minimize how much data needs to cross the wire to the other database.</p><p>So first up we need to tell the Orders database about the credentials needed to access the remote database, products. To do this we need to use a SQL account on the products database. Windows accounts and integrated security doesn't currently work for this.</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">master</span> <span class="keyword">key</span> encryption <span class="keyword">by</span> <span class="keyword">password</span> = <span class="string">'monkeyNose!2'</span>;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">database</span> scoped credential ProductDatabaseCredentials </span><br><span class="line"><span class="keyword">with</span> <span class="keyword">identity</span> = <span class="string">'ProductsDBUser'</span>, </span><br><span class="line">secret = <span class="string">'wouNHk41l9fBBcqadwWiq3ert'</span>;</span><br></pre></td></tr></table></figure><p>Next we set up an external data source for the products</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">external</span> <span class="keyword">data</span> <span class="keyword">source</span> ProductsSource <span class="keyword">with</span> </span><br><span class="line">(<span class="keyword">type</span>=RDBMS, location = <span class="string">'testias.database.windows.net'</span>, </span><br><span class="line">database_name = <span class="string">'testias'</span>, credential = ProductDatabaseCredentials);</span><br></pre></td></tr></table></figure><p>Finally we create a table definition in the Orders database that matches the remote table (without any defaults or constraints).</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">external</span> <span class="keyword">table</span> Products( <span class="keyword">id</span> uniqueidentifier,</span><br><span class="line"><span class="keyword">name</span> <span class="keyword">nvarchar</span>(<span class="number">50</span>))</span><br><span class="line"><span class="keyword">with</span> ( data_source = ProductsSource)</span><br></pre></td></tr></table></figure><p>We now have a products table in the external tables section in the object explorer</p><p><img src="https://blog.simontimms.com/images/elasticquery/testtableview.png" alt="Tables from both databases"></p><p>We can query the external table and even cross it against the tables in this database</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">name</span>, ol.quantity <span class="keyword">from</span> orderLineItems ol <span class="keyword">inner</span> <span class="keyword">join</span> products p <span class="keyword">on</span> ol.productId = p.id</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">socks   16</span><br><span class="line">socks   10</span><br><span class="line">gloves  1</span><br><span class="line">gloves  99</span><br><span class="line">hats    2</span><br><span class="line">hats    0</span><br></pre></td></tr></table></figure><p>So it is possible to run queries across databases in Azure but it takes a little set up and a little bit of thought about how to best set it up.</p><h1>Possible Gotchas</h1><ul><li>I forgot to set up the database to be able to talk to Azure resources in the firewall so I had to go back and add that</li><li>Inserting to the external table isn't supported, which is good, make the changes directly in the source database</li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;I seem to be picking up a few projects lately which require migrating data up to Azure SQL from an on premise database. One of the things that people tend to do when they have on premise databases is query across databases or link servers together. It is a really tempting prospect to be able to query the &lt;code&gt;orders&lt;/code&gt; database from the &lt;code&gt;customers&lt;/code&gt; database. There are, of course, numerous problems with taking this approach not the least of which is making it very difficult to change database schema. We have all heard that it is madness to integrate applications at the database level and that&#39;s one of the reasons.&lt;/p&gt;
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title type="html">A Solo Gamejam Experience | A Ludum Dare 47 Story</title>
    <link href="https://westerndevs.com/devlog/a-solo-gamejam-experience-ld47/" rel="alternate" type="text/html"/>
    <id>https://westerndevs.com/devlog/a-solo-gamejam-experience-ld47/</id>
    <published>2020-10-23T13:00:00.000Z</published>
    <updated>2020-11-09T21:27:02.250Z</updated>
	<author>
	
	  
	  <name>David Wesst</name>
	  <email>questions@davidwesst.com</email>
	
	  <uri>https://westerndevs.com</uri>
	</author>
    
    <content type="html"><![CDATA[<p>I submitted a game to <a href="https://ldjam.com/events/ludum-dare/47/out-the-door" target="_blank" rel="noopener">Ludum Dare 47</a> I call <a href="https://davidwesst.itch.io/out-the-door" target="_blank" rel="noopener">Out the Door (Play Now in your Browser)</a> as a solo, amateur game developer with a non-gamedev day job, family responsibilities, and household to maintain.</p><!-- more --><iframe width="560" height="315" src="https://www.youtube.com/embed/AFnGMS24qvg" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>]]></content>
    
    <summary type="html">
    
      Wonder what it takes to be a solo amateur game developer in a global gamejam? DW summarizes his Ludum Dare 47 experience in this video.
    
    </summary>
    
      <category term="devlog" scheme="https://westerndevs.com/categories/devlog/"/>
    
    
      <category term="gamedev" scheme="https://westerndevs.com/tags/gamedev/"/>
    
      <category term="game development" scheme="https://westerndevs.com/tags/game-development/"/>
    
      <category term="devlog" scheme="https://westerndevs.com/tags/devlog/"/>
    
      <category term="gamejam" scheme="https://westerndevs.com/tags/gamejam/"/>
    
      <category term="ludum dare" scheme="https://westerndevs.com/tags/ludum-dare/"/>
    
      <category term="github gameoff" scheme="https://westerndevs.com/tags/github-gameoff/"/>
    
  </entry>
  
  <entry>
    <title type="html">The trimStart rabbit hole</title>
    <link href="https://westerndevs.com//typescript-definition/" rel="alternate" type="text/html"/>
    <id>https://westerndevs.com//typescript-definition/</id>
    <published>2020-09-28T18:00:00.000Z</published>
    <updated>2020-11-09T21:27:02.250Z</updated>
	<author>
	
	  
	  <name>Simon Timms</name>
	  <email>stimms@gmail.com</email>
	
	  <uri>https://westerndevs.com</uri>
	</author>
    
    <content type="html"><![CDATA[<p>I was bragging to <a href="https://westerndevs.com/bios/dave_paquette/">David</a> about a particularly impressive piece of TypeScript code I wrote last week</p><figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (body.<span class="keyword">trim</span>().<span class="keyword">startsWith</span>(<span class="string">'&lt;'</span>)) &#123; <span class="comment">//100% infallible xml detection</span></span><br></pre></td></tr></table></figure><p>He, rightly, pointed out that <code>trimStart</code> would probably be more efficient. Of course it would! However when I went to make that change there was only <code>trim</code>, <code>trimLeft</code> and <code>trimRight</code> in my TypeScript auto-complete drop down.</p><p><img src="https://blog.simontimms.com/images/trimStart/missing.png" alt="TrimStart and TrimEnd are missing"></p><p>Odd. This was for sure a real function because it appears in the <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String/trimStart" target="_blank" rel="noopener">MDN docs</a>.</p><p>A reasonable person would have used trimLeft and moved on but it was Monday and I was full of passion for programming. So I went down the rabbit hole.</p><p>Checking out the TypeScript directory in my node_modules I found that there were quite a few definition files in there. These were the definition files that described the JavaScript language itself rather than any libraries. Included in that bunch was one called <code>lib.es2019.string.d.ts</code>. This file contained changes which were made to the language in es2019.</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> String &#123;</span><br><span class="line">    <span class="comment">/** Removes the trailing white space and line terminator characters from a string. */</span></span><br><span class="line">    trimEnd(): <span class="built_in">string</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Removes the leading white space and line terminator characters from a string. */</span></span><br><span class="line">    trimStart(): <span class="built_in">string</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Removes the leading white space and line terminator characters from a string. */</span></span><br><span class="line">    trimLeft(): <span class="built_in">string</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Removes the trailing white space and line terminator characters from a string. */</span></span><br><span class="line">    trimRight(): <span class="built_in">string</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>So I must be targeting the wrong thing! Sure enough in my <code>tsconfig.js</code> I was targeting <code>es5</code> on this project. When we started this was using an older version of node on lambda that didn't have support for more recent versions of ES. I checked and the lambda was running node 12.18.3 and support for ES2020 landed in node 12.9 so I was good to move up to es2020 as a target.</p><p>Incidentally you can check the running node version in JavaScript by running</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="string">'Versions: '</span> + <span class="built_in">JSON</span>.stringify(process.versions));</span><br></pre></td></tr></table></figure><p>After updating my <code>tsconfig.js</code> and restarting the language server all was right in the world.</p><p><img src="https://blog.simontimms.com/images/trimStart/there.png" alt="The missing functions appear"></p>]]></content>
    
    <summary type="html">
    
      If you&#39;re missing expected functions in your TypeScript app the problem might be an incorrect target
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title type="html">Game Portfolio Self Evaluation (in prep for Ludum Dare 47)</title>
    <link href="https://westerndevs.com/devlog/game-portfolio-review-2020/" rel="alternate" type="text/html"/>
    <id>https://westerndevs.com/devlog/game-portfolio-review-2020/</id>
    <published>2020-09-18T13:00:00.000Z</published>
    <updated>2020-11-09T21:27:02.250Z</updated>
	<author>
	
	  
	  <name>David Wesst</name>
	  <email>questions@davidwesst.com</email>
	
	  <uri>https://westerndevs.com</uri>
	</author>
    
    <content type="html"><![CDATA[<p>Ludum Dare 47, a weekend long global gamejam, is coming up in a few weeks. In order to prep for the event, I decided to take the time for review and reflect on my game portfolio to see what I learning objective and goals I can set for myself.</p><iframe width="560" height="315" src="https://www.youtube.com/embed/V_zCHtZIsYw" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe><h2>My Portfolio</h2><p>What was that? You wanted to know where to find and play my games?! Well then, if you're inclined to try some of my games (and hopefully leave some feedback), here they are:</p><ul><li><a href="https://davidwesst.itch.io/vagabondgame" target="_blank" rel="noopener">Vagabond Game</a> -&gt; A top-down Unity based prototype where I learned the technical ropes of putting together a small, game experience, with narrative, graphics, and animation.</li><li><a href="https://davidwesst.itch.io/leaps-and-bounds" target="_blank" rel="noopener">Car Scientist</a> -&gt; My first gamejam submission and evolution of the Vagabond Game prototype, except this time built in Godot.</li><li><a href="https://davidwesst.itch.io/little-shop-of-wall-street" target="_blank" rel="noopener">Little Shop of Wall Street</a> -&gt; My Ludum Dare 46 submission, co-authored by <a href="https://westerndevs.com/bios/darcy_lussier/">D'Arcy Lussier</a> where you trade stocks online in order to feed an interesting plant, before it feeds on YOU!</li></ul>]]></content>
    
    <summary type="html">
    
      Ludum Dare 47, a weekend long global gamejam, is coming up in a few weeks. In order to prep for the event, I decided to take the time for review and reflect on my game portfolio to see what I learning objective and goals I can set for myself.
    
    </summary>
    
      <category term="devlog" scheme="https://westerndevs.com/categories/devlog/"/>
    
    
      <category term="gamedev" scheme="https://westerndevs.com/tags/gamedev/"/>
    
      <category term="game development" scheme="https://westerndevs.com/tags/game-development/"/>
    
      <category term="devlog" scheme="https://westerndevs.com/tags/devlog/"/>
    
      <category term="gamejam" scheme="https://westerndevs.com/tags/gamejam/"/>
    
      <category term="ludum dare" scheme="https://westerndevs.com/tags/ludum-dare/"/>
    
      <category term="github gameoff" scheme="https://westerndevs.com/tags/github-gameoff/"/>
    
  </entry>
  
  <entry>
    <title type="html">Release Notes for Little Shop of Wall Street 0.1.0-beta</title>
    <link href="https://westerndevs.com/devlog/little-shop-of-wall-street-01-release-notes/" rel="alternate" type="text/html"/>
    <id>https://westerndevs.com/devlog/little-shop-of-wall-street-01-release-notes/</id>
    <published>2020-07-02T15:13:00.000Z</published>
    <updated>2020-11-09T21:27:02.250Z</updated>
	<author>
	
	  
	  <name>David Wesst</name>
	  <email>questions@davidwesst.com</email>
	
	  <uri>https://westerndevs.com</uri>
	</author>
    
    <content type="html"><![CDATA[<p>Finally! The 0.1 beta has arrived for Little Shop of Wall Street!</p><p>In this video, DW walks through the new features rolled out both in-game and behind the scenes for his LD46 game jam title.</p><iframe width="560" height="315" src="https://www.youtube.com/embed/baMlNqGgiV4" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe><p>You can play the game here on <a href="https://davidwesst.itch.io/little-shop-of-wall-street" target="_blank" rel="noopener">Itch.io</a>.</p><h2>Side Notes</h2><p>This release is an important one for me.</p><p>First, off it's the first &quot;beta&quot; release which I've categorized as a moderately stable release, and includes a &quot;complete gameplay loop&quot; on purpose. There are still plenty of bugs (as the video even showed) but it works and playable.</p><p>Second, this release is the original vision of what I pictured the gamejam submission to be when D'Arcy and I came up with the idea back in April. Many months later, I have that release which says a lot about my prototyping and experimenting process (i.e. I'm too slow).</p><p>Lastly, I have multiple versions of the game out there including Linux/X11 and Windows versions. There's still a lot more to learn and do with the while devops setup for my projects, but this is a great step forward and can be reused with all my Godot-based projects moving forward.</p><p>Until the next one-- thanks for playing.</p><p>~ DW</p>]]></content>
    
    <summary type="html">
    
      Little Shop of Wall Street has a 0.1-beta release!
    
    </summary>
    
      <category term="devlog" scheme="https://westerndevs.com/categories/devlog/"/>
    
    
      <category term="gamedev" scheme="https://westerndevs.com/tags/gamedev/"/>
    
      <category term="game development" scheme="https://westerndevs.com/tags/game-development/"/>
    
      <category term="devlog" scheme="https://westerndevs.com/tags/devlog/"/>
    
      <category term="little shop of wall street" scheme="https://westerndevs.com/tags/little-shop-of-wall-street/"/>
    
      <category term="godot" scheme="https://westerndevs.com/tags/godot/"/>
    
  </entry>
  
  <entry>
    <title type="html">Scaling Azure Functions from Consumption Plan to Premium Plan (and back again)</title>
    <link href="https://westerndevs.com/Azure/Azure-Functions/scaling-azure-functions-from-consumption-plan-to-premium-hosting-plan/" rel="alternate" type="text/html"/>
    <id>https://westerndevs.com/Azure/Azure-Functions/scaling-azure-functions-from-consumption-plan-to-premium-hosting-plan/</id>
    <published>2020-05-23T16:30:00.000Z</published>
    <updated>2020-11-09T21:27:02.250Z</updated>
	<author>
	
	  
	  <name>Dave Paquette</name>
	  <email>contactme@davepaquette.com</email>
	
	  <uri>https://westerndevs.com</uri>
	</author>
    
    <content type="html"><![CDATA[<p>Azure Functions, when hosted on a consumption plan, are great for most scenarios. You pay per use which is great for keeping costs down but there are some downsides and limitations. One of those is the time it takes to cold start your function app. If your function app hasn't been triggered in some time, it can take a while for the a new instance to start up to run your app. Likewise, if a very sudden spike in load occurs, it can take some time for the consumption plan to start up enough instances to handle that load. In the meantime, you might have clients getting timeouts or failed requests.</p><p>Azure Functions offers another hosting model called <a href="https://docs.microsoft.com/en-us/azure/azure-functions/functions-premium-plan" target="_blank" rel="noopener">Azure Functions Premium Plan</a>. With premium plans, instead of paying per function execution, you pay for the underlying compute instances that are hosting your functions. This is often more expensive, but it also ensures there are always a pre-set number of warmed instances ready to execute your function.</p><p>That's great, but what if I only really need those pre-warmed instances for a short period of time when I'm expecting a lot of incoming traffic. The rest of the time, I would rather use a Consumption Plan to save on hosting costs.</p><p>I thought the choice of hosting plan was something you needed to make up front but it turns out that you can actually move an Azure Function App from a consumption plan to a premium plan (and back again).</p><p>Thanks to <a href="https://twitter.com/stimms/" target="_blank" rel="noopener">Simon Timms</a> for starting this discussion on Twitter. We got very helpful responses from folks on the Azure Functions team:</p><p><a href="https://twitter.com/jeffhollan/" target="_blank" rel="noopener">Jeff Hollan</a> has a great <a href="https://github.com/Azure-Samples/functions-csharp-premium-scaler" target="_blank" rel="noopener">sample</a> using an Azure Durable Function to scale an Azure Function App to a premium plan for a specified amount of time, then automatically scale back down to a consumption plan.</p><blockquote class="twitter-tweet"><p lang="und" dir="ltr"><a href="https://t.co/6C9l3PQDoZ" target="_blank" rel="noopener">https://t.co/6C9l3PQDoZ</a></p>&mdash; Jeff Hollan (@jeffhollan) <a href="https://twitter.com/jeffhollan/status/1245779682961674240?ref_src=twsrc%5Etfw" target="_blank" rel="noopener">April 2, 2020</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script><p>This is a super cool sample. It uses the <a href="https://docs.microsoft.com/en-us/rest/api/resources/" target="_blank" rel="noopener">Azure Resource Manager REST API</a> to make changes to the target function app resources. For my project however, I didn't really want to spin up another Azure Function to manage my Azure Functions. I just wanted an easy way to scale my 12 function apps up to premium plans for a couple hours, then scale them back down to a consumption plan.</p><p>I decided to try using the AZ CLI for this and it turned out really well. I was able to write a simple script to scale up and down.</p><h2>Setting up the AZ CLI</h2><p>First up, <a href="https://docs.microsoft.com/en-us/cli/azure/?view=azure-cli-latest" target="_blank" rel="noopener">install the az cli</a>.</p><p>Once installed, you'll need to login to your Azure Subscription.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">az login</span><br></pre></td></tr></table></figure><p>A browser window will popup, prompting you to log in to your Azure account. Once you've logged in, the browser window will close and the az cli will display a list of subscriptions available in your account. If you have more than one subscription, make sure you select the one you want to use.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">az account <span class="built_in">set</span> --subscription YourSubscriptionId</span><br></pre></td></tr></table></figure><h2>Create a Resource Group</h2><p>You will need a resource group for your Storage and CDN resources. If you don't already have one, create it here.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">az group create --name DavesFunctionApps --location WestUS2</span><br></pre></td></tr></table></figure><p>Most commands will require you to pass in a <code>--resource-group</code> and <code>--location</code> parameters. These parameters are <code>-g</code> and <code>-l</code> for short, but you can save yourself even more keystrokes by setting defaults for <code>az</code>.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">az configure -d group=DavesFunctionApps</span><br><span class="line">az configure -d location=WestUS2</span><br></pre></td></tr></table></figure><h2>Creating a (temporary) Premium Hosting Plan</h2><p>There is a strange requirement with Azure Functions / App Service. As per Jeff Hollan's sample:</p><blockquote><p>The Azure Functions Premium plan is only available in a sub-set of infrastructure in each region. Internally we call these &quot;webspaces&quot; or &quot;stamps.&quot; You will only be able to move your function between plans if the webspace supports both consumption and premium. To make sure your consumption and premium functions land in an enabled webspace you should create a premium plan in a new resource group. Then create a consumption plan in the same resource group. You can then remove the premium plan. This will ensure the consumption function is in a premium-enabled webspace.</p><footer><strong>Jeff Hollan</strong><cite><a href="https://github.com/Azure-Samples/functions-csharp-premium-scaler" target="_blank" rel="noopener">github.com/Azure-Samples/functions-csharp-premium-scaler</a></cite></footer></blockquote><p>First, add an Azure Functions Premium plan to the resource group.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">az functionapp plan create -n dave_temp_premium_plan --sku EP1 --min-instances 1</span><br></pre></td></tr></table></figure><p>You can delete this premium plan using the command below <em>after</em> you've deployed a function app to this resource group . <strong>Don't forget to delete the premium plan. These cost $$$</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">az functionapp plan delete -n dave_temp_premium_plan</span><br></pre></td></tr></table></figure><h2>Creating a Function App</h2><p>There are many options for creating a new function app. I really like the <code>func</code> command line tool which I installed using npm. Check out the <a href="https://github.com/Azure/azure-functions-core-tools" target="_blank" rel="noopener">Azure Functions Core Tools GitHub Repo</a> for details on other options for installing the <code>func</code> tooling.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i -g azure-functions-core-tools@3 --unsafe-perm <span class="literal">true</span></span><br></pre></td></tr></table></figure><p>The focus of this blog post is around scaling a function app. If you don't already have an app built, you can follow along with <a href="https://docs.microsoft.com/azure/azure-functions/functions-run-local?tabs=windows%2Ccsharp%2Cbash" target="_blank" rel="noopener">this walkthrough</a> to create a function app.</p><p>A function app requires a Storage Account resource. An Application Insights resource is also highly recommended as this really simplifies monitoring your function app after it has been deployed. Let's go ahead and create those 2 resources.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">az storage account create -n davefuncappstorage</span><br><span class="line">az extension add -n application-insights</span><br><span class="line">az monitor app-insights component create --app davefuncappinsights</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>Now we can create our Azure Function App resource with a consumption plan, passing in the name of the storage account and app insights resources that we just created. In my case, I'm specifying the dotnet runtime on a Windows host.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">az functionapp create --consumption-plan-location WestUS2 --name davefuncapp123 --os-type Windows --runtime dotnet --storage-account davefuncappstorage --app-insights davefuncappinsights --<span class="built_in">functions</span>-version 3</span><br></pre></td></tr></table></figure><p>Remember to delete that temporary Premium Hosting Plan now!</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">az functionapp plan delete -n dave_temp_premium_plan</span><br></pre></td></tr></table></figure><h3>Deploying your Function App using the az cli</h3><p>This is a bit outside the scope of this blog post but I like using the <code>az</code> cli to deploy my function apps because it's easy to incorporate that into my CI/CD pipelines. Since my app is using the dotnet runtime, I use the <code>dotnet publish</code> command to build the app.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dotnet publish -c release</span><br></pre></td></tr></table></figure><p>Then, zip the contents of the publish folder (<code>bin\release\netcoreapp3.1\publish\</code>).</p><p>In PowerShell:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Compress-Archive -Path .\bin\release\netcoreapp3.1\publish\* -DestinationPath .\bin\release\netcoreapp3.1\package.zip</span><br></pre></td></tr></table></figure><p>or in Bash</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zip -r ./bin/release/netcoreapp3.1/package.zip ./bin/release/netcoreapp3.1/publish/</span><br></pre></td></tr></table></figure><p>Finally, use the <code>az functionapp deployment</code> command to deploy the function app.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">az functionapp deployment <span class="built_in">source</span> config-zip  -n davefuncapp123 --src ./bin/release/netcoreapp3.1/package.zip</span><br></pre></td></tr></table></figure><h2>Scale up to a premium plan</h2><p>Okay, now that we have a functioning (pun intended) app deployed and running on a consumption plan, let's see what it takes to scale this thing up to a premium plan.</p><p>First, create a new Premium Hosting Plan with the parameters that make sense for the load you are expecting. The <code>--sku</code> parameter refers to the size of the compute instance: EP1 is the smallest. The <code>--min-instancs</code> parameter is the number of pre-warmed instances that will always be running for this hosting plan. The <code>--max-burst</code> parameter is the upper bounds on the number of instances that the premium plan can elastically scale out if more instances are needed to handle load.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">az functionapp plan create -n davefuncapp123_premium_plan --sku EP1 --min-instances 4 --max-burst 12</span><br></pre></td></tr></table></figure><p>Next, move the function app to that premium hosting plan.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">az functionapp update --plan davefuncapp123_premium_plan -n davefuncapp123</span><br></pre></td></tr></table></figure><p>That's it! All it took was those 2 command and your function app is now running on a premium plan!</p><h2>Scale back down to a consumption plan</h2><p>Of course, that premium plan isn't cheap. You might only want your function app running on the premium plan for a short period of time. Scaling back down is equally easy.</p><p>First, move the function app back to the consumption based plan. In my case, the name of the consumption plan is <code>WestUS2Plan</code>. You should see a consumption plan in your resource group.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">az functionapp update --plan WestUS2Plan -n davefuncapp123</span><br></pre></td></tr></table></figure><p>Next, delete the premium hosting plan.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">az functionapp plan delete -n davefuncapp123_premium_plan </span><br></pre></td></tr></table></figure><h2>Wrapping it up</h2><p>In this post, we saw how easy it is to move a function app between Premium and Consumption plans. A couple very simple <code>az</code> commands can help you get the performance and features of the Premium plan <em>only</em> when you need it while taking advantages of the simplicity and cost savings of a Consumption plan the rest of the time.</p>]]></content>
    
    <summary type="html">
    
      In this post, we use the az cli to move an Azure Function app from a Consumption Plan to a Premium Plan (and back again).
    
    </summary>
    
      <category term="Azure" scheme="https://westerndevs.com/categories/Azure/"/>
    
      <category term="Azure Functions" scheme="https://westerndevs.com/categories/Azure/Azure-Functions/"/>
    
    
      <category term="Azure" scheme="https://westerndevs.com/tags/Azure/"/>
    
      <category term="Web Dev" scheme="https://westerndevs.com/tags/Web-Dev/"/>
    
      <category term="AZ CLI" scheme="https://westerndevs.com/tags/AZ-CLI/"/>
    
      <category term="Azure Functions" scheme="https://westerndevs.com/tags/Azure-Functions/"/>
    
  </entry>
  
  <entry>
    <title type="html">Kubernetes - My Journey</title>
    <link href="https://westerndevs.com/kubernetes/kubernetes-my-journey/" rel="alternate" type="text/html"/>
    <id>https://westerndevs.com/kubernetes/kubernetes-my-journey/</id>
    <published>2020-05-22T17:00:00.000Z</published>
    <updated>2020-11-09T21:27:02.250Z</updated>
	<author>
	
	  
	  <name>Dave White</name>
	  <email>dmhwhite@gmail.com</email>
	
	  <uri>https://westerndevs.com</uri>
	</author>
    
    <content type="html"><![CDATA[<h1>The Journey</h1><p>This is a series of articles chronicling my learning journey as I was asked to build an IdentityServer4-based authentication system for one of my clients. This story included details about my adoption of Kubernetes, Azure Kubernetes Service, and all the things that I had to do to stand-up this client's new IdentityServer4 authentication implementation.</p><p>As with most learning experiences, I've made mistakes, arrived at working applications, adjusted my implementations, and continued to grow. My hope is that this series will continue to grow and evolve and be a bit of a living series of documents. I'll actively change articles when I discover something new or a better way to describe things. I'll add new articles or maybe alternate paths through the series as new topics present themselves. And I'm certainly not an authority on all of these topics, so as I get feedback from friends and peers, I'll certainly be making adjustments.</p><p>I have two primary goals with this series. Documenting the learning journey is the first one, but the second and almost as important goal was to provide someone (you) with a complete set of steps to get a Kubernetes cluster up and running with an IdentityServer4 implementation running inside of it. Once someone has this platform up and running, they can continue to learn and grow in the same manner that I will but hopefully they're path getting to this point was a little smoother than mine was.</p><p>As always, comments and feedback are encouraged and very welcome.</p><p>Now, on to the articles!</p><h2>Series Table of Contents</h2><ol><li><a href="/kubernetes/kubernetes-my-journey-part-1">Business problems</a></li><li><a href="/kubernetes/kubernetes-my-journey-part-2">Initial Assumptions, Technologies, Learning resources</a></li><li><a href="/kubernetes/kubernetes-my-journey-part-3">Tools in Use</a></li><li><a href="/kubernetes/kubernetes-my-journey-part-4">Building an ASP.NET Core IdentityServer Implementation</a></li><li>Getting Started with Kubernetes - Minikube<ul><li><a href="/kubernetes/kubernetes-my-journey-part-5a">Part A - Getting Started with Kubernetes - Minikube</a></li><li><a href="/kubernetes/kubernetes-my-journey-part-5b">Part B - Getting Started with Kubernetes - Minikube</a></li></ul></li><li><a href="/kubernetes/kubernetes-my-journey-part-6">Pause to reflect</a></li><li>Moving to Azure Kubernetes Service<ul><li><a href="/kubernetes/kubernetes-my-journey-part-7a">Part A - Moving to Azure Kubernetes Service</a></li><li><a href="/kubernetes/kubernetes-my-journey-part-7b">Part B - Moving to Azure Kubernetes Service</a></li></ul></li><li><a href="/kubernetes/kubernetes-my-journey-part-8">Making Your Kubernetes Cluster Publicly Accessible</a></li><li><a href="/kubernetes/kubernetes-my-journey-part-9">Adding Cluster Logging (fluentd)</a></li><li><a href="/kubernetes/kubernetes-my-journey-part-10">Tuning resource usage</a></li></ol><h2>Approach to this series</h2><p>I've decided to break this series into discrete posts to make this easier to write and consume. I'll have specific topics for a post that are aligned with the overall vision, and you'll be able to read the parts that are important to you.</p><p>This series is going to strive to demonstrate work that is completely done. Every bit of code in each post should work and be complete. I'll point out bits of knowledge and wisdom I've learned along the way, but the intention is to give you a working system that you can then alter/re-create and learn from that experience.</p><p>All the code, projects, manifests, etc. are (or will be) in <a href="https://github.com/agileramblings/my-kubernetes-journey" target="_blank" rel="noopener">Github here</a>.</p><p><strong>Enjoy</strong></p><p><strong>Next up:</strong><a href="/kubernetes/kubernetes-my-journey-part-1">Business problems</a></p><style>    h1, h2, h3, h4, h5, h6 {       margin-top: 25px;    }    figure.highlight{        background-color: #E8EEFE;    }    figure.highlight .gutter{        color: #0033CD;    }    figure.highlight pre {        font-family: 'Cascadia Code PL', monospace;    }    code {        font-family: 'Cascadia Code PL', sans-serif;        border-width: 0.1em;        border-color: #E8EEFE;        border-style: solid;        border-radius: 0.3em;        background-color: #E8EEFE;        color: #0033CD;        padding: 0em 0.4em;        white-space: nowrap;    }</style>]]></content>
    
    <summary type="html">
    
      &lt;h1&gt;The Journey&lt;/h1&gt;
&lt;p&gt;This is a series of articles chronicling my learning journey as I was asked to build an IdentityServer4-based authen
    
    </summary>
    
      <category term="kubernetes" scheme="https://westerndevs.com/categories/kubernetes/"/>
    
    
      <category term="kubernetes, azure, aks, identityserver, docker, containers" scheme="https://westerndevs.com/tags/kubernetes-azure-aks-identityserver-docker-containers/"/>
    
  </entry>
  
  <entry>
    <title type="html">Kubernetes - My Journey - Part 1</title>
    <link href="https://westerndevs.com/kubernetes/kubernetes-my-journey-part-1/" rel="alternate" type="text/html"/>
    <id>https://westerndevs.com/kubernetes/kubernetes-my-journey-part-1/</id>
    <published>2020-05-22T16:00:00.000Z</published>
    <updated>2020-11-09T21:27:02.246Z</updated>
	<author>
	
	  
	  <name>Dave White</name>
	  <email>dmhwhite@gmail.com</email>
	
	  <uri>https://westerndevs.com</uri>
	</author>
    
    <content type="html"><![CDATA[<p><a href="/kubernetes/kubernetes-my-journey">Series Table of Contents</a></p><h1>The Business Problem</h1><p>My client has been in business since 1993. As you can imagine, software has been an integral part of their ability to deliver services to their customers. About 10 years ago, they had a re-platforming initiative that was the start of their current monolithic, critical LOB system. It is an ASP.NET MVC 5.x application that has evolved over time and is certainly reaching the limits of what its architecture can provide. It isn't &quot;cloud-native&quot; and it basically continues to be enhanced/evolved based on assumptions that were made 10 years ago.</p><p>For this project, the important part to understand is that it used forms authentication and has a user store internally that manages all of the user accounts and authorization rules. It currently only uses cookies to store authenticated user details on the client and doesn't support any modern sort of token-based activities that are needed for modern applications.</p><p>It is also important to understand that the platform is growing as users and customers demand more modern and specific user experiences. New web applications (React), mobile devices (native), IoT devices, and system-to-system integrations are all being added to the platform and all these new applications need to participate in the authentication scheme. In some cases, new applications have been created but because the current LOB system doesn't support modern authentication techniques, they cloned the existing user store and used the data to implement the appropriate authentication techniques for their specific use case. This has led to a bunch of applications re-implementing their own authentication, with everyone sharing the user store (or a copy of it) of the core LOB system.</p><p>So, the current system has demonstrated a few key problems that the new system needs to address.</p><h3>Security is hard and incredibly important</h3><p>One of the plagues of modern business is bad actors attacking various systems trying to gain access and cause lots of troubles. This is an ever-present problem for most corporations. Security needs to be a first-class citizen in all projects. Using modern authentication platforms that are proven and community-reviewed is seen as a requirement.</p><p>Speaking of security, in this series, you will find a lot of usernames, passwords, and internal details about the systems that is being built. I would ask that you <strong>please take a great deal of care when building your systems!</strong> I'm not worried about presenting these details as I'm tearing all of this down all the time and it won't be left running on my Azure accounts. I will change passwords, usernames, and all kinds of other details to make it harder for anyone to break into a running system. I strongly encourage you to do the same.</p><h3>Decentralized identity management sucks</h3><p>The platform is currently a monolithic LOB system that provides <strong>all</strong> functional aspects for the various business groups. The platform is also growing a collection of loosely related applications that basically represent specific implementations that are tailored for each individual area of the business. All the systems are re-implementing authentication while using, in most cases, a copy of the LOB user store. This basically means that we have multiple user stores that all must be managed independently. There are SSIS workflows trying to keep the right data in sync while not clobbering specific customizations to the user store data.</p><p>This is all complicated, complex, and error prone. We generally don't have a lot of troubles with authentication, but it is expensive and time-consuming to setup and maintain and as new applications are added, it adds more things to manage and has more things that can go wrong.</p><h3>New applications require modern Identity technologies</h3><p>In 2020, business that used to be well-served by a monolithic web application, are finding that this is no longer the case. Native applications, new web applications based on new technologies (SPA), IoT devices and System-to-System integrations all require more modern authentication technologies and these applications are being added to platform ecosystems at an increasing pace.</p><h3>Reduce the costs of running applications</h3><p>One of the overall initiatives for this client is to become more cloud-native and reduce the running costs of applications. There is already an initiative to move all the platform servers to Azure, but we didn't want any new applications continuing the pattern of &quot;lift and shift&quot; used for the existing apps. There is a strong desire to leverage containers (docker) and orchestrators (Kubernetes) at an increasing rate for all the applications in order to reduce overall run costs.</p><h3>Being able to scale up is important</h3><p>As with all businesses, we expect growth. My client is heavily reliant on devices for their current business needs and will be adding customers, native apps, and IoT devices at an ever-increasing rate. This means that having the ability to scale vertically or horizontally needs to be present from the start. Growth was anticipated (pre-COVID19) to be &gt; 30% year over year for the next 3-5 years so there were going to be lots of people and devices needing to use the system in the future.</p><h2>Summary (TL;DR;)</h2><p>Security is hard! De-centralized (read: many) authentication systems are expensive. Old Application are ... well... old! Modern applications need support! Moving to the cloud is happening! And businesses grow!!</p><p>I hope that this gives some context that helps you understand some of the decisions that I'll be sharing in the next section!</p><p><strong>Next up:</strong><a href="/kubernetes/kubernetes-my-journey-part-2">Initial Assumptions, Technologies, Learning resources</a></p><style>    h1, h2, h3, h4, h5, h6 {       margin-top: 25px;    }        figure.highlight{        background-color: #E8EEFE;    }    figure.highlight .gutter{        color: #0033CD;    }    figure.highlight pre {        font-family: 'Cascadia Code PL', monospace;    }    code {        font-family: 'Cascadia Code PL', sans-serif;        border-width: 0.1em;        border-color: #E8EEFE;        border-style: solid;        border-radius: 0.3em;        background-color: #E8EEFE;        color: #0033CD;        padding: 0em 0.4em;        white-space: nowrap;    }</style>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;a href=&quot;/kubernetes/kubernetes-my-journey&quot;&gt;Series Table of Contents&lt;/a&gt;&lt;/p&gt;
&lt;h1&gt;The Business Problem&lt;/h1&gt;
&lt;p&gt;My client has been in busin
    
    </summary>
    
      <category term="kubernetes" scheme="https://westerndevs.com/categories/kubernetes/"/>
    
    
      <category term="kubernetes, azure, aks, identityserver, docker, containers" scheme="https://westerndevs.com/tags/kubernetes-azure-aks-identityserver-docker-containers/"/>
    
  </entry>
  
  <entry>
    <title type="html">Kubernetes - My Journey - Part 2</title>
    <link href="https://westerndevs.com/kubernetes/kubernetes-my-journey-part-2/" rel="alternate" type="text/html"/>
    <id>https://westerndevs.com/kubernetes/kubernetes-my-journey-part-2/</id>
    <published>2020-05-22T15:00:00.000Z</published>
    <updated>2020-11-09T21:27:02.246Z</updated>
	<author>
	
	  
	  <name>Dave White</name>
	  <email>dmhwhite@gmail.com</email>
	
	  <uri>https://westerndevs.com</uri>
	</author>
    
    <content type="html"><![CDATA[<p><a href="/kubernetes/kubernetes-my-journey">Series Table of Contents</a></p><p><strong>Previously:</strong><a href="/kubernetes/kubernetes-my-journey-part-1">Business problems</a></p><h1>Initial Assumptions, Technologies, Learning Resources</h1><p>There are some assumptions that were made before my involvement with this company that made some of this decision making easy. Those assumptions were driven by the business problems we discussed previously.</p><p>Some of these decisions were made by me throughout this project. It was important for me to understand the organization's business, goals, and culture when making these decisions so they weren't as easy to make. The good thing is that I've got a great group of leaders and developers in this organization that helped me and trusted me to make better decisions on their behalf.</p><h2>Pre-defined Assumptions</h2><p>So, there are a bunch of things that we're decided before me arriving on the scene! These decisions governed my initial decision making to just get the project started.</p><h3>We're going to the cloud</h3><p>I'm not sure this needs a lot of elaboration. Everyone is going to the cloud. Owning and operating data centres is hard. Companies like Microsoft, Amazon, and Google have commoditized hardware setup, management, and maintenance so much so that it almost doesn't makes sense to own your own data centre. So, anything I did should strive to be cloud-native.</p><h4>Azure</h4><p>Azure was chosen as the vendor for all our cloud services prior to my involvement. This certainly plays to my strength as a Microsoft-based technologist and an avid Azure user for all my own projects.</p><h4>ASP.NET Core (C#)</h4><p>This company is a Microsoft shop. All the developers are C# developers who are familiar with Microsoft technologies, so it only makes sense that we are going to leverage the existing people and skills that are present in the organization. Using .NET Core and ASP.NET Core 3+ in all projects going forward was made a requirement (and is probably simple common sense) by the assumption of moving to the cloud.</p><p>I couldn't build something that only I could maintain or would require the company to go and try to find new developers or acquire new skills in their current developers. There is going to be a lot of learning being done by everyone here, but we don't need to add to the pile of new stuff to learn.</p><h4>HTTPS</h4><p>One of the things that seems obvious, but turns out isn't always obvious, is the fact that in today's world, we should be using HTTPS everywhere. It has become easier and easier to do this, and part of this project's mandate was to ensure that we accelerated the adoption of HTTPS throughout the deployed platform and make it <em>easier to own and maintain</em>. Simply doing an Identity implementation will drive this.</p><h2>Decisions I made</h2><p>During the planning of this project, I had the flexibility to make a lot of decisions. I didn't make them in isolation, but I did get to make the final decisions.</p><h3>Containers and Orchestration</h3><p>Going to the cloud can be as simple as lift-and-shift. Pick up your server, virtualize it if necessary, and place it in the cloud. In some cases, we can make this even simpler by provisioning a VM with all the pre-installed parts we need and simply deploying our application into that new VM. This is certainly &quot;going to the cloud&quot; but it isn't considered <em>cloud-native</em>.</p><h4>Docker</h4><p>I'm not an expert on what <em>cloud-native</em> entirely means, but I've discerned that one thing you need to do is containers. So today, that means <strong>Docker</strong>. Being a Microsoft shop, going to Azure, using Visual Studio and the az cli as tools, Docker was a no-brainer for a container engine with all the great tool support in Visual Studio, Azure DevOps Server, and the other tools, so I just rolled with it.</p><h4>Kubernetes</h4><p>When using Azure and running containers in the cloud, you have several options. Two easy ones are Azure Container Instances (server-less container hosting) and <strong>Azure Kubernetes Services (aka AKS)</strong>. Since our environment was going to be far more complicated than running a bunch of single containers in the cloud, we needed an orchestration platform. There are two options for that today: Kubernetes and DockerCompose and we chose Kubernetes. The community support for Kubernetes is incredible, the momentum it has in the marketplace can't be denied, and it is natively supported by Azure via the <strong>AKS</strong> product, so it was another easy decision.</p><h3>Cloud-Hosted</h3><p>I sort of covered this one off, but there is an option to stand up your own Kubernetes cluster manually in Azure simply using Virtual Machines. <strong>AKS</strong> effectively took this option off the table. In my experience so far, <strong>AKS</strong> is a polished product, easy to use, and the control plane components are included for free. You simply pay for all the other Azure products that will make up your cluster. These include VMs, Storage, Networking, and any other products you leverage in your implementation.</p><h4>Azure Kubernetes Service (<strong>AKS</strong>)</h4><p><strong>AKS</strong> also makes some of our <em>ability to scale</em> requirements much easier to address. You can scale vertically by dynamically increasing the size of the VMs in the cluster and we can scale horizontally by dynamically adding (or removing) nodes from the cluster.</p><h3>Identity Implementation</h3><p>While this project has many objectives, they key objective for all this work was to deliver a new Identity management implementation to the platform that would enable a secure, modern way for all users, applications, and devices to authenticate with each other.</p><p>One of the underlying cultural desires at this client that I should state is a strong desire to minimize subscriptions and dependencies on 3rd party vendors. This desire precluded us from selecting any of the current Identity providers that exist on the marketplace today. AuthO and Okta are two such companies and while I'm sure they have great products, wedecided to build our own Identity system.</p><h4>IdentityServer4</h4><p>Now, we didn't want to build all the identity system from scratch! That doesn't make sense. We'd have to become experts in OAuth, OpenID Connect, flows, encryption, tokens, and all those technologies that are implemented by great communities out there already. This OSS frameworks are also scrutinized and vetted by the community, so you know that a lot of people care that they are done right. Basically, we wanted to take the best implementation of a security framework in the Microsoft open-source community, host it in our infrastructure, and be able to customize it to our specific use-cases. This led us to IdentityServer4, which is the core technical component of our Identity implementation.</p><h4>Skoruba IdentityServer4 Admin</h4><p>One of the things about identity implementations is that there is a lot of configuration and user data to manage. To be honest, client configuration and user data is one of the biggest PITA about doing Identity work. Once you get it, it isn't so bad but so much of a successful roll-out with an identity platform hinges on getting all this data right. And to do that, it helps to have a good administrative platform.</p><p>While I'd love to have had the time to write an application that gives a good user experience for the administration of this data, I didn't have that time. So, I went looking for something in the community that used IdentityServer4 as a foundational component and added the user experience I wanted. And after several pilots, I found and selected Skoruba IdentityServer4 Admin. This is an ASP.NET Core 3.x web application that provides the Security Token Service (STS), and Administrative Application, and an Administrative API, all in one easy to use package! I've been really happy that I found it.</p><h3>Data Persistence</h3><p>The Skoruba templates allows for the selection of one from three different built-in persistence providers via Entity Framework Core. SqlServer, MySql and Postgres.</p><h4>Postgres</h4><p>Postgres was the database provider the I selected. This reduced our licensing costs, provides the appropriate level of performance and functionality, and with us being in Azure, we always have the option of moving to <strong>Azure Database for PostgreSQL</strong> which has single instance SKU and an HA/Hyperscale SKU if that eventually becomes a needed capability. There is also a ton of community support around the product, which means libraries, documentation, and examples are plentiful.</p><h3>Logging</h3><p>I cannot under-state how important logging is when developing, maintaining, and owning a multi-container environment, spread across multiple servers (nodes) that are hosted in the cloud. This isn't the first and hopefully won't be the last blog post to emphasize this point. The community building cloud-based applications already blogs about this, you've almost certainly read about it somewhere before here, but it still may not have sunk in that, perhaps, this needs to be the first thing you figure out in your new container-based platform. I paid some attention at the beginning, but not enough.</p><h4>Seq - Log Ingestion and Analytics</h4><p>When I first arrived at my client, they were still relying on file-based logging, spread over all the servers in the farm. They had a lot of logging in the application, but it wasn't easily accessible, and it wasn't easy at all to find out what happened across a workflow, sometimes broken, that traversed a bunch of servers.</p><p>The other thing that wasn't possible was querying and basic analytics of the log data that was being generated. It was inconsistent, unstructured, and just barely helping them solve problems.</p><p>At a previous engagement, I had used Splunk and really came to love it! The tool was great. Powerful queries, visualization, dashboard, alerts, integrations! Splunk has it all. There was only one problem. Splunk is expensive. That isn't a problem if your needs justify the spend and you have the required expertise in owning and operating Splunk, but that wasn't the case here, so I needed to find something easier to bring into the ecosystem. This was when I found Seq!</p><p>Seq is a great entry-level tool (that keeps on getting better) for organizations that are just getting started on getting logs into a central product and using that log data to analyze problems and operational aspects of the platform. Seq is built by Datalust.co, who also makes Serilog the .NET library that we use for logging internally in the application. This combination has turned out to be a cost-effective, easy to learn, setup and maintain logging infrastructure for our apps, so it was quite easy for me to bring this into the Identity project and the <strong>Kubernetes (k8s)</strong> infrastructure.</p><h4>Fluentd</h4><p>In addition to the identity applications that are in the <strong>k8s</strong> cluster that will be logging to Seq, the infrastructure applications in the cluster <em>itself</em> will generate an incredible amount of information about its operations and problems. This is a non-trivial log ingestion problem that has been made very approachable with a product called <strong>fluentd</strong>. Built to live inside of <strong>k8s</strong> clusters, fluentd is basically an event processing pipeline implementation that takes events from log files that are written all over the <strong>k8s</strong> cluster. It takes care of finding the files, processing them as they get additional entries, and sending those events &quot;somewhere&quot;. In this case, I used an fluentd docker image that emits logs to <strong>graylog</strong> consumers, which thankfully, Seq is with an addon. So, with Serilog in the applications, fluentd in the cluster using a graylog variant and Seq running in the cluster to ingest and aggregate all the log information, we have a very compact, useful logging strategy to get us started.</p><p>I don't know how far this logging implementation will grow with the cluster into the future, but it is designed to have pieces replaced as we outgrow their capabilities.</p><h3>Learning Resources</h3><p>This adventure required an incredible amount of learning on my part. The way that I learn best is by reading/learning enough to get started, and then building like crazy, discovering deficiencies in what I know, resolving the deficiency, and then finding the next thing I don't know.</p><p>This series of blog posts will hopefully capture some of that learning experience, but I wanted to make sure I shared the places that I started.</p><h4>Pluralsight</h4><p>There are a lot of courses on Pluralsight. I think I've enjoyed all them, with some courses being better than others for me at that point in my learning. For this project, I didn't need any help with C# or ASP.NET Core or any of that part. I needed to get familiar with Kubernetes and I needed to become familiar with authentication flows using OAuth2 and OpenID Connect.</p><p>The <strong>k8s</strong> courses were from Nigel Poulton were great places to get started with <strong>k8s</strong>. The ones that I watched are:</p><ul><li><a href="https://app.pluralsight.com/library/courses/getting-started-kubernetes/table-of-contents" target="_blank" rel="noopener">Getting Started with Kubernetes</a></li><li><a href="https://app.pluralsight.com/library/courses/docker-kubernetes-big-picture/table-of-contents" target="_blank" rel="noopener">Docker and Kubernetes: The Big Picture</a></li></ul><p>When getting more details on OAuth2 and OpenId Connect, Kevin Dockx and Micah Silverman had two nice courses to review.</p><ul><li><a href="https://app.pluralsight.com/library/courses/securing-aspdotnet-core2-oauth2-openid-connect/table-of-contents" target="_blank" rel="noopener">Securing ASP.NET Core 2 with OAuth2 and OpenID Connect</a></li><li><a href="https://app.pluralsight.com/library/courses/that-conference-2019-session-07/table-of-contents" target="_blank" rel="noopener">THAT Conference '19: OAuth 2.0 and OpenID Connect (In Plain English)</a></li></ul><blockquote><p>There is a new version of Kevin Dockx course available using ASP.NET Core 3 <a href="https://app.pluralsight.com/library/courses/securing-aspnet-core-3-oauth2-openid-connect/table-of-contents" target="_blank" rel="noopener">here</a></p></blockquote><h4>Kubernetes.io</h4><p>Based on what and how I was learning <strong>k8s</strong> from Nigel on Pluralsight, Kubernetes.io became an invaluable resource for me to learn about <strong>k8s</strong> and its ecosystem. Nigel's courses encourage you to work with manifests, building your <strong>k8s</strong> cluster in a declarative manner, and kubernetes.io supported that approach well. I would highly recommend working with manifests and understanding them and how they work when learning <strong>k8s</strong>. We'll discover later that I don't work directly with manifests when provisioning my cluster resources, but you have to know manifests because all the examples in the communities are in manifests!</p><h4>Community blogs</h4><p>This would have been much harder without the incredibly vibrant community of bloggers in the world who are sharing what they are doing, the problems, and how they are solving those problems. I'm hoping that my addition in writing this blog fills a gap and makes it a bit easier for you or someone else to put this all together, but this would have been incredibly difficult without this vibrant community.</p><p><strong>Next up:</strong><a href="/kubernetes/kubernetes-my-journey-part-3">Tools in Use</a></p><h5>Links</h5><ul><li><a href="https://azure.microsoft.com/en-us/" target="_blank" rel="noopener">Azure</a></li><li><a href="https://azure.microsoft.com/en-us/-services/kubernetes-service/" target="_blank" rel="noopener">Azure Kubernetes Services</a></li><li><a href="https://www.kubernetes.io" target="_blank" rel="noopener">Kubernetes</a></li><li><a href="https://identityserver4.readthedocs.io/en/latest/" target="_blank" rel="noopener">IdentityServer4</a></li><li><a href="https://github.com/skoruba/IdentityServer4.Admin" target="_blank" rel="noopener">Skoruba IdentityServe4 Administration</a></li><li><a href="https://www.pulumi.com/" target="_blank" rel="noopener">Pulumi</a></li><li><a href="https://datalust.co/seq" target="_blank" rel="noopener">Seq Log Ingestion</a></li><li><a href="https://docs.fluentd.org/" target="_blank" rel="noopener">Fluentd</a></li><li><a href="https://www.postgresql.org/" target="_blank" rel="noopener">Postgres</a></li><li><a href="https://www.postgresql.org/" target="_blank" rel="noopener">pgAdmin4</a></li><li><a href="https://github.com/jetstack/cert-manager" target="_blank" rel="noopener">CertManager</a></li><li><a href="https://www.nginx.com/" target="_blank" rel="noopener">Nginx</a></li><li><a href="https://containo.us/traefik/" target="_blank" rel="noopener">Traefix</a></li></ul><style>    h1, h2, h3, h4, h5, h6 {       margin-top: 25px;    }    figure.highlight{        background-color: #E8EEFE;    }    figure.highlight .gutter{        color: #0033CD;    }    figure.highlight pre {        font-family: 'Cascadia Code PL', monospace;    }    code {        font-family: 'Cascadia Code PL', sans-serif;        border-width: 0.1em;        border-color: #E8EEFE;        border-style: solid;        border-radius: 0.3em;        background-color: #E8EEFE;        color: #0033CD;        padding: 0em 0.4em;        white-space: nowrap;    }</style>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;a href=&quot;/kubernetes/kubernetes-my-journey&quot;&gt;Series Table of Contents&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Previously:&lt;/strong&gt;
&lt;a href=&quot;/kubernetes/kuberne
    
    </summary>
    
      <category term="kubernetes" scheme="https://westerndevs.com/categories/kubernetes/"/>
    
    
      <category term="kubernetes, azure, **AKS**, identityserver, docker, containers" scheme="https://westerndevs.com/tags/kubernetes-azure-AKS-identityserver-docker-containers/"/>
    
  </entry>
  
  <entry>
    <title type="html">Kubernetes - My Journey - Part 3</title>
    <link href="https://westerndevs.com/kubernetes/kubernetes-my-journey-part-3/" rel="alternate" type="text/html"/>
    <id>https://westerndevs.com/kubernetes/kubernetes-my-journey-part-3/</id>
    <published>2020-05-22T14:00:00.000Z</published>
    <updated>2020-11-09T21:27:02.246Z</updated>
	<author>
	
	  
	  <name>Dave White</name>
	  <email>dmhwhite@gmail.com</email>
	
	  <uri>https://westerndevs.com</uri>
	</author>
    
    <content type="html"><![CDATA[<p><a href="/kubernetes/kubernetes-my-journey">Series Table of Contents</a></p><p><strong>Previously:</strong><a href="/kubernetes/kubernetes-my-journey-part-2">Initial Assumptions, Technologies, Learning resources</a></p><h1>Tools in Use</h1><p>Tooling is an incredibly important aspect of a developer's daily life. IDEs, CLIs, Automations, Visualizations; the list goes on and on. Sifting through the set of tools that are available and finding out if they work for you can take a lot of time. As a former Microsoft MVP (Dev Tools), I'm always interested in tooling because I know the importance it can make in developer productivity and the overall productivity and quality for an organization! I'm hoping that by sharing my base set of tools, and what I use them for, you'll get a bit of tool-curation time savings back to spend on learning other things.</p><p>These are the tools I use <strong>every day</strong> on this project.</p><h2>Visual Studio</h2><table><thead><tr><th></th><th style="text-align:center"></th></tr></thead><tbody><tr><td><a href="https://visualstudio.microsoft.com/vs/" target="_blank" rel="noopener">Visual Studio</a> has come a long, long way since the first time I ever used is as Microsoft Visual Studio 97 (5.x). Wow! This IDE has been my constant companion for the entirety of my development career, and I have to say that the current VS 2019 version of the tool is a pleasure to work with. Given the complex nature of building projects and supporting all of the ecosystems that we build projects for, VS 2019 does a fantastic job of supporting <em>my</em> needs.</td><td style="text-align:center"><img width="200px" src="https://s3.amazonaws.com/neowin/news/images/uploaded/2017/02/1486663278_visual-studio-97.jpg" alt="Visual Studio 97"></td></tr></tbody></table><p>With this project, I obviously appreciate all of the normal C# coding functions that are present, but the docker/docker-compose support is particularly important and the ability to debug applications running in docker containers is great.</p><p>I still have <a href="https://www.jetbrains.com/resharper/" target="_blank" rel="noopener">ReSharper</a> and I still have many extensions (Thanks <a href="https://marketplace.visualstudio.com/publishers/MadsKristensen" target="_blank" rel="noopener">Mads</a>!) running in Visual Studio, but this IDE is the workhorse of my day-to-day activities when I'm working in C#.</p><blockquote><p>I don't recommend that you download and try to use Microsoft Visual Studio 97!</p></blockquote><h2>VS Code</h2><p><a href="https://code.visualstudio.com/" target="_blank" rel="noopener">Visual Studio Code</a> is a fantastic, light-weight text editor with an incredible extensibility feature that the community has taken full advantage of! Out of the box, it is very good at one thing. Editing text files. With all the extensions being written and placed on the marketplace, it has become some people's full-time IDE. The great thing about VS Code is that it runs on macOS, Linux, and Windows, so you take it wherever you go! And, it's free! It has mostly replaced all my other text editors, with the exception of <strong>Notepad</strong>. Still use that one from time to time.</p><p>I use VS Code for editing all my manifests, <strong>Pulumi</strong> Typescript applications, and markdown files for documentation. This blog post was written in Markdown using VS Code! With an integrated terminal window using PS Core, I can do pretty much all my <strong>k8s</strong> deployment and resource work without leaving VS Code.</p><h2>Pulumi</h2><p>I've mentioned that while I find manifests a great way to learn <strong>k8s</strong>, I've adopted a different approach for deploying <strong>k8s</strong>. That approach is from a company called <a href="https://www.pulumi.com/" target="_blank" rel="noopener">Pulumi</a>! What they've basically done is built a platform and multiple SDKs in various languages that allow us to do <strong>Infrastructure as Code</strong> in a programming language of our choice!! It's a great way to define and manage your cloud resources. Once you have written your application that knows what you want to do, you simply tell the <strong>pulumi cli</strong> to <code>up</code> or <code>destroy</code> your infrastructure! <code>pulumi up</code> and it will create or update your infrastructure resources as needed, and <code>pulumi destroy</code> tears it all down and cleans everything up!</p><h2>Git</h2><p><a href="https://git-scm.com/" target="_blank" rel="noopener">Git</a> is the most popular and arguably the defacto source control system in the world today. All my manifests and pulumi typescript files are version controlled in git, as are all the Identity application projects that we'll be building later on.</p><h2>Azure DevOps Services (Server 2019)</h2><p><a href="https://azure.microsoft.com/en-ca/services/devops/" target="_blank" rel="noopener">Azure DevOps (Server)</a> is our DevOps management software. Source control (Git and TFVC), Work Item Management, Builds, and Deployments are all provided by this service. It provides us a tremendous amount of automation, and it gives us a place to make our knowledge about how to build and deploy our applications concrete! If you haven't tried Azure DevOps recently, you really should give it another go. It's been a tremendously valuable addition to the development process.</p><h2>Kubernetes Web UI (Dashboard)</h2><p><a href="https://kubernetes.io/docs/tasks/access-application-cluster/web-ui-dashboard/" target="_blank" rel="noopener">Kubernetes Web UI (Dashboard)</a> is a great dashboard that is built into your <strong>k8s</strong> cluster that provides a User experience to help you visualize and manage your <strong>k8s</strong> cluster.</p><h2>Octant</h2><p><a href="https://octant.dev/" target="_blank" rel="noopener">Octant</a> is a dashboard for your <strong>k8s</strong> cluster, similar to the Kubernetes Dashboard, but it doesn't require you to port-forward to your local machine to get at the dashboard, it simply runs on your local development machine and uses the kubectl current context to access the cluster! This makes is quite easy to spin up. It provides port-forwarding capabilities in addition to many of the capabilities present in the Kubernetes Web UI. I find myself using them both quite often throughout the day.</p><h2>K9s</h2><p><a href="https://k9scli.io/" target="_blank" rel="noopener">K9s</a> is a console-based user experience for managing your <strong>k8s</strong> cluster! As with Octant, it uses kubectl and your current context to determine which <strong>k8s</strong> cluster it is managing. I quite like it! I also find it really interesting how I have three different tools for managing the <strong>k8s</strong> cluster and depending on what I'm doing or even my mood, I can pick from any of the three tools.</p><h2>Honorable Mention - Docker Desktop for Windows</h2><p><a href="https://hub.docker.com/editions/community/docker-ce-desktop-windows" target="_blank" rel="noopener">Docker Desktop for Windows</a> is the easiest way to get docker containers running on a windows desktop. You need a CPU that supports virtualization and you have to have Windows 10 Pro for the HyperV/WSL2 support. There are other options if you aren't running Windows 10 Pro and up, but I'll leave that as an exercise for you to figure out. But during initial development of the Skoruba project, it was immensely helpful to be able to build, deploy, and debug the application without having to deal with <strong>k8s</strong> or <strong>minikube</strong>. There are additional complexities involved with that that you will want to defer for a while.</p><p><strong>Next up:</strong><a href="/kubernetes/kubernetes-my-journey-part-4">Building an ASP.NET Core IdentityServer Implementation</a></p><h3>Links</h3><ul><li><a href="https://visualstudio.microsoft.com/" target="_blank" rel="noopener">Visual Studio</a></li><li><a href="https://code.visualstudio.com/" target="_blank" rel="noopener">VS Code</a></li><li><a href="https://www.pulumi.com/" target="_blank" rel="noopener">Pulumi</a></li><li><a href="https://git-scm.com/" target="_blank" rel="noopener">Git</a></li><li><a href="https://www.github.com" target="_blank" rel="noopener">Github</a><ul><li><a href="http://git-school.github.io/visualizing-git/" target="_blank" rel="noopener">Git Simulator - Github</a></li></ul></li><li><a href="https://azure.microsoft.com/en-ca/services/devops/" target="_blank" rel="noopener">Azure DevOps (Server)</a></li><li><a href="https://kubernetes.io/docs/tasks/access-application-cluster/web-ui-dashboard/" target="_blank" rel="noopener">Kubernetes Dashboard</a></li><li><a href="https://octant.dev/" target="_blank" rel="noopener">Octant</a> - <a href="https://github.com/vmware-tanzu/octant" target="_blank" rel="noopener">Github</a></li><li><a href="https://k9scli.io/" target="_blank" rel="noopener">K9s</a> - <a href="https://github.com/derailed/k9s" target="_blank" rel="noopener">Github</a></li><li><a href="https://www.virtuallyghetto.com/2020/04/useful-interactive-terminal-and-graphical-ui-tools-for-kubernetes.html" target="_blank" rel="noopener">Useful Interactive Terminal And Graphical UI Tools For Kubernetes - Virtually Ghetto</a></li></ul><style>    h1, h2, h3, h4, h5, h6 {       margin-top: 25px;    }    figure.highlight{        background-color: #E8EEFE;    }    figure.highlight .gutter{        color: #0033CD;    }    figure.highlight pre {        font-family: 'Cascadia Code PL', monospace;    }    code {        font-family: 'Cascadia Code PL', sans-serif;        border-width: 0.1em;        border-color: #E8EEFE;        border-style: solid;        border-radius: 0.3em;        background-color: #E8EEFE;        color: #0033CD;        padding: 0em 0.4em;        white-space: nowrap;    }</style>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;a href=&quot;/kubernetes/kubernetes-my-journey&quot;&gt;Series Table of Contents&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Previously:&lt;/strong&gt;
&lt;a href=&quot;/kubernetes/kuberne
    
    </summary>
    
      <category term="kubernetes" scheme="https://westerndevs.com/categories/kubernetes/"/>
    
    
      <category term="kubernetes, azure, aks, identityserver, docker, containers" scheme="https://westerndevs.com/tags/kubernetes-azure-aks-identityserver-docker-containers/"/>
    
  </entry>
  
  <entry>
    <title type="html">Kubernetes - My Journey - Part 4</title>
    <link href="https://westerndevs.com/kubernetes/kubernetes-my-journey-part-4/" rel="alternate" type="text/html"/>
    <id>https://westerndevs.com/kubernetes/kubernetes-my-journey-part-4/</id>
    <published>2020-05-22T13:00:00.000Z</published>
    <updated>2020-11-09T21:27:02.246Z</updated>
	<author>
	
	  
	  <name>Dave White</name>
	  <email>dmhwhite@gmail.com</email>
	
	  <uri>https://westerndevs.com</uri>
	</author>
    
    <content type="html"><![CDATA[<p><a href="/kubernetes/kubernetes-my-journey">Series Table of Contents</a></p><p><strong>Previously:</strong><a href="/kubernetes/kubernetes-my-journey-part-3">Tools in Use</a></p><h1>Building an ASP.NET Core IdentityServer Implementation</h1><p>This is where the articles start to get a bit longer. I've broken a couple up into a-b parts. We won't be talking about tasks in <strong>k8s</strong> for a bit, so if you want to skip on to that, you can go <a href="/kubernetes/kubernetes-my-journey-part-5">here</a>.</p><p>There are, in my opinion, 2 parts that need to be considered when building up this IdentityServer4 implementation, and the 2nd part can arguably be split into 2 smaller parts, which is how this implementation is built.</p><p>The first part of the system needs to be the <strong>Security Token Services (STS)</strong> implementation. This part of the system is simply responsible for managing tokens. This means validating log in credentials, creating tokens, refreshing tokens, and sending along the appropriate metadata and claims. I would want this broken into a separate service because it will probably have different operational characteristics then the other parts of the application, and so we can scale is separately. If there are 1000s of request per minute to generate/validate/refresh tokens and send along metadata, that is different than administrating the data that the system relies on. Additionally, it makes it easier to secure the administrative access if it is a separate application.</p><p>The second part of the system is the <strong>Administrative (Admin)</strong> implementation. The application that provides a user experience that will help identity administrators do the right things.</p><p>In our implementation, which is based on the Skoruba project, there is actually a third part to the administrative side of the system and that is a <strong>Admin WebAPI</strong> that does all of the actual CRUD on the database. I'm happy with this setup and I'm glad the Skoruba project went in this direction.</p><p>Let's get into the details of what I did.</p><h2>Start Learning with the IdentityServer4 Quickstart</h2><p>If you are new to IdentityServer4 or even newer to OAuth2 and OpenID Connect, your first stop needs to be the <a href="https://identityserver4.readthedocs.io/en/latest/quickstarts/0_overview.html" target="_blank" rel="noopener">IdentityServer4 Quickstarts</a>. These quickstart modules will walk you through all of the steps required to incrementally build an IdentityServer4 server. They are all self-contained, building your knowledge from one to the next, and by the end of the quickstarts, you've built a functional IdentityServer4 implementation. I'm not going to re-produce any of these quickstarts or even how to get you started on them, other than providing the <a href="https://identityserver4.readthedocs.io/en/latest/quickstarts/0_overview.html" target="_blank" rel="noopener">link</a> and some encouragement. Go do the quickstarts, then come back here and continue reading!</p><blockquote><p>It was during the quickstarts that I side-stepped and did the Pluralsight courses on OAuth2 and OpenID Connect.</p></blockquote><h2>Starting your project with Skoruba</h2><p>So, you've done the quickstarts, or you're already experienced with IdentityServer4 and the real reason you are here is because the quickstarts left you wanting more! You wanted an Administrative application!! You wanted databases to persist all of this configuration and the quickstarts don't give you any of that! You're in the right place! I was in that position just a little while ago myself.</p><p>After doing the quickstarts, I realized I had to build/find an administrative experience for our platform. It isn't hard to find a couple when you google <em>IdentityServer4 Administration</em>. There are a number of Github repos that you'll find, and perhaps a couple products that you can purchase. Again, because of the desire to build/own vs. buy/subscribe, we continued looking until we found the <a href="https://github.com/skoruba/IdentityServer4.Admin" target="_blank" rel="noopener">Skoruba IdentityServer4 Admin</a> project on Github. This is a great project and I've been very happy that I found it. It is put together well and is super easy to get started with.</p><p>In order to use the project, you'll need to have the latest ASP.NET Core 3.x SDK and development tools.</p><p>The first thing I did was get the awesome template that the Skoruba team build to get you started using their project. This command tells the dotnet tooling to go off to nuget.org and get the template.</p><p><code>dotnet new -i Skoruba.IdentityServer4.Admin.Templates::1.0.0-rc1-update2</code></p><p>Once you have the template, you are ready to start creating your solution. You can start by using the template.</p><figure class="highlight ps"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">dotnet new skoruba.is4admin -<span class="literal">-name</span> MyProject -<span class="literal">-title</span> MyProject `</span><br><span class="line">-<span class="literal">-adminemail</span> <span class="string">"admin@codingwithdave.xyz"</span> -<span class="literal">-adminpassword</span> <span class="string">"P@ssw0rd!"</span> `</span><br><span class="line">-<span class="literal">-adminrole</span> IdentityAdminRole -<span class="literal">-adminclientid</span> MyClientId `</span><br><span class="line">-<span class="literal">-adminclientsecret</span> MyClientSecret -<span class="literal">-dockersupport</span> true</span><br></pre></td></tr></table></figure><p>A couple notes about that command that make sense once you have done the ID4 Quickstarts:</p><ul><li><code>-adminrole IdentityAdminRole</code> is the User Role that will be used in the Admin application and the AdminAPI to know if a user is an administrator of the Identity system. This role will be assigned to your admin user account.</li><li><code>-adminclientid MyClientId</code> is the ClientId (username of your application) for the Admin application in the STS. Your Admin application needs this id to be allowed to access the STS.</li><li><code>-adminclientsecret MyClientSecret</code> is the ClientSecret (password of your application) for the Admin application in the STS. It is used with ClientId.</li></ul><p>Since we are planning to run this all in Docker locally and eventually deploying this to a <strong>k8s</strong> cluster, Docker support is required. All of the yaml examples in this post are in the docker-compose.yml file.</p><p>Once that command has run, you should have a project that looks something like this:</p><img src="/images/dwhite/Skoruba-projects-initial.png" alt="Skoruba Initial Projects Setup" height="250px"><h3>Select your DB Platform</h3><p>One of the cool things about the Skoruba template is that it comes out of the box with 3 different database persistence mechanism already waiting for you. You can just select the one you want to use, and off it goes. I don't need to provide the ability to switch mechanisms, so I'm simply going to remove the templated <strong>MySql</strong> and <strong>SqlServer</strong> options.</p><p>If you are planning to use SqlServer in your <strong>k8s</strong> cluster, you can <strong>skip</strong> these instructions and the next Postgres/pgAdmin4 instructions. You could delete everything except for SqlServer implementation details. I understand why the template spits it out, but your running application probably won't need persistence choices.</p><h3>So you selected PostgreSQL</h3><p><a href="https://www.postgresql.org/" target="_blank" rel="noopener">PostgreSQL (Postgres) is an open-source database</a> that is more than sufficient for our use-cases. It is free to use/run and has great support in the community. In order to minimize costs, I choose to use PostgresSQL.</p><p>The first thing I did was delete the MySql and SqlServer projects. I wasn't planning to use them and as such, just deleting them is the right course. They can always be put back in if the need ever arose to migrate to a different database platform. This is going to immediately break your solution. You can just go and delete/fix all of the broken code. You're just removing <code>using</code> statements and adjusting/removing <code>if {}</code> blocks. I also deleted all of the database types/selection code and configuration settings.</p><img src="/images/dwhite/delete-switch-block.png" alt="Deleting a Switch Block" height="250px"><p>That should leave you with a solution that builds and that only contains these projects.</p><img src="/images/dwhite/skoruba-projects-only-postgres.png" alt="Skoruba Final Projects Setup" height="250px"><p>You probably also want to delete the <code>db</code> entry in the docker-compose.yml file. The SqlServer image is a large image and you don't necessarily need to download it.</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># remove this entry</span></span><br><span class="line">  <span class="attr">db:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">"mcr.microsoft.com/mssql/server"</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">1433</span><span class="string">:1433</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">skoruba-identityserver4-DB</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">SA_PASSWORD:</span> <span class="string">"$&#123;DB_PASSWORD:-Password_123&#125;"</span></span><br><span class="line">      <span class="attr">ACCEPT_EULA:</span> <span class="string">"Y"</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">dbdata:/var/opt/mssql</span></span><br></pre></td></tr></table></figure><blockquote><p>In case you didn't know, Docker Desktop is the local image registry for all things Docker on your Windows workstation. All images will be downloaded and cached here. Docker Desktop is <em>not</em> the local image registry for <strong>k8s</strong> (minikube).</p></blockquote><h2>Backend Containers - Postgres,  pgAdmin4 &amp; Seq</h2><p>Now, your solution is building and ready to run, but our local infrastructure isn't quite there yet. We're going to need a Postgres database instance on our local machine to run this in Visual Studio, so we can do that in the docker-compose.yml file.</p><p>To bring a Postgres database container into Docker Desktop, add the following:</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">postgresdb:</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">postgres:alpine</span></span><br><span class="line">  <span class="attr">hostname:</span> <span class="string">postgres</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="number">5432</span><span class="string">:5432</span></span><br><span class="line">  <span class="attr">container_name:</span> <span class="string">postgresdb</span></span><br><span class="line">  <span class="attr">environment:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">"POSTGRES_USER=admin"</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">"POSTGRES_PASSWORD=P@ssw0rd!"</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">"POSTGRES_DB=identity"</span> <span class="comment"># this is the DB name that will be generated by EFCore</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">postgresdata:/var/lib/postgresql/data</span></span><br><span class="line">  <span class="attr">networks:</span></span><br><span class="line">    <span class="attr">default:</span></span><br><span class="line">      <span class="attr">aliases:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">postgres</span></span><br></pre></td></tr></table></figure><p>What this does is get the latest version of the Postgres container image from DockerHub. It exposes the default Postgres port of <strong>5432</strong>, gives this container an alias in the DNS of <strong>postgres</strong>, and hooks the container up to a persistent volume, mapped to a volume on the local host, to store its identity data. We need to add that mapping near the bottom of the existing docker-compose.yml file. We will add a mapping for <strong>pgAdmin4</strong> while we are at it.</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">volumes:</span></span><br><span class="line">  <span class="attr">postgresdata:</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">local</span></span><br><span class="line">  <span class="attr">pgdata:</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">local</span></span><br></pre></td></tr></table></figure><blockquote><p>There is a lot of YAML in <strong>k8s</strong> and <strong>docker</strong>. You are going to have to become familiar with it. I'm going to assume that you'll work through any yaml syntax errors that may come out of working through the articles.</p></blockquote><p>After adding in Postgre, we can now add in our pgAdmin4 container instance. pgAdmin4 is a database management tool built as a web application. If you have another Postgre management tool, you don't need to follow these steps.</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">pgAdmin4:</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">dpage/pgadmin4:4.20</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="number">5050</span><span class="string">:80</span></span><br><span class="line">  <span class="attr">container_name:</span> <span class="string">pgAdmin4</span></span><br><span class="line">  <span class="attr">environment:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">"PGADMIN_DEFAULT_EMAIL=admin@codingwithdave.xyz"</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">"PGADMIN_DEFAULT_PASSWORD=P@ssw0rd!"</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">"PGDATA=/mnt/data/pgdata"</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">pgdata:/mnt/data/pgdata</span></span><br></pre></td></tr></table></figure><p>The pgAdmin4 container doesn't need an alias. We gave the Postgre instance a DNS alias so that all of the running containers in the cluster can simply reference the database (in the connection string) by the DNS entry of postgres. The IdentityServer4 apps and pgAdmin4 don't really need this kind of mapping so we'll leave them as accessible at the <strong>http://127.0.0.1.xip.io:port</strong> addresses.</p><p>If you want to explore more options in the pgAdmin4 configuration that are available to you, you can go to the <a href="https://www.pgadmin.org/docs/pgadmin4/latest/container_deployment.html" target="_blank" rel="noopener">pgAdmin4 Container Configuration</a> page for more details.</p><p>We're also going to add a Seq instance into our docker-compose.yml file.</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">seq:</span></span><br><span class="line">  <span class="attr">container_name:</span> <span class="string">seq</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">datalust/seq:preview</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">"5341:80"</span></span><br><span class="line">  <span class="attr">environment:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">"ACCEPT_EULA=Y"</span></span><br></pre></td></tr></table></figure><p>When I added the <strong>Seq</strong> container, I did <em>not</em> give it a persistent volume on the host to store log data. In the case of Seq, I'm using it for transient purposes in docker so I don't really care if the history of log entries goes away when the container is re-started. If you do want to keep your log files, you can give it a persistent volume on the host, in the same way as the databases.</p><blockquote><p>Persistent Volumes do not survive a Docker Desktop data purge.</p></blockquote><p>We are going to add <em>one</em> more little container that I want to introduce now before it really appeared in my story, but I wish that I had found it earlier. It is a small little container from <strong>Google</strong> that helps me do DNS diagnostics and debugging in the containers/<strong>k8s</strong> network. You can quickly and easily add this container at just about any time, do your diagnostics, and then remove it from the cluster. It automatically stops after 1 hour as well.</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">dnsutil:</span></span><br><span class="line">  <span class="attr">container_name:</span> <span class="string">dnsutils</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">gcr.io/kubernetes-e2e-test-images/dnsutils:1.3</span></span><br><span class="line">  <span class="attr">command:</span> <span class="string">"sleep 3600"</span></span><br></pre></td></tr></table></figure><h2>Configuration Changes</h2><p>We aren't quite ready to run things yet. We need to make some more configuration adjustments.</p><blockquote><p>You should be prepared to make a lot of configuration adjustments in your IdentityServer4 and <strong>k8s</strong> career!</p></blockquote><p>Here are the things I've done to make this easier/cleaner for running locally.</p><ol><li>Change all usernames to <strong>admin</strong></li><li>Change all admin passwords to <strong>P@ssw0rd!</strong></li><li>Change all Role entries to <strong>IdentityAdminRole</strong></li><li>Delete all of the unnecessary launchSettings profiles</li><li>Tweak the URL configuration values</li><li>Change all of the database connection strings to point at our local Postgres instance</li><li>Tweak the code to always run migrations and seeding data on startup</li><li>Configure Serilog to use Seq and the console</li></ol><h3>Change Credentials and Role</h3><p>You will have lots of chances once you've explored and learned about all of these configurations to change usernames, potentially move to Azure Managed Identities, or use something like Azure KeyVault to store your credentials. For the time being, we want this to be quite easy to do, so we're going to simplify this and make all the admin accounts the same.</p><ul><li><strong>Postgres</strong> - If you revisit the Postgre yaml snippet, you see the default Postgre power user is <strong>admin</strong> and <strong>P@ssword!</strong>.</li><li><strong>pgAdmin4</strong> - You'll see that the pgAdmin4 wants an email address, so in the yaml snippet we see the username <strong>admin@codingwithdave.xyz</strong> and <strong>P@ssw0rd!</strong></li><li><strong>Seq</strong> - currently requires no authentication</li></ul><p>There are three .json files in a file in the root of the solution called <strong>shared</strong>. These files hold seed data for the applications. They are joined to the docker containers and are used by the running instances of the applications when they are in docker. You need to edit the copies of these files.</p><img src="/images/dwhite/Shared_seed_data_files_location.png" alt="Seed data JSON files" height="175px"><p>I added a <strong>solution folder</strong> to the solution and added these files to it.</p><img src="/images/dwhite/solution-add-existing-shared-files.png" alt="Add shared files to solution" height="175px"><p>I changed the following:</p><ul><li><strong>identitydata.json</strong><ul><li>change the initial username credentials to <strong>admin</strong> and <strong>P@ssw0rd!</strong></li><li>change the <strong>Roles</strong> entry to <strong>IdentityAdminRole</strong>.</li></ul></li></ul><p>In the three projects, we need to make a few tweaks in the appsettings.json files. I did this for a little added clarity.</p><ul><li>appsettings.json in MyProject.Admin</li><li>appsettings.json in MyProject.Admin.Api</li><li>appsettings.json in MyProject.STS.Identity<ul><li>change the <strong>AdminApiConfiguration:AdministrationRole</strong> to <strong>IdentityAdminRole</strong></li></ul></li></ul><br/><p>Here is an example from the STS <strong>appsettings.json</strong> file.</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">"AdminConfiguration": &#123;</span><br><span class="line">    "PageTitle": "Skoruba IdentityServer4",</span><br><span class="line">    "HomePageLogoUri": "/images/skoruba-icon.png",</span><br><span class="line">    "FaviconUri": "/favicon.ico",</span><br><span class="line">    "IdentityAdminBaseUrl": "http://127.0.0.1.xip.io:9000",</span><br><span class="line">    "AdministrationRole": "IdentityAdminRole"</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><h3>Delete Unnecessary LaunchSettings Profiles</h3><p>This one is fairly simple and just a cleaning exercise. I can debug with Docker Desktop and the DockerCompose project, so good riddance to all the other clutter! I don't plan to run this in IIS or single Docker containers, so I can remove those profiles and settings. I will leave the Kestrel settings since I can envision <em>someone</em> doing that. Otherwise, I'm only planning to run ecosystem this via DockerCompose or sending it to a <strong>k8s</strong> cluster.</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"iisSettings"</span>: &#123;</span><br><span class="line">    <span class="attr">"windowsAuthentication"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">"anonymousAuthentication"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">"iisExpress"</span>: &#123;</span><br><span class="line">      <span class="attr">"applicationUrl"</span>: <span class="string">"http://127.0.0.1.xip.io:5000"</span>,</span><br><span class="line">      <span class="attr">"sslPort"</span>: <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"profiles"</span>: &#123;</span><br><span class="line">    <span class="attr">"IIS Express"</span>: &#123;</span><br><span class="line">      <span class="attr">"commandName"</span>: <span class="string">"IISExpress"</span>,</span><br><span class="line">      <span class="attr">"launchBrowser"</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">"environmentVariables"</span>: &#123;</span><br><span class="line">        <span class="attr">"ASPNETCORE_ENVIRONMENT"</span>: <span class="string">"Development"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"MyProject.AspNetIdentity"</span>: &#123;</span><br><span class="line">      <span class="attr">"commandName"</span>: <span class="string">"Project"</span>,</span><br><span class="line">      <span class="attr">"launchBrowser"</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">"environmentVariables"</span>: &#123;</span><br><span class="line">        <span class="attr">"ASPNETCORE_ENVIRONMENT"</span>: <span class="string">"Development"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"applicationUrl"</span>: <span class="string">"http://127.0.0.1.xip.io:5000"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"Docker"</span>: &#123;</span><br><span class="line">      <span class="attr">"commandName"</span>: <span class="string">"Docker"</span>,</span><br><span class="line">      <span class="attr">"launchBrowser"</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">"launchUrl"</span>: <span class="string">"&#123;Scheme&#125;://&#123;ServiceHost&#125;:&#123;ServicePort&#125;"</span>,</span><br><span class="line">      <span class="attr">"environmentVariables"</span>: &#123;&#125;,</span><br><span class="line">      <span class="attr">"httpPort"</span>: <span class="number">10000</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>becomes</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"profiles"</span>: &#123;</span><br><span class="line">    <span class="attr">"MyProject.AspNetIdentity"</span>: &#123;</span><br><span class="line">      <span class="attr">"commandName"</span>: <span class="string">"Project"</span>,</span><br><span class="line">      <span class="attr">"launchBrowser"</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">"environmentVariables"</span>: &#123;</span><br><span class="line">        <span class="attr">"ASPNETCORE_ENVIRONMENT"</span>: <span class="string">"Development"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"applicationUrl"</span>: <span class="string">"http://127.0.0.1.xip.io:5000"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Repeat for all of the launchSettings.json files.</p><h3>The URL configuration values</h3><p>Identity implementations require a lot of information about people and applications in order to work. One of those pieces of information is the URL of the caller. The Skoruba template spits out all of the URLs in the form of <strong>127.0.0.1.xip.io</strong>. These URLs are using the <a href="http://xip.io/" target="_blank" rel="noopener">xip.io</a> service provided by the makers of Basecamp. This DNS server basically takes the DNS entry request, pulls the IP address out of it, and send that IP address base as the resolved IP. You can basically get a public DNS to resolve to an IP address that is your local machine.</p><img src="/images/dwhite/xip-io-landingpage.png" alt="Xip.io Landing Page" height="200px"><p>One thing I found while looking over the project was a blend of <strong>localhost</strong> configurations and <strong>127.0.0.1.xip.io</strong>. Because of the way that xip.io works, we can get rid of all of the localhost references. So, you can do a <strong>Replace in Files</strong> and replace all of the localhost with 127.0.0.1.xip.io.</p><blockquote><p>We could also replace all of the 127.0.0.1.xip.io with <strong>lvh.me</strong> which is a public DNS entry that resolves to 127.0.0.1 as well. <a href="https://nickjanetakis.com/blog/ngrok-lvhme-nipio-a-trilogy-for-local-development-and-testing" target="_blank" rel="noopener">This link</a> describes lvh.me and some other good utilities.</p></blockquote><p>These URLs are in the <strong>launchSettings.json</strong> file and the <strong>appsettings.json</strong>. Remember that in ASP.NET Core applications, by convention the <strong>environmental variable</strong> configurations are loaded last and overwrite anything in the appsettings.json files.</p><blockquote><p>One thing about configuration in this adventure is making sure that your configuration supports anywhere you run. That is why you see this crazy overlap of appsettings.json files or environmental variables managed all over the place. You have to develop a good understanding of how the configuration systems work in the runtime environments and take advantage of them.</p></blockquote><p>While we are doing this work, I also adjusted the ports that everything lives at. There are some mistakes in the Skoruba template that state that the Admin API is at 5001. So in this exercise I've set:</p><ul><li>STS to port 80 (no port)</li><li>Admin is at port 9000</li><li>Admin API is at port 5000</li></ul><p>These go along with pgAdmin4 already being at port 5050 and Seq being at port 5341.</p><h3>Database Connection strings</h3><p>The Skoruba uses 5 different DbContext to do its work. This in theory allows you to maintain smaller, more specific entity sets and could also spread some of this persistence work across different servers, but in practice, we'll only use one server. You can replace all connection strings with this one connection string.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Server&#x3D;postgres; User Id&#x3D;admin; Database&#x3D;identity; Port&#x3D;5432; Password&#x3D;P@ssw0rd!; SSL Mode&#x3D;Prefer; Trust Server Certificate&#x3D;true;</span><br></pre></td></tr></table></figure><blockquote><p>Notice that we can reference the Postgre DB at its DNS alias of <strong>postgres</strong>.</p></blockquote><h3>Tweak Code to Run Migrations Always</h3><p>You can see that the Skoruba team already had this idea in mind when they created the template. You just need to make the switch in <strong>Program.cs</strong> around line <strong>32</strong> and the MyProject.Admin project.</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Uncomment this to seed upon startup, alternatively pass in `dotnet run /seed` to seed using CLI</span></span><br><span class="line"><span class="keyword">await</span> DbMigrationHelpers.EnsureSeedData&lt;IdentityServerConfigurationDbContext,</span><br><span class="line">                                        AdminIdentityDbContext,</span><br><span class="line">                                        IdentityServerPersistedGrantDbContext,</span><br><span class="line">                                        AdminLogDbContext,</span><br><span class="line">                                        AdminAuditLogDbContext,</span><br><span class="line">                                        UserIdentity,</span><br><span class="line">                                        UserIdentityRole&gt;(host);</span><br><span class="line"><span class="comment">//if (seed)</span></span><br><span class="line"><span class="comment">//&#123;</span></span><br><span class="line"><span class="comment">//    await DbMigrationHelpers</span></span><br><span class="line"><span class="comment">//        .EnsureSeedData&lt;IdentityServerConfigurationDbContext, AdminIdentityDbContext,</span></span><br><span class="line"><span class="comment">//            IdentityServerPersistedGrantDbContext, AdminLogDbContext, AdminAuditLogDbContext,</span></span><br><span class="line"><span class="comment">//            UserIdentity, UserIdentityRole&gt;(host);</span></span><br><span class="line"><span class="comment">//&#125;</span></span><br></pre></td></tr></table></figure><h3>Configure Serilog to use Seq</h3><p>This is going to require a little bit of work in Visual Studio. The Skoruba template already makes use of Serilog as the logging engine, but it doesn't have the Seq sink that will be used to send all of the structured log messages to Seq. We need to add that bit to the Identity applications.</p><ol><li>Add the <code>Serilog.Sinks.Seq</code> package to all three Identity projects<img src="/images/dwhite/add-serilog-sink-seq-package.png" alt="Add Serilog Sink Seq Package to Projects" height="250px"></li><li>Change the configuration in the <strong>/shared/serilog.json</strong> file that will be used by the docker containers. <figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"Serilog"</span>: &#123;</span><br><span class="line">    <span class="attr">"Using"</span>: [ <span class="string">"Serilog.Sinks.Console"</span> ],</span><br><span class="line">    <span class="attr">"MinimumLevel"</span>: &#123;</span><br><span class="line">      <span class="attr">"Default"</span>: <span class="string">"Debug"</span>,</span><br><span class="line">      <span class="attr">"Override"</span>: &#123;</span><br><span class="line">        <span class="attr">"Microsoft"</span>: <span class="string">"Information"</span>,</span><br><span class="line">        <span class="attr">"System"</span>: <span class="string">"Error"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"WriteTo"</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"Name"</span>: <span class="string">"Console"</span>,</span><br><span class="line">        <span class="attr">"Args"</span>: &#123; <span class="attr">"outputTemplate"</span>: <span class="string">"[&#123;Timestamp:o&#125;][&#123;Level:u4&#125;][&#123;SourceContext&#125;] &#123;Message&#125;&#123;NewLine&#125;&#123;Exception&#125;"</span> &#125;</span><br><span class="line">      &#125;,&#123;</span><br><span class="line">        <span class="attr">"Name"</span>: <span class="string">"Seq"</span>,</span><br><span class="line">        <span class="attr">"Args"</span>: &#123; <span class="attr">"serverUrl"</span>: <span class="string">"http://seq:5341"</span> &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"Enrich"</span>: [ <span class="string">"FromLogContext"</span>, <span class="string">"WithMachineName"</span> ],</span><br><span class="line">    <span class="attr">"Properties"</span>: &#123;</span><br><span class="line">      <span class="attr">"Product"</span>: <span class="string">"IdentityServer4"</span>,</span><br><span class="line">      <span class="attr">"Platform"</span>: <span class="string">"Docker"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><strong>Optional</strong> Change the individual <strong>serilog.json</strong> files in each project to approximately match. Remember that the docker containers all use the <strong>shared/serilog.json</strong> file, not the individual serilog.json file via the <code>volumes:</code> directive <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">"./shared/serilog.json:/app/serilog.json"</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">"./shared/identitydata.json:/app/identitydata.json"</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">"./shared/identityserverdata.json:/app/identityserverdata.json"</span></span><br></pre></td></tr></table></figure></li></ol><h2>Ready to run</h2><p>Alright! We've scaffolded the IdentityServer4/Skoruba applications, we've put all of our infrastructure in place, and we've adjusted all of our configuration! We should be ready to run this application!</p><ol><li>Select the docker-compose project in the solution explorer!<img src="/images/dwhite/select-docker-compose-project.png" alt="Select Docker Compose file" height="200px"></li><li>You should see only the docker-compose option in the Visual Studio Run button<img src="/images/dwhite/docker-compose-run-button.png" alt="Docker Compose Run Button" height="200px"></li><li>Run your docker-compose orchestration!<img src="/images/dwhite/containers-running-in-docker.png" alt="Container Explorer in Visual Studio" height="200px"></li></ol><p>Now we can start to explore what we've got running in the container network.</p><ol><li>pgAdmin4</li><li>Seq</li><li>STS</li><li>Admin</li><li>AdminApi</li></ol><h3>pgAdmin4</h3><p>You should be able now to navigate to <a href="http://127.0.0.1.xip.io:5050" target="_blank" rel="noopener">http://127.0.0.1.xip.io:5050</a> in order to see the pgAdmin4 login screen.</p><img src="/images/dwhite/pgadmin4-login.png" alt="pgAdmin4 Login Screen" height="250px"><p>Now we enter our login credentials that we set in the pgAdmin4 section in the docker-compose.yml file.</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">pgAdmin4:</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">dpage/pgadmin4:4.20</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">"5050:80"</span></span><br><span class="line">  <span class="attr">container_name:</span> <span class="string">pgAdmin4</span></span><br><span class="line">  <span class="attr">environment:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">"PGADMIN_DEFAULT_EMAIL=admin@codingwithdave.xyz"</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">"PGADMIN_DEFAULT_PASSWORD=P@ssw0rd!"</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">"PGDATA=/mnt/data/pgdata"</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">pgdata:/mnt/data/pgdata</span></span><br></pre></td></tr></table></figure><img src="/images/dwhite/pgadmin4-login-details.png" alt="pgAdmin4 Login Screen" height="250px"><p>Once we've logged in! We need to add a connection to the Postgre database into pgAdmin4.</p><ol><li>Create Server Listing Entry<img src="/images/dwhite/pgadmin4-create-server-listing.png" alt="pgAdmin4 Create Server Entry" height="250px"></li><li>Enter server location (DNS)<img src="/images/dwhite/pgadmin4-server-listing-name.png" alt="pgAdmin4 Enter Server DNS location" height="150px"></li><li>Enter Postgre server admin credentials <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">postgresdb:</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">postgres:alpine</span></span><br><span class="line">  <span class="attr">hostname:</span> <span class="string">postgres</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">"5432:5432"</span></span><br><span class="line">  <span class="attr">container_name:</span> <span class="string">postgresdb</span></span><br><span class="line">  <span class="attr">environment:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">"POSTGRES_USER=admin"</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">"POSTGRES_PASSWORD=P@ssw0rd!"</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">"POSTGRES_DB=identity"</span> <span class="comment"># this is the DB name that will be generated by EFCore</span></span><br></pre></td></tr></table></figure> <img src="/images/dwhite/pgadmin4-server-login-credentials.png" alt="pgAdmin4 Postgres Admin Credentials" height="250px"></li></ol><p>And voila! We can administer our Postgre-based Identity store that is used by the 3 applications in the platform!</p><img src="/images/dwhite/pgadmin4-identity-database.png" alt="pgAdmin4 Identity Database Structure" height="250px"><p>We can now run Postgre queries and sql commands to look at or manipulate our data.</p><img src="/images/dwhite/pgadmin4-identity-query-users-table.png" alt="pgAdmin4 Identity Database Query" height="250px"><h3>Seq</h3><p>Looking at Seq is a little easier! We just need to go to the <a href="http://127.0.0.1.xip.io:5341" target="_blank" rel="noopener">http://127.0.0.1.xip.io:5341</a> URL. Since we are in a single-user license and with no authentication turned on or hooked up, we'll simply land on the query screen!</p><img src="/images/dwhite/Seq-landing-page.png" alt="Seq Landing Page" height="250px"><p>Now, we can start to just get a taste of the benefit of a embedded log-ingestion application. We can see that the apps are all logging into the Seq platform.</p><img src="/images/dwhite/Seq-application-name-query.png" alt="Seq distinct query" height="250px"><p>And now we can start to look at basic loads across all three applications <em>in the same timeframe</em>.</p><img src="/images/dwhite/seq-query-visualization-all-apps.png" alt="Seq load query for all applications" height="250px"><p>I'll leave a much deeper exploration of what Seq can do for you as homework! I know your probably already at home (or work?!?!) but I'm not going to directly explore Seq's capabilities in this blog post! I'll save that for another series. But you should definitely go check out <a href="https://www.datalust.co/seq" target="_blank" rel="noopener">Seq by DataLust.co</a>.</p><blockquote><p>I am not affiliated with Datalust or Seq in anyway. I get no money for this. I just really like the product.</p></blockquote><h3>STS</h3><p>Database. Check!Database Admin. Check!Log Ingestion. Check!</p><p>Now we get to see the applications (finally) that is the reason we are doing all of the rest of this work.</p><blockquote><p>Ensure the <strong>DockerCompose</strong> project is running in Visual Studio.</p></blockquote><p>If you navigate to <a href="http://127.0.0.1.xip.io" target="_blank" rel="noopener">http://127.0.0.1.xip.io</a> you will land on the STS login page.</p><img src="/images/dwhite/sts-landing-page.png" alt="Security Token Service Landing Page" height="250px"><blockquote><p>If you have another web server running and serving pages on port 80 you may have a conflict here.</p></blockquote><p>We can log into this application using the account that was created for us! We saw the <strong>admin</strong> account in the pgAdmin4 query of the <code>Users</code> table!</p><img src="/images/dwhite/sts-login-page.png" alt="Security Token Service Login Page" height="250px"><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"IdentityData"</span>: &#123;</span><br><span class="line">    <span class="attr">"Roles"</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"Name"</span>: <span class="string">"IdentityAdminRole"</span></span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"Users"</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"Username"</span>: <span class="string">"admin"</span>,</span><br><span class="line">        <span class="attr">"Password"</span>: <span class="string">"P@ssw0rd!"</span>,</span><br><span class="line">        <span class="attr">"Email"</span>: <span class="string">"admin@codingwithdave.xyz"</span>,</span><br><span class="line">        <span class="attr">"Roles"</span>: [</span><br><span class="line">          <span class="string">"IdentityAdminRole"</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="attr">"Claims"</span>: [</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">"Type"</span>: <span class="string">"name"</span>,</span><br><span class="line">            <span class="attr">"Value"</span>: <span class="string">"admin"</span></span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Once we are logged into the STS, we can see that users can manage <em>their</em> details. They can look at the applications they've granted permissions to, they can look at their profile data. They can delete their personal data, turn on MFA, and change their password! Phew!</p><img src="/images/dwhite/sts-user-functions.png" alt="Security Token Service User Functions" height="250px"><p>Again, I'll leave a deeper exploration of the STS for homework. You should have enough familiarity after working through the IdentityServer4 Quickstarts that most of this will seem familiar. Also, this is only the user profile information, so it isn't exciting.</p><h3>Admin</h3><p>Next, we'll open a tab to the Admin application. If you are already logged into the STS, you won't be challenged for a username/password but have no doubt, you were authenticated!</p><p>Navigate to <a href="http://127.0.0.1.xip.io:9000" target="_blank" rel="noopener">http://127.0.0.1.xip.io:9000</a> you will land on the Admin application landing page.</p><img src="/images/dwhite/admin-landing-page.png" alt="Admin Landing Page" height="250px"><p>If you were not logged in, you would have been re-directed to the STS to enter your credentials, prove who you were, and then returned to the Admin page. Give it a try. Log out of the STS and try going to the admin URL again!</p><p>There is a lot to learn about administering an IdentityServer4 implementation. I'm going to cop out again and leave you to explore this as homework.</p><h3>Admin Api</h3><p>Last but not least, the Swashbuckle Api Explorer application (swagger) that is embedded in the AdminApi project!</p><p>Navigate to <a href="http://127.0.0.1.xip.io:5000/swagger" target="_blank" rel="noopener">http://127.0.0.1.xip.io:5000/swagger</a> you will land on the Admin WebApi ApiExplorer page.</p><img src="/images/dwhite/swashbuckle-api-explorer.png" alt="Swashbuckle Api Explorer" height="250px"><p>The Api Explorer is already setup to leverage token-based authentication, so if you hit the Authorize button, you'll be directed to log in (authenticate) with the STS (if you haven't already). If you are already authenticated, you may be asked by the Api Explorer app for your consent to use your profile details, but you won't have to type in your username/password again. And if you allow your consent to be remembered, you won't be challenged for it again.</p><p>If you execute any of the API methods before you are authorized, you'll get the dreaded <strong>401</strong> Unauthorized HTTP status code!</p><img src="/images/dwhite/swashbuckle-api-explorer-unauthorized.png" alt="Swashbuckle Api Explorer Unauthorized" height="250px"><p>Now get authenticated!</p><img src="/images/dwhite/swashbuckle-api-explorer-authorize.png" alt="Swashbuckle Api Explorer Authorize" height="250px"><p>And this time, we are authorized and our API call succeeds!</p><img src="/images/dwhite/swashbuckle-api-explorer-authorized.png" alt="Swashbuckle Api Explorer Authorized" height="250px"><h2>Summary</h2><p>Now that is it! Wow! That was a lot of work! But we have been rewarded by a fully functioning IdentityServer4 running on our machine with a Postgres DB as persistence, pgAdmin4 for database administration, and Seq for log ingestion!</p><p>One thing I didn't do for demonstration purposes is do any sort of custom-branding on the Skoruba applications, but they are just ASP.NET Core 3.1 <em>web applications</em> that you already know how to modify and enhance. The Skoruba template has a little bit of built-in branding configuration, but you can certainly charge ahead and make this look however you'd like.</p><p>So, there we go. We have a fully functional system running in Docker, but that isn't going to help us where we are going. Time for the next step and we move our platform to <strong>Kubernetes</strong>!!</p><p><strong>Next up:</strong><a href="/kubernetes/kubernetes-my-journey-part-5a">Getting Started with Kubernetes - Minikube</a></p><style>    h1, h2, h3, h4, h5, h6 {       margin-top: 25px;    }    figure.highlight{        background-color: #E8EEFE;    }    figure.highlight .gutter{        color: #0033CD;    }    figure.highlight pre {        font-family: 'Cascadia Code PL', monospace;    }    code {        font-family: 'Cascadia Code PL', sans-serif;        border-width: 0.1em;        border-color: #E8EEFE;        border-style: solid;        border-radius: 0.3em;        background-color: #E8EEFE;        color: #0033CD;        padding: 0em 0.4em;        white-space: nowrap;    }</style><link  href="https://cdnjs.cloudflare.com/ajax/libs/viewerjs/1.5.0/viewer.min.css" rel="stylesheet"><script src="https://cdnjs.cloudflare.com/ajax/libs/viewerjs/1.5.0/viewer.min.js"></script><script>// View an imageconst gallery = new Viewer(document.getElementById('mainPostContent', {    "navbar": false,    "toolbar": false}));</script>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;a href=&quot;/kubernetes/kubernetes-my-journey&quot;&gt;Series Table of Contents&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Previously:&lt;/strong&gt;
&lt;a href=&quot;/kubernetes/kuberne
    
    </summary>
    
      <category term="kubernetes" scheme="https://westerndevs.com/categories/kubernetes/"/>
    
    
      <category term="kubernetes, azure, aks, identityserver, docker, containers" scheme="https://westerndevs.com/tags/kubernetes-azure-aks-identityserver-docker-containers/"/>
    
  </entry>
  
  <entry>
    <title type="html">Kubernetes - My Journey - Part 5a</title>
    <link href="https://westerndevs.com/kubernetes/kubernetes-my-journey-part-5a/" rel="alternate" type="text/html"/>
    <id>https://westerndevs.com/kubernetes/kubernetes-my-journey-part-5a/</id>
    <published>2020-05-22T12:00:00.000Z</published>
    <updated>2020-11-09T21:27:02.246Z</updated>
	<author>
	
	  
	  <name>Dave White</name>
	  <email>dmhwhite@gmail.com</email>
	
	  <uri>https://westerndevs.com</uri>
	</author>
    
    <content type="html"><![CDATA[<p><a href="/kubernetes/kubernetes-my-journey">Series Table of Contents</a></p><p><strong>Previously:</strong><a href="/kubernetes/kubernetes-my-journey-part-4">Building an ASP.NET Core IdentityServer Implementation</a></p><h1>Getting Started with Kubernetes - Minikube - Part A</h1><p>We're finally getting to the part of the series where we have a group of applications and we want to have them live in <strong>Kubernetes (k8s)</strong>. In order to do that, we need to have <strong>k8s</strong> on our local development machine and we are going to use <strong>Minikube</strong> to do that.</p><h2>Important Caveat</h2><p>I'm going to make an assumption that at a minimum, you've reviewed various types of <strong>k8s</strong> resources on <a href="https://kubernetes.io" target="_blank" rel="noopener">kubernetes.io</a> and in a best case scenario, you've watched Nigel Poulton's Pluralsight course <a href="https://app.pluralsight.com/library/courses/getting-started-kubernetes/table-of-contents" target="_blank" rel="noopener">Getting Started with Kubernetes</a>. If you haven't, my discussions about these topics may be harder to understand because they do not cover these basics.</p><p>Also, my understanding of Kubernetes is certainly not as extensive as I'd like. I'm not sure I'd hazard calling myself an expert. I've got a working cluster and applications in that cluster but I am not going to make the statement that I've done it all right or with the current best practices in place. This is a learning exercise for me (and you) and while I want to get you with a cluster up and running as soon as possible, I expect you to learn/challenge/grow your <strong>k8s</strong> cluster knowledge as well.</p><h2>Getting started</h2><p>Thankfully, I don't have to create a huge blog post on this! There is already some great documentation at <a href="https://kubernetes.io" target="_blank" rel="noopener">kubernetes.io</a> that gets you setup with <a href="https://kubernetes.io/docs/setup/learning-environment/minikube/#installation" target="_blank" rel="noopener">a learning environment based on minikube</a> so I'll just let you go there and read the installation guide! I'm using v1.9.2 of minikube during the creation of this series of articles.</p><h3>A Powershell Script</h3><p>It is certainly easy enough to remember some commands when standing up your environment, but as we work through getting everything into minikube using the command-line and manifests, it can become quite a list of commands and so I'd recommend creating a powershell script that you can capture your commands in the order that you are likely to execute them.</p><p>The way that I've been structuring my source files is:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">project_root</span><br><span class="line">      |- infra</span><br><span class="line">      |- manifests</span><br><span class="line">      |- src</span><br></pre></td></tr></table></figure><p>The <strong>src</strong> folder is where the ASP.NET Core applications are. You can ignore the <strong>infra</strong> directory for a while, but for this part of the journey, we'll be using the <strong>manifests</strong> folder to store all of our <strong>k8s</strong> declarative manifest files. This is also where I store my <strong>stand-up.ps1</strong> powershell script file!</p><p>The first line in your stand-up.ps1 file should probably be (if your on windows):</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">minikube start -<span class="literal">-vm</span><span class="literal">-driver</span>=hyperv -<span class="literal">-cpus</span>=<span class="number">4</span> -<span class="literal">-memory</span>=<span class="number">16</span>g -<span class="literal">-extra</span><span class="literal">-config</span>=apiserver.service<span class="literal">-node</span><span class="literal">-port</span><span class="literal">-range</span>=<span class="number">80</span><span class="literal">-33000</span></span><br></pre></td></tr></table></figure><p>This is saying:</p><ul><li>start minikube<ul><li>use the hyperv driver</li><li>with 4 logical CPUS (4 of the <em>n</em> you have in Task Manager - Performance Tab)</li><li>with 16 gb of memory</li><li>20 gb of disk space (default value)</li><li>and expanding the range of usable ports in minikube</li></ul></li></ul><p>You're going to want to adjust these numbers to what make sense for your workstation. I have a i9-9900k with 64 gbs of memory, so these numbers makes sense for me. You can certainly run all of this on 1 CPU and 4 gb of RAM with no problems. As you build <strong>k8s</strong> clusters with more hosted pods, you'll probably need to increase the values when starting minikube.</p><blockquote><p>It is important to understand that this command creates a virtual machine, running linux, in hyperv, on your local workstation. If you want to change these parameters, you'll need to destroy your current minikube instance and re-create a new one.</p></blockquote><p>Out of the box, <strong>k8s</strong> (minikube) limits the port range of containers in the cluster to 30000-33000. I've expanded this range because I want to use the same port values that we used in docker. This expanded range allows <strong>k8s</strong> in minikube to use more ports, but it doesn't claim all of them.</p><p>After the minikube VM has been created (which may take a few minutes), we can then invoke our next command to make sure it is up and running!</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Start a tunnel from your local machine into minikube and the kubernetes dashboard</span></span><br><span class="line"><span class="comment"># 127.0.0.1 should open in a browser window for you and it should be the Kubernetes Web UI in minikube</span></span><br><span class="line"><span class="built_in">Start-Process</span> <span class="literal">-NoNewWindow</span> minikube dashboard</span><br></pre></td></tr></table></figure><p>Using this powershell command, the process creating the tunnel is started and control of the shell is returned to you, but the process remains running. When you close down this shell, the running process will also be closed and the tunnel will close.</p><p>Hopefully, the tunnel started, a browser window opened and you can see the Kubernetes Web UI for your new minikube <strong>k8s</strong> cluster! Let's leave this browser window open and we can keep our eyes on it.</p><h2>Putting your backend into the cluster</h2><p>Now that <strong>k8s</strong> is running on your local machine, we can start to install our backend services into the cluster. We'll do this activity first, with easy to configure pods, to get used to working with manifests. Installing our IdentityServer4-based applications will require some additional resources and automation.</p><p>In this section, we will start the process of converting our docker-compose.yml into a bunch of <strong>k8s</strong> <em>manifest</em> files. We could do this as a monolithic manifest file, but I prefer smaller manifest files. They are easier to think about and just as easy to use.</p><h3>Postgres manifests</h3><p>If we look at the postgres section of our docker-compose.yml file, we will see a couple of things.</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">postgresdb:</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">postgres:alpine</span></span><br><span class="line">  <span class="attr">hostname:</span> <span class="string">postgres</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">"5432:5432"</span></span><br><span class="line">  <span class="attr">container_name:</span> <span class="string">postgresdb</span></span><br><span class="line">  <span class="attr">environment:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">"POSTGRES_USER=admin"</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">"POSTGRES_PASSWORD=P@ssw0rd!"</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">"POSTGRES_DB=identity"</span> <span class="comment"># this is the db name that will be generated by EFCore</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">postgresdata:/var/lib/postgresql/data</span></span><br><span class="line">  <span class="attr">networks:</span></span><br><span class="line">    <span class="attr">default:</span></span><br><span class="line">      <span class="attr">aliases:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">postgres</span></span><br></pre></td></tr></table></figure><ul><li>an image from DockerHub</li><li>container name</li><li>ports that are exposed</li><li>environmental variable declarations</li><li>attached persistent volumes</li><li>network alias</li></ul><p>In <strong>k8s</strong>, those concepts are separated into different types of resources that we will want to provision. Generally speaking, the container-based resources will be described in a <strong>Deployment</strong> manifest and the network-based resources will be described in a <strong>Service</strong> manifest.</p><blockquote><p>I tend to clump container-based concerns into a <em>manifest</em> file. So in this case, with postgres, I will also describe the <strong>PersistentVolume</strong> resources in with the Deployment resources.</p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">postgres-pv-volume</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">local</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">manual</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">1Gi</span></span><br><span class="line">  <span class="attr">hostPath:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/var/lib/postgresql/data</span></span><br><span class="line"><span class="comment"># divider to separate resource declarations in a yaml file</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">postgres-pv-claim</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">manual</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">1Gi</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">postgres-dep</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">postgres</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">revisionHistoryLimit:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">postgres</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">postgres</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">postgres-pv-storage</span></span><br><span class="line">          <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">            <span class="attr">claimName:</span> <span class="string">postgres-pv-claim</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">postgres</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">postgres:alpine</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POSTGRES_USER</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">"admin"</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POSTGRES_PASSWORD</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">"P@ssw0rd!"</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POSTGRES_DB</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">"identity"</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">5432</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">"/var/lib/postgresql/data"</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">postgres-pv-storage</span></span><br></pre></td></tr></table></figure><p>Let's decompose that Deployment manifest in more detail.</p><h4>PersistenVolume</h4><p>From <em>kubernetes.io</em>...</p><p><em>A PersistentVolume (PV) is a piece of storage in the cluster that has been provisioned by an administrator or dynamically provisioned using Storage Classes. It is a resource in the cluster just like a node is a cluster resource.</em></p><p>So we need to have some disk space made available for us to use in the cluster.</p><p><a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/" target="_blank" rel="noopener">PersistentVolumes</a></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">postgres-pv-volume</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">local</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">postgres</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">manual</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">1Gi</span></span><br><span class="line">  <span class="attr">hostPath:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/var/lib/postgresql/data</span></span><br></pre></td></tr></table></figure><p>The <strong>TL;DR;</strong> (too long; didn't read it) description of this resource description is:</p><ul><li>Create a volume on the linux host (<strong>k8s</strong> <em>node</em>)<ul><li>at the path described</li><li>make it 1Gi large</li><li>only let <em>one</em> node (VM/host) connect to it</li></ul></li></ul><h4>PersistentVolumeClaim</h4><p>From <em>kubernetes.io</em>...</p><p><em>A PersistentVolumeClaim (PVC) is a request for storage by a user. It is similar to a Pod. Pods consume node resources and PVCs consume PV resources. Pods can request specific levels of resources (CPU and Memory).</em></p><p>We need to claim some of the disk resources from the cluster (the PersistentVolume) in the same way that we would request some CPU or memory capacity from the cluster. It is important to explore the relationship between PV and PVC. <a href="https://rancher.com/blog/2018/2018-09-20-unexpected-kubernetes-part-1/" target="_blank" rel="noopener">This blog article</a> provides some insights as does this <a href="https://stackoverflow.com/questions/48956049/what-is-the-difference-between-persistent-volume-pv-and-persistent-volume-clai" target="_blank" rel="noopener">Stack Overflow Question/Answer</a>.</p><p>As I understand it, we will need to do this PV+PVC technique because we are using minikube, not AKS, and the storageClassName that we are using (manual) doesn't allow for <em>dynamic</em> provisioning of the storage resource. This will change when we move to AKS.</p><p><a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/#persistentvolumeclaims" target="_blank" rel="noopener">PersistentVolumeClaims</a></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">postgres-pv-claim</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">postgres</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">manual</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">1Gi</span></span><br></pre></td></tr></table></figure><h4>Deployment</h4><p>So we have the persistent storage that we want for our database setup. Now we need to get postgres deployed into our cluster.</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">postgres-dep</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">postgres</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">revisionHistoryLimit:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">postgres</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">postgres</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">volumes:</span> <span class="comment">#this pod is going to claim this PVC and call it postgres-pv-storage</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">postgres-pv-storage</span></span><br><span class="line">          <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">            <span class="attr">claimName:</span> <span class="string">postgres-pv-claim</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">postgres</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">postgres:alpine</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POSTGRES_USER</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">"admin"</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POSTGRES_PASSWORD</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">"P@ssw0rd!"</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POSTGRES_DB</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">"identity"</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">5432</span></span><br><span class="line">          <span class="attr">volumeMounts:</span> <span class="comment"># this container is going to mount the volume that is the claimed PVC</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">"/var/lib/postgresql/data"</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">postgres-pv-storage</span></span><br></pre></td></tr></table></figure><p>There is a lot that goes into a Deployment manifest. You can <a href="https://kubernetes.io/docs/concepts/workloads/controllers/deployment/" target="_blank" rel="noopener">see more details here</a> in the event that you need a refresher.</p><p>We've created this manifest that will stand-up Postgres in the <strong>k8s</strong> cluster. Now we can use <strong>kubectl</strong> to run this manifest against our cluster.</p><p>First, let's make sure our kubectl is configured to point at minikube.</p><p><code>kubectl config current-context</code> should report <strong>minikube</strong>.</p><p>Next, let's run the postgre-dep.yml file through kubectl.</p><p><code>kubectl create -f .\postgres-dep.yml</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">PS D:\temp\testidentity\MyProject\manifests&gt; kubectl create -f .\postgres-dep.yml</span><br><span class="line"></span><br><span class="line">persistentvolume/postgres-pv-volume created</span><br><span class="line">persistentvolumeclaim/postgres-pv-claim created</span><br><span class="line">deployment.apps/postgres-dep created</span><br><span class="line"></span><br><span class="line">PS D:\temp\testidentity\MyProject\manifests&gt;</span><br></pre></td></tr></table></figure><p>Now go to the browser window that is showing you the <strong>Kubernetes Web UI</strong> and you should see all of the new resources in your cluster!</p><h5>PersistentVolume In the Cluster</h5><img src="/images/dwhite/postgres-deployment-persistentvolume.png" alt="Postgres PersistentVolume Created" height="250px"><p>Notice how this PV is a resource <em>in the cluster</em> and not related to any particular pod.</p><h5>Postgres-based Resources</h5><p>If you'd like to see only the Postgres resources,you can use the Search bar to filter everything else out.</p><img src="/images/dwhite/kubernetes-search-bar.png" alt="Postgres Deployment Completed" height="120px"><p>And now we can see all of the resources we just deployed, and explore them in more detail individually.</p><img src="/images/dwhite/postgres-deployment-completed.png" alt="Postgres Deployment Completed" height="250px"><p>So that completes putting our Postgres database into the cluster! Now we have to expose it.</p><h4>Postgres Service Manifest</h4><p>From <em>kubernetes.io</em>...</p><p><em>An abstract way to expose an application running on a set of Pods as a network service.</em><em>With Kubernetes you dont need to modify your application to use an unfamiliar service discovery mechanism. Kubernetes gives Pods their own IP addresses and a single DNS name for a set of Pods, and can load-balance across them.</em></p><p><a href="https://kubernetes.io/docs/concepts/services-networking/service/" target="_blank" rel="noopener">Services</a></p><p>Generally, you want to present as little surface area for security reasons as possible, so I have no desire to expose the database outside of the cluster. We still need a service resource created so that the container gets a DNS name within the cluster, and as containers/pods come and go, the cluster will ensure that the DNS entry always points to the right place.</p><p>So in this service manifest, we are basically telling <strong>k8s</strong> to map the DNS entry <strong>postgres-svc</strong> to whatever pod spins up with the label <strong>app:postgres</strong>.</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">postgres-svc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">postgres</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">5432</span></span><br></pre></td></tr></table></figure><h3>pgAdmin4 Deployment manifests</h3><p>The pgAdmin4 deployment manifest is very similar to the postgres-dep.yml file we've created already. So I'll just post it in here so you can take a look at it. The only things that are really different are the environmental variables and the names of things.</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pgadmin4-pv-volume</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">local</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">manual</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">1Gi</span></span><br><span class="line">  <span class="attr">hostPath:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/var/lib/pgadmin4/data</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pgadmin4-pv-claim</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">manual</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">1Gi</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pgadmin4-dep</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">pgadmin4</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">revisionHistoryLimit:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">pgadmin4</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">pgadmin4</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">pgadmin4-pv-storage</span></span><br><span class="line">          <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">            <span class="attr">claimName:</span> <span class="string">pgadmin4-pv-claim</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">pgadmin4</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">dpage/pgadmin4</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">PGADMIN_DEFAULT_EMAIL</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">"admin@codingwithdave.xyz"</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">PGADMIN_DEFAULT_PASSWORD</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">"P@ssw0rd!"</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">"/var/lib/pgadmin/data"</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">pgadmin-pv-storage</span></span><br></pre></td></tr></table></figure><h3>pgAdmin4 Service manifests</h3><p>Since I do want to be able to access the pgAdmin4 application from outside of the cluster, we need to make a service manifest that exposes the pgAdmin4 pod.</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pgadmin4-svc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">pgadmin4</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">nodePort:</span> <span class="number">5050</span></span><br></pre></td></tr></table></figure><p>Simply speaking, this manifest says to create a NodePort service resource for this pod and expose it on port 5050. Notice that the <strong>spec: selector:</strong> is saying that this service will be applied to pods with the same label of <strong>pgadmin4</strong>. Remember, in <strong>k8s</strong>, labels are usually very important. And because of the <strong>type: NodePort</strong> on this service, we will be able to access this pod from outside of the cluster.</p><blockquote><p>If you want to expose your Postgres resource outside of the cluster, you can change that manifest to create a <strong>type: NodePort</strong> service exposing the postgres pod on port 5432.</p></blockquote><p>Now we need to use kubectl to create this resource in the cluster.</p><p><code>kubectl create -f .\pgadmin4-svc.yml</code></p><p>You should see the new pgAdmin4 resources in your cluster.</p><p>We can also now use another feature of minikube which allows you to expose services in your cluster to the outside world on minikube's IP address. In order to expose pgAdmin4, simply type:</p><p><code>minikube service pgadmin4-svc</code></p><p>Minikube should then create a tunnel into the cluster for you, and open a web browser to the URL that was generated!</p><p>You can also use <code>minikube service list</code> at any time to see a list of the exposed services in your cluster.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">PS D:\temp\testidentity\MyProject\manifests&gt; minikube service list  </span><br><span class="line"></span><br><span class="line">|----------------------|---------------------------|--------------|----------------------------|</span><br><span class="line">|      NAMESPACE       |           NAME            | TARGET PORT  |            URL             |</span><br><span class="line">|----------------------|---------------------------|--------------|----------------------------|</span><br><span class="line">| default              | kubernetes                | No node port |                            |</span><br><span class="line">| default              | pgadmin4-svc              |           80 | http://172.28.129.202:5050 |</span><br><span class="line">| default              | postgres-svc              | No node port |                            |</span><br><span class="line">| kube-system          | kube-dns                  | No node port |                            |</span><br><span class="line">| kubernetes-dashboard | dashboard-metrics-scraper | No node port |                            |</span><br><span class="line">| kubernetes-dashboard | kubernetes-dashboard      | No node port |                            |</span><br><span class="line">|----------------------|---------------------------|--------------|----------------------------|</span><br></pre></td></tr></table></figure><p>You should be able to log into pgAdmin4 with the credentials we've come to know and love (<strong>user:</strong> admin@codingwithdave.xyz <strong>pwd:</strong> P@ssw0rd!). Once in there, you will be able to re-create your server list entry, but this time, the location of the server is the name of the postgres service, as described in the metadata: element of the yaml.</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">postgres-svc</span></span><br></pre></td></tr></table></figure><img src="/images/dwhite/minikube-postgres-server-location.png" alt="Postgres Deployment Completed" height="250px"><h3>Seq Deployment manifests</h3><p>The Seq deployment manifest is very similar to the others we've created already. So take a look, and then put Seq into your minikube cluster.</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">seq-pv-volume</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">local</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">manual</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">3Gi</span></span><br><span class="line">  <span class="attr">hostPath:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/mnt/data/seqv6/</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">seq-pv-claim</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">manual</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">3Gi</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">seq-dep</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">seq</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">revisionHistoryLimit:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">seq</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">seq</span> </span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">seq-pv-storage</span></span><br><span class="line">          <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">            <span class="attr">claimName:</span> <span class="string">seq-pv-claim</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">seq</span> </span><br><span class="line">        <span class="attr">image:</span> <span class="string">datalust/seq:preview</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">"/data"</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">seq-pv-storage</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ACCEPT_EULA</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">"Y"</span></span><br></pre></td></tr></table></figure><p><code>kubectl create -f .\seq-dep.yml</code> will get your resources created!</p><h3>Seq Service manifests</h3><p>We want to see Seq outside of the cluster, so we will also want to expose it with a <strong>NodePort</strong> service.</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">seq-svc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">seq</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">nodePort:</span> <span class="number">5341</span></span><br></pre></td></tr></table></figure><p><code>kubectl create -f .\seq-dep.yml</code> will get your service resource created!</p><p>Then expose your service via:</p><p><code>minikube service seq-svc</code></p><p>And voila! A browser window opens and you'll see Seq!! Nothing is logging there yet, but it's there! Woo hoo!!</p><h2>Summary</h2><p>Hopefully now, you've shifted all of the backend services required for our IdentityServer4 applications into minikube! They are all up and running, and you've been able to access pgAdmin4 (connected to the postgres db) and you've been able to access Seq, even if nothing is logging to it!</p><p>This has been really long post, so I'm going to take a break, let you have a break, and continue on to Part B of putting our system in Minikube!</p><p><strong>Next up:</strong><a href="/kubernetes/kubernetes-my-journey-part-5b">Getting Started with Kubernetes - Minikube - Part B</a></p><style>    h1, h2, h3, h4, h5, h6 {       margin-top: 25px;    }    figure.highlight{        background-color: #E8EEFE;    }    figure.highlight .gutter{        color: #0033CD;    }    figure.highlight pre {        font-family: 'Cascadia Code PL', monospace;    }    code {        font-family: 'Cascadia Code PL', sans-serif;        border-width: 0.1em;        border-color: #E8EEFE;        border-style: solid;        border-radius: 0.3em;        background-color: #E8EEFE;        color: #0033CD;        padding: 0em 0.4em;        white-space: nowrap;    }</style><link  href="https://cdnjs.cloudflare.com/ajax/libs/viewerjs/1.5.0/viewer.min.css" rel="stylesheet"><script src="https://cdnjs.cloudflare.com/ajax/libs/viewerjs/1.5.0/viewer.min.js"></script><script>// View an imageconst gallery = new Viewer(document.getElementById('mainPostContent', {    "navbar": false,    "toolbar": false}));</script>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;a href=&quot;/kubernetes/kubernetes-my-journey&quot;&gt;Series Table of Contents&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Previously:&lt;/strong&gt;
&lt;a href=&quot;/kubernetes/kuberne
    
    </summary>
    
      <category term="kubernetes" scheme="https://westerndevs.com/categories/kubernetes/"/>
    
    
      <category term="kubernetes, azure, aks, identityserver, docker, containers" scheme="https://westerndevs.com/tags/kubernetes-azure-aks-identityserver-docker-containers/"/>
    
  </entry>
  
  <entry>
    <title type="html">Kubernetes - My Journey - Part 5b</title>
    <link href="https://westerndevs.com/kubernetes/kubernetes-my-journey-part-5b/" rel="alternate" type="text/html"/>
    <id>https://westerndevs.com/kubernetes/kubernetes-my-journey-part-5b/</id>
    <published>2020-05-22T11:00:00.000Z</published>
    <updated>2020-11-09T21:27:02.246Z</updated>
	<author>
	
	  
	  <name>Dave White</name>
	  <email>dmhwhite@gmail.com</email>
	
	  <uri>https://westerndevs.com</uri>
	</author>
    
    <content type="html"><![CDATA[<p><a href="/kubernetes/kubernetes-my-journey">Series Table of Contents</a></p><p><strong>Previously:</strong><a href="/kubernetes/kubernetes-my-journey-part-5a">Getting Started with Kubernetes - Minikube - Part A</a></p><h1>Getting Started with Kubernetes - Minikube - Part B</h1><p>We're finally getting to the part of the series where we have a group of applications and we want to have them live in <strong>Kubernetes (k8s)</strong>. In order to do that, we need to have <strong>k8s</strong> on our local development machine and we are going to use <strong>Minikube</strong> to do that.</p><h2>Important Caveat</h2><p>I'm going to make an assumption that at a minimum, you've reviewed various types of <strong>k8s</strong> resources on kubernetes.io and in a best case scenario, you've watched Nigel Poulton's Pluralsight course <a href="https://app.pluralsight.com/library/courses/getting-started-kubernetes/table-of-contents" target="_blank" rel="noopener">Getting Started with Kubernetes</a>. If you haven't, some of the stuff I discuss will not have sufficient detail in this post to close the gap.</p><p>Also, my understanding of Kubernetes is certainly not as extensive as I'd like. I'm not sure I'd hazzard calling myself an expert. I've got a working cluster and applications in that cluster but I am not going to make the statement that I've done it all right or with the current best practices in place. This is a learning exercise for me (and you) and while I want to get you with a cluster up and running as soon as possible, I expect you to learn/challenge/grow your <strong>k8s</strong> cluster knowledge as well.</p><h2>Continuing on...</h2><p>So we've now deployed all of our backend services into minikube. There is a little detail that probably went un-noticed until now. Where did minikube get the container images from? In this case, it pulled the postgres, pgAdmin4, and Seq container images from <a href="https://hub.docker.com/" target="_blank" rel="noopener">DockerHub</a>, a public container registry. So if you want to publish your custom-built Skoruba templates to DockerHub, everything will keep on working without any changes. But chances are, your going to want to publish those images to a private container registry such a DockerHub (private) or in my case, an Azure Container Registry hosted in our Azure subscription.</p><h3>What about my local docker repository?</h3><p>You may be asking, you've built your app locally and deployed it to Docker Desktop registry, why can't I just get it from there?</p><p>Minikube (<strong>k8s</strong> in the VM) has it's own docker daemon instance running, so now you have two docker daemons running on your machine. One in Docker Desktop and one in minikube. And the one in minikube didn't build/deploy your applications, the Docker Desktop one did. But minikube doesn't use that one. It uses its own internal docker container registry or a public/private one from the internet. I've read that you can use minikube's docker daemon for builds, but I don't want to make any adjustments to your environment that might break the Docker Desktop experience so we'll just continue on with creating a private container registry. We need to get there eventually no matter what, so let's keep going!</p><h2>Azure Container Registry (ACR)</h2><p>For this part of the journey, we are going to leave Visual Studio and the comfort of C# and yaml and journey to the <a href="https://portal.azure.com" target="_blank" rel="noopener">Azure Subscription</a> that we want to host our private container registry in!</p><p>At this point, you'll need to have access to a Azure subscription. Microsoft has made it very easy to create them (they are free) and use them (there are lots of free services)! The ACR service is not free, but it is pretty inexpensive for the Basic SKU which holds up to 10gb of container images.</p><p>If an Azure ACR is not in the cards for you, you can continue (without my help for the moment) with a free DockerHub public registry, or a private container registry that you may already have access to.</p><p>For this part of the project, I'll be using my Depth Consulting Azure Subscription and Azure DevOps Service instance. My client, who has the identity management business problem, also has Azure DevOps Server 2019 and an Azure subscription that holds their private ACR.</p><h3>Creating the ACR</h3><p>Creating a ACR is very easy.</p><ol><li>Log into the <a href="https://portal.azure.com" target="_blank" rel="noopener">Azure Portal</a></li><li>Create a new ACR Resource<br/><img src="/images/dwhite/azure-container-registry-create.png" alt="Create an Azure Container Registry" height="250px"></li><li>Follow the wizard and complete the creation of your ACR<ul><li>pick the <strong>Basic</strong> SKU. It is more than enough for now and you can upgrade later.</li><li>The Basic ACR costs about $0.17 per day for 10GiB of storage.</li></ul></li></ol><p>Tada! ACR created!</p><img src="/images/dwhite/azure-container-registry-created.png" alt="Azure Container Registry Created" height="250px"><blockquote><p>I could create the ACR via Pulumi but it is a one-and-done kind of activity, so I didn't do that. It's just easier to create it in the portal.</p></blockquote><h3>Secrets! Secrets! Secrets!</h3><p>In order to access a private container registry, you need credentials! And more specifically, your <strong>k8s</strong> <em>cluster</em> needs the credentials for your private container registry. And it isn't just <strong>k8s</strong> that needs those credentials, your DevOps pipeline will need those credentials as well in order to publish container images into the registry.</p><p>Our ACR credentials are available in the Azure Portal. You can find the ones we'll need there.</p><img src="/images/dwhite/azure-container-registry-credentials.png" alt="Azure Container Registry Created" height="250px"><p>Remember where they are. When we get back to manifest land, we'll need them.</p><h2>Azure DevOps Service (Server 2019)</h2><p>Now that we have a private container registry, we need to build our IdentityServer4 applications and publish those container images to our ACR. If you do not have an Azure DevOps Service instance, you can <a href="https://azure.microsoft.com/en-ca/services/devops/" target="_blank" rel="noopener">create one for free</a>.</p><blockquote><p>I will try to create blog post sometime doing something like this from <a href="https://github.com/" target="_blank" rel="noopener">GitHub</a>, using <a href="https://github.com/features/actions" target="_blank" rel="noopener">GitHub Actions</a> with a public <a href="https://hub.docker.com/" target="_blank" rel="noopener">DockerHub</a> Registry.</p></blockquote><h3>Assumptions</h3><p>I'm progressing on the assumption that your IdentityServer4 implementation projects have been checked into a git repository somewhere. If this is in an Azure DevOps Services instance, that's great, but it can be GitHub or any other repository that Azure DevOps Pipelines can monitor for changes.</p><h3>Build and Publish in one Pipeline</h3><p>The next step is to build and publish our applications. For this, we're going to leverage Azure DevOps Pipelines that contain a couple DockerCompose tasks. Thankfully, this is very easy to setup in thanks to the pipeline templates and the integration between Azure Portal and Azure DevOps Services.</p><ol><li><p>Go to your Pipelines in Azure DevOps Service instance</p></li><li><p>Create a new Pipeline<img src="/images/dwhite/azure-pipelines-create.png" alt="Create new Azure Pipeline" height="180px"></p></li><li><p>Connect the pipeline to your repository</p></li><li><p>On the <em>Configure your pipeline</em> wizard step, select <strong>Docker - Build and Push an Image to Azure Container Registry</strong><img src="/images/dwhite/azure-pipelines-configure-pipeline.png" alt="Configure the pipeline" height="250px"></p></li><li><p>Select your Azure subscription with the ACR in it<img src="/images/dwhite/azure-pipelines-select-azure-subscription.png" alt="Select your Azure Subscription" height="250px"></p></li><li><p>Select your ACR that you want the images in<img src="/images/dwhite/azure-pipelines-select-acr.png" alt="Select your ACR in the subscription" height="250px"></p><ul><li>don't worry about the <strong>image name</strong> or <strong>Dockerfile</strong> parameters. They'll be deleted in a moment</li></ul></li><li><p>Create the new pipeline</p></li><li><p>Delete the whole Docker@2 task</p> <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">stages:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">stage:</span> <span class="string">Build</span></span><br><span class="line">  <span class="attr">displayName:</span> <span class="string">Build</span> <span class="string">and</span> <span class="string">push</span> <span class="string">stage</span></span><br><span class="line">  <span class="attr">jobs:</span>  </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job:</span> <span class="string">Build</span></span><br><span class="line">    <span class="attr">displayName:</span> <span class="string">Build</span></span><br><span class="line">    <span class="attr">pool:</span></span><br><span class="line">      <span class="attr">vmImage:</span> <span class="string">$(vmImageName)</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">task:</span> <span class="string">Docker@2</span> <span class="comment"># &lt;-- remove this whole task</span></span><br><span class="line">      <span class="attr">displayName:</span> <span class="string">Build</span> <span class="string">and</span> <span class="string">push</span> <span class="string">an</span> <span class="string">image</span> <span class="string">to</span> <span class="string">container</span> <span class="string">registry</span></span><br><span class="line">      <span class="attr">inputs:</span></span><br><span class="line">        <span class="attr">command:</span> <span class="string">buildAndPush</span></span><br><span class="line">        <span class="attr">repository:</span> <span class="string">$(imageRepository)</span></span><br><span class="line">        <span class="attr">dockerfile:</span> <span class="string">$(dockerfilePath)</span></span><br><span class="line">        <span class="attr">containerRegistry:</span> <span class="string">$(dockerRegistryServiceConnection)</span></span><br><span class="line">        <span class="attr">tags:</span> <span class="string">|</span></span><br><span class="line">          <span class="string">$(tag)</span></span><br></pre></td></tr></table></figure></li><li><p>Delete the Docker@2 task variables</p> <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">variables:</span></span><br><span class="line">  <span class="comment"># Container registry service connection established during pipeline creation</span></span><br><span class="line">  <span class="attr">dockerRegistryServiceConnection:</span> <span class="string">'&lt;your service connection Id&gt;'</span></span><br><span class="line">  <span class="attr">imageRepository:</span> <span class="string">'identityserver'</span> <span class="comment"># &lt;-- delete</span></span><br><span class="line">  <span class="attr">containerRegistry:</span> <span class="string">'depthconsulting.azurecr.io'</span> <span class="comment"># &lt;-- delete</span></span><br><span class="line">  <span class="attr">dockerfilePath:</span> <span class="string">'$(Build.SourcesDirectory)/src/DepthConsulting.Identity.Admin.Api/Dockerfile'</span> <span class="comment"># &lt;-- delete</span></span><br><span class="line">  <span class="attr">tag:</span> <span class="string">'$(Build.BuildId)'</span></span><br></pre></td></tr></table></figure></li><li><p>With your cursor under the <strong>steps</strong> yaml entry, Add a Docker Compose task</p><ul><li>Work through the wizard and the Command is <strong>build</strong></li></ul></li><li><p>With your cursor under the last DockerCompose@0 task, Add another Docker Compose task</p><ul><li>Work through the wizard again and the Command is <strong>push</strong></li></ul></li><li><p>Save the pipeline and run it!</p><ul><li>You may need to give your pipeline permission to use a service principal to connect to the ACR. If you see that your pipeline is queued and waiting for persmission, go ahead and give it permission.</li></ul></li></ol><p>Your final pipeline yaml should look something like this.</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Docker</span></span><br><span class="line"><span class="comment"># Build and push an image to Azure Container Registry</span></span><br><span class="line"><span class="comment"># https://docs.microsoft.com/azure/devops/pipelines/languages/docker</span></span><br><span class="line"></span><br><span class="line"><span class="attr">trigger:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">master</span></span><br><span class="line"></span><br><span class="line"><span class="attr">resources:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">repo:</span> <span class="string">self</span></span><br><span class="line"></span><br><span class="line"><span class="attr">variables:</span></span><br><span class="line">  <span class="comment"># Container registry service connection established during pipeline creation</span></span><br><span class="line">  <span class="attr">dockerRegistryServiceConnection:</span> <span class="string">'&lt;your service connection guid here&gt;'</span></span><br><span class="line">  <span class="attr">tag:</span> <span class="string">'$(Build.BuildId)'</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># Agent VM image name</span></span><br><span class="line">  <span class="attr">vmImageName:</span> <span class="string">'ubuntu-latest'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">stages:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">stage:</span> <span class="string">Build</span></span><br><span class="line">  <span class="attr">displayName:</span> <span class="string">Build</span> <span class="string">and</span> <span class="string">push</span> <span class="string">stage</span></span><br><span class="line">  <span class="attr">jobs:</span>  </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job:</span> <span class="string">Build</span></span><br><span class="line">    <span class="attr">displayName:</span> <span class="string">Build</span></span><br><span class="line">    <span class="attr">pool:</span></span><br><span class="line">      <span class="attr">vmImage:</span> <span class="string">$(vmImageName)</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">task:</span> <span class="string">DockerCompose@0</span></span><br><span class="line">      <span class="attr">inputs:</span></span><br><span class="line">        <span class="attr">containerregistrytype:</span> <span class="string">'Azure Container Registry'</span></span><br><span class="line">        <span class="attr">azureSubscription:</span> <span class="string">'&lt;your subscription id here&gt;'</span></span><br><span class="line">        <span class="attr">azureContainerRegistry:</span> <span class="string">'&#123;"loginServer":"depthconsulting.azurecr.io", "id" : "/subscriptions/&lt;your subscription id here&gt;/resourceGroups/&lt;your resource group here&gt;/providers/Microsoft.ContainerRegistry/registries/depthconsulting"&#125;'</span></span><br><span class="line">        <span class="attr">dockerComposeFile:</span> <span class="string">'**/docker-compose.yml'</span></span><br><span class="line">        <span class="attr">action:</span> <span class="string">'Run a Docker Compose command'</span></span><br><span class="line">        <span class="attr">dockerComposeCommand:</span> <span class="string">'build'</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">task:</span> <span class="string">DockerCompose@0</span></span><br><span class="line">      <span class="attr">inputs:</span></span><br><span class="line">        <span class="attr">containerregistrytype:</span> <span class="string">'Azure Container Registry'</span></span><br><span class="line">        <span class="attr">azureSubscription:</span> <span class="string">'&lt;your subscription id here&gt;'</span></span><br><span class="line">        <span class="attr">azureContainerRegistry:</span> <span class="string">'&#123;"loginServer":"depthconsulting.azurecr.io", "id" : "/subscriptions/&lt;your subscription id here&gt;/resourceGroups/&lt;your resource group here&gt;/providers/Microsoft.ContainerRegistry/registries/depthconsulting"&#125;'</span></span><br><span class="line">        <span class="attr">dockerComposeFile:</span> <span class="string">'**/docker-compose.yml'</span></span><br><span class="line">        <span class="attr">action:</span> <span class="string">'Run a Docker Compose command'</span></span><br><span class="line">        <span class="attr">dockerComposeCommand:</span> <span class="string">'push'</span></span><br></pre></td></tr></table></figure><p>After the build has run, we should now see our IdentityServer4 container images in the ACR!</p><img src="/images/dwhite/azure-pipelines-acr-success.png" alt="Successfully pushed container images to ACR" height="250px"><p>You should navigate the ACR repositories and look at what images are in each repository. Also, all of our images were tagged as <strong>latest</strong> so every time the build runs, we'll have new a <strong>latest</strong> image that will be pulled down as needed by the <strong>k8s</strong> cluster. I'll leave container image tag management to another blog post. We're just trying to get to <strong>k8s</strong> today.</p><h2>Adding our ACR Secrets to minikube</h2><p>Now that we have our IdentityServer4 applications published to a container registery, we need to give our <strong>k8s</strong> cluster the credentials that will allow it to pull those images down from the ACR into the cluster. To do that, we will create a <strong>k8s</strong> Secret resource.</p><p><a href="https://kubernetes.io/docs/concepts/configuration/secret/" target="_blank" rel="noopener">Secrets</a></p><p>For this step in the process, the easiest way to do this is to use <strong>kubectl</strong> to create a secret in the cluster.</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubectl -<span class="literal">-namespace</span> default create secret docker<span class="literal">-registry</span> docker<span class="literal">-credentials</span> `</span><br><span class="line">-<span class="literal">-docker</span><span class="literal">-server</span>=&lt;acr url&gt; `</span><br><span class="line">-<span class="literal">-docker</span><span class="literal">-username</span>=&lt;acr username&gt; `</span><br><span class="line">-<span class="literal">-docker</span><span class="literal">-password</span>=&lt;acr password&gt; `</span><br><span class="line">-<span class="literal">-docker</span><span class="literal">-email</span>=&lt;your@email.address.com&gt;</span><br></pre></td></tr></table></figure><blockquote><p>Put this command in your start-up.ps1 file for now</p></blockquote><p>This will create a Secret resource in the <strong>k8s</strong> cluster that it's docker daemon will use to access your private container registry. You can look at the secret that was created using kubectl.</p><p><code>kubectl get secrets</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">NAME                  TYPE                                  DATA   AGE</span><br><span class="line">default-token-7n4h4   kubernetes.io/service-account-token   3      26h</span><br><span class="line">docker-credentials    kubernetes.io/dockerconfigjson        1      17s</span><br></pre></td></tr></table></figure><p>And you can look at the specific secret in yaml with kubectl as well.</p><p><code>kubectl get secret docker-credentials -o yaml</code></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="string">.dockerconfigjson:</span> <span class="string">&lt;snipped&gt;</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="string">"2020-04-30T16:15:02Z"</span></span><br><span class="line">  <span class="attr">managedFields:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line">    <span class="attr">fieldsType:</span> <span class="string">FieldsV1</span></span><br><span class="line">    <span class="attr">fieldsV1:</span></span><br><span class="line">      <span class="attr">f:data:</span></span><br><span class="line">        <span class="string">.:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">        <span class="attr">f:.dockerconfigjson:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">      <span class="attr">f:type:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">    <span class="attr">manager:</span> <span class="string">kubectl.exe</span></span><br><span class="line">    <span class="attr">operation:</span> <span class="string">Update</span></span><br><span class="line">    <span class="attr">time:</span> <span class="string">"2020-04-30T16:15:02Z"</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">docker-credentials</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">resourceVersion:</span> <span class="string">"207328"</span></span><br><span class="line">  <span class="attr">selfLink:</span> <span class="string">/api/v1/namespaces/default/secrets/docker-credentials</span></span><br><span class="line">  <span class="attr">uid:</span> <span class="string">419c553b-bcaa-49e5-831e-1388c9fad5fe</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">kubernetes.io/dockerconfigjson</span></span><br></pre></td></tr></table></figure><p>You could take this yaml and create a <code>docker-secret.yml</code> manifest file and declaratively create your secret. I'll leave that to you as homework.</p><p>Now our <strong>k8s</strong> cluster should be able to get the container images. We'll prove that in the next section!</p><h2>Deploying our IdentityServer4 applications to minikube</h2><p>Now that we have our applications in our container registry, we can build up the manifest files for these applications and we can reasonablly expect our <strong>k8s</strong> to be able to fulfill the Deployments that we have in those manifest files.</p><h3>STS</h3><p>Here is the deployment and service manifests for the STS.</p><h4>Deployment Manifest</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">identity-sts-dep</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">identity-sts</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">revisionHistoryLimit:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">identity-sts</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">identity-sts</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">identity-sts</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">depthconsulting.azurecr.io/depthconsulting.identity.sts:latest</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ASPNETCORE_ENVIRONMENT</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">"Development"</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SEQ_URL</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">"http://seq-svc"</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">AdminConfiguration__IdentityAdminBaseUrl</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">http://127.0.0.1.xip.io:9000</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ASPNETCORE_URLS</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">"http://+:80"</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">imagePullSecrets:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">docker-credentials</span></span><br></pre></td></tr></table></figure><p>Interesting entries in this manifest are:</p><ul><li>Labels are important. They match a Service to a Deployment</li><li>We are telling the deployment where to get the container images from</li><li>our Seq url is the DNS entry created for the Seq post in the cluster</li><li>we are telling <strong>k8s</strong> to use the <strong>docker-credentials</strong> secret when trying to pull down the container images from our ACR<ul><li>this allows us to pull images from multiple private repositories if needed</li></ul></li></ul><h4>Service Manifest</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">identity-sts-svc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">identity-sts</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">nodePort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure><p>A simple Service manifest telling us that:</p><ul><li>use the <strong>type: NodePort</strong> to expose the STS service to the external network on port 80</li><li>the label will hook this Service up with the pods with the matching label</li></ul><h3>Admin</h3><h4>Deployment Manifest</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">identity-admin-dep</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">identity-admin</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">revisionHistoryLimit:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">identity-admin</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">identity-admin</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">identity-admin</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">depthconsulting.azurecr.io/depthconsulting.identity.admin:latest</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ASPNETCORE_ENVIRONMENT</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">"Development"</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SEQ_URL</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">"http://seq-svc"</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">AdminConfiguration__IdentityServerBaseUrl</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">http://127.0.0.1.xip.io</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">AdminConfiguration__IdentityAdminRedirectUri</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">http://127.0.0.1.xip.io:9000/signin-oidc</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ASPNETCORE_URLS</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">"http://+:9000"</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">imagePullSecrets:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">docker-credentials</span></span><br></pre></td></tr></table></figure><h4>Service Manifest</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">identity-admin-svc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">identity-admin</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">nodePort:</span> <span class="number">9000</span></span><br></pre></td></tr></table></figure><h3>Admin Api</h3><h4>Deployment Manifest</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">identity-admin-api-dep</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">identity-admin-api</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">revisionHistoryLimit:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">identity-admin-api</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">identity-admin-api</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">identity-admin-api</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">depthconsulting.azurecr.io/depthconsulting.identity.adminapi:latest</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ASPNETCORE_ENVIRONMENT</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">"Development"</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SEQ_URL</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">"http://seq-svc"</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">AdminApiConfiguration__IdentityServerBaseUrl</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">http://127.0.0.1.xip.io</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">AdminApiConfiguration__ApiBaseUrl</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">http://127.0.0.1.xip.io:5000</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ASPNETCORE_URLS</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">"http://+:80"</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">imagePullSecrets:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">docker-credentials</span></span><br></pre></td></tr></table></figure><h4>Service manifest</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span>  <span class="string">identity-admin-api-svc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span>  <span class="string">identity-admin-api</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">nodePort:</span> <span class="number">5002</span></span><br></pre></td></tr></table></figure><p>Now we can kubectl all of these manifests into our <strong>k8s</strong> cluster and we should see them all appear in the Web UI.</p><ul><li><p><code>kubectl create -f .\sts-dep.yml</code></p></li><li><p><code>kubectl create -f .\sts-svc.yml</code></p></li><li><p><code>kubectl create -f .\admin-dep.yml</code></p></li><li><p><code>kubectl create -f .\admin-svc.yml</code></p></li><li><p><code>kubectl create -f .\adminapi-dep.yml</code></p></li><li><p><code>kubectl create -f .\adminapi-svc.yml</code></p></li></ul><blockquote><p>Feel free to put put these into a single manifest file or any other combination that makes sense to you.</p></blockquote><p>Now expose all of the services from minikube.</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># expose the services from minikube</span></span><br><span class="line">minikube service identity<span class="literal">-sts</span><span class="literal">-svc</span></span><br><span class="line">minikube service identity<span class="literal">-admin</span><span class="literal">-svc</span></span><br><span class="line">minikube service identity<span class="literal">-admin</span><span class="literal">-api</span><span class="literal">-svc</span></span><br></pre></td></tr></table></figure><h4>Inspect The Pods In Kubernetes</h4><p>Now is a good time, before we go try to use these applications, to see if the Pods are up and healthy in your <strong>k8s</strong> cluster in minikube. If you haven't yes, you can use the <code>minikube dashboard</code> command to get to the <strong>Kubernetes Web UI</strong> or you can go to a command prompt and type <code>octant</code> to start that tool if you've installed it.</p><h5>Octant</h5><img src="/images/dwhite/octant-started.png" alt="Start Octant" height="200px"><p>We're taking a look at the state of the pods now because with our approach to putting pod resources into <strong>k8s</strong>, we are taking an indirect path to getting actual pods running. Our approach is to:</p><ul><li>create a <code>Deployment</code> resource<ul><li>which creates a <code>ReplicateSet</code> resource<ul><li>which creates <code>Pod</code> resource(s) as necessary</li></ul></li></ul></li></ul><p>In our previous steps, the backend infrastructure resources that we wanted running came from DockerHub (a public repository) and they are pretty easy to get started, so we were unlikely to see any Pod start-up failures. With our own Skoruba-based applications in a private repository, there is a greater chance that our pods will fail to start up, and we'd like to see that now.</p><p>Hopefully, everything worked and what you see in Octant is this:</p><img src="/images/dwhite/octant-pods-running.png" alt="Pods running in as seen in Octant" height="250px"><p>What we see in this image is all the pods having fulfilled their ReplicaSet <code>replicas:</code> pod count and that they are all <code>running</code>.</p><p>When I did this the first time, my <strong>Pods</strong> did <em>not</em> all end up running. I encountered for the first time the dreaded <strong>ImagePullBackoff</strong> error condition! This is a condition where the <strong>k8es</strong> control plane is having troubles acquiring an image, for any of a number of reasons, and is now slowing down the rate that it tries to acquire the image.</p><img src="/images/dwhite/octant-image-pull-backoff-sts-pending.png" alt="STS pod cannot run" height="90px"><img src="/images/dwhite/octant-image-pull-backoff.png" alt="Image Pull Backoff Condition" height="150px"><p>In this case, I've simply changed the image that the Deployment is trying to pull to create this error condition. If the image name is incorrect, this error condition will occur.</p><p>Another reason that it occurred for me was because I had my <em>private container registry</em> credentials wrong. If you are missing the docker-secret or you have the wrong username/password in that secret, you will also get an <strong>ImagePullBackoff</strong> error condition.</p><p>I'd encourage you to give this a try! You only need to <code>kubectl apply -f .\identity-sts-dep.yml</code> with an incorrect image name and you'll see this error. Change it back and apply again and you'll see it fixed. You could also remove the <strong>docker-secret</strong> to see how that affects things.</p><p>It should go without saying, that if you have this problem, you have to resolve this prior to continuing.</p><h2>We need DNS entries for IdentityServer4</h2><p>The combination of hosting our <strong>k8s</strong> cluster on minikube and running this all on our local machine and the fact that this is an bunch of Identity applications where the <code>hostname</code> is really important, we have to do a little extra work. You're going to want to put this into your <strong>start-up.ps1</strong> file.</p><h3>Update your Windows host file</h3><p>We need to be able to use hostnames for our web applications, so we are going to have to alter our <strong>host</strong> file in order to make that happen. Here is a powershell script (<strong>that you should 100% review yourself!</strong>) that will udpate your <strong>host</strong> file to make this work with the <strong>127.0.0.1.xip.io</strong> DNS/hostname. This should not damage your existing host file entries, but <strong>please back-up your hosts file first.</strong></p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># edit your workstations host file to add minikube ip and DNS alias</span></span><br><span class="line"><span class="variable">$hostFileLocation</span> = <span class="string">"C:\Windows\System32\drivers\etc\hosts"</span></span><br><span class="line"><span class="variable">$ip</span> = minikube ip <span class="comment"># get the minikube IP adddress put the address in a variable call $ip</span></span><br><span class="line"><span class="variable">$localDnsEntry</span> = <span class="string">"127.0.0.1.xip.io"</span> <span class="comment"># our fake DNS entry/hostname</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">Write-Host</span> <span class="string">"We are going to set the minikube IP address <span class="variable">$ip</span> to DNS entry of <span class="variable">$localDnsEntry</span>"</span></span><br><span class="line"><span class="variable">$dump</span> =  <span class="built_in">Get-Content</span> <span class="literal">-Path</span> <span class="variable">$hostFileLocation</span></span><br><span class="line"><span class="variable">$hostFile</span> = [<span class="type">System.Collections.Generic.List</span>[<span class="built_in">string</span>]] <span class="variable">$dump</span></span><br><span class="line"><span class="variable">$entriesCount</span> = <span class="variable">$hostFile</span>.Count</span><br><span class="line"><span class="built_in">Write-host</span> <span class="string">"Found <span class="variable">$entriesCount</span> entries in the hosts file"</span></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$hostFile</span>.Contains(<span class="string">"# minikube section"</span>))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">Write-Host</span> <span class="string">"Found a minikube section... replacing it."</span></span><br><span class="line">    <span class="variable">$hostFile</span>.Remove(<span class="string">"# minikube section"</span>) | <span class="built_in">Out-Null</span></span><br><span class="line">    <span class="variable">$hostFile</span>.FindAll(&#123;<span class="keyword">param</span>(<span class="variable">$line</span>) <span class="variable">$line</span>.Contains(<span class="variable">$localDnsEntry</span>)&#125;) | % &#123; <span class="variable">$hostFile</span>.Remove(<span class="variable">$_</span>) | <span class="built_in">Out-Null</span> &#125;</span><br><span class="line">    <span class="variable">$hostFile</span>.Remove(<span class="string">"# minikube end section"</span>) | <span class="built_in">Out-Null</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$hostFile</span>.Add(<span class="string">"# minikube section"</span>)</span><br><span class="line"><span class="variable">$hostFile</span>.Add(<span class="string">"<span class="variable">$ip</span>`t<span class="variable">$localDnsEntry</span>"</span>)</span><br><span class="line"><span class="variable">$hostFile</span>.Add(<span class="string">"# minikube end section"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$hostFile</span>.Count <span class="operator">-ge</span> <span class="variable">$entriesCount</span>) <span class="comment"># test to ensure we don't put fewer entries back in host file</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">Write-Host</span> <span class="string">"Updating our hosts file with <span class="variable">$</span>(<span class="variable">$hostFile</span>.Count) entries."</span></span><br><span class="line">  <span class="built_in">Set-Content</span> <span class="literal">-path</span> C:\Windows\System32\drivers\etc\hosts <span class="variable">$hostFile</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">Write-Host</span> <span class="string">"Done"</span></span><br></pre></td></tr></table></figure><p>This powershell script <strong>will</strong> change the way that the DNS system works on your Windows workstation. The <strong>hosts</strong> file takes precedence over a DNS query to the internet, so once we do this, our Windows machine will resolve the IP address we've stated and not the one that would have been return by xip.io. This will break our ability to use DockerCompose. Comment out the entry to use DockerCompose again. The alternative is to create separate domains/configurations for each environment (Docker &amp; minikube) on your local workstation. This is a bit cumbersome with the way seed data is handled today, but it is a problem that could be solved.</p><p>You should now be able to visit the following URLs and only be challenged for your username/password once and you will be asked for consent from each set that you visit.</p><ul><li><a href="http://127.0.0.1.xip.io" target="_blank" rel="noopener">http://127.0.0.1.xip.io</a> - STS Landing page</li><li><a href="http://127.0.0.1.xip.io:9000" target="_blank" rel="noopener">http://127.0.0.1.xip.io:9000</a> - Admin Application</li><li><a href="http://127.0.0.1.xip.io:5000/swagger" target="_blank" rel="noopener">http://127.0.0.1.xip.io:5000/swagger</a> - Admin API Swagger Api Explorer</li></ul><p>With the Admin Application, if you have not already logged in, you should be re-directed to the STS login page, hence the single-sign on aspect of our authentication ecosystem!</p><h2>Victory!!</h2><p>So! I'm crossing my fingers (virtually and into perpetuity) that you've arrived at a place that you can test the IdentityServer4 applications (all three), running in a minikube-based <strong>K8S</strong> cluster! If you can't, you'll have to work at it a bit and if you really get stuck, try reaching out to me on Twitter! I'm usually paying attention to notifications there!</p><p>I certainly encourage you to explore and experiment with <strong>k8s</strong> and IdentityServer4 in this environment. With these instructions, your manifests, and a little bit of luck, you should be able to always get back to a known working state, even if that means a little bit of lost data.</p><p>You can always start from scratch very easily from a minikube <strong>k8s</strong> cluster perspective. The following commands will tear down and re-build you minikube cluster. This destroys everything and gives you a totally clean slate.</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">minikube stop</span><br><span class="line">minikube destroy</span><br><span class="line">minikube start -<span class="literal">-vm</span><span class="literal">-driver</span>=hyperv -<span class="literal">-cpus</span>=<span class="number">4</span> -<span class="literal">-memory</span>=<span class="number">16</span>g -<span class="literal">-extra</span><span class="literal">-config</span>=apiserver.service<span class="literal">-node</span><span class="literal">-port</span><span class="literal">-range</span>=<span class="number">80</span><span class="literal">-33000</span></span><br></pre></td></tr></table></figure><p>Our next stop will be a bit of a reflection point, and then, on to AKS!!</p><p><strong>Next up:</strong><a href="/kubernetes/kubernetes-my-journey-part-6">Pause to reflect</a></p><style>    h1, h2, h3, h4, h5, h6 {       margin-top: 25px;    }    figure.highlight{        background-color: #E8EEFE;    }    figure.highlight .gutter{        color: #0033CD;    }    figure.highlight pre {        font-family: 'Cascadia Code PL', monospace;    }    code {        font-family: 'Cascadia Code PL', sans-serif;        border-width: 0.1em;        border-color: #E8EEFE;        border-style: solid;        border-radius: 0.3em;        background-color: #E8EEFE;        color: #0033CD;        padding: 0em 0.4em;        white-space: nowrap;    }</style><link  href="https://cdnjs.cloudflare.com/ajax/libs/viewerjs/1.5.0/viewer.min.css" rel="stylesheet"><script src="https://cdnjs.cloudflare.com/ajax/libs/viewerjs/1.5.0/viewer.min.js"></script><script>// View an imageconst gallery = new Viewer(document.getElementById('mainPostContent', {    "navbar": false,    "toolbar": false}));</script>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;a href=&quot;/kubernetes/kubernetes-my-journey&quot;&gt;Series Table of Contents&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Previously:&lt;/strong&gt;
&lt;a href=&quot;/kubernetes/kuberne
    
    </summary>
    
      <category term="kubernetes" scheme="https://westerndevs.com/categories/kubernetes/"/>
    
    
      <category term="kubernetes, azure, aks, identityserver, docker, containers" scheme="https://westerndevs.com/tags/kubernetes-azure-aks-identityserver-docker-containers/"/>
    
  </entry>
  
  <entry>
    <title type="html">Kubernetes - My Journey - Part 6</title>
    <link href="https://westerndevs.com/kubernetes/kubernetes-my-journey-part-6/" rel="alternate" type="text/html"/>
    <id>https://westerndevs.com/kubernetes/kubernetes-my-journey-part-6/</id>
    <published>2020-05-22T10:00:00.000Z</published>
    <updated>2020-11-09T21:27:02.246Z</updated>
	<author>
	
	  
	  <name>Dave White</name>
	  <email>dmhwhite@gmail.com</email>
	
	  <uri>https://westerndevs.com</uri>
	</author>
    
    <content type="html"><![CDATA[<p><a href="/kubernetes/kubernetes-my-journey">Series Table of Contents</a></p><p><strong>Previously:</strong><a href="/kubernetes/kubernetes-my-journey-part-5b">Getting Started with Kubernetes - Minikube - Part B</a></p><h1>Pause to reflect</h1><p>There was a point in this development effort that things started to click in my head, and I wanted to put this chapter in here as a more concrete reflection point and not leave it to luck that you'll have yours as well. I also wanted to share my epiphany(s) so this spot makes as good a place as any.</p><p>There were a bunch of things that clicked for me after moving this from docker to <strong>k8s</strong>.</p><h2>Kubernetes is not hard</h2><p>Kubernetes, all by itself, is very approachable with the tools and the self-guided training I started. With <strong>minikube</strong>, <a href="https://www.kubernetes.io" target="_blank" rel="noopener">kubernetes.io</a>, and <a href="https://www.pluralsight.com" target="_blank" rel="noopener">Pluralsight</a>, I was able to stand-up a cluster and just do simple things like put resources into the cluster! Sure there are some things that turned out to be a bit of a pain in the butt that we'll discuss later on, but Kubernetes itself isn't hard.</p><h2>Getting a running system in Kubernetes IS hard</h2><p>So, as easy as kubernetes was, getting an actual working business solution running in kubernetes was much harder! This exercise has really adjusted my perspective about the scope of DevOps and it has adjusted my perspective of what &quot;full-stack&quot; could really mean. Let's step back for a second and look at what I had to create and stand-up in my <strong>k8s</strong> cluster for things to work.</p><ul><li>a database (Postgres)<ul><li>needs Postgres-specific configuration</li><li>needs networking configuration</li><li>needs persistent volumes</li><li>needs secrets</li></ul></li><li>a database administration application (pgAdmin4)<ul><li>needs pgAdmin-specific configuration</li><li>needs networking configuration</li><li>needs persistent volumes</li><li>needs secrets</li></ul></li><li>log ingestion (Seq)<ul><li>needs Seq-specific configuration (minimal)</li><li>needs networking configuration</li><li>needs persistent volumes</li></ul></li><li>raw log consumption (fluentd/graylog/sqelf)<ul><li>needs fluentd-specific configuration</li><li>needs rule pipelines designed</li><li>needs networking configuration</li></ul></li><li>the identityserver4 group (STS, Admin, AdminAPI)<ul><li>build the applications (ASP.NET Core, Web Apps, etc)</li><li>OAuth2, OpenID Connect is all about configuration!</li><li>needs networking configuration</li></ul></li><li>Ingress Controller (nginx and/or traefik)<ul><li>needs nginx-specific configuration</li><li>needs traefik-specific configuration</li><li>Azure-specific annotations</li></ul></li><li>DNS rules (CoreDNS)<ul><li>forwarding and rewrite rule configuration</li></ul></li><li>certificate management (CertManager)</li></ul><p>The interesting thing about all of these applications is that they are all <strong>completely independent</strong> pieces of software/products that you need to become proficient, if not an expert, in configuring, running, and maintaining. Kubernetes makes it pretty easy to put all of these things in the cluster. Making it all work, in a manner than you can own and operate in an enterprise production setting, is non-trivial and I'll just come out and say it, Hard!</p><p>I don't want it to be a doom and gloom story though. There is a light at the end of the tunnel. These are modern pieces of software that are really good to work with. But you still should plan to work with them if you are doing this yourself. If you are on a bigger team with lots of support, then make sure you delegate tasks to those with skills and or experience to get that part of it done. Then automate it, and share the knowledge you've learned.</p><h2>Getting it running in the cloud is not bad</h2><p>The good thing about getting it working in the cloud is, your probably going to focus on one cloud. Could you get it working in multiple clouds? You bet! The <strong>k8s</strong> resources are all the same, it would just be the cloud provisioning application(s) that would be different. Getting to be really familiar with what services your cloud provider offers and how to use those services will be key. But, again, you will need to be very proficient if not an expert in your cloud providers services to own and operate your <strong>k8s</strong> cluster in the cloud.</p><p>The Azure services that we are using and need to understand are:</p><ul><li>Azure Kubernetes Service</li><li>Public IP Address</li><li>Load Balancer</li><li>Azure Storage Accounts<ul><li>azureFile</li><li>azureDisk</li></ul></li><li>Virtual Network</li><li>Virutal Machine Scale Set</li><li>Route Table</li><li>Network Security Group</li></ul><p>Thankfully, programmatically approaching my infrastructure with <a href="https://www.pulumi.com" target="_blank" rel="noopener">Pulumi</a> has made this much easier, especially with intellisense support, so don't worry about this too much. I'll show you what I did shortly.</p><h2>You do not need to master ALL runtime environments</h2><p>One thing I discovered quickly is I don't need to keep my web applications running in:</p><ol><li>Windows Native - IIS</li><li>Kestrel</li><li>Docker</li><li><strong>AKS</strong></li></ol><p>Trying to do this will lead to a lot of work that just isn't going to be needed. It is potentially a valuable learning experience so I'm not saying <em>don't</em> do it, but once you decide on your runtime environment(s), do what is best to make sure it is configured and runnable there.</p><p>In this case, I felt I did want to keep it running in Docker for the local developer debugging experience. But my primary runtime target was going to be <strong>AKS</strong> so I didn't spend any time keeping this running in Kestrel or IIS via Visual Studio from a configuration perspective, and Docker did not get the full-fidelity experience that eventually <strong>AKS</strong> did. I do keep the DockerCompose experience working so I can debug the IdentityServer4 applications on my local machine.</p><h2>Cluster Logging from the Start</h2><p>When I started this, I already knew I wanted to do logging in my applications, but I really didn't think about logging across the cluster. I knew it happened and I did solve some problems by looking at the logs in various pods, I should have explored and found <strong>fluentd</strong> sooner in my journey. Logs are so important in this environment because we have many applications and kubernetes itself spread across multiple nodes and who knows how many pods.</p><h2>IaC and Automation are Awesome</h2><p>I am really glad that I started down the path of <strong>Infrastructure as Code</strong> right from the very start of the <strong>AKS</strong> journey, and I'm going to get my <strong>Pulumi</strong> IaC applications running against minikube as well. Being able to capture what you've learned about your infrastructure as application code is a fantastic benefit, in addition to the actual automation that you can invoke with a couple key strokes, the push of a button, or a commit/push. If I was going to give myself some advice, I'd tell myself I should really make sure I pay attention to the next post in the series.</p><h2>Be Prepared to need a LOT of Permissions</h2><p>At the beginning of your project, if you aren't in full control of the whole ecosystem, you should start the process of getting the required permissions. This whole series generally assumes you have full-control when we start working on the <strong>AKS</strong> components, but you'll also need access to DNS registrations, and you may need permissions to acquire and use some of the tooling.</p><h2>Summary</h2><p>This was intended to be a brief stop. A chance to pause, catch your breath, and reflect on what you might of learned based on what I did learn. Don't be discouraged if all of this is hard or tricky or taking longer than you expected. This has been an incredible amount of learning if you started from scratch like me with <strong>k8s</strong> and you should be proud of where you've gotten too.</p><p><strong>Next up:</strong><a href="/kubernetes/kubernetes-my-journey-part-7a">Moving to Azure Kubernetes Service - Part A</a></p><style>    h1, h2, h3, h4, h5, h6 {       margin-top: 25px;    }    figure.highlight{        background-color: #E8EEFE;    }    figure.highlight .gutter{        color: #0033CD;    }    figure.highlight pre {        font-family: 'Cascadia Code PL', monospace;    }    code {        font-family: 'Cascadia Code PL', sans-serif;        border-width: 0.1em;        border-color: #E8EEFE;        border-style: solid;        border-radius: 0.3em;        background-color: #E8EEFE;        color: #0033CD;        padding: 0em 0.4em;        white-space: nowrap;    }</style><link  href="https://cdnjs.cloudflare.com/ajax/libs/viewerjs/1.5.0/viewer.min.css" rel="stylesheet"><script src="https://cdnjs.cloudflare.com/ajax/libs/viewerjs/1.5.0/viewer.min.js"></script><script>// View an imageconst gallery = new Viewer(document.getElementById('mainPostContent', {    "navbar": false,    "toolbar": false}));</script>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;a href=&quot;/kubernetes/kubernetes-my-journey&quot;&gt;Series Table of Contents&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Previously:&lt;/strong&gt;
&lt;a href=&quot;/kubernetes/kuberne
    
    </summary>
    
      <category term="kubernetes" scheme="https://westerndevs.com/categories/kubernetes/"/>
    
    
      <category term="kubernetes, azure, aks, identityserver, docker, containers" scheme="https://westerndevs.com/tags/kubernetes-azure-aks-identityserver-docker-containers/"/>
    
  </entry>
  
  <entry>
    <title type="html">Kubernetes - My Journey - Part 7a</title>
    <link href="https://westerndevs.com/kubernetes/kubernetes-my-journey-part-7a/" rel="alternate" type="text/html"/>
    <id>https://westerndevs.com/kubernetes/kubernetes-my-journey-part-7a/</id>
    <published>2020-05-22T09:00:00.000Z</published>
    <updated>2020-11-09T21:27:02.246Z</updated>
	<author>
	
	  
	  <name>Dave White</name>
	  <email>dmhwhite@gmail.com</email>
	
	  <uri>https://westerndevs.com</uri>
	</author>
    
    <content type="html"><![CDATA[<p><a href="/kubernetes/kubernetes-my-journey">Series Table of Contents</a></p><p><strong>Previously:</strong><a href="/kubernetes/kubernetes-my-journey-part-6">Pause to reflect</a></p><h1>Moving to Azure Kubernetes Service - Part A</h1><p>It would be great if we could get this all working in minikube and call it done, but we're not quite that lucky! We're probably going to need a platform with a bit more breathing room and additional capabilities to run our production workloads, so we'll have to figure out a way to move all of this into that platform. In our case, that platform is going to be <strong>Azure</strong> and the <strong>Azure Kubernetes Services (AKS)</strong>.</p><p>With the desire to move our resources into a new <strong>k8s</strong> cluster in the cloud, there are a lot of moving parts in the infrastructure as compared to what minikube has. Here is a picture of the basic resources we'll have in Azure after we stand up this <strong>k8s</strong> cluster.</p><img src="/images/dwhite/azure-basic-aks-resources.png" alt="Basic Azure Kubernetes Services Resources" height="400px"><p>I also had to consider managing the <strong>k8s</strong> resources (apps in manifests). I want that to be a part of any automation as well.</p><p>With all of this in mind, I knew I was going to want something more than a collection of PowerShell scripts to manage the <strong>AKS</strong> resources <em>and</em> the <strong>k8s</strong> resources in our cluster. Thankfully, a new product called <a href="https://www.pulumi.com" target="_blank" rel="noopener">Pulumi</a> had recently joined the market that looked like it would fit the bill as far as ease of use, community support, and a full IaC ecosystem for me to work with.</p><p>This part of the series is mostly going to be about Pulumi, with side discussions about the specific Azure resources that we will instantiate with Pulumi.</p><h2>Important Assumption</h2><p>Now that we are moving our activites off of our development machines and into the cloud, it is very important that you have all of the required permissions to act (or for Pulumi to act on your behalf) in your Azure subscription. We will be creating many resources in Azure and you <strong>must</strong> have permission to create these resources.</p><h2>Pulumi - Getting Started</h2><p><a href="https://www.pulumi.com" target="_blank" rel="noopener">Pulumi</a> is a platform that includes:</p><ol><li>A cloud-platform that stores data about your preferences, your settings for projects (stacks), and the results of your executions.</li><li>Multiple language-specific SDKs (see languages below) that allow you to create a Pulumi application that will run and deploy your infrastructure. You can choose the language you are most comfortable with to write <em>your</em> application.</li><li>The Pulumi CLI tool that will allow you to manage your infrastructure and run your application to stand-up, tear down, or manage your project (stack).</li></ol><p>In addition to the actual tooling, there is a tremendous amount of documentation and community support. I've generally been happy with the documentation even though I think it is still lacking in a couple places, but the community support has been really good. <a href="https://slack.pulumi.com/" target="_blank" rel="noopener">Pulumi has a Slack</a> that anyone can join; it has logical channels that will generally meet your needs, and the Pulumi team have been very responsive in this slack whenever I encountered a problem.</p><blockquote><p>I don't know about you, but when I have a programming problem, I skip all of the &quot;conceptual&quot; stuff, dive in, and thrash around a bunch. But, if you are inclined to understand the core Pulumi architecture and concepts, you should <a href="https://www.pulumi.com/docs/intro/concepts/" target="_blank" rel="noopener">start reading here.</a></p></blockquote><h3>Creating an Account</h3><p>Pulumi is a platform and a part of that platform are cloud-based services, associated to an account, that stores your settings, secrets, and outcomes from deployments. Pulumi has 4 pricing tiers, the first of which is Community and is free! This is the one I'm currently using. In the Community edition, your user is basically mapped one to one with an <em>Organization</em> and this organziation can have <em>stacks</em> which are (sort of) the Pulumi term for a deployment target. These stacks are associated with deployment projects so a project can have <em>n</em> stacks in it. The Community SKU of Pulumi is free and so far, it has been everything I needed.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Pulumi Organization</span><br><span class="line">  |- User Account(s)</span><br><span class="line">  |- Project A</span><br><span class="line">  |   |- Pulumi application</span><br><span class="line">  |   |- stack (dev)</span><br><span class="line">  |      |- config, history, etc</span><br><span class="line">  |   |- stack (prod)</span><br><span class="line">  |      |- config, history, etc</span><br><span class="line">  |</span><br><span class="line">  |-Project B</span><br><span class="line">      |_ Pulumi application</span><br><span class="line">      |- stack (dev)</span><br><span class="line">         |- config, history, etc</span><br><span class="line">      |- stack (prod)</span><br><span class="line">         |- config, history, etc</span><br></pre></td></tr></table></figure><p>You may already know that you need to have more than one person working on this or you may be concerned that you'll outgrow the Community edition, but you shouldn't be concerned. It looks like Pulumi has a seamless upgrade path (that I haven't used) and Pulumi also has a feature that allows you to transfer a stack to another account, so you aren't going to be stuck as you grow with the platform. Additionally, everything that you create to use Pulumi (apps and scripts) is <strong>yours</strong> and can be version controlled, shared, and re-used as you see fit. It would be quite easy to re-create a stack in a new organization as needed.</p><p>So, unless you know you are going to have multiple people involved in the IaC part of the project, you can just create a Community-based account and start deploying!</p><h3>Install the Tools</h3><p>Pulumi has a great set of tutorials <a href="https://www.pulumi.com/docs/get-started/azure/" target="_blank" rel="noopener">here</a> for getting started with Azure. I'm going to repeat some of it, but you should definitely check out their learning resources.</p><p>Now that you've created an account, it is time to start building your application! First, you'll need to install the Pulumi CLI in your development environment and sign into your cloud account.</p><h4>Pulumi CLI</h4><p>You have a couple choices to get the Pulumi CLI!</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">choco install pulumi <span class="comment"># requires chocolatey</span></span><br><span class="line"><span class="comment"># -or-</span></span><br><span class="line"><span class="comment"># plain powershell</span></span><br><span class="line">iex ((<span class="built_in">New-Object</span> System.Net.WebClient).DownloadString(<span class="string">'https://get.pulumi.com/install.ps1'</span>))</span><br></pre></td></tr></table></figure><p>Once you have the CLI, you can login via a username/password redirect to a browser or you can use an access token that you've created in the web admin pages for your Pulumi account.</p><img src="/images/dwhite/pulumi-login-cli.png" alt="Logging into Pulumi" height="150px"><p>You can use the <code>pulumi whoami</code> to see if you are currently logged in (or who you are logged in as) as well.</p><h4>Language-specific SDKs</h4><p>Next, you'll need to consider what <a href="https://www.pulumi.com/docs/intro/languages/" target="_blank" rel="noopener">language</a> you are going to use when creating your Pulumi application. There are many choices. <strong>Typescript/JavaScript, Go, .NET Core (C#, F#, VB), and Python</strong>. Pick whichever one your organization has the most skills in. I like Typescript so that is what I picked and what my code will be written in. If you want, you can write an SDK in your favorite language. This is all open-source.</p><h4>Project Structure</h4><p>Once you've selected a language, you can use the Pulumi <strong>CLI</strong> to create your first <strong>deployment project and stack</strong>. I treat a stack as a deployment that I want to put in a specific environment. For example, I would have 2 stacks for my <strong>k8s</strong> infrastructure. One is the dev infrastructure in our Development Azure subscription, and the other is the production infrastructure which would be in the Production Azure subscription. These 2 stacks stand-up all of the Azure <strong>AKS</strong> resources. I would also have 2 stacks for the <strong>k8s</strong> resources that go into those <strong>k8s</strong> clusters.</p><p>Projects are mostly containers for stacks (configuration, history) and an application. Stacks have specific configuration settings and histories that are important. The application that you run for the project can use each stack for specific deployment details.</p><blockquote><p>A monolithic stack with a single app is a good way to learn and this is how most of the tutorials work. However, I found that it wasn't how I wanted to manage my deployments.</p></blockquote><p>I originally created a single monolithic project with a single stack and one application but have since changed this to two projects with a single application and a dev/prod stack each. The first project for the <strong>AKS</strong> infrastructure was less volatile and I didn't need to tear it all down all the time. It takes about 18 minutes to stand-up our cluster and 10 minutes to tear it all down. The second project for the <strong>k8s</strong> resources changed much more frequently and I would often want to clear out the <strong>k8s</strong> cluster and start from a clean slate. <strong>k8s</strong> resources can be added or removed from the cluster quickly and frequently. This series will only show the multi-project approach.</p><p>First, using the Pulumi CLI, we are going to create a deployment application, in the Typescript language, for the Azure cloud, for only the AKS infrastructure. We'll do our <strong>k8s</strong> resource deployment application later.</p><p>Let's create a folder in our infrastructure folder for the <strong>AKS</strong> deployment stack.</p><img src="/images/dwhite/pulumi-create-new-stack.png" alt="Create a new Pulumi stack" height="450px"><p>Once that is done, we can use the Pulumi CLI to build our new project with its initial stack.</p><p><code>pulumi new azure-typescript --secrets-provider=passphrase</code></p><p>This will kick off the workflow to acquire some details before it creates the stack. In my case, I answered the workflow questions with:</p><ol><li>project name (aks) &lt;-- hit enter and accepted default</li><li>project description: <strong>Deploy our kubernetes infrastructure</strong></li><li>stack name: (dev) &lt;-- hit enter and accepted default</li><li>Enter your passphrase to protect config/secrets: <strong>P@ssw0rd!</strong></li><li>azure:environment: (public) &lt;-- hit enter and accept default</li><li>azure:location: (WestUS) <strong>WestUS</strong></li></ol><p>After answering those questions, the CLI will finish off by:</p><ul><li>creating your project and first stack<ul><li>saving them in the cloud - this happens automatically</li></ul></li><li>scaffolding out the initial application files locally<ul><li>pulling down all of the correct npm modules based on your cloud provider selection and language choices.</li></ul></li></ul><img src="/images/dwhite/pulumi-created-dev-stack.png" alt="Create a new Pulumi stack" height="300px"><p>We can also look in the web portal for our Pulumi account and see the new stack is available there!</p><img src="/images/dwhite/pulumi-new-project-in-web.png" alt="The new stack in the web portal" height="300px"><p>You can click the the stack to see what information has been published to the Pulumi cloud. There isn't much there yet, but there are some instructions on how to get more information there. We'll see that shortly.</p><h5>A Note about --secrets-provider</h5><p>You should have noticed that I've used the <code>--secrets-provider</code> parameter in the pulumi CLI invocation. If you are going to be building a single stack like many of the pulumi examples you'll find, you will not use or see this parameter. By default, each stack as a unique secrets provider and stacks <strong>cannot</strong> read each other's secrets. I already plan to have multiple stacks that I want to be able to share secrets between so I need to use this parameter in order to create secrets providers that can reach each other's secrets.</p><p>Passphrase is the simplest to use and get working so I'm using that for this article, but you can also use external 3rd party secrets providers. Support providers include:</p><ul><li>awskms: AWS Key Management Service (KMS)</li><li>azurekeyvault: Azure Key Vault</li><li>gcpkms: Google Cloud Key Management Service (KMS)</li><li>hashivault: HashiCorp Vault Transit Secrets Engine</li></ul><p>More details about how to use these encryption providers can be found <a href="https://www.pulumi.com/docs/intro/concepts/config/" target="_blank" rel="noopener">here -- Alternate Secrets Encryption.</a></p><p>We will re-visit secrets in a little while. Now back to our new project.</p><h4>Scaffolded Files</h4><p>If we inspect the scaffolded application in the aks folder, we'll see the following:</p><table><thead><tr><th style="text-align:left"></th><th style="text-align:left"></th></tr></thead><tbody><tr><td style="text-align:left"><strong>node_modules</strong></td><td style="text-align:left">This is where our SDK lives, we use NPM to add SDK components</td></tr><tr><td style="text-align:left"><strong>.gitignore</strong></td><td style="text-align:left">Version controlled application development, just like you already do!</td></tr><tr><td style="text-align:left"><strong>index.ts</strong></td><td style="text-align:left">the entry-point for our TypeScript-based IaC application</td></tr><tr><td style="text-align:left"><strong>packages.json</strong></td><td style="text-align:left">The list of packages used in our application</td></tr><tr><td style="text-align:left"><strong>Pulumi.dev.yaml</strong></td><td style="text-align:left">stack-specific configuration values</td></tr><tr><td style="text-align:left"><strong>Pulumi.yaml</strong></td><td style="text-align:left">project-specific values</td></tr><tr><td style="text-align:left"><strong>tsconfig.json</strong></td><td style="text-align:left">TypeScript application configuration</td></tr></tbody></table><h2>More Tooling - azure-cli</h2><p>So, we have the Pulumi CLI, maybe git CLI, and now we need to make sure we have one more tool in place. We need the <strong>azure-cli</strong> command line tool. Pulumi will use the <strong>azure-cli</strong> to actually do all of the work in the correct subscription.</p><p>You'll need to install the <strong>azure-cli</strong> with <a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli-windows?view=azure-cli-latest#install-or-update" target="_blank" rel="noopener">instructions here</a>. I like the little PowerShell script that does it for you myself.</p><p>Once the azure-cli is installed, you'll need to log into your Azure subscription that you want to work with.</p><p><code>az login</code> will open a browser window and help you log into your subscription.</p><p><code>az account list</code> will list all of the available subscriptions (if there is more than one)</p><p><code>az account set &lt;subscription name&gt;</code> will set the current context to the desired subscription</p><blockquote><p>If you have multiple subscriptions, you'll probably spend a bit of time switching back and forth. One thing I would suggest is to be careful when working with multiple subscriptions. Pulumi, via the current azure-cli context, will happily deploy or tear-down your infrastructure when asked. There are some safe-guards in place with regard to tear-down or changing, but I've found Pulumi is always happy to stand new things up into a subscription! I accidentally installed a minecraft server into my client's development subscription this way once! Ok, maybe twice!</p></blockquote><p>With Pulumi ready and azure-cli ready, we should be ready to start coding! If you haven't done this already, it's time to open VS Code or your favorite text editor!</p><h2>Your first Pulumi Application</h2><p>I like to open VS Code right away for a couple reasons. It is a nice text editor with excellent TypeScript support and it also has a built-in terminal window that I can set to use PowerShell Core and I can leave the directory set to the one that holds the files I'm working in.</p><p>Open your <strong>index.ts</strong> file and take a look at what the Pulumi CLI scaffolded.</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> pulumi <span class="keyword">from</span> <span class="string">"@pulumi/pulumi"</span>; <span class="comment">// Add the Pulumi core SDK module to your application</span></span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> azure <span class="keyword">from</span> <span class="string">"@pulumi/azure"</span>;   <span class="comment">// Add the Azure core SDK module to your application</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Create an Azure Resource Group</span></span><br><span class="line"><span class="keyword">const</span> resourceGroup = <span class="keyword">new</span> azure.core.ResourceGroup(<span class="string">"resourceGroup"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Create an Azure resource (Storage Account)</span></span><br><span class="line"><span class="keyword">const</span> account = <span class="keyword">new</span> azure.storage.Account(<span class="string">"storage"</span>, &#123;</span><br><span class="line">    <span class="comment">// The location for the storage account will be derived automatically from the resource group.</span></span><br><span class="line">    resourceGroupName: resourceGroup.name,</span><br><span class="line">    accountTier: <span class="string">"Standard"</span>,</span><br><span class="line">    accountReplicationType: <span class="string">"LRS"</span>,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Export the connection string for the storage account</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> connectionString = account.primaryConnectionString;</span><br></pre></td></tr></table></figure><p>At the top, you'll see that two modules have been added for you. The Pulumi Core SDK module and the Azure Core SDK module. Depending on what you need, you only add the modules to your application that you are actually using. If you need additional modules, we can use <code>npm install @pulumi/&lt;module name&gt;</code> to get those SDK modules.</p><p>Next, we see code that is creating a new ResourceGroup in Azure to hold all of our new resources.</p><p>Then, we see code that is creating a new Storage account.</p><p>And finally, we have a snippet of code that is going to export the storage account's connection string for use later.</p><blockquote><p>Anything that you <code>export</code> in your TypeScript will be published to the cloud for review or use by another Pulumi stack/application at a later date. If you don't want these properties publicly accessible, do not export them. We will demonstrate this later. This is important to understand when working with stacks that are dependent on other stacks.</p></blockquote><p>The next step is deploying this stack! Go ahead! Type:</p><p><code>pulumi up</code></p><p>You will see the Pulumi CLI kick off your IaC application. It builds the app, does some analysis of what it wants to do, and then asks you if you'd like to continue!</p><blockquote><p>If your TypeScript application won't build, the process stops here, and you have to fix it.</p></blockquote><img src="/images/dwhite/pulumi-first-up.png" alt="Logging into Pulumi" height="250px"><p>Once you accept, it finishes doing what you've coded, and it deploys your new Azure infrastructure to your subscription.</p><img src="/images/dwhite/pulumi-first-up-completed.png" alt="Logging into Pulumi" height="250px"><p>And it also publishes details into your Pulumi cloud account for this project/stack. You can see the exported connnectionString. Also available in the cloud is a historical log of what has happened in this stack in the <strong>Activity</strong> tab.</p><img src="/images/dwhite/pulumi-first-up-completed-web.png" alt="Logging into Pulumi" height="600px"><img src="/images/dwhite/pulumi-first-stack-history.png" alt="Logging into Pulumi" height="300px"><p>And here are the Azure resources that were created.</p><img src="/images/dwhite/pulumi-first-up-azure-storage-account.png" alt="Azure Storage Account" height="300px"><blockquote><p>Notice that Pulumi has appended a segment of characters on your resource names to try and ensure they are unique within the subscription. I haven't tried to alter that behaviour. You can create a resource directly in Azure and import it into your stack and Pulumi will respect the name it was given.</p></blockquote><p>That's pretty cool! The only problem is, I don't want a lone storage account in my Azure subscription.</p><p>So, what do we do now? Tear it all down and let Pulumi clean up everything it created.</p><p><code>pulumi destroy</code></p><p>This will ask you for confirmation, so you are protected that way. Just let the Pulumi CLI finish it's work and go look in your Azure subscriptions! It will be clean as a whistle!</p><h2>Deploying an AKS</h2><p>I hope that was a good introduction to Pulumi, but what we really wanted to do was build an application that would deploy our <strong>AKS</strong> into our subscription. Let's get to that.</p><p>Before getting started, <strong>delete all of the existing lines of code in your index.ts</strong>. We will not be using anything created during the initial scaffolding.</p><h3>Importing more Pulumi SDK modules</h3><p>Standing up an <strong>AKS</strong> service cluster is move involved that a simple storage account. We will need more SDK modules in our application in order to make that happen. Let's add some import statements into our Pulumi application.</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> azure <span class="keyword">from</span> <span class="string">"@pulumi/azure"</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> pulumi <span class="keyword">from</span> <span class="string">"@pulumi/pulumi"</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> k8s <span class="keyword">from</span> <span class="string">"@pulumi/kubernetes"</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> azuread <span class="keyword">from</span> <span class="string">"@pulumi/azuread"</span>;</span><br></pre></td></tr></table></figure><p>This is what the top of you <strong>index.ts</strong> should look like. If you are doing this in VS Code, you probably have some red squiggly lines under the bottom two imports. This is where we ask NPM to go get those modules for us!</p><p><code>npm install @pulumi/kubernetes</code> <strong>Get kubernetes module of the SDK</strong><code>npm install @pulumi/azuread</code>  <strong>Get Azure ActiveDirectory module of the SDK</strong></p><p>Once that is done, the red squiggly lines should go away and you'll see that you can use those SDK modules in your application now.</p><h3>Initial Configuration Values</h3><p>The next part of our app initializes and exports configuration variables that we'll need for the <strong>AKS</strong> provisioning. The names for these variables are intended to be informative, but they are names that I've chosen. The values are determined by the intended usage. Azure expects some of these values to be specific, such as <strong>location</strong> or <strong>nodeSize</strong>. The <strong>nodeCount</strong> variable needs to be an int. The string <strong>const</strong> values that I export are for consistency in the same way that you would have an <strong>enum</strong> or a class containing <strong>consts</strong> values in a C# application. I believe this initial list of variables are the bare minimum you need to create a cluster. You may eventually have many more in your application.</p><p>This is what the configuration section will look like <em>when it is complete</em>. We will add these lines of code into the application as we work though the configuration setup so that we can <code>pulumi up</code> multiple times and see the incremental changes.</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Acquire stack configuration values and export application-defined configuration variables</span></span><br><span class="line"><span class="keyword">const</span> config = <span class="keyword">new</span> pulumi.Config();</span><br><span class="line"><span class="keyword">const</span> password = config.requireSecret(<span class="string">"password"</span>);</span><br><span class="line"><span class="keyword">const</span> sshPublicKey = config.require(<span class="string">"sshPublicKey"</span>);</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> location = config.get(<span class="string">"stackLocation"</span>) || (config.get(<span class="string">"azure:location"</span>) || <span class="string">"WestUS"</span>);</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> nodeCount = config.getNumber(<span class="string">"nodeCount"</span>) || <span class="number">2</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> nodeSize = config.get(<span class="string">"nodeSize"</span>) || <span class="string">"Standard_B2s"</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> storageClassName = <span class="string">"managed-premium"</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> resourceGroupName = <span class="string">"rg_identity_dev_zwus_aks"</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> publicIpAddressName = <span class="string">"pip_identity_dev_zwus_aks"</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> k8sDnsName = <span class="string">"identity-auth-dev"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> clientConfig = azure.core.getClientConfig();</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> subscriptionId = clientConfig.subscriptionId;</span><br></pre></td></tr></table></figure><h4>Pulumi Config Object</h4><p><code>const config = new pulumi.Config();</code></p><p>The first thing we do is ask the Pulumi SDK to get our stacks configuration in the form of an object of type <strong>pulumi.Config</strong>. This object lets us get configuration values (secret/non-secret) for our application, specific to this stack, from the Pulumi cloud. You're probably wondering how they got there though?</p><p>The Pulumi CLI has a number of methods that allow us to manage our stack configuration values. In this case, we need to get 5 different values from the cloud.</p><h4>Passwords and Secrets</h4><p>Here we get to meet another part of the Pulumi cloud infrastructure. Stacks can contain plaintext configuration information, and they can also contain secret configuration information. We can acquire this configuration information from the cloud when our application runs in order to provision our cluster. Let's work through this for a moment.</p><p>This password will be used for our administrative user in our <strong>AKS</strong> cluster. We probably don't want this to be saved as plaintext anywhere, so we're going to use the <strong>--secret</strong> flag when we use the Pulumi CLI to set this configuration value in our stack.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pulumi config <span class="built_in">set</span> password --secret [your-cluster-password-here] <span class="comment"># P@ssw0rd!</span></span><br></pre></td></tr></table></figure><p>This command tells the Pulumi CLI to set a property on our stack configuration called <strong>password</strong> to the value provided and make sure it is treated securely.</p><p>Since we delete all of the text, let's <code>pulumi up</code> and get that value into the cloud to see what happens.</p><img src="/images/dwhite/pulumi-set-config-password.png" alt="Set the admin password in the configuration" height="450px"><blockquote><p>Other than the initial <strong>pulumi new azure-typescript</strong> CLI command, any changes we make to our local context wil not be available in the web portal until we use the <code>pulumi up</code> command.</p></blockquote><p>In order to access this secret from the pulumi.Config object, we add this line of code to our application.</p><p><code>const password = config.require(&quot;password&quot;);</code></p><blockquote><p>You can use config.requireSecret(&quot;password&quot;) to mark a variable as secret and at that point it's safe to export because it will always be encrypted/masked (in the state as well as CLI and console)</p></blockquote><h4>SSH Public Key</h4><p>If you'd like to be able to SSH into your linux nodes (VMs) that are in the cluster, you'll need to provide an SSH key that is provisioned into your nodes. Using a tool called <code>ssh-keygen</code> we can create an SSH key and then we can put that key into our Pulumi stack config for use anytime we create the cluster.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t rsa -f key.rsa</span><br><span class="line">pulumi config <span class="built_in">set</span> sshPublicKey &lt; key.rsa.pub</span><br></pre></td></tr></table></figure><p><code>ssh-keygen</code> will walk you through the process of creating an SSH key.</p><p>Then we will use the Pulumi config to set the sshPublicKey configuration variable on the stack. If you are running a PowerShell terminal, this won't work. PowerShell doesn't like the <strong>&lt;</strong> operator. You can get around that by using this command.</p><p><code>cmd.exe /c &quot;pulumi config set sshPublicKey &lt; key.rsa.pub&quot;</code></p><p>Now you can <code>pulumi up</code> and go take a look at your configuration in the web portal again.</p><p>In order to use this variable in our application, add this line of code to our application.</p><p><code>const sshPublicKey = config.require(&quot;sshPublicKey&quot;);</code></p><img src="/images/dwhite/pulumi-set-config-sshPublicKey.png" alt="Set the SSH Public Key in the configuration" height="225px"><h4>Location, NodeCount, NodeSize</h4><p>Azure is going to want to know:</p><ol><li>What region to create your resources in</li><li>How many nodes do we want in our cluster</li><li>What VMs SKUs (size) do we want to use for our cluster</li></ol><p>The location configuration value is interesting!</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> stackLocation = config.get(<span class="string">"stackLocation"</span>) || (config.get(<span class="string">"azure:location"</span>) || <span class="string">"WestUS"</span>);</span><br></pre></td></tr></table></figure><p>In this code, we look for a configuration value called <strong>stackLocation</strong> that we can set if we want. This supports DR/HA-specific stack scenarios that I'll discuss later. If it isn't present, we can use the the default location set in the <strong>azure:location</strong> configuration value that was set for us when we created the project. You can take a look again with the Pulumi CLI command <code>pulumi config get &quot;azure:location&quot;</code> or you can look in the web portal as well. In the event that there is no configuration values, we've provided a fallback value of <strong>WestUS</strong>.</p><p>I love being able to use programmatic logic in my infrastructure deployments!!</p><blockquote><p><strong>az account list-locations</strong> will list supported regions for the current subscription. It will spit out a JSON blob of regions and you can use the name property. It seems that commands that take a region parameter name are case-insensitive.</p></blockquote><p>In order to create a <strong>k8s</strong> cluster, we need VMs (nodes) in the cluster. We can configure how big we want cluster to be and store that data in the stack configuration. Our fallback value is <strong>2</strong>.</p><p><code>pulumi config set nodeCount 2</code></p><blockquote><p>A <strong>k8</strong> cluster only needs 1 node to operate. This is certainly sufficient for dev contexts, but you probably want 3+ nodes in production.</p></blockquote><p>Add <code>export const nodeCount = config.getNumber(&quot;nodeCount&quot;) || 2;</code> to the application.</p><p>Azure also needs to know what SKU our nodes (VMs) should be.</p><blockquote><p><code>az vm list-skus</code> is the azure-cli command that will list out all of the SKUs you can pick from but it spews an enormous JSON blob that lists them all and their capabilities. You're probably better off visiting <a href="https://azure.microsoft.com/en-us/pricing/details/virtual-machines/linux/" target="_blank" rel="noopener">here</a> to help you decide what SKU to use.</p></blockquote><p><code>pulumi config set nodeSize Standard_B2s</code></p><p>Add <code>export const nodeSize = config.get(&quot;nodeSize&quot;) || &quot;Standard_B2s&quot;;</code> to the application.</p><p>Again, we provided a fallback value in the application.</p><p><code>pulumi up</code> and look at the configuration values in the web portal.</p><img src="/images/dwhite/pulumi-set-config-done.png" alt="All Configurations Set" height="350px"><h4>Exports From Your Application</h4><p>Finally, we want to provide some <strong>const</strong> values that will be available in the stack, displayed in the web portal, and also available to any other stack that belongs to the Pulumi organization.</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> storageClassName = <span class="string">"managed-premium"</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> resourceGroupName = <span class="string">"rg_identity_dev_zncu_aks"</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> publicIpAddressName = <span class="string">"pip_identity_dev_zncu_aks"</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> k8sDnsName = <span class="string">"identity-auth-dev"</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> acrSecretName = <span class="string">"docker-credentials"</span>;</span><br></pre></td></tr></table></figure><p><code>pulumi up</code> and you'll see all the rest of our configuration values in the web portal. Exports are shown in a different group in the web portal. The are considered <strong>outputs</strong> of the stack.</p><img src="/images/dwhite/pulumi-set-config-outputs.png" alt="Outputs from the application" height="400px"><blockquote><p>You should recognize when you export a value that you will get a value in the <strong>outputs</strong> section of the web portal and it also be in the <strong>config</strong>. You don't have to export <code>const</code> values if you want to avoid that confusion.</p></blockquote><h4>Getting the Azure Subscription Id</h4><p>We need one more value for our application and that is the <strong>subscriptionId</strong>. In this case, we could use the <code>pulumi config set</code> command to manually set it, but we can get the subscription from the Azure context that we are already connected to. This is exposed via an SDK component.</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// getClientConfig is an async call, so wrap in pulumi.output</span></span><br><span class="line"><span class="keyword">const</span> clientConfig = pulumi.output(azure.core.getClientConfig());</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> subscriptionId = clientConfig.subscriptionId;</span><br></pre></td></tr></table></figure><h2>Add AKS resources to Azure</h2><p>Now that we have the basic configuration values that are required for our <strong>AKS</strong> cluster resources, we can start to add them into our Pulumi application.</p><blockquote><p>After each section, you can <code>pulumi up</code> and see what happens. When you are done that increment, you can <code>pulumi destroy</code> to clean up the resources.</p></blockquote><h4>A Pre-Defined ResourceGroup</h4><p>While Pulumi is quite capable of building a ResourceGroup from scratch, you may want to use one that already exists in your Azure subscription. Financial reporting, permissions, operational activities, etc may be leveraging ResourceGroups in this way. For this example, we are going to use a pre-existing ResourceGroup. This code is also the reason that we acquired the <strong>subscriptionId</strong> and set the <strong>resourceGroupName</strong> in our configuration section.</p><p>You will need to create this ResourceGroup in Azure via the <strong>azure-cli</strong> or in the Azure Portal. The `azure-cli command is</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># this resourceGroupName matches our const value in the config section</span></span><br><span class="line">az group create -<span class="literal">-location</span> WestUs -<span class="literal">-name</span> rg_identity_dev_zwus_aks</span><br></pre></td></tr></table></figure><p>Here is the code to get the resourceGroup object for using in the application code.</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// get the Azure Resource Group</span></span><br><span class="line"><span class="keyword">var</span> resouceGroupId = pulumi.interpolate <span class="string">`/subscriptions/<span class="subst">$&#123;subscriptionId&#125;</span>/resourceGroups/<span class="subst">$&#123;resourceGroupName&#125;</span>`</span>;</span><br><span class="line"><span class="keyword">const</span> resourceGroup = azure.core.ResourceGroup.get(resourceGroupName, resouceGroupId);</span><br></pre></td></tr></table></figure><blockquote><p>TypeScript <strong>string interpolation</strong> doesn't work very good with Pulumi Output<T> objects. You need to use the <strong>pulumi.interpolate</strong> syntax to create strings from Output<T></p></blockquote><h4>Creating an Azure Service Principal</h4><p>Your new <strong>AKS</strong> service instance is going to need to be able to create a lot of Azure resources. It will do all of this for you, but in order to create these resources, it will need to log in as a Service Principal that you've created in your subscription. The first thing we'll do is get our application to create that Service Principal.</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Original example: https://github.com/pulumi/examples/blob/master/azure-ts-aks-helm/README.md</span></span><br><span class="line"><span class="comment">// Create an Azure AD Application</span></span><br><span class="line"><span class="keyword">const</span> adApp = <span class="keyword">new</span> azuread.Application(<span class="string">"aksSSO"</span>);</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> adAppId = adApp.applicationId;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Create an Azure Service Principal for that application</span></span><br><span class="line"><span class="keyword">const</span> adSp = <span class="keyword">new</span> azuread.ServicePrincipal(<span class="string">"aksSSOSp"</span>, &#123; applicationId: adApp.applicationId &#125;);</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> adSpId = adSp.id;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Assign the password from our configuration values to the Service Principal</span></span><br><span class="line"><span class="keyword">const</span> adSpPassword:<span class="built_in">any</span> = <span class="keyword">new</span> azuread.ServicePrincipalPassword(<span class="string">"aksSpPassword"</span>, &#123;</span><br><span class="line">    servicePrincipalId: adSpId,</span><br><span class="line">    value: password,</span><br><span class="line">    endDate: <span class="string">"2099-01-01T00:00:00Z"</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>We are not exporting any of these values. We won't need to see them in the Pulumi web portal or use them in any other project or stack. You can see this application and Service Principal in the AAD that your subscription is connected to.</p><blockquote><p>Creating an AAD Service Principal sometimes takes a bit of time. Operations that depend on the SP being created (the AKS Service creation code) may fail until the SP is finished being created. If this happens, simply <code>pulumi up</code> again.</p></blockquote><h4>Storage Account for Database backups</h4><p>Our business problem requires a database and a good thing to do once in a while is backup that database and put those backups somewhere. For this activity, we are creating an Azure Storage Account, in our <strong>AKS</strong> specific resource group, that we will use as a volume in the pgAdmin4 pod.</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Create storage account for Azure Files</span></span><br><span class="line"><span class="keyword">const</span> storageAccountK8s = <span class="keyword">new</span> azure.storage.Account(<span class="string">"Identity"</span>,&#123;</span><br><span class="line">    resourceGroupName: resourceGroupName,</span><br><span class="line">    accountTier: <span class="string">"Standard"</span>,</span><br><span class="line">    accountReplicationType: <span class="string">"LRS"</span>,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> storageAccountName = storageAccountK8s.name;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> storageAccountKeyPrimary = pulumi.secret(storageAccountK8s.primaryAccessKey);</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> storageAccountKeySecondary = pulumi.secret(storageAccountK8s.secondaryAccessKey);</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> storageAccountConnectionStringPrimary = pulumi.secret(storageAccountK8s.primaryConnectionString);</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> storageAccountConnectionStringSecondary = pulumi.secret(storageAccountK8s.secondaryConnectionString);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> fileShare = <span class="keyword">new</span> azure.storage.Share(<span class="string">"k8sFileShare"</span>, &#123;</span><br><span class="line">    name: <span class="string">"k8s-file-share"</span>,</span><br><span class="line">    storageAccountName: storageAccountK8s.name,</span><br><span class="line">    quota: <span class="number">10</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> fileShareName = fileShare.name;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> fileShareUrl = fileShare.url;</span><br></pre></td></tr></table></figure><p>You'll notice that during the creation of the storage account, we get back the connection strings and keys which we'll need to use later on. We can use the <code>pulumi.secret()</code> method to ensure that these are treated as secrets by the Pulumi cloud infrastructure.</p><img src="/images/dwhite/pulumi-secrets-output.png" alt="Outputs as secrets" height="200px"><h4>Azure Kubernetes Service</h4><p>We are finally going to create our <strong>Azure Kubernetes Service (AKS)</strong> instance! w00 h00!! Or I should say, we're going to code it up in Pulumi and we'll let Pulumi take care of creating it!</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Creates an AKS cluster.</span></span><br><span class="line"><span class="keyword">const</span> k8sCluster = <span class="keyword">new</span> azure.containerservice.KubernetesCluster(<span class="string">"aksCluster"</span>, &#123;</span><br><span class="line">    resourceGroupName: resourceGroupName,</span><br><span class="line">    kubernetesVersion: <span class="string">"1.17.3"</span>,</span><br><span class="line">    location: stackLocation,</span><br><span class="line">    defaultNodePool:&#123;</span><br><span class="line">        name: <span class="string">"aksagentpool"</span>,</span><br><span class="line">        nodeCount: nodeCount,</span><br><span class="line">        enableAutoScaling: <span class="literal">false</span>,</span><br><span class="line">        vmSize: nodeSize</span><br><span class="line">    &#125;,</span><br><span class="line">    dnsPrefix: k8sDnsName,</span><br><span class="line">    linuxProfile: &#123;</span><br><span class="line">        adminUsername: <span class="string">"aksuser"</span>,</span><br><span class="line">        sshKey: &#123; keyData: sshPublicKey &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    servicePrincipal: &#123;</span><br><span class="line">        clientId: adAppId,</span><br><span class="line">        clientSecret: password,</span><br><span class="line">    &#125;,</span><br><span class="line"><span class="comment">/* This is commented out because we do not want to do this. Please see my</span></span><br><span class="line"><span class="comment">   blurb about LogAnalytics at the bottom of this post.</span></span><br><span class="line"><span class="comment">    addonProfile: &#123;</span></span><br><span class="line"><span class="comment">        omsAgent: &#123;</span></span><br><span class="line"><span class="comment">            enabled: true,</span></span><br><span class="line"><span class="comment">            logAnalyticsWorkspaceId: loganalytics.id,</span></span><br><span class="line"><span class="comment">        &#125;,</span></span><br><span class="line"><span class="comment">    &#125; */</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> nodeResourceGroup = k8sCluster.nodeResourceGroup;</span><br></pre></td></tr></table></figure><p>This is a pretty simple pulumi declaration given everything it took to get here. You'll notice the following parameters are mostly using our configuration. This is important when we add additional stacks (deployment target environments):</p><ul><li>resourceGroupName</li><li>kubernetesVersion: &quot;1.17.3&quot;<ul><li>you can only use kubernetes versions supported by Azure. This is the most recent at the time of writing</li></ul></li><li>location</li><li>nodeCount</li><li>vmSize</li><li>dnsPrefix</li><li>sshKey</li><li>servicePrincpal<ul><li>generated during creation</li></ul></li></ul><p>One of the things that does happen when Azure creates this <strong>AKS</strong> instance is that the cluster will use the Service Principal to create all of the resources and that all of the cluster resources will be placed in a in an auto-generated ResourceGroup. I haven't discovered to how to alter this behaviour. The name of the resource group that you create the <strong>AKS</strong> service in will be a component of this auto-generated ResourceGroup's name.</p><blockquote><p>If you <code>pulumi up</code> after this section be aware that creating a cluster takes time and requires the Service Principal to exist as well. <code>pulumi destroy</code> also takes a few minutes to run when an <strong>AKS</strong> instance is involved.</p></blockquote><h4>Interacting with Kubernetes in our Cluster</h4><p>Now that we have an <strong>k8s</strong> cluster running, we need to start interacting with the cluster and not Azure. In order to do that, we need a Pulumi object that is comparable to <code>kubectl</code>. In Pulumi, this is the <strong>k8s.Provider</strong> object.</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Expose a k8s provider instance using our custom cluster instance.</span></span><br><span class="line"><span class="keyword">const</span> k8sProvider = <span class="keyword">new</span> k8s.Provider(<span class="string">"aksK8s"</span>, &#123;</span><br><span class="line">    kubeconfig: k8sCluster.kubeConfigRaw,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// put our new clusterName in Pulumi service</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> clusterName = k8sCluster.name;</span><br><span class="line"><span class="comment">// put the az aks get-credentials command in Pulumi service</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> kubeCtrlCredentialsCommand = pulumi.interpolate <span class="string">`az aks get-credentials --resource-group <span class="subst">$&#123;resourceGroupName&#125;</span> --name <span class="subst">$&#123;clusterName&#125;</span> --context "MyProject.Identity"`</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Export the kubeConfig</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> kubeConfig = pulumi.secret(k8sCluster.kubeConfigRaw);</span><br></pre></td></tr></table></figure><p>In this code, you can see that we create a k8s.Provider instance using the kubeConfig that we can get from our <strong>AKS</strong> cluster instance. We also want to export that kubeConfig so that we can use it in our next Pulumi application that will create all of the <strong>k8s</strong> resources in the cluster. Remember, the kubeConfig is credentials to get into your cluster, so you should treat it as a very important <strong>secret</strong>.</p><p>I've also exported the new clusterName and a helper output value of the <code>az aks get-credentials</code> command that will help you put your new <strong>k8s</strong> credentials in your local kubeConfig file.</p><p>We will use the <strong>k8sProvider</strong> object in the remainder of this script to interact with our <strong>k8s</strong> cluster.</p><h4>Kubernetes Secrets</h4><p>The finish our basic <strong>AKS</strong> deployment, I am going to install a couple secrets that our <strong>k8s</strong> cluster will need to operate.</p><p>For our Azure Container Registry secrets, we need to get the ACR instance, ask it for it's secrets, and put them into <strong>k8s</strong>. This is the safest way to manage these secrets since we don't want them in our code base.</p><blockquote><p>Please treat these and all other secrets with all due care.</p></blockquote><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> acrInstanceName = <span class="string">"depthconsulting"</span>;</span><br><span class="line"><span class="keyword">const</span> acrIdentifier:<span class="built_in">string</span> =  <span class="string">"/subscriptions/&lt;your subscriptionId&gt;/resourceGroups/&lt;your resourceGroup&gt;/providers/Microsoft.ContainerRegistry/registries/&lt;your RegistryName&gt;"</span>;</span><br><span class="line"><span class="keyword">const</span> privateACRInstance = azure.containerservice.Registry.get(acrInstanceName, myAcrIdentifier);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> k8sDockerSecret = helpers.createImagePullSecret(</span><br><span class="line">    acrSecretName, <span class="comment">// secret name</span></span><br><span class="line">    privateACRInstance.adminUsername,</span><br><span class="line">    privateACRInstance.adminPassword,</span><br><span class="line">    privateACRInstance.loginServer,</span><br><span class="line">    k8sProvider);</span><br></pre></td></tr></table></figure><p>There is a help function that we are using that hides the complexity of this.</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createImagePullSecret</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    secretName: <span class="built_in">string</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    username: pulumi.Output&lt;<span class="built_in">string</span>&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">    password: pulumi.Output&lt;<span class="built_in">string</span>&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">    registry : pulumi.Output&lt;<span class="built_in">string</span>&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">    k8sProvider : k8s.Provider</span>): <span class="title">k8s</span>.<span class="title">core</span>.<span class="title">v1</span>.<span class="title">Secret</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Put the username password into dockerconfigjson format.</span></span><br><span class="line">    <span class="keyword">let</span> base64JsonEncodedCredentials : pulumi.Output&lt;<span class="built_in">string</span>&gt; = </span><br><span class="line">        pulumi.all([username, password, registry])</span><br><span class="line">        .apply(<span class="function">(<span class="params">[username, password, registry]</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> base64Credentials = Buffer.from(username + <span class="string">':'</span> + password).toString(<span class="string">'base64'</span>)</span><br><span class="line">            <span class="keyword">const</span> json =  <span class="string">`&#123;"auths":&#123;"<span class="subst">$&#123;registry&#125;</span>":&#123;"auth":"<span class="subst">$&#123;base64Credentials&#125;</span>"&#125;&#125;&#125;`</span></span><br><span class="line">            <span class="built_in">console</span>.log(json)</span><br><span class="line">            <span class="keyword">return</span> Buffer.from(json).toString(<span class="string">'base64'</span>)</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> k8s.core.v1.Secret(secretName, &#123;</span><br><span class="line">        metadata: &#123;</span><br><span class="line">            name: secretName,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="keyword">type</span>: <span class="string">'kubernetes.io/dockerconfigjson'</span>,</span><br><span class="line">        data: &#123;</span><br><span class="line">            <span class="string">".dockerconfigjson"</span>: base64JsonEncodedCredentials,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;, &#123; provider: k8sProvider &#125;)</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>We will also need to create a way for our <strong>k8s</strong> cluster to connect to the various storage providers that are available to us in Azure. In this case, we want to enable <strong>k8s</strong> to connect to the file storage we are going to use for our database backups. This uses some of the variables that we captured when creating our Storage Account as well as a helper function.</p><p><a href="https://docs.microsoft.com/en-us/azure/aks/azure-files-volume" target="_blank" rel="noopener">Microsoft Documentation</a></p><p>This is the <strong>kubectl</strong> command that would create this secret.</p><p><code>kubectl create secret generic azure-secret --from-literal=azurestorageaccountname=$AKS_PERS_STORAGE_ACCOUNT_NAME --from-literal=azurestorageaccountkey=$STORAGE_KEY</code></p><p>Now we convert that into a TypeScript function.</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> azureStorageSecret = helpers.createAzureFileSecret(</span><br><span class="line">    azureStorageSecretName,</span><br><span class="line">    storageAccountName,</span><br><span class="line">    storageAccountKeyPrimary,</span><br><span class="line">    k8sProvider);</span><br></pre></td></tr></table></figure><p>Here is a helper function that will create the secret properly for us.</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createAzureFileSecret</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    secretName: <span class="built_in">string</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    storageAccountName: pulumi.Output&lt;<span class="built_in">string</span>&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">    storageAccountKey: pulumi.Output&lt;<span class="built_in">string</span>&gt;, </span></span></span><br><span class="line"><span class="function"><span class="params">    k8sProvider : k8s.Provider</span>): <span class="title">k8s</span>.<span class="title">core</span>.<span class="title">v1</span>.<span class="title">Secret</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> dataValue = pulumi</span><br><span class="line">        .all([storageAccountName, storageAccountKey])</span><br><span class="line">        .apply(<span class="function">(<span class="params">[san,sak]</span>) =&gt;</span>&#123;</span><br><span class="line">            <span class="keyword">const</span> b64SAN = Buffer.from(san).toString(<span class="string">'base64'</span>);</span><br><span class="line">            <span class="keyword">const</span> b64SAK = Buffer.from(sak).toString(<span class="string">'base64'</span>);</span><br><span class="line">            <span class="keyword">return</span> &#123; azurestorageaccountname: b64SAN, azurestorageaccountkey: b64SAK &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> k8s.core.v1.Secret(secretName, &#123;</span><br><span class="line">        <span class="keyword">type</span>: <span class="string">"kubernetes.io/generic"</span>,</span><br><span class="line">        metadata: &#123;</span><br><span class="line">            name: secretName,</span><br><span class="line">            <span class="keyword">namespace</span>: <span class="string">"default"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        data: dataValue</span><br><span class="line">    &#125;,&#123;provider: k8sProvider&#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><blockquote><p>I'll eventually make this a more generic mechanism for creating secrets.</p></blockquote><h3>Our Full AKS Application</h3><p>We have now completed our whole Pulumi application that will stand up a basic <strong>AKS</strong> cluster in Azure. Here is the entire script for completeness.</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> azure <span class="keyword">from</span> <span class="string">"@pulumi/azure"</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> pulumi <span class="keyword">from</span> <span class="string">"@pulumi/pulumi"</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> k8s <span class="keyword">from</span> <span class="string">"@pulumi/kubernetes"</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> azuread <span class="keyword">from</span> <span class="string">"@pulumi/azuread"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Import some stack configuration and export used configuration variables for the AKS stack.</span></span><br><span class="line"><span class="keyword">const</span> config = <span class="keyword">new</span> pulumi.Config();</span><br><span class="line"><span class="keyword">const</span> password = config.requireSecret(<span class="string">"password"</span>);</span><br><span class="line"><span class="keyword">const</span> sshPublicKey = config.require(<span class="string">"sshPublicKey"</span>);</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> stackLocation = config.get(<span class="string">"stackLocation"</span>) || (config.get(<span class="string">"azure:location"</span>) || <span class="string">"WestUS"</span>);</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> nodeCount = config.getNumber(<span class="string">"nodeCount"</span>) || <span class="number">2</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> nodeSize = config.get(<span class="string">"nodeSize"</span>) || <span class="string">"Standard_B2s"</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> storageClassName = <span class="string">"managed-premium"</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> resourceGroupName = <span class="string">"rg_identity_dev_zwus_aks"</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> publicIpAddressName = <span class="string">"pip_identity_dev_zwus_aks"</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> k8sDnsName = <span class="string">"identity-auth-dev"</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> acrSecretName = <span class="string">"docker-credentials"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> clientConfig = pulumi.output(azure.core.getClientConfig());</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> subscriptionId = clientConfig.subscriptionId;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Get reference to pre-existing Azure ResourceGroup</span></span><br><span class="line"><span class="comment">// get the Azure Resource Group</span></span><br><span class="line"><span class="keyword">var</span> resouceGroupId:pulumi.Output&lt;<span class="built_in">string</span>&gt; = pulumi.interpolate <span class="string">`/subscriptions/<span class="subst">$&#123;subscriptionId&#125;</span>/resourceGroups/<span class="subst">$&#123;resourceGroupName&#125;</span>`</span>;</span><br><span class="line"><span class="keyword">const</span> resourceGroup = azure.core.ResourceGroup.get(resourceGroupName, resouceGroupId);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Create AAD Application and Service Principal for AKS Cluster to use to create resources in the subscription</span></span><br><span class="line"><span class="comment">// https://github.com/pulumi/examples/blob/master/azure-ts-aks-helm/README.md</span></span><br><span class="line"><span class="comment">// Create the AD service principal for the k8s cluster.</span></span><br><span class="line"><span class="keyword">const</span> adApp = <span class="keyword">new</span> azuread.Application(<span class="string">"aksSSO"</span>);</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> adAppId = adApp.applicationId;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> adSp = <span class="keyword">new</span> azuread.ServicePrincipal(<span class="string">"aksSSOSp"</span>, &#123; applicationId: adApp.applicationId &#125;);</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> adSpId = adSp.id;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> adSpPassword:<span class="built_in">any</span> = <span class="keyword">new</span> azuread.ServicePrincipalPassword(<span class="string">"aksSpPassword"</span>, &#123;</span><br><span class="line">    servicePrincipalId: adSpId,</span><br><span class="line">    value: password,</span><br><span class="line">    endDate: <span class="string">"2099-01-01T00:00:00Z"</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Create storage account for Azure Files</span></span><br><span class="line"><span class="keyword">const</span> storageAccountK8s = <span class="keyword">new</span> azure.storage.Account(<span class="string">"Identity"</span>,&#123;</span><br><span class="line">    resourceGroupName: resourceGroupName,</span><br><span class="line">    accountTier: <span class="string">"Standard"</span>,</span><br><span class="line">    accountReplicationType: <span class="string">"LRS"</span>,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> storageAccountName = storageAccountK8s.name;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> storageAccountKeyPrimary = pulumi.secret(storageAccountK8s.primaryAccessKey);</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> storageAccountKeySecondary = pulumi.secret(storageAccountK8s.secondaryAccessKey);</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> storageAccountConnectionStringPrimary = pulumi.secret(storageAccountK8s.primaryConnectionString);</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> storageAccountConnectionStringSecondary = pulumi.secret(storageAccountK8s.secondaryConnectionString);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> fileShare = <span class="keyword">new</span> azure.storage.Share(<span class="string">"k8sFileShare"</span>, &#123;</span><br><span class="line">    name: <span class="string">"k8s-file-share"</span>,</span><br><span class="line">    storageAccountName: storageAccountK8s.name,</span><br><span class="line">    quota: <span class="number">10</span></span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> fileShareName = fileShare.name;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> fileShareUrl = pulumi.secret(fileShare.url);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Create AKS Cluster</span></span><br><span class="line"><span class="keyword">const</span> k8sCluster = <span class="keyword">new</span> azure.containerservice.KubernetesCluster(<span class="string">"aksCluster"</span>, &#123;</span><br><span class="line">    resourceGroupName: resourceGroupName,</span><br><span class="line">    kubernetesVersion: <span class="string">"1.17.3"</span>,</span><br><span class="line">    location: stackLocation,</span><br><span class="line">    defaultNodePool:&#123;</span><br><span class="line">        name: <span class="string">"aksagentpool"</span>,</span><br><span class="line">        nodeCount: nodeCount,</span><br><span class="line">        enableAutoScaling: <span class="literal">false</span>,</span><br><span class="line">        vmSize: nodeSize</span><br><span class="line">    &#125;,</span><br><span class="line">    dnsPrefix: k8sDnsName,</span><br><span class="line">    linuxProfile: &#123;</span><br><span class="line">        adminUsername: <span class="string">"aksuser"</span>,</span><br><span class="line">        sshKey: &#123; keyData: sshPublicKey &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    servicePrincipal: &#123;</span><br><span class="line">        clientId: adAppId,</span><br><span class="line">        clientSecret: password,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Expose a k8s provider instance using our custom cluster instance.</span></span><br><span class="line"><span class="keyword">const</span> k8sProvider = <span class="keyword">new</span> k8s.Provider(<span class="string">"aksK8s"</span>, &#123;</span><br><span class="line">    kubeconfig: k8sCluster.kubeConfigRaw,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// put our new clusterName in Pulumi service</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> clusterName = k8sCluster.name;</span><br><span class="line"><span class="comment">// put the az aks get-credentials command in Pulumi service</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> kubeCtrlCredentialsCommand = pulumi.interpolate <span class="string">`az aks get-credentials --resource-group <span class="subst">$&#123;resourceGroupName&#125;</span> --name <span class="subst">$&#123;clusterName&#125;</span> --context "MyProject.Identity"`</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Export the kubeConfig as a secret</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> kubeConfig = pulumi.secret(k8sCluster.kubeConfigRaw);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Create secrets in **k8s** cluster to allow certain operations</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Docker Registry credentials</span></span><br><span class="line"><span class="keyword">const</span> acrInstanceName = <span class="string">"&lt;your ACR name here&gt;"</span>;</span><br><span class="line"><span class="comment">//const acrIdentifier = config.requireSecret("acrIdentifier");</span></span><br><span class="line"><span class="keyword">const</span> acrIdentifier:<span class="built_in">string</span> =  <span class="string">"/&lt;your ACR ID (uri) here&gt;"</span>;</span><br><span class="line"><span class="keyword">let</span> myAcrIdentifier = pulumi.output(acrIdentifier);</span><br><span class="line"><span class="keyword">const</span> privateACRInstance = azure.containerservice.Registry.get(acrInstanceName, myAcrIdentifier);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> k8sDockerSecret = helpers.createImagePullSecret(</span><br><span class="line">    <span class="string">"docker-credentials"</span>,</span><br><span class="line">    privateACRInstance.adminUsername,</span><br><span class="line">    privateACRInstance.adminPassword,</span><br><span class="line">    privateACRInstance.loginServer,</span><br><span class="line">    k8sProvider);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// Azure Storage Account Credentials</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> azureStorageSecretName = <span class="string">"azure-storage-secret"</span>;</span><br><span class="line"><span class="keyword">const</span> azureStorageSecret = <span class="keyword">new</span> k8s.core.v1.Secret(azureStorageSecretName, &#123;</span><br><span class="line">    <span class="keyword">type</span>: <span class="string">"kubernetes.io/generic"</span>,</span><br><span class="line">    metadata: &#123;</span><br><span class="line">        name: azureStorageSecretName,</span><br><span class="line">        <span class="keyword">namespace</span>: <span class="string">"default"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    data:&#123;</span><br><span class="line">        azurestorageaccountname: storageAccountName,</span><br><span class="line">        azurestorageaccountkey: storageAccountK8s.primaryAccessKey</span><br><span class="line">    &#125;</span><br><span class="line">&#125;,&#123;provider: k8sProvider&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createImagePullSecret</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    secretName: <span class="built_in">string</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    username: pulumi.Output&lt;<span class="built_in">string</span>&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">    password: pulumi.Output&lt;<span class="built_in">string</span>&gt;, </span></span></span><br><span class="line"><span class="function"><span class="params">    registry : pulumi.Output&lt;<span class="built_in">string</span>&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">    k8sProvider : k8s.Provider</span>): <span class="title">k8s</span>.<span class="title">core</span>.<span class="title">v1</span>.<span class="title">Secret</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Put the username password into dockerconfigjson format.</span></span><br><span class="line">    <span class="keyword">let</span> base64JsonEncodedCredentials : pulumi.Output&lt;<span class="built_in">string</span>&gt; = </span><br><span class="line">        pulumi.all([username, password, registry])</span><br><span class="line">        .apply(<span class="function">(<span class="params">[username, password, registry]</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> base64Credentials = Buffer.from(username + <span class="string">':'</span> + password).toString(<span class="string">'base64'</span>);</span><br><span class="line">            <span class="keyword">const</span> json =  <span class="string">`&#123;"auths":&#123;"<span class="subst">$&#123;registry&#125;</span>":&#123;"auth":"<span class="subst">$&#123;base64Credentials&#125;</span>"&#125;&#125;&#125;`</span>;</span><br><span class="line">            <span class="built_in">console</span>.log(json);</span><br><span class="line">            <span class="keyword">return</span> Buffer.from(json).toString(<span class="string">'base64'</span>);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> k8s.core.v1.Secret(secretName, &#123;</span><br><span class="line">        metadata: &#123;</span><br><span class="line">            name: secretName,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="keyword">type</span>: <span class="string">'kubernetes.io/dockerconfigjson'</span>,</span><br><span class="line">        data: &#123;</span><br><span class="line">            <span class="string">".dockerconfigjson"</span>: base64JsonEncodedCredentials,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;, &#123; provider: k8sProvider &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>A last <code>pulumi up</code> and you should have your <strong>AKS</strong> cluster completely provisioned in your Azure subscription.</p><h2>Creating a Production Stack</h2><p>One of the things about using a Pulumi application with multiple stacks is that each stack holds environment-specific configuration, so we can re-use our application for different environments via stacks. You will probably create your <strong>dev</strong> and <strong>prod</strong> stacks, but you could also manage your <strong>Disaster Recover(DR)</strong> or <strong>High-Availability (HA)</strong> (different region) as stacks as well.</p><p>In this case, we're going to use the Pulumi CLI <a href="https://www.pulumi.com/docs/intro/concepts/stack/" target="_blank" rel="noopener">to create a prod stack</a> for our <strong>k8s</strong> infrastructure. To create a new stack, the command is:</p><p><code>pulumi stack init prod</code></p><p>We can list all available stacks in a project using:</p><p><code>pulumi stack ls</code> and selecting a different stack is <code>pulumi stack select &lt;stack-name&gt;</code></p><p>Once our production stack is created, we can set all of the <code>pulumi config</code> variables that are required for the stack to operate and voila! We can create a <strong>prod</strong> deployment of our <strong>AKS</strong> infrastructure that should look exactly like our <strong>dev</strong> stack infrastructure.</p><h2>Summary</h2><p>This has been a very long post! I hope you've been able to successfully deploy your <strong>AKS</strong> instance. We will need it for the next article in this series where we put our resources into that <strong>k8s</strong> cluster!</p><h2>A Note about Log Analytics</h2><p>In your research about <strong>AKS</strong> you will probably come across examples that show attaching Log Analytics instances to your <strong>AKS</strong> cluster.</p><p>I did this and a week or so later, I was looking at costs in my Azure subscription and I saw that our <strong>AKS</strong> resource group had cost way more than I expected! Digging into the reasons, I found that Log Analytics actually cost <strong>more</strong> than our <strong>AKS</strong> VM resources! I immediately turned it off. Log Analytics is too expensive for us at this point in time. Perhaps when you have a large Kubernetes installation it is worth it, but right now, our Log Analytics bill couldn't be justified!</p><p>When I was turning it off, I wanted to make sure that we removed all traces of it from our subscription and the <strong>AKS</strong> cluster. First, I deleted the Log Analytics components in Azure. The cluster still worked! Great! Stop the billing and keep everything working. Then I wanted to clean out all of the <code>omsagents</code> from the cluster, but those pods/deployments/services are impossible to remove from the AKS Cluster. I'm guessing that something on the outside that is managing the cluster is watching them and putting them in there all the time. I had to do something else, which lead me to this document.</p><p><a href="https://docs.microsoft.com/en-us/azure/azure-monitor/insights/container-insights-optout" target="_blank" rel="noopener">Link to Microsoft Documents</a></p><p>For the time being, because I have a lot of internal logging happening in the cluster and I don't want to spend more money on monitoring than the cluster itself, I'll just leave it off and recommend that you start without it.</p><p>If you do want Log Analytics in your <strong>AKS</strong> cluster, you can add this code into your application...</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Setup log analytics for k8s</span></span><br><span class="line"><span class="keyword">const</span> loganalytics = <span class="keyword">new</span> azure.operationalinsights.AnalyticsWorkspace(<span class="string">"aksloganalytics"</span>, &#123;</span><br><span class="line">    resourceGroupName: resourceGroupName,</span><br><span class="line">    location: location,</span><br><span class="line">    sku: <span class="string">"PerGB2018"</span>,</span><br><span class="line">    retentionInDays: <span class="number">30</span>,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>... and un-comment out these JSON parameters in the <strong>AKS</strong> cluster creation method.</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* This is commented out because we do not want to do this. Please see my</span></span><br><span class="line"><span class="comment">   blurb about LogAnalytics at the bottom of this post.</span></span><br><span class="line"><span class="comment">    addonProfile: &#123;</span></span><br><span class="line"><span class="comment">        omsAgent: &#123;</span></span><br><span class="line"><span class="comment">            enabled: true,</span></span><br><span class="line"><span class="comment">            logAnalyticsWorkspaceId: loganalytics.id,</span></span><br><span class="line"><span class="comment">        &#125;,</span></span><br><span class="line"><span class="comment">    &#125; */</span></span><br></pre></td></tr></table></figure><p><strong>Next up:</strong><a href="/kubernetes/kubernetes-my-journey-part-7b">Moving to Azure Kubernetes Service - Part B</a></p><style>    h1, h2, h3, h4, h5, h6 {       margin-top: 25px;    }    img {       margin: 25px 0px;    }    figure.highlight{        background-color: #E8EEFE;    }    figure.highlight .gutter{        color: #0033CD;    }    figure.highlight pre {        font-family: 'Cascadia Code PL', monospace;    }    code {        font-family: 'Cascadia Code PL', sans-serif;        border-width: 0.1em;        border-color: #E8EEFE;        border-style: solid;        border-radius: 0.3em;        background-color: #E8EEFE;        color: #0033CD;        padding: 0em 0.4em;        white-space: nowrap;    }</style><link  href="https://cdnjs.cloudflare.com/ajax/libs/viewerjs/1.5.0/viewer.min.css" rel="stylesheet"><script src="https://cdnjs.cloudflare.com/ajax/libs/viewerjs/1.5.0/viewer.min.js"></script><script>// View an imageconst gallery = new Viewer(document.getElementById('mainPostContent', {    "navbar": false,    "toolbar": false}));</script>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;a href=&quot;/kubernetes/kubernetes-my-journey&quot;&gt;Series Table of Contents&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Previously:&lt;/strong&gt;
&lt;a href=&quot;/kubernetes/kuberne
    
    </summary>
    
      <category term="kubernetes" scheme="https://westerndevs.com/categories/kubernetes/"/>
    
    
      <category term="kubernetes, azure, aks, identityserver, docker, containers" scheme="https://westerndevs.com/tags/kubernetes-azure-aks-identityserver-docker-containers/"/>
    
  </entry>
  
  <entry>
    <title type="html">Kubernetes - My Journey - Part 7b</title>
    <link href="https://westerndevs.com/kubernetes/kubernetes-my-journey-part-7b/" rel="alternate" type="text/html"/>
    <id>https://westerndevs.com/kubernetes/kubernetes-my-journey-part-7b/</id>
    <published>2020-05-22T08:00:00.000Z</published>
    <updated>2020-11-09T21:27:02.246Z</updated>
	<author>
	
	  
	  <name>Dave White</name>
	  <email>dmhwhite@gmail.com</email>
	
	  <uri>https://westerndevs.com</uri>
	</author>
    
    <content type="html"><![CDATA[<p><a href="/kubernetes/kubernetes-my-journey">Series Table of Contents</a></p><p><strong>Previously:</strong><a href="/kubernetes/kubernetes-my-journey-part-7a">Moving to Azure Kubernetes Service - Part A</a></p><h1>Moving to Azure Kubernetes Service - Part B</h1><p>We're really making some progress! We should have our <strong>AKS</strong> cluster running now and ready for use to start putting some resources into. If you don't, head on back to the previous article in the series and get your <strong>k8s</strong> standing up in Azure!</p><h2>Continuing with Pulumi</h2><p>In the prevoius article, we used Pulumi exclusively to describe what we wanted in our <strong>AKS</strong> infrastructure and we had the Pulumi CLI do all the hard work of provisioning our <strong>k8s</strong> cluster. Now we are going to ask Pulumi to do a little more work and help us get our <strong>k8s</strong> resources into the cluster.</p><p>First, let's create a new Pulumi Project and Stack to hold our resource specific configuration values, application, and history.</p><p>Let's create a folder in our infrastructure folder for the <strong>k8s</strong> deployment stack. Starting in your <code>infra</code> folder, run the command:</p><p><code>mkdir k8s &amp;&amp; cd k8s</code></p><p>Now use the Pulumi CLI to build our new project with its initial stack.</p><p><code>pulumi new azure-typescript --secrets-provider=passphrase</code></p><p>This will kick off the workflow to acquire some details before it creates the stack. In my case, I answered the workflow questions with:</p><ol><li>project name (k8s) &lt;-- hit enter and accepted default</li><li>project description: <strong>Deploy our kubernetes infrastructure</strong></li><li>stack name: (dev) &lt;-- hit enter and accepted default</li><li>Enter your passphrase to protect config/secrets: <strong>P@ssw0rd!</strong></li><li>azure:environment: (public) &lt;-- hit enter and accept default</li><li>azure:location: (WestUS) <strong>WestUS</strong></li></ol><p>This will scaffold our new project and submit the project and stack details to our Pulumi cloud. Let's open VS Code, open the <strong>index.ts</strong> and delete everything from the file.</p><p>We are going to need to add the Pulumi kubernetes SDK module to our project.</p><p><code>npm install @pulumi/kubernetes</code></p><p>Now, at the top of our empty <strong>index.ts</strong> file, we can add the following imports.</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> pulumi <span class="keyword">from</span> <span class="string">"@pulumi/pulumi"</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> k8s <span class="keyword">from</span> <span class="string">"@pulumi/kubernetes"</span>;</span><br></pre></td></tr></table></figure><h3>Getting Configuration Values</h3><p>In our <strong>AKS</strong> Pulumi project/stack, we had a number of configuration values that we stored in our Pulumi service. One of those important configuration values was the kubeConfig file that contains the credentials required to connect to our <strong>k8s</strong> instance. We are now going to use the Pulumi SDK to get that kubeConfig value so that we can use it in this project.</p><p><a href="https://www.pulumi.com/docs/intro/concepts/organizing-stacks-projects/#inter-stack-dependencies" target="_blank" rel="noopener">Inter-Stack Dependencies</a></p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// setup config</span></span><br><span class="line"><span class="keyword">const</span> env = pulumi.getStack(); <span class="comment">// reference to this stack</span></span><br><span class="line"><span class="keyword">const</span> stackId = <span class="string">`dave/aks/<span class="subst">$&#123;env&#125;</span>`</span>;</span><br><span class="line"><span class="keyword">const</span> aksStack = <span class="keyword">new</span> pulumi.StackReference(stackId);</span><br><span class="line"><span class="keyword">const</span> kubeConfig = aksStack.getOutput(<span class="string">"kubeConfig"</span>);</span><br><span class="line"><span class="keyword">const</span> k8sProvider = <span class="keyword">new</span> k8s.Provider(<span class="string">"k8s"</span>, &#123; kubeconfig: kubeConfig  &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// output kubeConfig for debugging purposes</span></span><br><span class="line"><span class="keyword">let</span> _ = aksStack.getOutput(<span class="string">"kubeConfig"</span>).apply(<span class="function"><span class="params">unwrapped</span> =&gt;</span> <span class="built_in">console</span>.log(unwrapped));</span><br></pre></td></tr></table></figure><p>If we break down this fragment of Typescript, we see that:</p><ol><li>Get a reference to the current stack</li><li>Ask Pulumi for an object reference to our <strong>AKS</strong> stack variables. We want the kubeConfig secret from it.</li><li>Create a <strong>k8s.Provider</strong> using the acquired kubeConfig values<ul><li>(Option) - Output the kubeConfig to the console for debugging</li></ul></li></ol><p><code>pulumi up</code> to test your application. It should simply compile, access our <strong>aks8</strong> stack, and output the kubeConfig!</p><h3>Labels</h3><p>Almost everything in <strong>k8s</strong> uses labels to perform important actions. For example, Services expose Deployments that match the selector labels. Also, you can use labels to do queries via <strong>kubectl</strong> or as filters in <strong>octant</strong>, <strong>k9s</strong>, or the <strong>Kubernetes Web UI</strong>. You'll see labels used throughout the manifests and the Pulumi code.</p><p>We will define some common label groups that we'll use throughout our application, merging them with service/deployment specific sets of labels as required. You can add to these groups as required for your situation.</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Common labels</span></span><br><span class="line"><span class="keyword">const</span> baseBackEndLabels = &#123; tier: <span class="string">"backend"</span>, group: <span class="string">"infrastructure"</span> &#125;;</span><br><span class="line"><span class="keyword">const</span> baseApplicationGroupLabels = &#123;tier: <span class="string">"frontend"</span>, group:<span class="string">"auth"</span>&#125;;</span><br></pre></td></tr></table></figure><h3>Moving Postgres from Manifest to Pulumi</h3><p>Now that we have a <strong>k8s.Provider</strong> that we can use to send instructions to our <strong>AKS</strong> cluster, we need to create the Pulumi instructions to start putting resources into our <strong>k8s</strong> cluster. Starting with postgres, let's take a look at our manifest that we used when putting resources into <strong>minikube</strong>.</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">postgres-pv-volume</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">local</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">manual</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">1Gi</span></span><br><span class="line">  <span class="attr">hostPath:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/var/lib/postgresql/data</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">postgres-pv-claim</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">manual</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">1Gi</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">postgres-dep</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">postgres</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">backend</span></span><br><span class="line">    <span class="attr">group:</span> <span class="string">infrastructure</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">revisionHistoryLimit:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">postgres</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">postgres</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">postgres-pv-storage</span></span><br><span class="line">          <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">            <span class="attr">claimName:</span> <span class="string">postgres-pv-claim</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">postgres</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">postgres:alpine</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POSTGRES_USER</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">"admin"</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POSTGRES_PASSWORD</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">"P@ssw0rd!"</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POSTGRES_DB</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">"identity"</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">5432</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">"/var/lib/postgresql/data"</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">postgres-pv-storage</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># from postgres-svc.yml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">postgres-svc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">postgres</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">5432</span></span><br></pre></td></tr></table></figure><p>We're going to ignore the first resource in the manifest. Because we are using <strong>AKS</strong>, we are able to take advantage of the <em>dynamic persistent volume</em> mechanism that is provided. We simply need to create <strong>PersistentVolumeClaim</strong> with the correct <strong>storageClass</strong> and <strong>Azure/AKS</strong> will take care of provisioning an actual persistent volume for us and attaching it to the correct host/node.</p><p>The second resource is the PersistentVolumeClaim. The important differnce between the manifest and the Pulumi application is going to be the use of the <strong>storageClassName</strong> configuration value that is coming from our <strong>aksStack</strong> configuration. In the <strong>AKS</strong> stack, this value is set to <strong>managed-premium</strong>.</p><p>For our third resource, the actual Deployment, we mostly want to map the values from our manifest into the TypeScript/JSON notation.</p><p>Last but not least, we map the Service manifest settings that will give the postgres-dep resource some network (internal to cluster) configuration into our Pulumi application.</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Add Postgres to AKS Cluster</span></span><br><span class="line"><span class="keyword">const</span> postgresLabels = &#123;...&#123; app: <span class="string">"postgres"</span>, role: <span class="string">"db"</span> &#125;, ...baseBackEndLabels&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> postgresPVClaimName = <span class="string">"postgres-pv-claim"</span>;</span><br><span class="line"><span class="keyword">const</span> postgresPersistentVolumeClaim = <span class="keyword">new</span> k8s.core.v1.PersistentVolumeClaim(postgresPVClaimName,&#123;</span><br><span class="line">    metadata:&#123; name: postgresPVClaimName&#125;,</span><br><span class="line">    spec: &#123;</span><br><span class="line">        storageClassName: aksStack.getOutput(<span class="string">"storageClassName"</span>),</span><br><span class="line">        accessModes: [<span class="string">"ReadWriteOnce"</span>],</span><br><span class="line">        resources: &#123;</span><br><span class="line">            requests: &#123;</span><br><span class="line">                storage: <span class="string">"32Gi"</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;, &#123;provider: k8sProvider&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> postgresDepName = <span class="string">"postgres-dep"</span>;</span><br><span class="line"><span class="keyword">const</span> postgresDeployment = <span class="keyword">new</span> k8s.apps.v1.Deployment(postgresDepName, &#123;</span><br><span class="line">    metadata: &#123; </span><br><span class="line">        name: postgresDepName, </span><br><span class="line">        labels: postgresLabels</span><br><span class="line">    &#125;,</span><br><span class="line">    spec: &#123;</span><br><span class="line">        selector: &#123; matchLabels: postgresLabels &#125;,</span><br><span class="line">        replicas: <span class="number">1</span>,</span><br><span class="line">        revisionHistoryLimit: <span class="number">2</span>,</span><br><span class="line">        template: &#123;</span><br><span class="line">            metadata: &#123; labels: postgresLabels &#125;,</span><br><span class="line">            spec: &#123;</span><br><span class="line">                containers: [&#123;</span><br><span class="line">                    name: <span class="string">"postgres"</span>,</span><br><span class="line">                    image: <span class="string">"postgres:alpine"</span>,</span><br><span class="line">                    volumeMounts: [&#123;</span><br><span class="line">                        mountPath: <span class="string">"/var/lib/postgresql/data"</span>,</span><br><span class="line">                        name: <span class="string">"volume"</span></span><br><span class="line">                    &#125;],</span><br><span class="line">                    resources: &#123;</span><br><span class="line">                        requests: &#123;</span><br><span class="line">                            cpu: <span class="string">"100m"</span>,</span><br><span class="line">                            memory: <span class="string">"100Mi"</span>,</span><br><span class="line">                        &#125;,</span><br><span class="line">                    &#125;,</span><br><span class="line">                    ports: [&#123; containerPort: <span class="number">5432</span> &#125;],</span><br><span class="line">                    env: [</span><br><span class="line">                        &#123;name: <span class="string">"POSTGRES_USER"</span>, value: <span class="string">"admin"</span>&#125;,</span><br><span class="line">                        &#123;name: <span class="string">"POSTGRES_PASSWORD"</span>, value: <span class="string">"P@ssw0rd!"</span>&#125;,</span><br><span class="line">                        &#123;name: <span class="string">"POSTGRES_DB"</span>, value: <span class="string">"identity"</span>&#125;,</span><br><span class="line">                        &#123;name: <span class="string">"PGDATA"</span>, value: <span class="string">"/mnt/data/pgdata"</span>&#125;</span><br><span class="line">                    ]</span><br><span class="line">                &#125;],</span><br><span class="line">                volumes:[&#123;</span><br><span class="line">                    name: <span class="string">"volume"</span>,</span><br><span class="line">                    persistentVolumeClaim: &#123;</span><br><span class="line">                        claimName: postgresPVClaimName</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;]</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;, &#123;provider: k8sProvider&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> postgresServiceName = <span class="string">"postgres-svc"</span>;</span><br><span class="line"><span class="keyword">const</span> postgresService = <span class="keyword">new</span> k8s.core.v1.Service(postgresServiceName, </span><br><span class="line">    &#123;</span><br><span class="line">        metadata: &#123;</span><br><span class="line">            name: postgresServiceName,</span><br><span class="line">            labels: postgresLabels,</span><br><span class="line">        &#125;,</span><br><span class="line">        spec: &#123;</span><br><span class="line">            ports: [&#123; port: <span class="number">5432</span>, protocol: <span class="string">"TCP"</span>&#125;],</span><br><span class="line">            selector: postgresLabels,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;, &#123;provider: k8sProvider&#125;);</span><br></pre></td></tr></table></figure><p><code>pulumi up</code> to compile our application and deploy postgres into the <strong>k8s</strong> cluster!</p><h3>Moving pgAdmin4 from Manifest to Pulumi</h3><p>Our next step is to migrate the pgAdmin4 manifest settings into Pulumi. This is going to be mostly the same as the postgres migration. I'll point out a few differences below.</p><p>For brevity, I've already removed the PersistentVolume manifest declaration.</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pgadmin4-pv-claim</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">manual</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">1Gi</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pgadmin4-dep</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">pgadmin4</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">revisionHistoryLimit:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">pgadmin4</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">pgadmin4</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">pgadmin4-pv-storage</span></span><br><span class="line">          <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">            <span class="attr">claimName:</span> <span class="string">pgadmin4-pv-claim</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">pgadmin4</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">dpage/pgadmin4</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">PGADMIN_DEFAULT_EMAIL</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">"admin@codingwithdave.xyz"</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">PGADMIN_DEFAULT_PASSWORD</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">"P@ssw0rd!"</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">"/var/lib/pgadmin/data"</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">pgadmin4-pv-storage</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># from pgadmin4-svc.yml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pgadmin4-svc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">pgadmin4</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">nodePort:</span> <span class="number">5050</span></span><br></pre></td></tr></table></figure><p>There are a few items that are different as we move to Pulumi because we are using Pulumi for the Azure production (eventually) environment and the operationalization of our stack. We will be using pgAdmin4 (the container, if not the application) to do database backups. The pgAdmin4 container has all of the tooling and settings required to do backups. What we need though is somewhere to put the backups. In this case, we will leverage another feature of <strong>AKS</strong> called azureFile storage provider for <strong>k8s</strong>. This bit of configuration instructs <strong>k8s</strong>, via Azure and <strong>AKS</strong>, to use a storage account file share as a volume in our pod.</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">name: pgAdminAzureVolumeName, <span class="comment">// &lt;-- This is "azure"</span></span><br><span class="line">  azureFile: &#123;</span><br><span class="line">    secretName: azureStorageSecretName,</span><br><span class="line">    shareName: azureFileShareName,</span><br><span class="line">    readOnly: <span class="literal">false</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>Recall that these resources were created in the <strong>AKS</strong> project so we need these values from our other stack configuration.</p><blockquote><p>Eventually, I expect we will move to a managed <a href="https://azure.microsoft.com/en-ca/services/postgresql/" target="_blank" rel="noopener">Azure Database for Postgres</a> SaaS offering, so all of this may eventually disappear. For now, we'll manage it all ourselves.</p></blockquote><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Add pgAdmin4 to AKS Cluster</span></span><br><span class="line"><span class="keyword">const</span> pgAdminLabels = &#123;...&#123; app: <span class="string">"pgAdmin4"</span>, role: <span class="string">"db"</span>&#125;, ...baseBackEndLabels &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> pgadminServiceName = <span class="string">"pgadmin-svc"</span>;</span><br><span class="line"><span class="keyword">const</span> pgAdminService = <span class="keyword">new</span> k8s.core.v1.Service(pgadminServiceName, &#123;</span><br><span class="line">    metadata: &#123;</span><br><span class="line">        name: pgadminServiceName,</span><br><span class="line">        labels: pgAdminLabels,</span><br><span class="line">    &#125;,</span><br><span class="line">    spec: &#123;</span><br><span class="line">        ports: [&#123; port: <span class="number">80</span>, targetPort: <span class="number">80</span>, protocol: <span class="string">"TCP"</span>&#125;],</span><br><span class="line">        selector: pgAdminLabels,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;, &#123;provider: k8sProvider&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> pgAdminAzureVolumeName = <span class="string">"azure"</span>;</span><br><span class="line"><span class="keyword">const</span> pgAdminDepName = <span class="string">"pgadmin-dep"</span>;</span><br><span class="line"><span class="keyword">const</span> pgAdminDeployment = <span class="keyword">new</span> k8s.apps.v1.Deployment(pgAdminDepName, &#123;</span><br><span class="line">    metadata: &#123; name: pgAdminDepName &#125;,</span><br><span class="line">    spec: &#123;</span><br><span class="line">        selector: &#123; matchLabels: pgAdminLabels &#125;,</span><br><span class="line">        replicas: <span class="number">1</span>,</span><br><span class="line">        revisionHistoryLimit: <span class="number">2</span>,</span><br><span class="line">        template: &#123;</span><br><span class="line">            metadata: &#123; labels: pgAdminLabels &#125;,</span><br><span class="line">            spec: &#123;</span><br><span class="line">                containers: [&#123;</span><br><span class="line">                    name: <span class="string">"pgadmin"</span>,</span><br><span class="line">                    image: <span class="string">"dpage/pgadmin4"</span>,</span><br><span class="line">                    resources: &#123;</span><br><span class="line">                        requests: &#123;</span><br><span class="line">                            cpu: <span class="string">"100m"</span>,</span><br><span class="line">                            memory: <span class="string">"150Mi"</span>,</span><br><span class="line">                        &#125;,</span><br><span class="line">                        limits: &#123;</span><br><span class="line">                            memory: <span class="string">"200Mi"</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    ports: [&#123; containerPort: <span class="number">80</span> &#125;],</span><br><span class="line">                    env: [</span><br><span class="line">                        &#123;name: <span class="string">"PGADMIN_DEFAULT_EMAIL"</span>, value: <span class="string">"admin@codingwithdave.xyz"</span>&#125;,</span><br><span class="line">                        &#123;name: <span class="string">"PGADMIN_DEFAULT_PASSWORD"</span>, value: <span class="string">"P@ssw0rd!"</span>&#125;,</span><br><span class="line">                        &#123;name: <span class="string">"POSTGRES_USER"</span>, value: <span class="string">"admin"</span>&#125;,</span><br><span class="line">                        &#123;name: <span class="string">"POSTGRES_PASSWORD"</span>, value: <span class="string">"P@ssw0rd!"</span>&#125;,</span><br><span class="line">                        &#123;name: <span class="string">"POSTGRES_DB"</span>, value: <span class="string">"identity"</span>&#125;</span><br><span class="line">                    ],</span><br><span class="line">                    volumeMounts:[</span><br><span class="line">                        &#123;name: pgAdminAzureVolumeName, mountPath: <span class="string">"/var/lib/pgadmin/azure"</span>&#125;</span><br><span class="line">                    ]</span><br><span class="line">                &#125;],</span><br><span class="line">                volumes: [&#123;</span><br><span class="line">                    name: pgAdminAzureVolumeName,</span><br><span class="line">                    azureFile: &#123;</span><br><span class="line">                        secretName: azureStorageSecretName,</span><br><span class="line">                        shareName: azureFileShareName,</span><br><span class="line">                        readOnly: <span class="literal">false</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;],</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;, &#123;provider: k8sProvider&#125;);</span><br></pre></td></tr></table></figure><p><code>pulumi up</code> will put the pgAdmin4 application/images into our <strong>k8s</strong> cluster. With the given configuration, it will be able to connect to the postgres database.</p><h3>Moving Seq from Manifest to Pulumi</h3><p>The final step (for now) of moving all of our infrastructure/backend components into pulumi is the Seq instance. This will be similar to the postgres instance as it also uses a PersistentVolumeClaim to get an azureDisk attached to the VM for saving our log data.</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">seq-pv-volume</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">local</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">manual</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">3Gi</span></span><br><span class="line">  <span class="attr">hostPath:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/mnt/data/seqv6/</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">seq-pv-claim</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">manual</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">3Gi</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">seq-dep</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">seq</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">revisionHistoryLimit:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">seq</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">seq</span> </span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">seq-pv-storage</span></span><br><span class="line">          <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">            <span class="attr">claimName:</span> <span class="string">seq-pv-claim</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">seq</span> </span><br><span class="line">        <span class="attr">image:</span> <span class="string">datalust/seq:preview</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">"/data"</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">seq-pv-storage</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ACCEPT_EULA</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">"Y"</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># from seq-svc.yml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">seq-svc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">seq</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">nodePort:</span> <span class="number">5341</span></span><br></pre></td></tr></table></figure><p>There are two notable differences in Pulumi Application code that were not in the manifests.</p><p>First of all, we are adding a <a href="https://kubernetes.io/docs/concepts/workloads/pods/pod-overview/" target="_blank" rel="noopener">side-car container</a> to this pod now that we are moving to Azure. This means that there are two containers running in this Pod. They are separate images (applications) but they will share the same network space and be able to access each other at the DNS <strong>localhost</strong> with the appropriate port. The side-car container we are adding is a container image called <a href="https://hub.docker.com/r/datalust/sqelf" target="_blank" rel="noopener">sqelf</a> which is a product produced by <a href="https://www.datalust.co" target="_blank" rel="noopener">datalust.co</a> that allows use to ingest log events in the <code>graylog</code> message format and send them directly into Seq.</p><p>The second change is in the Service description. We need to expose the <strong>sqelf</strong> service on a UDP port so that eventually, <strong>fluentd</strong> will be able to send log event messages, in the <strong>graylog</strong> format, to the <strong>sqelf</strong> container. The <strong>squelf</strong> container then just sends it on to <strong>Seq</strong>. We'll discuss <strong>fluentd</strong> in another article.</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Add Seq to AKS Cluster</span></span><br><span class="line"><span class="keyword">const</span> seqLabels = &#123;...&#123; app: <span class="string">"seq"</span>, role: <span class="string">"logingestion"</span>&#125;, ...baseBackEndLabels&#125;;</span><br><span class="line"><span class="keyword">const</span> seqPersistentVolumeClaim = <span class="keyword">new</span> k8s.core.v1.PersistentVolumeClaim(<span class="string">"seq-pv-claim"</span>,&#123;</span><br><span class="line">    metadata:&#123; name: <span class="string">"seq-pv-claim"</span>&#125;,</span><br><span class="line">    spec: &#123;</span><br><span class="line">        storageClassName: aksStack.getOutput(<span class="string">"storageClassName"</span>),</span><br><span class="line">        accessModes: [<span class="string">"ReadWriteOnce"</span>],</span><br><span class="line">        resources: &#123;</span><br><span class="line">            requests: &#123;</span><br><span class="line">                storage: <span class="string">"32Gi"</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;, &#123;provider: k8sProvider&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> seqServiceName = <span class="string">"seq-svc"</span>;</span><br><span class="line"><span class="keyword">const</span> seqService = <span class="keyword">new</span> k8s.core.v1.Service(seqServiceName, &#123;</span><br><span class="line">    metadata: &#123;</span><br><span class="line">        name: seqServiceName,</span><br><span class="line">        labels: seqLabels,</span><br><span class="line">    &#125;,</span><br><span class="line">    spec: &#123;</span><br><span class="line">        ports: [</span><br><span class="line">            &#123; name: <span class="string">"http-seq"</span>, port: <span class="number">80</span>, targetPort: <span class="number">80</span>, protocol: <span class="string">"TCP"</span>&#125;,</span><br><span class="line">            &#123; name: <span class="string">"udp-sqelf"</span>, port: <span class="number">12201</span>, protocol: <span class="string">"UDP"</span>&#125;],</span><br><span class="line">        selector: seqLabels,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;,&#123;provider: k8sProvider&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> seqDeploymentName = <span class="string">"seq-dep"</span>;</span><br><span class="line"><span class="keyword">const</span> seqDeployment = <span class="keyword">new</span> k8s.apps.v1.Deployment(seqDeploymentName, &#123;</span><br><span class="line">    metadata: &#123; name: seqDeploymentName &#125;,</span><br><span class="line">    spec: &#123;</span><br><span class="line">        selector: &#123; matchLabels: seqLabels &#125;,</span><br><span class="line">        replicas: <span class="number">1</span>,</span><br><span class="line">        revisionHistoryLimit: <span class="number">2</span>,</span><br><span class="line">        template: &#123;</span><br><span class="line">            metadata: &#123; labels: seqLabels &#125;,</span><br><span class="line">            spec: &#123;</span><br><span class="line">                volumes: [&#123;</span><br><span class="line">                    name: <span class="string">"seq-pv-storage"</span>,</span><br><span class="line">                    persistentVolumeClaim: &#123;</span><br><span class="line">                        claimName: <span class="string">"seq-pv-claim"</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;],</span><br><span class="line">                containers: [&#123;</span><br><span class="line">                    name: <span class="string">"seq"</span>,</span><br><span class="line">                    image: <span class="string">"datalust/seq:preview"</span>,</span><br><span class="line">                    resources: &#123;</span><br><span class="line">                        requests: &#123;</span><br><span class="line">                            cpu: <span class="string">"100m"</span>,</span><br><span class="line">                            memory: <span class="string">"500Mi"</span>,</span><br><span class="line">                        &#125;,</span><br><span class="line">                        limits:&#123;</span><br><span class="line">                            memory: <span class="string">"1000Mi"</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    ports: [&#123; containerPort: <span class="number">80</span>, protocol: <span class="string">"TCP"</span> &#125;],</span><br><span class="line">                    volumeMounts: [&#123;</span><br><span class="line">                        mountPath: <span class="string">"/data"</span>,</span><br><span class="line">                        name: <span class="string">"seq-pv-storage"</span></span><br><span class="line">                    &#125;],</span><br><span class="line">                    env: [&#123;name: <span class="string">"ACCEPT_EULA"</span>, value: <span class="string">"Y"</span>&#125;]</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    name: <span class="string">"sqelf"</span>,</span><br><span class="line">                    image: <span class="string">"datalust/sqelf"</span>,</span><br><span class="line">                    resources: &#123;</span><br><span class="line">                        requests: &#123;</span><br><span class="line">                            cpu: <span class="string">"100m"</span>,</span><br><span class="line">                            memory: <span class="string">"100Mi"</span>,</span><br><span class="line">                        &#125;,</span><br><span class="line">                    &#125;,</span><br><span class="line">                    ports: [&#123;containerPort: <span class="number">12201</span>, protocol: <span class="string">"UDP"</span>&#125;],</span><br><span class="line">                    env: [</span><br><span class="line">                        &#123;name: <span class="string">"ACCEPT_EULA"</span>, value: <span class="string">"Y"</span>&#125;,</span><br><span class="line">                        &#123;name: <span class="string">"SEQ_ADDRESS"</span>, value: <span class="string">"http://localhost:80"</span>&#125;</span><br><span class="line">                    ]</span><br><span class="line">                &#125;</span><br><span class="line">            ],</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;, &#123;provider: k8sProvider&#125;);</span><br></pre></td></tr></table></figure><p><code>pulumi up</code> will get the Seq pod up and running, with 2 containers, in our <strong>k8s</strong> infrastructure.</p><h3>Moving IdentityServer4 from Manifest to Pulumi</h3><p>The final bit of work to get our platform moved from <strong>minikube</strong> to <strong>AKS</strong> is to move our applications. There is nothing terribly special or noteworthy from a container perspective in this mapping. None of these pods need durable storage. The only difference with these pods is that they indicate that they want to use <strong>docker-credentials</strong> secret to access the private ACR.</p><p>There is a particularly important difference for our application when it comes to networking and accessing our applications. Our <strong>k8s</strong> has a public IP address and all of our applications will eventually be accessed via a unique DNS entry, not a shared DNS entry with different ports. I imagine you could use the shared DNS/multiple ports approach, but I did not. I don't think it helps human beings understand what they are using or working on to hide the intention behind a port abstraction. So, we will give everything its own URL.</p><p>This has consequences on our initial database seed data. Once this is all deployed, we will have to go into pgAdmin4 and run a script to update our configuration. Otherwise, the authentication system won't work. The Admin needs to be able <em>and allowed</em> to access the STS from its hostname location so we'll need to change the STS seed data. We're also going to change the configuration that is stored in the environmental variables which are appsettings.json overrides.</p><h4>STS</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">identity-sts-dep</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">identity-sts</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">revisionHistoryLimit:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">identity-sts</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">identity-sts</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">identity-sts</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">depthconsulting.azurecr.io/skoruba-identityserver4-sts-identity:latest</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ASPNETCORE_ENVIRONMENT</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">"Development"</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SEQ_URL</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">"http://seq-svc"</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ConnectionStrings__ConfigurationDbConnection</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">"User ID=admin;Password=P@ssw0rd!;Host=postgres-svc;Port=5432;Database=identity;Pooling=true;"</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ConnectionStrings__PersistedGrantDbConnection</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">"User ID=admin;Password=P@ssw0rd!;Host=postgres-svc;Port=5432;Database=identity;Pooling=true;"</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ConnectionStrings__IdentityDbConnection</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">"User ID=admin;Password=P@ssw0rd!;Host=postgres-svc;Port=5432;Database=identity;Pooling=true;"</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">AdminConfiguration__IdentityAdminBaseUrl</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">http://127.0.0.1.xip.io:9000</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ASPNETCORE_URLS</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">"http://+:80"</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">imagePullSecrets:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">docker-credentials</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># from identity-sts-svc.yml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">identity-sts-svc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">identity-sts</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">nodePort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure><p>I'm so glad that Pulumi is a programatic IaC model. One thing I can do here before we get to far along is move my DB connection strings (and the list) into variables and then use them where needed.</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> dbConnectionString = <span class="string">"Server=postgres-svc; User Id=admin; Database=identity; Port=5432; Password=P@ssw0rd!; SSL Mode=Prefer; Trust Server Certificate=true;"</span>;</span><br><span class="line"><span class="keyword">const</span> dbConnectionStringList = [</span><br><span class="line">    &#123;name: <span class="string">"ConnectionStrings__ConfigurationDbConnection"</span>, value: dbConnectionString&#125;,</span><br><span class="line">    &#123;name: <span class="string">"ConnectionStrings__PersistedGrantDbConnection"</span>, value: dbConnectionString&#125;,</span><br><span class="line">    &#123;name: <span class="string">"ConnectionStrings__IdentityDbConnection"</span>, value: dbConnectionString&#125;,</span><br><span class="line">    &#123;name: <span class="string">"ConnectionStrings__AdminLogDbConnection"</span>, value: dbConnectionString&#125;,</span><br><span class="line">    &#123;name: <span class="string">"ConnectionStrings__AdminAuditLogDbConnection"</span>, value: dbConnectionString&#125;</span><br><span class="line">];</span><br></pre></td></tr></table></figure><p>Now to code the STS provisioning.</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Add Identity STS Service to AKS Cluster</span></span><br><span class="line"><span class="keyword">const</span> stsLabels = &#123;...&#123; app: <span class="string">"identity-sts"</span>, role: <span class="string">"authentication"</span>&#125;, ...baseApplicationGroupLabels&#125;;</span><br><span class="line"><span class="keyword">const</span> stsDepName = <span class="string">"identity-sts-dep"</span>;</span><br><span class="line"><span class="keyword">const</span> stsDeployment = <span class="keyword">new</span> k8s.apps.v1.Deployment(stsDepName, &#123;</span><br><span class="line">    metadata: &#123; </span><br><span class="line">        name: stsDepName,</span><br><span class="line">        labels: stsLabels</span><br><span class="line">    &#125;,</span><br><span class="line">    spec: &#123;</span><br><span class="line">        selector: &#123; matchLabels: &#123;app: <span class="string">"identity-sts"</span>&#125; &#125;,</span><br><span class="line">        replicas: <span class="number">1</span>,</span><br><span class="line">        revisionHistoryLimit: <span class="number">2</span>,</span><br><span class="line">        template: &#123;</span><br><span class="line">            metadata: &#123; labels: stsLabels &#125;,</span><br><span class="line">            spec: &#123;</span><br><span class="line">                containers: [&#123;</span><br><span class="line">                    name: <span class="string">"identity-sts"</span>,</span><br><span class="line">                    image: <span class="string">"depthconsulting.azurecr.io/skoruba-identityserver4-sts-identity:latest"</span>,</span><br><span class="line">                    resources: &#123;</span><br><span class="line">                        requests: &#123;</span><br><span class="line">                            cpu: <span class="string">"100m"</span>,</span><br><span class="line">                            memory: <span class="string">"200Mi"</span>,</span><br><span class="line">                        &#125;,</span><br><span class="line">                        limits:&#123;</span><br><span class="line">                            memory: <span class="string">"300Mi"</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    ports: [&#123; containerPort: <span class="number">80</span>, protocol: <span class="string">"TCP"</span> &#125;],</span><br><span class="line">                    env: [</span><br><span class="line">                        &#123;name: <span class="string">"ASPNETCORE_ENVIRONMENT"</span>, value: <span class="string">"Development"</span>&#125;,</span><br><span class="line">                        &#123;name: <span class="string">"SEQ_URL"</span>, value: <span class="string">"http://seq-svc:5341"</span>&#125;,</span><br><span class="line">                        &#123;name: <span class="string">"AdminConfiguration__IdentityAdminBaseUrl"</span>, value: <span class="string">"https://auth-admin.codingwithdave.xyz"</span>&#125;,</span><br><span class="line">                        &#123;name: <span class="string">"ASPNETCORE_URLS"</span>, value: <span class="string">"http://+:80"</span>&#125;</span><br><span class="line">                    ].concat(dbConnectionStringList)</span><br><span class="line">                &#125;],</span><br><span class="line">                imagePullSecrets: [&#123;name: acrSecretName &#125;]</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;, &#123;provider: k8sProvider&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> stsServiceName = <span class="string">"identity-sts-svc"</span>;</span><br><span class="line"><span class="keyword">const</span> stsService = <span class="keyword">new</span> k8s.core.v1.Service(stsServiceName, &#123;</span><br><span class="line">    metadata: &#123;</span><br><span class="line">        name: stsServiceName,</span><br><span class="line">        labels: &#123;app: <span class="string">"identity-sts"</span>&#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    spec: &#123;</span><br><span class="line">        ports: [</span><br><span class="line">            &#123; name: <span class="string">"http"</span>, port: <span class="number">80</span>, targetPort: <span class="number">80</span>, protocol: <span class="string">"TCP"</span>&#125;</span><br><span class="line">        ],</span><br><span class="line">        selector: &#123;app: <span class="string">"identity-sts"</span>&#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;,&#123;provider: k8sProvider&#125;);</span><br></pre></td></tr></table></figure><h4>IdentityServer4 Admin</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">identity-admin-dep</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">identity-admin</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">revisionHistoryLimit:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">identity-admin</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">identity-admin</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">identity-admin</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">depthconsulting.azurecr.io/skoruba-identityserver4-admin:latest</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ASPNETCORE_ENVIRONMENT</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">"Development"</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SEQ_URL</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">"http://seq-svc"</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ConnectionStrings__ConfigurationDbConnection</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">"User ID=admin;Password=P@ssw0rd!;Host=postgres-svc;Port=5432;Database=identity;Pooling=true;"</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ConnectionStrings__PersistedGrantDbConnection</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">"User ID=admin;Password=P@ssw0rd!;Host=postgres-svc;Port=5432;Database=identity;Pooling=true;"</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ConnectionStrings__IdentityDbConnection</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">"User ID=admin;Password=P@ssw0rd!;Host=postgres-svc;Port=5432;Database=identity;Pooling=true;"</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ConnectionStrings__AdminLogDbConnection</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">"User ID=admin;Password=P@ssw0rd!;Host=postgres-svc;Port=5432;Database=identity;Pooling=true;"</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ConnectionStrings__AdminAuditLogDbConnection</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">"User ID=admin;Password=P@ssw0rd!;Host=postgres-svc;Port=5432;Database=identity;Pooling=true;"</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">AdminConfiguration__IdentityServerBaseUrl</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">http://127.0.0.1.xip.io</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">AdminConfiguration__IdentityAdminRedirectUri</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">http://127.0.0.1.xip.io:9000/signin-oidc</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ASPNETCORE_URLS</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">"http://+:80"</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">imagePullSecrets:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">docker-credentials</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># from identity-admin-svc.yml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">identity-admin-svc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">identity-admin</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">nodePort:</span> <span class="number">9000</span></span><br></pre></td></tr></table></figure><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Add Auth Admin Application to AKS Cluster</span></span><br><span class="line"><span class="keyword">const</span> adminLabels = &#123;...&#123; app: <span class="string">"identity-admin"</span>, role: <span class="string">"authentication"</span>&#125;, ...baseApplicationGroupLabels&#125;;</span><br><span class="line"><span class="keyword">const</span> adminDepName = <span class="string">"identity-admin-dep"</span>;</span><br><span class="line"><span class="keyword">const</span> adminDeployment = <span class="keyword">new</span> k8s.apps.v1.Deployment(adminDepName, &#123;</span><br><span class="line">    metadata: &#123;</span><br><span class="line">        name: adminDepName,</span><br><span class="line">        labels: adminLabels</span><br><span class="line">    &#125;,</span><br><span class="line">    spec: &#123;</span><br><span class="line">        selector: &#123; matchLabels: &#123;app: <span class="string">"identity-admin"</span>&#125; &#125;,</span><br><span class="line">        replicas: <span class="number">1</span>,</span><br><span class="line">        revisionHistoryLimit: <span class="number">2</span>,</span><br><span class="line">        template: &#123;</span><br><span class="line">            metadata: &#123; labels: adminLabels &#125;,</span><br><span class="line">            spec: &#123;</span><br><span class="line">                containers: [&#123;</span><br><span class="line">                    name: <span class="string">"identity-admin"</span>,</span><br><span class="line">                    image: <span class="string">"depthconsulting.azurecr.io/skoruba-identityserver4-admin:latest"</span>,</span><br><span class="line">                    resources: &#123;</span><br><span class="line">                        requests: &#123;</span><br><span class="line">                            cpu: <span class="string">"100m"</span>,</span><br><span class="line">                            memory: <span class="string">"200Mi"</span>,</span><br><span class="line">                        &#125;,</span><br><span class="line">                        limits:&#123;</span><br><span class="line">                            memory: <span class="string">"300Mi"</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    ports: [&#123; containerPort: <span class="number">80</span>, protocol: <span class="string">"TCP"</span> &#125;],</span><br><span class="line">                    env: [</span><br><span class="line">                        &#123;name: <span class="string">"ASPNETCORE_ENVIRONMENT"</span>, value: <span class="string">"Development"</span>&#125;,</span><br><span class="line">                        &#123;name: <span class="string">"SEQ_URL"</span>, value: <span class="string">"http://seq-svc:5341"</span>&#125;,</span><br><span class="line">                        &#123;name: <span class="string">"AdminConfiguration__IdentityServerBaseUrl"</span>, value: <span class="string">"https://auth.codingwithdave.xyz"</span>&#125;,</span><br><span class="line">                        &#123;name: <span class="string">"AdminConfiguration__IdentityAdminRedirectUri"</span>, value: <span class="string">"https://auth-admin.codingwithdave.xyz/signin-oidc"</span>&#125;,</span><br><span class="line">                        &#123;name: <span class="string">"AdminConfiguration__RequireHttpsMetadata"</span>, value: <span class="string">"true"</span>&#125;,</span><br><span class="line">                        &#123;name: <span class="string">"ASPNETCORE_URLS"</span>, value: <span class="string">"http://+:80"</span>&#125;</span><br><span class="line">                    ].concat(dbConnectionStringList)</span><br><span class="line">                &#125;],</span><br><span class="line">                imagePullSecrets: [&#123;name: acrSecretName &#125;]</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;, &#123;provider: k8sProvider&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> adminServiceName = <span class="string">"identity-admin-svc"</span>;</span><br><span class="line"><span class="keyword">const</span> adminService = <span class="keyword">new</span> k8s.core.v1.Service(adminServiceName, &#123;</span><br><span class="line">    metadata: &#123;</span><br><span class="line">        name: adminServiceName,</span><br><span class="line">        labels: &#123;app: <span class="string">"identity-admin"</span>&#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    spec: &#123;</span><br><span class="line">        ports: [&#123; port: <span class="number">80</span>, targetPort: <span class="number">80</span>, protocol: <span class="string">"TCP"</span>&#125;],</span><br><span class="line">        selector: &#123;app: <span class="string">"identity-admin"</span>&#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;,&#123;provider: k8sProvider&#125;);</span><br></pre></td></tr></table></figure><h4>IdentityServer4 Admin API</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">identity-admin-api-dep</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">identity-admin-api</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">revisionHistoryLimit:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">identity-admin-api</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">identity-admin-api</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">identity-admin-api</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">depthconsulting.azurecr.io/skoruba-identityserver4-admin-api:latest</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ASPNETCORE_ENVIRONMENT</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">"Development"</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SEQ_URL</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">"http://seq-svc"</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ConnectionStrings__ConfigurationDbConnection</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">"User ID=admin;Password=P@ssw0rd!;Host=postgres-svc;Port=5432;Database=identity;Pooling=true;"</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ConnectionStrings__PersistedGrantDbConnection</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">"User ID=admin;Password=P@ssw0rd!;Host=postgres-svc;Port=5432;Database=identity;Pooling=true;"</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ConnectionStrings__IdentityDbConnection</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">"User ID=admin;Password=P@ssw0rd!;Host=postgres-svc;Port=5432;Database=identity;Pooling=true;"</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ConnectionStrings__AdminLogDbConnection</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">"User ID=admin;Password=P@ssw0rd!;Host=postgres-svc;Port=5432;Database=identity;Pooling=true;"</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ConnectionStrings__AdminAuditLogDbConnection</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">"User ID=admin;Password=P@ssw0rd!;Host=postgres-svc;Port=5432;Database=identity;Pooling=true;"</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">AdminApiConfiguration__IdentityServerBaseUrl</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">http://127.0.0.1.xip.io</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">AdminApiConfiguration__ApiBaseUrl</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">http://127.0.0.1.xip.io:5000</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ASPNETCORE_URLS</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">"http://+:80"</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">imagePullSecrets:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">docker-credentials</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># from identity-adminapi-svc.yml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span>  <span class="string">identity-admin-api-svc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span>  <span class="string">identity-admin-api</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">nodePort:</span> <span class="number">5000</span></span><br></pre></td></tr></table></figure><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Add Auth Admin API to AKS Cluster</span></span><br><span class="line"><span class="keyword">const</span> adminApiLabels = &#123;...&#123; app: <span class="string">"identity-admin-api"</span>, role: <span class="string">"authentication"</span>&#125;, ...baseApplicationGroupLabels&#125;;</span><br><span class="line"><span class="keyword">const</span> adminApiDepName = <span class="string">"identity-admin-api-dep"</span>;</span><br><span class="line"><span class="keyword">const</span> adminApiDeployment = <span class="keyword">new</span> k8s.apps.v1.Deployment(adminApiDepName, &#123;</span><br><span class="line">    metadata: &#123; </span><br><span class="line">      name: adminApiDepName,</span><br><span class="line">      labels: adminApiLabels</span><br><span class="line">    &#125;,</span><br><span class="line">    spec: &#123;</span><br><span class="line">        selector: &#123; matchLabels: &#123;app: <span class="string">"identity-admin-api"</span>&#125; &#125;,</span><br><span class="line">        replicas: <span class="number">1</span>,</span><br><span class="line">        revisionHistoryLimit: <span class="number">2</span>,</span><br><span class="line">        template: &#123;</span><br><span class="line">            metadata: &#123; labels: adminApiLabels &#125;,</span><br><span class="line">            spec: &#123;</span><br><span class="line">                containers: [&#123;</span><br><span class="line">                    name: <span class="string">"identity-admin-api"</span>,</span><br><span class="line">                    image: <span class="string">"depthconsulting.azurecr.io/skoruba-identityserver4-admin-api:latest"</span>,</span><br><span class="line">                    resources: &#123;</span><br><span class="line">                        requests: &#123;</span><br><span class="line">                            cpu: <span class="string">"100m"</span>,</span><br><span class="line">                            memory: <span class="string">"200Mi"</span>,</span><br><span class="line">                        &#125;,</span><br><span class="line">                        limits:&#123;</span><br><span class="line">                            memory: <span class="string">"300Mi"</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    ports: [&#123; containerPort: <span class="number">80</span>, protocol: <span class="string">"TCP"</span> &#125;],</span><br><span class="line">                    env: [</span><br><span class="line">                        &#123;name: <span class="string">"ASPNETCORE_ENVIRONMENT"</span>, value: <span class="string">"Development"</span>&#125;,</span><br><span class="line">                        &#123;name: <span class="string">"SEQ_URL"</span>, value: <span class="string">"http://seq-svc:5341"</span>&#125;,</span><br><span class="line">                        &#123;name: <span class="string">"AdminApiConfiguration__IdentityServerBaseUrl"</span>, value: <span class="string">"https://auth.codingwithdave.xyz"</span>&#125;,</span><br><span class="line">                        &#123;name: <span class="string">"AdminApiConfiguration__ApiBaseUrl"</span>, value: <span class="string">"https://auth-admin-api.codingwithdave.xyz"</span>&#125;,</span><br><span class="line">                        &#123;name: <span class="string">"ASPNETCORE_URLS"</span>, value: <span class="string">"http://+:80"</span>&#125;</span><br><span class="line">                    ].concat(dbConnectionStringList)</span><br><span class="line">                &#125;],</span><br><span class="line">                imagePullSecrets: [&#123;name: acrSecretName &#125;]</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;, &#123;provider: k8sProvider&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> adminApiServiceName = <span class="string">"identity-admin-api-svc"</span>;</span><br><span class="line"><span class="keyword">const</span> adminApiService = <span class="keyword">new</span> k8s.core.v1.Service(adminApiServiceName, &#123;</span><br><span class="line">    metadata: &#123;</span><br><span class="line">        name: adminApiServiceName,</span><br><span class="line">        labels: &#123;app: <span class="string">"identity-admin-api"</span>&#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    spec: &#123;</span><br><span class="line">        ports: [&#123; port: <span class="number">80</span>, targetPort: <span class="number">80</span>, protocol: <span class="string">"TCP"</span>&#125;],</span><br><span class="line">        selector: &#123;app: <span class="string">"identity-admin-api"</span>&#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;,&#123;provider: k8sProvider&#125;);</span><br></pre></td></tr></table></figure><p><code>pulumi up</code> will push all of your applications up into <strong>AKS</strong>.</p><h3>Verify all the Pods are Up and Running</h3><p>With our last <code>pulumi up</code> we should have all of our <strong>AKS</strong> infrastructure up and hosting our <strong>k8s</strong> cluster, and we should have all of our applications/services/resources from our second pulumi stack in the <strong>k8s</strong> cluster. We should now be able to go into a one of our tools and verify that the apps are running.</p><p>If you used the pulumi application in our previous post, you should have a <strong>az aks get-credentials ...</strong> in your pulumi output for that stack. It should look something like this:</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">az aks <span class="built_in">get-credentials</span> -<span class="literal">-resource</span><span class="literal">-group</span> rg_identity_dev_zwus_aks `</span><br><span class="line">-<span class="literal">-name</span> aksclusterfbfa950e -<span class="literal">-context</span> <span class="string">"MyProject.Identity"</span></span><br></pre></td></tr></table></figure><p>You can run that command, with your specific values, and have the <strong>azure-cli</strong> append this <strong>k8s</strong> context details into your kubeConfig file. Once that is done, we can type <code>octant</code> on the command line and look at our pods.</p><p>Using <strong>octant</strong> (v0.12.1), we can see that all of our pods are present in the cluster.</p><img src="/images/dwhite/octant-azure-pods-running.png" alt="Pods running in Azure" height="250px"><p>We will click into the <strong>pgAdmin4</strong> pod as an example in the article, but you should eventually click into all of the pods to ensure they are functioning.</p><p>Looking at the pgAdmin4 pod, we can see that it is initialized and ready! If we go down a bit further, we'll see the port forward functionality of <strong>octant</strong> waiting for us to press the button.</p><img src="/images/dwhite/octant-azure-pgadmin-portforward.png" alt="PortForward function in Octant" height="250px"><p>Once we press the button, we'll see that we now have an option to navigate to the port-forward URL.</p><img src="/images/dwhite/octant-azure-pgadmin-portforward-started.png" alt="PortForward to pgAdmin4 started" height="100px"><p>When we click on that link, you'll see the pgAdmin4 log in screen and once you log in, you should be able to create a server entry in our list to our postgres pod. The <strong>k8s</strong> network DNS name for our postgres pod should be <strong>postgres-svc</strong> from our Service resource. Once the entry is connected, we should be able to see our postgres database!</p><img src="/images/dwhite/octant-azure-pgadmin-running.png" alt="pgAdmin4 running" height="250px"><p>You should work your way through all of the pods. They should all be up and running. The whole authentication/authorization system won't be working yet. We'll wait until the next article to fix that up and test it out.</p><h4>Problems</h4><p>When you have problems in <strong>k8s</strong>, you have to start looking in two places. First, you have to look in the logs. <strong>octant</strong> has a nice screen for looking at the log files directly on a pod. Remember, we don't have log ingestion and tooling setup for the <strong>k8s</strong> cluster yet, so we have to go look in the pods themselves. Here you can see pgAdmin4 running just fine, but if it wasn't working, you'll find clues as to why here.</p><img src="/images/dwhite/octant-azure-pgadmin-log.png" alt="pgAdmin4 logs in the pod" height="250px"><p>Once we have all of our log ingestion infrastructure in place, we will be able to go to Seq to look log entries across the cluster, but you should always be ready to go look directly in the pods for the log entries.</p><p>And the other place you will probably want to inspect is the running pod itself. You can use the <strong>terminal</strong> tab in <strong>octant</strong> to look at various settings in your pod.</p><img src="/images/dwhite/octant-azure-pgadmin-terminal.png" alt="pgAdmin4 terminal window" height="250px"><h3>Not Quite Done Yet</h3><p>This article is going to end in a bit of a &quot;not quite working as I'd like&quot; state. All of the pods are up and running, but our IdentityServer4 needs some configuration changes in order to work. And in order to do that, we need to be able to access our <strong>k8s</strong> publicly, give it a DNS entry (hostname), and then configure our IdentityServer4 system to allow those hostnames to interact with the STS.</p><p>Our next stop will be adding an Ingress Controller to our <strong>k8s</strong> cluster and getting all of these services publicly available.</p><p><strong>Next up:</strong><a href="/kubernetes/kubernetes-my-journey-part-8">Making Your Kubernetes Cluster Publicly Accessible</a></p><style>    h1, h2, h3, h4, h5, h6 {       margin-top: 25px;    }    img {       margin: 25px 0px;    }    figure.highlight{        background-color: #E8EEFE;    }    figure.highlight .gutter{        color: #0033CD;    }    figure.highlight pre {        font-family: 'Cascadia Code PL', monospace;    }    code {        font-family: 'Cascadia Code PL', sans-serif;        border-width: 0.1em;        border-color: #E8EEFE;        border-style: solid;        border-radius: 0.3em;        background-color: #E8EEFE;        color: #0033CD;        padding: 0em 0.4em;        white-space: nowrap;    }</style><link  href="https://cdnjs.cloudflare.com/ajax/libs/viewerjs/1.5.0/viewer.min.css" rel="stylesheet"><script src="https://cdnjs.cloudflare.com/ajax/libs/viewerjs/1.5.0/viewer.min.js"></script><script>// View an imageconst gallery = new Viewer(document.getElementById('mainPostContent', {    "navbar": false,    "toolbar": false}));</script>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;a href=&quot;/kubernetes/kubernetes-my-journey&quot;&gt;Series Table of Contents&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Previously:&lt;/strong&gt;
&lt;a href=&quot;/kubernetes/kuberne
    
    </summary>
    
      <category term="kubernetes" scheme="https://westerndevs.com/categories/kubernetes/"/>
    
    
      <category term="kubernetes, azure, aks, identityserver, docker, containers" scheme="https://westerndevs.com/tags/kubernetes-azure-aks-identityserver-docker-containers/"/>
    
  </entry>
  
  <entry>
    <title type="html">Kubernetes - My Journey - Part 8</title>
    <link href="https://westerndevs.com/kubernetes/kubernetes-my-journey-part-8/" rel="alternate" type="text/html"/>
    <id>https://westerndevs.com/kubernetes/kubernetes-my-journey-part-8/</id>
    <published>2020-05-22T07:00:00.000Z</published>
    <updated>2020-11-09T21:27:02.250Z</updated>
	<author>
	
	  
	  <name>Dave White</name>
	  <email>dmhwhite@gmail.com</email>
	
	  <uri>https://westerndevs.com</uri>
	</author>
    
    <content type="html"><![CDATA[<p><a href="/kubernetes/kubernetes-my-journey">Series Table of Contents</a></p><p><strong>Previously:</strong><a href="/kubernetes/kubernetes-my-journey-part-7b">Moving to Azure Kubernetes Service - Part B</a></p><h1>Making Your Kubernetes Cluster Publicly Accessible</h1><p>Hopefully you've arrived at this article with two Pulumi applications that you can use to create an <strong>Azure Kubernetes Service</strong>-based Kubernetes (<strong>k8s</strong>) cluster with a collection of <strong>k8s</strong> resources (container images) inside of it that all function together to provide a <strong>IdentityServer4</strong> based authentication system. If not, you should probably <a href="/kubernetes/kubernetes-my-journey">go back and re-read those articles</a> since we're going to build off of that effort in this article.</p><p>In this article, we're going to go through the process of making our <strong>k8s</strong> cluster publicly accessible with proper DNS entries (hostname) so that the authentication system can be configured and works properly.</p><h2>Pre-requisites</h2><p>Up until now, I've done my best to ensure you can do as much as possible on your developer machine with minimal financial requirements. From this point forward, I will be assuming that you have a <strong>custom domain</strong> that you can use for your configuration. On my part, I will be using the <strong>codingwithdave.xyz</strong> domain for the remainder of the articles.</p><h2>Daily Ritual</h2><p>I want to share a side-note about one of my processes.</p><p>One thing I really appreciate about my infrastructure automation while I'm doing all of this development and writing is the ability to stand up and tear down the <strong>k8s</strong> cluster every day. I start my day by doing a <code>pulumi up</code> command and it stands up all the cluster. I do another <code>pulumi up</code> and it puts all of the applications in the cluster. And at the end of the day, I reverse my start of day activities by doing a <code>pulumi destroy</code> on the resources and then a <code>pulumi destroy</code> on the cluster itself. I do this for two reasons. First, it saves money. This cluster only runs when I'm working on this article or doing some <strong>k8s</strong> research and then it goes away. This is a great benefit for a development process. Second, it forces me to make sure that my automation is working at the beginning and end of each day.</p><p>Standing up the <strong>k8s</strong> cluster daily makes this <code>get-credentials</code> command a nice output that we capture in Pulumi. This is generated in the Pulumi application that stands up the <strong>aks</strong> services. All of my <strong>k8s</strong> development tooling uses this set of credentials.</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">az aks <span class="built_in">get-credentials</span> -<span class="literal">-resource</span><span class="literal">-group</span> rg_identity_dev_zwus_aks -<span class="literal">-name</span> akscluster5b1237c2 -<span class="literal">-context</span> <span class="string">"MyProject.Identity"</span></span><br></pre></td></tr></table></figure><p>This command changes daily, so having this change captured in standing up the infrastructure so I can just go to my Pulumi service to pull it out and use it, is certainly helpful. Hey <strong>@Pulumi</strong> if you are reading, I'd love a <a href="https://github.com/pulumi/pulumi/issues/4623" target="_blank" rel="noopener">copy-to-clipboard-button beside my Outputs in the service page for my stacks!</a></p><blockquote><p>Consider rate limited activities like Let's Encrypt when standing-up and tearing down resources.</p></blockquote><h2>Ingress and Ingress Controllers</h2><p>A <strong>k8s</strong> cluster, kind of by default, is a closed system. You can access it administratively which is certainly dangerous, but unless you make conscious decisions about how and when to expose <em>your</em> services, only the cluster services themselves are exposed so that tools like <strong>kubectl</strong> can work. There are a number of mechanisms for exposing your services but in this article, we are going to discuss the Ingress resource and the IngressController resource as the means by which we expose services in our cluster to the public.</p><h2>Ingress Controllers</h2><p>In order to expose the IdentityServer4 services, my first step was to create an <a href="https://kubernetes.io/docs/concepts/services-networking/ingress-controllers/" target="_blank" rel="noopener">IngressController resource</a>. An IngressController is something that you put into your <strong>k8s</strong> cluster that will watch for <strong>Ingress</strong> resources, interpret them,  create the appropriate external resources for your cluster to interact with the outside, and then route all traffic that comes in through your ingress point to the appropriate services inside of your cluster.</p><p>There are many IngressController implementations that you can use, and if you find that you don't like one after a bit of use, it isn't terribly hard to change to another one. There are certainly considerations to make when picking on, but for me, honestly, it was originally ease of getting it working, so I choose the <a href="https://kubernetes.github.io/ingress-nginx/" target="_blank" rel="noopener">nginx IngressController</a>. There are many examples of how to put this controller into your <strong>k8s</strong> cluster and how to create the Ingress rules that <strong>nginx</strong> will follow.</p><p>For the IngressController, there is no manifest. I didn't put one into the minikube instance. So we'll only have Pulumi code for this part of the journey.</p><h3>Deploying nginx Ingress Controller</h3><p>Up until now, we've mostly been dealing with single-container resources. A self-contained application that for the most part can provide it's own bit of functionality. Arguably, the IdentityServer4 group of containers should always be deployed together, but I haven't set that up yet. The way that you do that in <strong>k8s</strong> is by using <a href="https://helm.sh/" target="_blank" rel="noopener">Helm</a>, basically a package manager for your <strong>k8s</strong> resources. Eventually, I will figure out how to author a Helm package, but for the time being, I'm just going to use them.</p><p>Installing Helm is very easy. In our case, on Windows, we can use <strong>chocolatey</strong> to install it.</p><p><code>choco install kubernetes-helm</code></p><p><a href="https://helm.sh/docs/intro/quickstart/" target="_blank" rel="noopener">This documentation</a> has more detailed instructions.</p><p>Once you have Helm installed, Pulumi is capable of using it to push Helm charts into your <strong>k8s</strong> cluster.</p><p>To give you a sense of what a Helm chart will do to your cluster, you can see that when we ask Pulumi to put a Helm chart into the cluster, a lot of things actually happen.</p><img id="image" src="/images/dwhite/helm-nginx-resources.png" alt="All the nginx resources"><p>Let's take a look at the pulumi typescript code required to install this Helm chart.</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Deploy ingress-controller using helm to AKS Cluster</span></span><br><span class="line"><span class="keyword">const</span> nginxIngress = <span class="keyword">new</span> k8s.helm.v3.Chart(<span class="string">"nginx"</span>, &#123;</span><br><span class="line">    chart: <span class="string">"nginx-ingress-controller"</span>,</span><br><span class="line">    <span class="keyword">namespace</span>: <span class="string">"kube-system"</span>,</span><br><span class="line">    repo: <span class="string">"bitnami"</span>,</span><br><span class="line">    values: &#123;</span><br><span class="line">      service: &#123;</span><br><span class="line">        annotations: &#123;</span><br><span class="line">            <span class="string">"service.beta.kubernetes.io/azure-dns-label-name"</span>: aksStack.getOutput(<span class="string">"k8sDnsName"</span>),</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">      resources: &#123; requests : &#123;memory: <span class="string">"150Mi"</span>, cpu: <span class="string">"100m"</span>&#125;&#125;,</span><br><span class="line">      serviceType: <span class="string">"LoadBalancer"</span>,</span><br><span class="line">      nodeCount: <span class="number">1</span>,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;, &#123;provider: k8sProvider &#125;);</span><br></pre></td></tr></table></figure><p>Most of the parameters in the <strong>ChartOpts</strong> parameter of the object we created are easy to understand.</p><ul><li><strong>chart</strong> - The chart we want to install</li><li><strong>namespace</strong> - The namespace that we are going to put this chart into</li><li><strong>repo</strong> - The Helm repository to get the chart from</li></ul><p>After that, we get into some options parameters that are a bit harder to deduce and I had to dig a bit into how Helm works to understand them and what Pulumi needed in order to make this work.</p><p>In our options we have created a <strong>values</strong> object that has additional properties. The <strong>values</strong> object is how we pass configurable values into Helm. This is comparable to the <strong>values.yaml</strong> in the chart definition. There are <a href="https://helm.sh/docs/chart_template_guide/values_files/" target="_blank" rel="noopener">a number of different ways</a> to pass in these values when using Helm charts directly, but this is how Pulumi provides these values to Helm.</p><blockquote><p>When trying to figure out what Helm chart options are available, it can be helpful to look at the default <strong>values.yaml</strong> in a chart's definition. <a href="https://github.com/kubernetes/ingress-nginx/blob/master/charts/ingress-nginx/values.yaml" target="_blank" rel="noopener">Here is the Nginx Ingress Controller Charts default values.yaml file</a>.</p></blockquote><p>There are a couple simple parameters in our values object.</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">resources: &#123; requests : &#123;memory: <span class="string">"150Mi"</span>, cpu: <span class="string">"100m"</span>&#125;&#125;,</span><br><span class="line">serviceType: <span class="string">"LoadBalancer"</span>,</span><br><span class="line">nodeCount: <span class="number">1</span>,</span><br></pre></td></tr></table></figure><p>This are parameters that are for the <strong>kubernetes</strong> resource for what will eventually be provisioned in <strong>k8s</strong>. They are resource requests for the Pod template in the Deployment, the service type for the nginx <strong>Service</strong> resource, and a nodeCount (replicas) for the Deployment resource.</p><p>The next part of these values is where we encounter some of the complicated aspects of IngressControllers. They are a resource in your <strong>k8s</strong> cluster that needs to work with things <strong>outside</strong> of the cluster. In this case, the <strong>nginx IngressController</strong> needs to be able to talk to Azure and create a <strong>LoadBalancer</strong> and <strong>PublicIP</strong> outside of the cluster. The same <strong>nginx IngressController</strong> would need to talk to AWS if this was deployed there. We can give these IngressControllers some information that helps them understand which external provider to work with and what that provider needs. We can add provider-specific values via <strong>annotations</strong> which could be provided in the <strong>values.yaml</strong> file but in our case, we will provide them via the <strong>values:</strong> object in the Pulumi ChartOpts class.</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">service: &#123;</span><br><span class="line">  annotations: &#123;</span><br><span class="line">    <span class="string">"service.beta.kubernetes.io/azure-dns-label-name"</span>: aksStack.getOutput(<span class="string">"k8sDnsName"</span>),</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>In this case, we are telling the IngressController to tell Azure that we want to use <strong>k8sDnsName</strong> as the DNS name label on the PublicIP that is created for our load balancer.</p><blockquote><p><strong>NOTE</strong> <s>At this time, this annotation is not working. I'll update as soon as I figure out what is going on.</s> I've updated the code snippet as I've figured out how this works now. Another blog post (short) will be written up.</p></blockquote><p>Now that the Pulumi script is working, we don't need to use this PowerShell but I will leave it here as an example of using the azure-cli with some PowerShell. <em>After</em> our IngressController has been provisioned, we can run this PowerShell script against the <strong>azure-cli</strong> command to do this for us.</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># get the PublicIP object for our load balancer</span></span><br><span class="line"><span class="variable">$pip</span> = az network public<span class="literal">-ip</span> list -<span class="literal">-query</span> <span class="string">"[?tags.service=='kube-system/nginx-nginx-ingress-controller']"</span> | <span class="built_in">ConvertFrom-Json</span></span><br><span class="line"><span class="comment"># update the --dns-name and refresh our object in PowerShell</span></span><br><span class="line"><span class="variable">$pip</span> = az network public<span class="literal">-ip</span> update <span class="literal">-n</span> <span class="variable">$pip</span>.name <span class="literal">-g</span> <span class="variable">$pip</span>.resourceGroup  -<span class="literal">-dns</span><span class="literal">-name</span> <span class="string">"identity-auth-dev"</span> | <span class="built_in">ConvertFrom-Json</span></span><br><span class="line"><span class="comment"># set the clusterFQDN in Pulumi</span></span><br><span class="line">pulumi config set clusterFQDN <span class="variable">$pip</span>.dnsSettings.fqdn</span><br><span class="line"><span class="comment"># verify that we can resolve our DNS entry</span></span><br><span class="line">nslookup <span class="variable">$pip</span>.dnsSettings.fqdn</span><br></pre></td></tr></table></figure><p>The important thing about this activity in regard to progressing toward a working IdentityServer4 implementation is that we now have a single public IP address that we can create DNS entries for. We also have a single DNS entry provided to us by Azure that we can use as a CNAME entry, but we still need individual DNS entries for each service that we are going to expose.</p><p>We aren't quite done yet though. We have 3-5 apps (depending on how you feel) that we need to expose as separate applications from our cluster. In order to do that, we need to a couple more things.</p><p>For the next steps, let's assume that:</p><ul><li>our the FQDN is <strong>identity-auth-dev.westus.cloudapp.azure.com</strong></li><li>our public IPv4 is <strong>137.135.18.68</strong></li></ul><blockquote><p>I abandon IP address all the time. Please don't expect this one to work. After this effort, I wouldn't expect the FQDN to be around either. It might be, but don't count on it.</p></blockquote><h3>Configuring Public DNS Records</h3><p>In order to make this authentication system work on your custom domain, you can simply take the following sub-domains and make a <a href="https://en.wikipedia.org/wiki/CNAME_record" target="_blank" rel="noopener">CNAME entry</a> in your DNS provider for each that points at our Azure-provided DNS entry.</p><table><thead><tr><th></th><th></th><th></th><th></th></tr></thead><tbody><tr><td>Record Type</td><td>Name</td><td>Value</td><td>TTL</td></tr><tr><td>CNAME</td><td>auth</td><td>identity-auth-dev.westus.cloudapp.azure.com</td><td>1hr</td></tr><tr><td>CNAME</td><td>auth-admin</td><td>identity-auth-dev.westus.cloudapp.azure.com</td><td>1hr</td></tr><tr><td>CNAME</td><td>auth-admin-api</td><td>identity-auth-dev.westus.cloudapp.azure.com</td><td>1hr</td></tr></tbody></table><blockquote><p>I'm no longer trying to keep this all on my local machine. There are no hosts file instructions going forward.</p></blockquote><h4>Give it a try</h4><p>After a quick <code>pulumi up</code> with the IngressController code added to our application, we should have a couple new Azure resources and a bunch of new <strong>k8s</strong> resources.</p><p>In Azure, you should find:</p><ul><li>A load balancer<code>az network lb list</code></li><li>A public IP<code>az network public-ip list</code></li></ul><p>In <strong>k8s</strong> you should find a bunch of nginx-based resources in the <strong>kube-system</strong> namespace. This should show you some, but not all, of these resources.</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl get deployments -<span class="literal">-namespace</span> kube<span class="literal">-system</span> <span class="literal">-l</span> app=nginx<span class="literal">-ingress</span><span class="literal">-controller</span></span><br><span class="line">kubectl get pods -<span class="literal">-namespace</span> kube<span class="literal">-system</span> <span class="literal">-l</span> app=nginx<span class="literal">-ingress</span><span class="literal">-controller</span></span><br><span class="line">kubectl get services -<span class="literal">-namespace</span> kube<span class="literal">-system</span> <span class="literal">-l</span> app=nginx<span class="literal">-ingress</span><span class="literal">-controller</span></span><br></pre></td></tr></table></figure><p>The great thing about the <strong>nginx IngressController</strong> Helm chart is that it installs a default backend for all un-managed routes. We will add rules for managing routes in the <strong>Ingress</strong> resource next, but until then, if you go to any of the URLs we setup, they should all work, with all of the traffic getting routed to the nginx backend web server!</p><img id="image" src="/images/dwhite/helm-nginx-default-backend.png" alt="All the nginx resources" height="258px"><p>Now, lets add certificates!</p><h3>Certificates</h3><h4>Big Caveat Here</h4><p>If you are still trying to use the host-file approach to access your applications, you <strong>won't be able</strong> to follow all of my steps for adding certificates management or HTTPs to your cluster. You will need to step outside of these articles to figure out how to provide a certificate to cert-manager that you can use. My guidance uses <a href="https://letsencrypt.org/" target="_blank" rel="noopener">lets-encrypt</a> and <a href="https://letsencrypt.org/" target="_blank" rel="noopener">lets-encrypt</a> needs to be able to access your public DNS entries to ensure that you are who you say you are. At this point, you should probably start thinking about getting a custom domain to make all of this a bit easier.</p><h4>Adding cert-manager</h4><p>One of the goals of the project was to ensure that everything has certificates, is using HTTPs, and it is easy to manage. With <strong>k8s</strong> that is very easy with <a href="https://cert-manager.io/docs/" target="_blank" rel="noopener">cert-manager</a>. In this case, we simply need to install <strong>cert-manager</strong> into our cluster with some pulumi code.</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// setup cert-manager</span></span><br><span class="line"><span class="keyword">const</span> certManager = <span class="keyword">new</span> k8s.yaml.ConfigFile(<span class="string">"cert-manager"</span>, &#123;</span><br><span class="line">    file: <span class="string">"https://github.com/jetstack/cert-manager/releases/download/v0.14.1/cert-manager.yaml"</span>,</span><br><span class="line"> &#125;, &#123;provider: k8sProvider&#125;);</span><br></pre></td></tr></table></figure><p>This file, which you can <a href="https://github.com/jetstack/cert-manager/releases/download/v0.14.1/cert-manager.yaml" target="_blank" rel="noopener">look at on github</a>, will install a lot of resources into your <strong>k8s</strong> cluster. You don't need to know a lot about them to use the certificate acquisition properties. I'm using <a href="https://letsencrypt.org/" target="_blank" rel="noopener">lets-encrypt</a> so I need to understand any limitations or restrictions imposed by them which in this case means the <a href="https://letsencrypt.org/docs/rate-limits/" target="_blank" rel="noopener">rate limits</a> for acquiring certificates. These are important to understand so please read up and manage your certificate usage appropriately.</p><h3>Adding a ClusterIssuer</h3><p>Once <strong>cert-manager</strong> is installed into your cluster, it will be able to acquire/issue local cluster self-signed certificates. If you'd like to acquire certificates from Let's Encrypt or another supported issuer, you need to add an <strong>Issuer</strong> or a <strong>ClusterIssuer</strong> resource so that <strong>cert-manager</strong> can get certs. In our case, we are going to <a href="https://docs.cert-manager.io/en/release-0.11/reference/clusterissuers.html" target="_blank" rel="noopener">add two ClusterIssuers</a> so that we can get staging certificates from Let's Encrypt and we can get production certificates from Let's Encrypt as well.</p><p>You should also take into consideration that we are using <strong>nginx</strong> as our <strong>IngressController</strong>. Each IngressController will have <a href="https://cert-manager.io/docs/tutorials/acme/ingress/" target="_blank" rel="noopener">different configuration and classes</a> that you need to setup and use.</p><p>Currently, Pulumi doesn't have a API/SDK module for <strong>cert-manager</strong> so we need to create a .yaml file and then use Pulumi to read it and bring the resources into the cluster.</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># filename: ca-cluster-issuer.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">cert-manager.io/v1alpha2</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterIssuer</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">letsencrypt-staging</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">acme:</span></span><br><span class="line">    <span class="attr">server:</span> <span class="string">https://acme-staging-v02.api.letsencrypt.org/directory</span> <span class="comment"># &lt;-- staging issuer, no certificate rate limits</span></span><br><span class="line">    <span class="attr">email:</span> <span class="string">dave@depthconsulting.ca</span> <span class="comment"># &lt;-- email address required for Let's Encrypt</span></span><br><span class="line">    <span class="attr">privateKeySecretRef:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">letsencrypt-staging</span></span><br><span class="line">    <span class="attr">solvers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">http01:</span></span><br><span class="line">        <span class="attr">ingress:</span></span><br><span class="line">          <span class="attr">class:</span> <span class="string">nginx</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">cert-manager.io/v1alpha2</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterIssuer</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">letsencrypt-prod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">acme:</span></span><br><span class="line">    <span class="attr">server:</span> <span class="string">https://acme-v02.api.letsencrypt.org/directory</span> <span class="comment"># &lt;-- prod issuer, strict certificate rate limits</span></span><br><span class="line">    <span class="attr">email:</span> <span class="string">dave@depthconsulting.ca</span></span><br><span class="line">    <span class="attr">privateKeySecretRef:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">letsencrypt-prod</span></span><br><span class="line">    <span class="attr">solvers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">http01:</span></span><br><span class="line">        <span class="attr">ingress:</span></span><br><span class="line">          <span class="attr">class:</span> <span class="string">nginx</span></span><br></pre></td></tr></table></figure><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// create certificate issuers for lets-encrypt</span></span><br><span class="line"><span class="keyword">const</span> caClusterIssuer = <span class="keyword">new</span> k8s.yaml.ConfigFile(<span class="string">"ca-cluster-issuer"</span>, &#123;</span><br><span class="line">    file: <span class="string">"ca-cluster-issuer.yaml"</span>,</span><br><span class="line"> &#125;, &#123;provider: k8sProvider&#125;);</span><br></pre></td></tr></table></figure><p>Once you've created this .yaml file and TypeScript fragment, you can <code>pulumi up</code> to get these resources into your cluster.</p><h3>Ingress Resource</h3><p>Now that we have <strong>cert-manager</strong> installed and issuers configured, we can add our <a href="https://kubernetes.io/docs/concepts/services-networking/ingress/" target="_blank" rel="noopener">Ingress Resource</a>.</p><p>An <strong>Ingress</strong> resource tells an <strong>IngressController</strong> what rules to setup for accessing services in the cluster. You can switch <strong>IngressControllers</strong> if you need to and the <strong>Ingress</strong> resource may not have to change. The rules can stay the same as long as the controller supports all of the rules laid out in the <strong>Ingress</strong> resource.</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> ingressName = <span class="string">"identity-ingress"</span>;</span><br><span class="line"><span class="keyword">const</span> ingressFrontEnd = <span class="keyword">new</span> k8s.networking.v1beta1.Ingress(ingressName,&#123;</span><br><span class="line">    metadata:&#123;</span><br><span class="line">        name: ingressName,</span><br><span class="line">        annotations: &#123;</span><br><span class="line">            <span class="string">"kubernetes.io/ingress.class"</span>: <span class="string">"nginx"</span>, <span class="comment">// &lt;-- we are using an nginx ingress controller</span></span><br><span class="line">            <span class="string">"cert-manager.io/cluster-issuer"</span>: <span class="string">"letsencrypt-staging"</span> <span class="comment">// &lt;-- we are using test certificates</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    spec: &#123;</span><br><span class="line">        tls:[&#123; <span class="comment">// &lt;-- we want certificates for all of these domains</span></span><br><span class="line">          hosts:[</span><br><span class="line">              <span class="string">"auth.codingwithdave.xyz"</span>,</span><br><span class="line">              <span class="string">"auth-admin.codingwithdave.xyz"</span>,</span><br><span class="line">              <span class="string">"auth-admin-api.codingwithdave.xyz"</span></span><br><span class="line">            ],</span><br><span class="line">          secretName: <span class="string">"tls-secret-certificate"</span> <span class="comment">// &lt;-- store the cert in this secret</span></span><br><span class="line">        &#125;],</span><br><span class="line">        rules: [</span><br><span class="line">            &#123;</span><br><span class="line">                host: <span class="string">"auth.codingwithdave.xyz"</span>,</span><br><span class="line">                http:&#123;</span><br><span class="line">                    paths: [&#123;</span><br><span class="line">                        path: <span class="string">"/"</span>,</span><br><span class="line">                        backend: &#123;</span><br><span class="line">                            serviceName: <span class="string">"identity-sts-svc"</span>,</span><br><span class="line">                            servicePort: <span class="number">80</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;]</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                host: <span class="string">"auth-admin.codingwithdave.xyz"</span>,</span><br><span class="line">                http:&#123;</span><br><span class="line">                    paths: [&#123;</span><br><span class="line">                        path: <span class="string">"/"</span>,</span><br><span class="line">                        backend: &#123;</span><br><span class="line">                            serviceName: <span class="string">"identity-admin-svc"</span>,</span><br><span class="line">                            servicePort: <span class="number">80</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;]</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                host: <span class="string">"auth-admin-api.codingwithdave.xyz"</span>,</span><br><span class="line">                http:&#123;</span><br><span class="line">                    paths: [&#123;</span><br><span class="line">                        path: <span class="string">"/"</span>,</span><br><span class="line">                        backend: &#123;</span><br><span class="line">                            serviceName: <span class="string">"identity-admin-api-svc"</span>,</span><br><span class="line">                            servicePort: <span class="number">80</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;]</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;,&#123;provider: k8sProvider&#125;);</span><br></pre></td></tr></table></figure><p>The rules in this particular <strong>Ingress</strong> definition are all using host-based rules. When someone visits our IdentityServer4 sites, the host-name that they used to get there will be pulled out of the request, and the <strong>nginx IngressController</strong> will look for that host in the rules, and if it finds it, send the request to the appropriate service. If it doesn't find it, it goes to the default backend controller.</p><blockquote><p>Internally, the <strong>k8s</strong> cluster only uses http. I'm sure there is a security reason to have HTTPs everywhere internally in the cluster, but I don't understand why, so I haven't implemented any of that.</p></blockquote><p>In these rules, we can see we need to declare a host and the path. Once that is in place, we simply describe what service to go to, using the internal <strong>k8s</strong> DNS entry and the port.</p><p>If you are using <strong>cert-manager</strong>, you can see that there are some instructions in the ingress for <strong>cert-manager</strong>.</p><ul><li><strong>&quot;cert-manager.io/cluster-issuer&quot;: &quot;letsencrypt-staging&quot;</strong> - this tells <strong>cert-manager</strong> to use letsencrypt-prod generates production certificates but also has important rate limits</li><li><strong>tls:[{ ... }]</strong> - this parameter will be used by <strong>cert-manager</strong> to determine what domains to generate certificates for.</li></ul><p>At this point, you should now be able to <code>pulumi up</code> and add <strong>cert-manager</strong> and the <strong>Ingress</strong> resource to your cluster. This will do a lot of things for you. If you are not generating production certificates, you should use the <strong>&quot;cert-manager.io/cluster-issuer&quot;: &quot;letsencrypt-staging&quot;</strong> issuer in <strong>cert-manager</strong>. There are no rate limits on generating staging certificates. If you are generating production certificates, you'll need to switch to the <strong>letsencrypt-prod</strong> issuer and understand the <a href="https://letsencrypt.org/docs/rate-limits/" target="_blank" rel="noopener">rate limits</a>.</p><p>Once that is done, you can start visiting your sites and you should hit something other than the default nginx backend.</p><ul><li><a href="https://auth.codingwithdave.xyz" target="_blank" rel="noopener">https://auth.codingwithdave.xyz</a> - STS landing page, should work</li><li><a href="https://auth-admin.codingwithdave.xyz" target="_blank" rel="noopener">https://auth-admin.codingwithdave.xyz</a> - Admin landing page, not default backend, won't work</li><li><a href="https://auth-admin-api.codingwithdave.xyz/swagger" target="_blank" rel="noopener">https://auth-admin-api.codingwithdave.xyz/swagger</a> - Swagger page, won't work, CORS error due to configuration</li></ul><p>If you used the letsencrypt-staging <strong>ClusterIssuer</strong> then you are going to get certificate error, but you can inspect the certificate before you acknowledge and continue. The certificates and certificate path should look like the following:</p><p><img id="image" src="/images/dwhite/cert-manager-letsencrypt-staging-cert.png" alt="Let's Encrypt Staging Certificate" height="500px"><br/></p><p><img id="image" src="/images/dwhite/cert-manager-letsencrypt-staging-cert-path.png" alt="ALet's Encrypt Staging Certificate Path" height="500px"><br/></p><p>In the case of the <strong>STS</strong>, you should land on a functioning page. You should be able to login with admin/P@ssw0rd!</p><p>For the <strong>Admin</strong> site, you should not land on the default backend, but you will probably land on a developer exception page because the admin site configuration in the IdentityServer4 database does not have the correct URLs anymore. We'll fix that in a moment.</p><p>For the <strong>AdminApi</strong> Swagger page, you should see the Swashbuckle Api Explorer frame, but the app will complain that it has a CORS issue. This will also be fixed by configuration now that we know our host names.</p><p>But this is progress! We are now able to access our services in the cluster!</p><h3>Updating our Client Configuration</h3><p>In order to fix all of our sites and get all of this working, we need to make some configuration changes in the IdentityServer4 database and in the Environmental Variables for our ASP.NET Core sites. Let's do that quickly.</p><p>For now, we have not exposed pgAdmin4 via the <strong>Ingress</strong> rules so we are going to need to connect to our cluster, create a port-forward to our local machines, and then browse to the pgAdmin4 app to do our data configuration changes via sql. I'm going to do this via <strong>octant</strong> again. We did exactly this activity <a href="kubernetes/kubernetes-my-journey-part-7b/">back in this article</a>.</p><p>Once you have pgAdmin4 open and connected to our postgres database, we can run the SQL script below in pgAdmin4.</p><blockquote><p>Remember to ensure the custom domain we are using is corrected in the scripts.</p><p>I am using https for all of these examples.</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- ClientCorsOrigins</span></span><br><span class="line"><span class="keyword">UPDATE</span> <span class="string">"ClientCorsOrigins"</span></span><br><span class="line"><span class="keyword">SET</span> <span class="string">"Origin"</span> = <span class="string">'https://auth-admin.codingwithdave.xyz'</span></span><br><span class="line"><span class="keyword">WHERE</span> <span class="string">"Id"</span> = <span class="number">1</span>;  </span><br><span class="line"></span><br><span class="line"><span class="comment">-- ClientPostLogoutRedirectUris</span></span><br><span class="line"><span class="keyword">UPDATE</span> <span class="string">"ClientPostLogoutRedirectUris"</span></span><br><span class="line"><span class="keyword">SET</span> <span class="string">"PostLogoutRedirectUri"</span> = <span class="string">'https://auth-admin.codingwithdave.xyz/signout-callback-oidc'</span></span><br><span class="line"><span class="keyword">WHERE</span> <span class="string">"Id"</span> = <span class="number">1</span>;  </span><br><span class="line"></span><br><span class="line"><span class="comment">-- ClientRedirectUris</span></span><br><span class="line"><span class="keyword">UPDATE</span> <span class="string">"ClientRedirectUris"</span></span><br><span class="line"><span class="keyword">SET</span> <span class="string">"RedirectUri"</span> = <span class="string">'https://auth-admin-api.codingwithdave.xyz/swagger/oauth2-redirect.html'</span></span><br><span class="line"><span class="keyword">WHERE</span> <span class="string">"Id"</span> = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">UPDATE</span> <span class="string">"ClientRedirectUris"</span></span><br><span class="line"><span class="keyword">SET</span> <span class="string">"RedirectUri"</span> = <span class="string">'https://auth-admin.codingwithdave.xyz/signin-oidc'</span></span><br><span class="line"><span class="keyword">WHERE</span> <span class="string">"Id"</span> = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ClientPostLogoutRedirectUris</span></span><br><span class="line"><span class="keyword">UPDATE</span> <span class="string">"Clients"</span></span><br><span class="line"><span class="keyword">SET</span> <span class="string">"ClientUri"</span> = <span class="string">'https://admin-auth.codingwithdave.xyz'</span>, <span class="string">"FrontChannelLogoutUri"</span> = <span class="string">'https://auth-admin.codingwithdave.xyz/signout-oidc'</span></span><br><span class="line"><span class="keyword">WHERE</span> <span class="string">"Id"</span> = <span class="number">2</span>;</span><br></pre></td></tr></table></figure><img id="image" src="/images/dwhite/identity-configuration-sql-update.png" alt="IdentityServer4 SQL Data Configuration changes" height="400px"><p>We also need to update the configuration for the environmental variables for our IdentityServer4 applications in our pulumi script. You will find these lines (approximately) in 3 Deployment resources in our scripts. You need to update them all.</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// find these lines in deployment env: [&#123; &#125;] blocks and make the appropriate custom domain name changes</span></span><br><span class="line">&#123;name: <span class="string">"AdminApiConfiguration__IdentityServerBaseUrl"</span>, value: <span class="string">"https://auth.codingwithdave.xyz"</span>&#125;,</span><br><span class="line">&#123;name: <span class="string">"AdminApiConfiguration__ApiBaseUrl"</span>, value: <span class="string">"https://auth-admin-api.codingwithdave.xyz"</span>&#125;,</span><br><span class="line">&#123;name: <span class="string">"AdminConfiguration__IdentityAdminRedirectUri"</span>, value: <span class="string">"https://auth-admin.codingwithdave.xyz/signin-oidc"</span>&#125;,</span><br></pre></td></tr></table></figure><p>Once you've changed your pulumi application, a simple <code>pulumi up</code> will get everything setup for you.</p><img id="image" src="/images/dwhite/identity-configuration-envvar-update.png" alt="IdentityServer4 App Settings Configuration changes" height="300px"><p>We should now have functional (or mostly functional) set of applications! If you used the <strong>letsencrypt-staging</strong> certificates, the <strong>Admin</strong> site will generate SSL errors since it can't create a valid TLS connection yet.</p><h3>nginx, IdentityServer4 and Aggravation</h3><blockquote><p>When this cluster and Pulumi application were originally written, I had this problem. When I started writing these articles and building the assets, it went away. I'm guessing that a default in nginx changed in one of the containers, but I'm not certain. I'm going to leave this here as a precaution.</p></blockquote><p>So, configuration is changed, services are running, everything is accessible, and you log into the STS. This works! Check the Admin Api Swashbuckle API Explorer and our page loads! But you can't log into the Admin application! What is going on!?!?</p><p>This particular problem vexed me for several days. I had gotten to this point pretty early in my journey, and I've done some (not all) things in these articles so far to help you have a chance to not spend several days on this problem or a problem like this one.</p><p>One thing I've done is the Seq log ingestion. You should be able to port-forward to the Seq application and look at the logs for our IdentityServer4 applications. This will allow you to see all of the applications logs in one spot. When I was looking at the Seq logs, I could see that some traffic simply wasn't flowing between the STS and the Admin application when a use performed an action. Technically, when you try to log into the Admin application, you go to the Admin application first, it determines you are not logged in, and then it re-directs you to the STS application to log in. Via Seq, I saw that this was not happening.</p><p>But there were things that I couldn't see directly in Seq, which was the motivation for our next chapter, but for now, the way this project is currently configured, you will miss log entries from all of our other applications/resources in <strong>k8s</strong> like nginx, coredns, and kubernetes itself.</p><p>In this case, I went to the <strong>nginx</strong> log entries and saw some problems that indicated that <em>something</em> was too small to handle the communications with STS.</p><img id="image" src="/images/dwhite/nginx-pod-logs.png" alt="nginx pod logs" height="250px"><p>In the logs, I found this error.</p><p><code>upstream sent too big header while reading response header from upstream</code></p><p>That little error snippet ended up sending me down a path where it took a couple days to refine my google-foo enough to find the solution to this problem. I tried a lot of different tricks during those couple days, but amazingly, I eventually found this exact problem on another blog that I read a lot, but I hadn't read this article! Andrew Lock does a LOT of good writing for the .NET community and he had run into the exact same problem <em>2 years earlier</em>!</p><p><a href="https://andrewlock.net/fixing-nginx-upstream-sent-too-big-header-error-when-running-an-ingress-controller-in-kubernetes/" target="_blank" rel="noopener">Andrew Lock - upstream-sent-too-big-header-error</a></p><p>Andrew fully describes the problem in a really good way. I'm not going to repeat it. I had the exact same problem and his solution worked. What I am going to present is the Pulumi application code that creates a ConfigMap that nginx will find to make the adjustments.</p><p>Morale of the story - You have to be ready to explore ALL of the logs in your cluster. If you have to do it manually, you should still be prepared to do it.</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> nginxIngressControllerConfigMap = <span class="keyword">new</span> k8s.core.v1.ConfigMap(<span class="string">"nginx-nginx-ingress-controller"</span>, &#123;</span><br><span class="line">    metadata:&#123;</span><br><span class="line">        annotations: &#123;&#125;,</span><br><span class="line">        name: <span class="string">"nginx-nginx-ingress-controller"</span>,</span><br><span class="line">        labels: &#123;<span class="string">"k8s-app"</span>: <span class="string">"nginx-ingress-controller"</span>&#125;,</span><br><span class="line">        <span class="keyword">namespace</span>:<span class="string">"kube-system"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    data: &#123;</span><br><span class="line">        <span class="string">"proxy-buffer-size"</span>: <span class="string">"128k"</span>,</span><br><span class="line">        <span class="string">"proxy-buffers"</span>: <span class="string">"8 128k"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;,&#123;provider: k8sProvider, <span class="keyword">import</span>: <span class="string">"kube-system/nginx-nginx-ingress-controller"</span>&#125;);</span><br></pre></td></tr></table></figure><h2>Summary</h2><p>We have arrived! If everything is going the way I hoped if not necessarily the way I planned, you (and I) should have a functional, basic Azure Kubernetes Service-based <strong>k8s</strong> cluster running an IdentityServer4 implementation in a completely self-sustained manner. It is publicly accessible, our backend infrastructure is not exposed but is accessible, and you can begin integrating your application into this authentication system.</p><p>My hope was that you were going to share my learning journey so that you could have a hands-on platform to continue your learning journey. Mine certainly isn't done. The next step is to show you how I made my logging a lot more comprehensive in a very easy manner!</p><p><strong>Next up:</strong><a href="/kubernetes/kubernetes-my-journey-part-9">Adding Cluster Logging (fluentd)</a></p><style>    h1, h2, h3, h4, h5, h6 {       margin-top: 25px;    }    figure.highlight{        background-color: #E8EEFE;    }    figure.highlight .gutter{        color: #0033CD;    }    figure.highlight pre {        font-family: 'Cascadia Code PL', monospace;    }    code {        font-family: 'Cascadia Code PL', sans-serif;        border-width: 0.1em;        border-color: #E8EEFE;        border-style: solid;        border-radius: 0.3em;        background-color: #E8EEFE;        color: #0033CD;        padding: 0em 0.4em;        white-space: nowrap;    }</style><link  href="https://cdnjs.cloudflare.com/ajax/libs/viewerjs/1.5.0/viewer.min.css" rel="stylesheet"><script src="https://cdnjs.cloudflare.com/ajax/libs/viewerjs/1.5.0/viewer.min.js"></script><script>// View an imageconst gallery = new Viewer(document.getElementById('mainPostContent', {    "navbar": false,    "toolbar": false}));</script>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;a href=&quot;/kubernetes/kubernetes-my-journey&quot;&gt;Series Table of Contents&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Previously:&lt;/strong&gt;
&lt;a href=&quot;/kubernetes/kuberne
    
    </summary>
    
      <category term="kubernetes" scheme="https://westerndevs.com/categories/kubernetes/"/>
    
    
      <category term="kubernetes, azure, aks, identityserver, docker, containers" scheme="https://westerndevs.com/tags/kubernetes-azure-aks-identityserver-docker-containers/"/>
    
  </entry>
  
</feed>
