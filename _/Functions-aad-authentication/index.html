<!DOCTYPE html>
<html lang="en" xml:lang="en">

  <head>
  
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>Azure Functions and Azure B2C Authentication | Western Devs</title>
  <meta name="description" content="I had a pretty good struggle setting up Azure Functions and Azure B2C to work together. There are a few guides out there but I wanted to put my own together because I had a terrible time finding these">
<meta property="og:type" content="article">
<meta property="og:title" content="Azure Functions and Azure B2C Authentication">
<meta property="og:url" content="https://westerndevs.com/_/Functions-aad-authentication/index.html">
<meta property="og:site_name" content="Western Devs">
<meta property="og:description" content="I had a pretty good struggle setting up Azure Functions and Azure B2C to work together. There are a few guides out there but I wanted to put my own together because I had a terrible time finding these">
<meta property="og:image" content="https://blog.simontimms.com/images/functions-aad/create_tenant.png">
<meta property="og:image" content="https://blog.simontimms.com/images/functions-aad/linking_tenant.png">
<meta property="og:image" content="https://blog.simontimms.com/images/functions-aad/spa_properties.png">
<meta property="og:image" content="https://blog.simontimms.com/images/functions-aad/api_properties.png">
<meta property="og:image" content="https://blog.simontimms.com/images/functions-aad/scopes.png">
<meta property="og:image" content="https://blog.simontimms.com/images/functions-aad/policy.png">
<meta property="og:image" content="https://blog.simontimms.com/images/functions-aad/platform_features.png">
<meta property="og:image" content="https://blog.simontimms.com/images/functions-aad/aad_settings.png">
<meta property="article:published_time" content="2019-01-30T18:00:00.000Z">
<meta property="article:modified_time" content="2024-08-31T00:01:11.031Z">
<meta property="article:author" content="Western Devs">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://blog.simontimms.com/images/functions-aad/create_tenant.png">
<meta name="twitter:creator" content="@westerndevs">

    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="title" content="WesternDevs">   
    <meta name="keywords" content="software development,software,asp.net,blog">
    <meta name="description" content="We're all west of somewhere">
    <meta name="copyright" content="WesternDevs">
    <meta name="revisit-after" content="15 days">
    <meta name="robots" content="all">
    <meta name="MSSmartTagsPreventParsing" content="true">
  
    <link rel="canonical" href="https://blog.simontimms.com/2019/01/30/2019-01-30-Functions-aad-authentication/">
  
  
    <link rel="alternate" href="/feed.xml" title="Western Devs" type="application/atom+xml">
  
  
<link rel="stylesheet" href="/css/style.css">

      
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <script src="//code.jquery.com/jquery-1.11.3.min.js"></script>  
  <meta name="generator" content="Hexo 4.2.1"></head>

<body>

<!-- FIXED HEADER BECAUSE SCROLLING -->
<!--HEADER STARTS-->
<div class="WrapperHeader">
<div style="display:inline-block; text-align: center;">
<div class="Header">

  <div class="HeaderLogo">
    <a href="/"><img src="/images/header_logo_transparent.png" alt="WesternDevs" title="WesternDevs" border="0" style="width: 206px; height: 64px;" width="206" height="64"></a>
  </div>

  <div class="HeaderLinks">
      <a href="/posts" class="nav">POSTS</a>       
      <a href="/podcasts" class="nav">PODCASTS</a>       
      <a href="/whoweare" class="nav">ABOUT</a>  
      <a href="/whatwevedone" class="nav">WHAT WE'VE DONE</a>  
      <a href="/speaking" class="nav">SPEAKING</a>
      <div class="HeaderIcons">
        <a href="mailto:info@westerndevs.com"><img src="/images/icon_email.png" border="0" alt="Email" title="Email" height="26" width="26"></a>
        <a href="/feed.xml"><img src="/images/icon_subscribe.png" border="0" alt="Subscribe" title="Subscribe" height="26" width="27"></a>
        <a href="http://twitter.com/westerndevs" target="_blank"><img src="/images/icon_twitter.png" border="0" alt="Twitter" title="Twitter" height="26" width="27"></a>
        <a href="http://github.com/westerndevs" target="_blank"><img src="/images/icon_github.png" border="0" alt="GitHub" title="GitHub" height="26" width="27"></a>     
      </div>
  </div>
  
</div>
</div>
</div>
<!--HEADER ENDS-->    



<!--WRAPPER STARTS-->
<div class="Wrapper" style="">

<!--SUBHEAD STARTS-->
<div class="WrapperSubHeaderSubpage">
<center>
	<div class="SubHeader">
		<H1 class="title"><img class="icon" src="/images/icon_posts.png" alt="POST" title="POST" border="0"> POST</H1>
	</div>
</center>
</div>
<!--SUBHEAD ENDS-->

<!--PAGE CONTENT STARTS-->
<center>
<div class="WrapperContent">

<!--MAIN CONTENT STARTS-->
	<div class="SubpageBoxSubLrg">
		<div class="SubpageBoxSubLrgContent">
		    <div class='postTitle'>
  <div class="ListLrgDateBG">
    <div class="ListLrgDateMonth">JAN</div>
    <div class="ListLrgDateDay">30</div>
    <div class="ListLrgDateYear">2019</div>
  </div>
  <h2>Azure Functions and Azure B2C Authentication</h2>
</div>

		    

<p class="TXTsm">ORIGINALLY POSTED TO: <a href="https://blog.simontimms.com/2019/01/30/2019-01-30-Functions-aad-authentication/" target="_blank" rel="noopener" class='originalurl'>https://blog.simontimms.com/2019/01/30/2019-01-30-Functions-aad-authentication/</a></p>



			<div id="mainPostContent">
	        <p>I had a pretty good struggle setting up Azure Functions and Azure B2C to work together. There are a few guides out there but I wanted to put my own together because I had a terrible time finding these posts initially. The scenario here is that we want a single page application written in React to talk to an API hosted entirely in Azure Functions such that the functions are authenticated.</p>
<a id="more"></a>
<h2>Azure</h2>
<p>First up you'll need to create a new tenant for Azure B2C. This is a weird two step process which I'm given to understand is going to be improved at some point in the near future. For now in the Azure Portal select <code>Create a resource</code> then <code>Azure B2C</code>. You'll be presented with these two options.</p>
<p><img src="https://blog.simontimms.com/images/functions-aad/create_tenant.png" alt="Creating a tenant"></p>
<p>To start you'll need to create a tenant, so pick the first one. You'll be presented with a few options for organization name and initial domain. These are specific to your organization so I'll leave them up to you but think on the names a little because they cannot be changed.</p>
<p>With the B2C tenant created you'll now need the second option to link an existing Azure AD B2C tenant to the Azure subscription. This will create a reference to your tenant in your main Azure subscription.</p>
<p><img src="https://blog.simontimms.com/images/functions-aad/linking_tenant.png" alt="Linking a tenant"></p>
<p>Managing tenants is very confusing because you need to actually switch your Azure portal over to the new tenant. This is the least intuitive part of the process in my mind and shouldn't have been implemented this way. So click on the account selector in the top right of the portal to switch directories. Once you're in the new directory you'll see all the various resources you're use to. Don't both touching those, head straight over to Azure AD B2C in All resources.</p>
<p>In here you'll want to start in the Applications section. We'll be creating two applications and defining some claims between them. One application will be for the functions and the other for the SPA. You can expand this to more applications as your application grows.</p>
<p>The SPA should be the first one you create. I, creatively, called mine <code>SPA</code>. This one does not need an App ID URI but you should allow implicit flows and include web app/web API.</p>
<p><img src="https://blog.simontimms.com/images/functions-aad/spa_properties.png" alt="Properties for the SPA"></p>
<p>The reply URLs should contain a list of all the page from which a user can authenticate. Unfortunately, wildcards are not permitted here so you need to be explicit.</p>
<p>With that created we can now move onto the API app. This one is similar except that you'll want to put in place an App ID. Mine is simply called <code>API</code></p>
<p><img src="https://blog.simontimms.com/images/functions-aad/api_properties.png" alt="Properties for the API"></p>
<p>In that screenshot you'll notice a reply URL. You likely don't have that yet so leave it blank. We'll come back to it. Now the API app will need to publish a scope. This is what ties your two apps (API and SPA) together. I created a single scope called <code>access</code> because I don't have anything too complex in my API. You can publish multiple scopes if you wish.</p>
<p><img src="https://blog.simontimms.com/images/functions-aad/scopes.png" alt="Scopes"></p>
<p>Publishing scopes is half the equation, now back to the API application and select <code>API access</code>. In there select <code>Add</code> and select <code>API</code> in the first dropdown and then select both scopes in the second. Users who have authenticated against the SPA will now be able to access the API.</p>
<p>We're almost done in the B2C for now but we also want to set up a <code>User Flow</code>. This is a hosted login experience. You can customize the experience but that's outside of this tutorial. We want a basic Signup and Sign in policy. I named mine <code>SignupSignin</code> but you can pick whatever you like. Be sure to check the Email Signup identity provider. I also drilled into the <code>User attributes and claims</code> to select Email Address as a collected attribute and Email Addresses as a returned claim. This means that during the signup process we'll ask for the Email address and when authenticating in the SPA the JWT passed back will contain a collection of Email addresses. You can select more if you like.</p>
<p><img src="https://blog.simontimms.com/images/functions-aad/policy.png" alt="Policy"></p>
<p>Once the policy is created you'll want to select it and click <code>Run user flow</code> in there you'll find a metadata URL which will be used in your SPA application and functions. Make a note of it. While we're here also make a not of the ID of the API application.</p>
<p>Now all this is created we're now ready to jump over to the function app you want to authenticate. Phew, that took a while.</p>
<p>Switch back to your primary directory and head over to your function app. If you don't have one created already just create a blank C# one. In the function app click through to the platform features and select Authentication.</p>
<p><img src="https://blog.simontimms.com/images/functions-aad/platform_features.png" alt="Authentication"></p>
<p>In authentication turn on <code>App Service Authentication</code> and select <code>Azure Active Directory</code>. Switch over to advanced and enter the API application Id in the Client ID field and the metadata URL in the Issuer Url field. These are the two things you made notes about before leaving the B2C.</p>
<p><img src="https://blog.simontimms.com/images/functions-aad/aad_settings.png" alt="Active Directory Auth"></p>
<p>Finally change the <code>Action to take when request is not authenticated</code> over to <code>Log in with Azure Active Directory</code>. Save the authentication page. Now you'll need to make one final change over in the B2C. You'll need to find the URL for you function app. This is easily found by clicking on a function and running it. Take the URL and back in the B2C head to the API application.</p>
<p>In the API application you'll need to set the <code>Reply URL</code>. The URL should be of the format <code>https://&lt;functionapp name&gt;/.auth/login/aad/callback</code> so if you function app is called <code>bob</code> the result would be <code>https://bob/.auth/login/aad/callback</code>. With that in place we're done the Azure setup.</p>
<h2>In React</h2>
<p>Open up a terminal and install the handy package <code>react-aad-msal</code>. (Note: If you run into problems authenticating you might want to try the <code>react-aad-msal-jfm</code> package instead. It works around a new domain that Microsoft is using for B2C which isn't accepted by the <code>react-aad-msal</code> package.). This package provides some React components you can put on your page to do the actual authentication.</p>
<p>In a page I put in this control. I'm using Create ReactApp so the values for authority, clientID and scope are taken from a config file. The Authority is the Url for the policy so something like <code>https://yourtenant.b2clogin.com/tfp/yourtenant.onmicrosoft.com/B2C_1_SiUpIn</code>. The client Id is the ID of the SPA app from the B2C. Finally the scope is the fully qualified scope <code>https://yourtenant.onmicrosoft.com/API/access</code></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">import &#123; AzureAD, LoginType, MsalAuthProviderFactory &#125; from 'react-aad-msal-jfm';</span><br><span class="line">...</span><br><span class="line"> <span class="tag">&lt;<span class="name">AzureAD</span></span></span><br><span class="line"><span class="tag">    <span class="attr">provider</span>=<span class="string">&#123;new</span> <span class="attr">MsalAuthProviderFactory</span>(&#123;</span></span><br><span class="line"><span class="tag">        <span class="attr">authority:</span> <span class="attr">process.env.REACT_APP_AUTHORITY</span>,</span></span><br><span class="line"><span class="tag">        <span class="attr">clientID:</span> <span class="attr">process.env.REACT_APP_CLIENT_ID</span>,</span></span><br><span class="line"><span class="tag">        <span class="attr">scopes:</span> [<span class="attr">process.env.REACT_APP_SCOPE</span>],</span></span><br><span class="line"><span class="tag">        <span class="attr">type:</span> <span class="attr">LoginType.Popup</span>,</span></span><br><span class="line"><span class="tag">        <span class="attr">persistLoginPastSession:</span> <span class="attr">true</span>,</span></span><br><span class="line"><span class="tag">        <span class="attr">validateAuthority:</span> <span class="attr">false</span></span></span><br><span class="line"><span class="tag"></span></span><br><span class="line"><span class="tag">    &#125;)&#125;</span></span><br><span class="line"><span class="tag">    <span class="attr">unauthenticatedFunction</span>=<span class="string">&#123;this.unauthenticatedFunction&#125;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">authenticatedFunction</span>=<span class="string">&#123;this.authenticatedFunction&#125;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">userInfoCallback</span>=<span class="string">&#123;this.userJustLoggedIn&#125;</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<p>With this in place a login button is rendered. Click on the button and a popup will be shown with your login page. I saved off the bearer token from the <code>userInfoCallback</code> which is passed an object containing the <code>jwtAccessToken</code>. The emails we permitted as a claim are passed back as <code>idToken.emails</code>. My reducer looks a bit like</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> getType(login.loginSuccess):</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        ...state,</span><br><span class="line">        loggedIn: <span class="literal">true</span>,</span><br><span class="line">        bearerToken: action.payload.body.jwtAccessToken,</span><br><span class="line">        displayName: action.payload.body.user.name,</span><br><span class="line">        userId: action.payload.body.user.userIdentifier,</span><br><span class="line">        email: action.payload.body.user.idToken.emails[<span class="number">0</span>]</span><br><span class="line">    &#125;;</span><br></pre></td></tr></table></figure>
<p>This jwtAccess token should be used in the headers of any fetches against the function app.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> result = <span class="keyword">await</span> fetch(<span class="string">`<span class="subst">$&#123;process.env.REACT_APP_API_URL&#125;</span>/Practices`</span>, &#123;</span><br><span class="line">            method: <span class="string">'GET'</span>,</span><br><span class="line">            headers: &#123;</span><br><span class="line">                <span class="string">'Authorization'</span>: <span class="string">`Bearer <span class="subst">$&#123;<span class="keyword">this</span>.props.login.bearerToken&#125;</span>`</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br></pre></td></tr></table></figure>

	        </div>

            
            <section id="comments">
            <div id="disqus_thread">
                <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript" target="_blank" rel="noopener">comments powered by Disqus.</a></noscript>
            </div>
            </section>
            
		</div>
	</div>
<!--MAIN CONTENT ENDS-->

<!--SIDEBAR CONTENT STARTS-->
	<div class="SubpageBoxSubSm">
		<div class="SubpageBoxSubSmContent">
			
			

			<div class="ProfileImg">
				
				<a href="/bios/simon_timms">
				
					<img src='/images/avatars/simon.jpg' />
				
				</a>
				
			</div>

			<BR clear="all">

			<h2><a href="/bios/simon_timms">Simon Timms</a></h2>
			
			<a href="mailto:stimms@gmail.com"><img class="ProfileIcon" src="/images/icon_email.png" border="0" alt="Email" title="Email"> Email</a><BR>
			
			
			<a href="http://blog.simontimms.com/" target="_blank"><img class="ProfileIcon" src="/images/icon_web.png" border="0" alt="Web" title="Web"> Web</a><BR>
			
			
			<a href="http://twitter.com/stimms" target="_blank"><img class="ProfileIcon" src="/images/icon_twitter.png" border="0" alt="Twitter" title="Twitter"> Twitter</a><BR>
			
			
			<a href="https://github.com/stimms" target="_blank"><img class="ProfileIcon" src="/images/icon_github.png" border="0" alt="GitHub" title="GitHub"> GitHub</a><br>
			
			
			
 			<a href="/feeds/simon_timms.xml"><img class="ProfileIcon" src="/images/icon_subscribe.png" /> RSS</a>
			

			<hr />
			<h4>Looking for someone else?</h4>
			<p>You can find the rest of the Western Devs Crew <a href="/whoweare">here</a>.</p>
		</div>
	</div>
<!--SIDEBAR CONTENT ENDS-->


</div>
</center>
<!--PAGE CONTENT ENDS-->


<!--FOOTER STARTS-->
<center>
  <div class="FooterBarTxt">&copy; 2015 Western Devs. All Rights Reserved. Design by <a href="http://www.karenchudobiak.ca" target="_blank">Karen Chudobiak, Graphic Designer</a></div>
</center>
<!--FOOTER ENDS-->

<!-- NAV FOOTER STARTS -->
<div class="NavFooter">
  <a href="/posts" alt="Posts"><i class="fa fa-newspaper-o fa-2x"></i><span>Posts</span></a>
  <a href="/podcasts" alt="Podcasts"><i class="fa fa-volume-up fa-2x"></i><span>Podcasts</span></a>
  <a href="/whoweare" alt="About"><i class="fa fa-star fa-2x"></i><span>About</span></a>
  <a href="/whatwevedone" alt="What We've Done"><i class="fa fa-trophy fa-2x"></i><span>Work</span></a>
  <a href="/speaking" alt="Speaking"><i class="fa fa-comment-o fa-2x fa-flip-horizontal"></i><span>Speaking</span></a>
</div>
<!-- NAV FOOTER ENDS -->




</div>
<!--WRAPPER ENDS-->


<script>
  var disqus_shortname = 'westerndevs';
  
  var disqus_url = 'https://westerndevs.com/_/Functions-aad-authentication/'.replace(".com//", ".com/");
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
  
function shuffle(array) {
  var currentIndex = array.length, temporaryValue, randomIndex;

  // While there remain elements to shuffle...
  while (0 !== currentIndex) {

    // Pick a remaining element...
    randomIndex = Math.floor(Math.random() * currentIndex);
    currentIndex -= 1;

    // And swap it with the current element.
    temporaryValue = array[currentIndex];
    array[currentIndex] = array[randomIndex];
    array[randomIndex] = temporaryValue;
  }

  return array;
}

</script>


</body>

  
<!-- Google Analytics -->
<script type="text/javascript">
if (document.location.hostname.search("westerndevs.com") !== -1 || document.location.hostname.search("www.westerndevs.com") !== -1) {
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-37617956-2', 'auto');

ga('set', 'contentGroup1', 'simon_timms');

ga('send', 'pageview');
}
</script>
<!-- End Google Analytics -->



</html>
