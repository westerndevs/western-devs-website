<!DOCTYPE html>
<html lang="en" xml:lang="en">

  <head>
  
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>Doing Snapshots on Azure Virtual Machines | Western Devs</title>
  <meta name="description" content="I&#39;ve always been frustrated that I can&#39;t do snapshots when I&#39;m using VM&#39;s in Azure. Especially when I&#39;m developing some deployment automation, I like to be able to try something out - and when it inev">
<meta property="og:type" content="article">
<meta property="og:title" content="Doing Snapshots on Azure Virtual Machines">
<meta property="og:url" content="https://westerndevs.com/_/azure-snapshots/index.html">
<meta property="og:site_name" content="Western Devs">
<meta property="og:description" content="I&#39;ve always been frustrated that I can&#39;t do snapshots when I&#39;m using VM&#39;s in Azure. Especially when I&#39;m developing some deployment automation, I like to be able to try something out - and when it inev">
<meta property="og:image" content="http://i.imgur.com/waHMXxG.png">
<meta property="og:image" content="http://i.imgur.com/601dKeE.png">
<meta property="og:image" content="http://i.imgur.com/EjdOOxL.png">
<meta property="og:image" content="http://i.imgur.com/05cF86c.png">
<meta property="og:image" content="http://i.imgur.com/QKLize8.png">
<meta property="og:image" content="http://i.imgur.com/psVa4XE.png">
<meta property="og:image" content="http://i.imgur.com/yh9cgcp.png">
<meta property="article:published_time" content="2015-11-04T06:30:00.000Z">
<meta property="article:modified_time" content="2022-11-11T15:53:21.770Z">
<meta property="article:author" content="Western Devs">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://i.imgur.com/waHMXxG.png">
<meta name="twitter:creator" content="@westerndevs">

    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="title" content="WesternDevs">   
    <meta name="keywords" content="software development,software,asp.net,blog">
    <meta name="description" content="We're all west of somewhere">
    <meta name="copyright" content="WesternDevs">
    <meta name="revisit-after" content="15 days">
    <meta name="robots" content="all">
    <meta name="MSSmartTagsPreventParsing" content="true">
  
  
    <link rel="alternate" href="/feed.xml" title="Western Devs" type="application/atom+xml">
  
  
<link rel="stylesheet" href="/css/style.css">

      
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <script src="//code.jquery.com/jquery-1.11.3.min.js"></script>  
  <meta name="generator" content="Hexo 4.2.1"></head>

<body>

<!-- FIXED HEADER BECAUSE SCROLLING -->
<!--HEADER STARTS-->
<div class="WrapperHeader">
<div style="display:inline-block; text-align: center;">
<div class="Header">

  <div class="HeaderLogo">
    <a href="/"><img src="/images/header_logo_transparent.png" alt="WesternDevs" title="WesternDevs" border="0" style="width: 206px; height: 64px;" width="206" height="64"></a>
  </div>

  <div class="HeaderLinks">
      <a href="/posts" class="nav">POSTS</a>       
      <a href="/podcasts" class="nav">PODCASTS</a>       
      <a href="/whoweare" class="nav">ABOUT</a>  
      <a href="/whatwevedone" class="nav">WHAT WE'VE DONE</a>  
      <a href="/speaking" class="nav">SPEAKING</a>
      <div class="HeaderIcons">
        <a href="mailto:info@westerndevs.com"><img src="/images/icon_email.png" border="0" alt="Email" title="Email" height="26" width="26"></a>
        <a href="/feed.xml"><img src="/images/icon_subscribe.png" border="0" alt="Subscribe" title="Subscribe" height="26" width="27"></a>
        <a href="http://twitter.com/westerndevs" target="_blank"><img src="/images/icon_twitter.png" border="0" alt="Twitter" title="Twitter" height="26" width="27"></a>
        <a href="http://github.com/westerndevs" target="_blank"><img src="/images/icon_github.png" border="0" alt="GitHub" title="GitHub" height="26" width="27"></a>     
      </div>
  </div>
  
</div>
</div>
</div>
<!--HEADER ENDS-->    



<!--WRAPPER STARTS-->
<div class="Wrapper" style="">

<!--SUBHEAD STARTS-->
<div class="WrapperSubHeaderSubpage">
<center>
	<div class="SubHeader">
		<H1 class="title"><img class="icon" src="/images/icon_posts.png" alt="POST" title="POST" border="0"> POST</H1>
	</div>
</center>
</div>
<!--SUBHEAD ENDS-->

<!--PAGE CONTENT STARTS-->
<center>
<div class="WrapperContent">

<!--MAIN CONTENT STARTS-->
	<div class="SubpageBoxSubLrg">
		<div class="SubpageBoxSubLrgContent">
		    <div class='postTitle'>
  <div class="ListLrgDateBG">
    <div class="ListLrgDateMonth">NOV</div>
    <div class="ListLrgDateDay">4</div>
    <div class="ListLrgDateYear">2015</div>
  </div>
  <h2>Doing Snapshots on Azure Virtual Machines</h2>
</div>

		    

			<div id="mainPostContent">
	        <p>I've always been frustrated that I can't do snapshots when I'm using VM's in Azure. Especially when I'm developing some deployment automation, I like to be able to try something out - and when it inevitably screws up - reset the VM to a snapshot and try again.</p>
<a id="more"></a>
<p>We still can't do actual snapshots, but I've written some powershell that achieves the same goal.  It will grab a copy of the VHD file (this acts as the snapshot), then when we want to restore to snapshot we'll just swap out the VHD's.  The trick here is that Azure won't let you swap out the VHD for an existing VM, so we need to actually destroy the VM, swap out the VHD's, then recreate the VM using the existing VHD.</p>
<blockquote>
<p>Note: This is all done using ARM (Azure Resource Manager) style VM's.</p>
</blockquote>
<p>If you want to try it out, here's a step-by-step to try it out:</p>
<p>First create a VM in Azure, and be sure to select Resource Manager as the deployment model:</p>
<p><img src="http://i.imgur.com/waHMXxG.png" alt="Create ARM VM"></p>
<p><img src="http://i.imgur.com/601dKeE.png" alt="VM Basics"></p>
<p><img src="http://i.imgur.com/EjdOOxL.png" alt="Select VM Size"></p>
<p><img src="http://i.imgur.com/05cF86c.png" alt="VM Settings"></p>
<p>After it's done processing we'll have a new Resource Group with 6 resources included:</p>
<p><img src="http://i.imgur.com/QKLize8.png" alt="Resource Group"></p>
<p>One thing I like to do - that the wizard doesn't let you specify - is to assign a DNS name to the public IP that I'll use to connect to my VM.  You can set this in the configuration page for the Public IP resource.</p>
<p><img src="http://i.imgur.com/psVa4XE.png" alt="Set DNS"></p>
<p>Lastly, I need to copy the Storage Account Access Key for use in the powershell.</p>
<p><img src="http://i.imgur.com/yh9cgcp.png" alt="Retrieve Storage Key"></p>
<p>Now all we need to do is take the powershell below, and modify the values of the variables at the start to match the names you used when you created the VM/Resource Group.</p>
<p>The first time you run the script it will create the initial snapshot.  All subsequent times you run the script it will reset it to that snapshot.</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Set variable values</span></span><br><span class="line"><span class="variable">$resourceGroupName</span> = <span class="string">"DylanDemo"</span></span><br><span class="line"><span class="variable">$location</span> = <span class="string">"West US"</span></span><br><span class="line"><span class="variable">$vmName</span> = <span class="string">"DylanDemo"</span></span><br><span class="line"><span class="variable">$vmSize</span> = <span class="string">"Standard_D1"</span></span><br><span class="line"><span class="variable">$vnetName</span> = <span class="string">"DylanDemo"</span></span><br><span class="line"><span class="variable">$nicName</span> = <span class="string">"dylandemo665"</span></span><br><span class="line"><span class="variable">$dnsName</span> = <span class="string">"dylandemo"</span></span><br><span class="line"><span class="variable">$diskName</span> = <span class="string">"DylanDemo"</span></span><br><span class="line"><span class="variable">$storageAccount</span> = <span class="string">"dylandemo"</span></span><br><span class="line"><span class="variable">$storageAccountKey</span> = <span class="string">"Enter Storage Key Here"</span></span><br><span class="line"><span class="variable">$subscriptionName</span> = <span class="string">"MSDN MPN"</span></span><br><span class="line"><span class="variable">$publicIpName</span> = <span class="string">"DylanDemo"</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$diskBlob</span> = <span class="string">"<span class="variable">$diskName</span>.vhd"</span></span><br><span class="line"><span class="variable">$backupDiskBlob</span> = <span class="string">"<span class="variable">$diskName</span>-backup.vhd"</span></span><br><span class="line"><span class="variable">$vhdUri</span> = <span class="string">"https://<span class="variable">$storageAccount</span>.blob.core.windows.net/vhds/<span class="variable">$diskBlob</span>"</span></span><br><span class="line"><span class="variable">$subnetIndex</span> = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># login to Azure</span></span><br><span class="line"><span class="built_in">Add-AzureAccount</span></span><br><span class="line"><span class="built_in">Select-AzureSubscription</span> <span class="literal">-SubscriptionName</span> <span class="variable">$subscriptionName</span></span><br><span class="line"><span class="built_in">Switch-AzureMode</span> AzureResourceManager</span><br><span class="line"></span><br><span class="line"><span class="comment"># create backup disk if it doesn't exist</span></span><br><span class="line"><span class="built_in">Stop-AzureVM</span> <span class="literal">-ResourceGroupName</span> <span class="variable">$resourceGroupName</span> <span class="literal">-Name</span> <span class="variable">$vmName</span> <span class="literal">-Force</span> <span class="literal">-Verbose</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$ctx</span> = <span class="built_in">New-AzureStorageContext</span> <span class="literal">-StorageAccountName</span> <span class="variable">$storageAccount</span> <span class="literal">-StorageAccountKey</span> <span class="variable">$storageAccountKey</span></span><br><span class="line"><span class="variable">$blobCount</span> = <span class="built_in">Get-AzureStorageBlob</span> <span class="literal">-Container</span> vhds <span class="literal">-Context</span> <span class="variable">$ctx</span> | where &#123; <span class="variable">$_</span>.Name <span class="operator">-eq</span> <span class="variable">$backupDiskBlob</span> &#125; | Measure | % &#123; <span class="variable">$_</span>.Count &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$blobCount</span> <span class="operator">-eq</span> <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="variable">$copy</span> = <span class="built_in">Start-AzureStorageBlobCopy</span> <span class="literal">-SrcBlob</span> <span class="variable">$diskBlob</span> <span class="literal">-SrcContainer</span> <span class="string">"vhds"</span> <span class="literal">-DestBlob</span> <span class="variable">$backupDiskBlob</span> <span class="literal">-DestContainer</span> <span class="string">"vhds"</span> <span class="literal">-Context</span> <span class="variable">$ctx</span> <span class="literal">-Verbose</span></span><br><span class="line">  <span class="variable">$status</span> = <span class="variable">$copy</span> | <span class="built_in">Get-AzureStorageBlobCopyState</span> </span><br><span class="line">  <span class="variable">$status</span> </span><br><span class="line"></span><br><span class="line">  <span class="keyword">While</span>(<span class="variable">$status</span>.Status <span class="operator">-eq</span> <span class="string">"Pending"</span>)&#123;</span><br><span class="line">    <span class="variable">$status</span> = <span class="variable">$copy</span> | <span class="built_in">Get-AzureStorageBlobCopyState</span> </span><br><span class="line">    <span class="built_in">Start-Sleep</span> <span class="number">10</span></span><br><span class="line">    <span class="variable">$status</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># delete VM</span></span><br><span class="line"><span class="built_in">Remove-AzureVM</span> <span class="literal">-ResourceGroupName</span> <span class="variable">$resourceGroupName</span> <span class="literal">-Name</span> <span class="variable">$vmName</span> <span class="literal">-Force</span> <span class="literal">-Verbose</span></span><br><span class="line"><span class="built_in">Remove-AzureStorageBlob</span> <span class="literal">-Blob</span> <span class="variable">$diskBlob</span> <span class="literal">-Container</span> <span class="string">"vhds"</span> <span class="literal">-Context</span> <span class="variable">$ctx</span> <span class="literal">-Verbose</span></span><br><span class="line"><span class="built_in">Remove-AzureNetworkInterface</span> <span class="literal">-Name</span> <span class="variable">$nicName</span> <span class="literal">-ResourceGroupName</span> <span class="variable">$resourceGroupName</span> <span class="literal">-Force</span> <span class="literal">-Verbose</span></span><br><span class="line"><span class="built_in">Remove-AzurePublicIpAddress</span> <span class="literal">-Name</span> <span class="variable">$publicIpName</span> <span class="literal">-ResourceGroupName</span> <span class="variable">$resourceGroupName</span> <span class="literal">-Force</span> <span class="literal">-Verbose</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># copy backup disk</span></span><br><span class="line"><span class="variable">$copy</span> = <span class="built_in">Start-AzureStorageBlobCopy</span> <span class="literal">-SrcBlob</span> <span class="variable">$backupDiskBlob</span> <span class="literal">-SrcContainer</span> <span class="string">"vhds"</span> <span class="literal">-DestBlob</span> <span class="variable">$diskBlob</span> <span class="literal">-DestContainer</span> <span class="string">"vhds"</span> <span class="literal">-Context</span> <span class="variable">$ctx</span> <span class="literal">-Verbose</span></span><br><span class="line"><span class="variable">$status</span> = <span class="variable">$copy</span> | <span class="built_in">Get-AzureStorageBlobCopyState</span> </span><br><span class="line"><span class="variable">$status</span> </span><br><span class="line"></span><br><span class="line"><span class="keyword">While</span>(<span class="variable">$status</span>.Status <span class="operator">-eq</span> <span class="string">"Pending"</span>)&#123;</span><br><span class="line">  <span class="variable">$status</span> = <span class="variable">$copy</span> | <span class="built_in">Get-AzureStorageBlobCopyState</span> </span><br><span class="line">  <span class="built_in">Start-Sleep</span> <span class="number">10</span></span><br><span class="line">  <span class="variable">$status</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># recreate VM</span></span><br><span class="line"><span class="variable">$vnet</span> = <span class="built_in">Get-AzurevirtualNetwork</span> <span class="literal">-Name</span> <span class="variable">$vnetName</span> <span class="literal">-ResourceGroupName</span> <span class="variable">$resourceGroupName</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$pip</span> = <span class="built_in">New-AzurePublicIpAddress</span> <span class="literal">-Name</span> <span class="variable">$publicIpName</span> <span class="literal">-ResourceGroupName</span> <span class="variable">$resourceGroupName</span> <span class="literal">-DomainNameLabel</span> <span class="variable">$dnsName</span> <span class="literal">-Location</span> <span class="variable">$location</span> <span class="literal">-AllocationMethod</span> Dynamic <span class="literal">-Verbose</span></span><br><span class="line"><span class="variable">$nic</span> = <span class="built_in">New-AzureNetworkInterface</span> <span class="literal">-Name</span> <span class="variable">$nicName</span> <span class="literal">-ResourceGroupName</span> <span class="variable">$resourceGroupName</span> <span class="literal">-Location</span> <span class="variable">$location</span> <span class="literal">-SubnetId</span> <span class="variable">$vnet</span>.Subnets[<span class="variable">$subnetIndex</span>].Id <span class="literal">-PublicIpAddressId</span> <span class="variable">$pip</span>.Id <span class="literal">-Verbose</span></span><br><span class="line"><span class="variable">$vm</span> = <span class="built_in">New-AzureVMConfig</span> <span class="literal">-VMName</span> <span class="variable">$vmName</span> <span class="literal">-VMSize</span> <span class="variable">$vmSize</span></span><br><span class="line"><span class="variable">$vm</span> = <span class="built_in">Add-AzureVMNetworkInterface</span> <span class="literal">-VM</span> <span class="variable">$vm</span> <span class="literal">-Id</span> <span class="variable">$nic</span>.Id</span><br><span class="line"><span class="variable">$vm</span> = <span class="built_in">Set-AzureVMOSDisk</span> <span class="literal">-VM</span> <span class="variable">$vm</span> <span class="literal">-Name</span> <span class="variable">$diskName</span> <span class="literal">-VhdUri</span> <span class="variable">$vhdUri</span> <span class="literal">-CreateOption</span> attach <span class="literal">-Windows</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">New-AzureVM</span> <span class="literal">-ResourceGroupName</span> <span class="variable">$resourceGroupName</span> <span class="literal">-Location</span> <span class="variable">$location</span> <span class="literal">-VM</span> <span class="variable">$vm</span> <span class="literal">-Verbose</span></span><br></pre></td></tr></table></figure>
	        </div>

            
            <section id="comments">
            <div id="disqus_thread">
                <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript" target="_blank" rel="noopener">comments powered by Disqus.</a></noscript>
            </div>
            </section>
            
		</div>
	</div>
<!--MAIN CONTENT ENDS-->

<!--SIDEBAR CONTENT STARTS-->
	<div class="SubpageBoxSubSm">
		<div class="SubpageBoxSubSmContent">
			
			

			<div class="ProfileImg">
				
				<a href="/bios/dylan_smith">
				
					<img src='/images/avatars/dylan_300x300.jpg' />
				
				</a>
				
			</div>

			<BR clear="all">

			<h2><a href="/bios/dylan_smith">Dylan Smith</a></h2>
			
			<a href="mailto:optikal@shaw.ca"><img class="ProfileIcon" src="/images/icon_email.png" border="0" alt="Email" title="Email"> Email</a><BR>
			
			
			<a href="http://www.geekswithblogs.net/optikal" target="_blank"><img class="ProfileIcon" src="/images/icon_web.png" border="0" alt="Web" title="Web"> Web</a><BR>
			
			
			<a href="http://twitter.com/dylan_smith" target="_blank"><img class="ProfileIcon" src="/images/icon_twitter.png" border="0" alt="Twitter" title="Twitter"> Twitter</a><BR>
			
			
			
			
 			<a href="/feeds/dylan_smith.xml"><img class="ProfileIcon" src="/images/icon_subscribe.png" /> RSS</a>
			

			<hr />
			<h4>Looking for someone else?</h4>
			<p>You can find the rest of the Western Devs Crew <a href="/whoweare">here</a>.</p>
		</div>
	</div>
<!--SIDEBAR CONTENT ENDS-->


</div>
</center>
<!--PAGE CONTENT ENDS-->


<!--FOOTER STARTS-->
<center>
  <div class="FooterBarTxt">&copy; 2015 Western Devs. All Rights Reserved. Design by <a href="http://www.karenchudobiak.ca" target="_blank">Karen Chudobiak, Graphic Designer</a></div>
</center>
<!--FOOTER ENDS-->

<!-- NAV FOOTER STARTS -->
<div class="NavFooter">
  <a href="/posts" alt="Posts"><i class="fa fa-newspaper-o fa-2x"></i><span>Posts</span></a>
  <a href="/podcasts" alt="Podcasts"><i class="fa fa-volume-up fa-2x"></i><span>Podcasts</span></a>
  <a href="/whoweare" alt="About"><i class="fa fa-star fa-2x"></i><span>About</span></a>
  <a href="/whatwevedone" alt="What We've Done"><i class="fa fa-trophy fa-2x"></i><span>Work</span></a>
  <a href="/speaking" alt="Speaking"><i class="fa fa-comment-o fa-2x fa-flip-horizontal"></i><span>Speaking</span></a>
</div>
<!-- NAV FOOTER ENDS -->




</div>
<!--WRAPPER ENDS-->


<script>
  var disqus_shortname = 'westerndevs';
  
  var disqus_url = 'https://westerndevs.com/_/azure-snapshots/'.replace(".com//", ".com/");
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
  
function shuffle(array) {
  var currentIndex = array.length, temporaryValue, randomIndex;

  // While there remain elements to shuffle...
  while (0 !== currentIndex) {

    // Pick a remaining element...
    randomIndex = Math.floor(Math.random() * currentIndex);
    currentIndex -= 1;

    // And swap it with the current element.
    temporaryValue = array[currentIndex];
    array[currentIndex] = array[randomIndex];
    array[randomIndex] = temporaryValue;
  }

  return array;
}

</script>


</body>

  
<!-- Google Analytics -->
<script type="text/javascript">
if (document.location.hostname.search("westerndevs.com") !== -1 || document.location.hostname.search("www.westerndevs.com") !== -1) {
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-37617956-2', 'auto');

ga('set', 'contentGroup1', 'dylan_smith');

ga('send', 'pageview');
}
</script>
<!-- End Google Analytics -->



</html>
