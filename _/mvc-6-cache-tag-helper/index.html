<!DOCTYPE html>
<html lang="en" xml:lang="en">

  <head>
  
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>MVC 6 cache tag helper | Western Devs</title>
  <meta name="description" content="In this post in my series exploring the ASP.NET 5 MVC 6 tag helpers, I will dig into the Cache Tag Helper. The Cache Tag Helper is a little different than most of the other tag helpers we talked about">
<meta property="og:type" content="article">
<meta property="og:title" content="MVC 6 cache tag helper">
<meta property="og:url" content="https://westerndevs.com/_/mvc-6-cache-tag-helper/index.html">
<meta property="og:site_name" content="Western Devs">
<meta property="og:description" content="In this post in my series exploring the ASP.NET 5 MVC 6 tag helpers, I will dig into the Cache Tag Helper. The Cache Tag Helper is a little different than most of the other tag helpers we talked about">
<meta property="article:published_time" content="2015-06-04T00:09:05.000Z">
<meta property="article:modified_time" content="2024-09-15T21:09:05.410Z">
<meta property="article:author" content="Western Devs">
<meta name="twitter:card" content="summary">
<meta name="twitter:creator" content="@westerndevs">

    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="title" content="WesternDevs">   
    <meta name="keywords" content="software development,software,asp.net,blog">
    <meta name="description" content="We're all west of somewhere">
    <meta name="copyright" content="WesternDevs">
    <meta name="revisit-after" content="15 days">
    <meta name="robots" content="all">
    <meta name="MSSmartTagsPreventParsing" content="true">
  
    <link rel="canonical" href="http://www.davepaquette.com/archive/2015/06/03/mvc-6-cache-tag-helper.aspx">
  
  
    <link rel="alternate" href="/feed.xml" title="Western Devs" type="application/atom+xml">
  
  
<link rel="stylesheet" href="/css/style.css">

      
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <script src="//code.jquery.com/jquery-1.11.3.min.js"></script>  
  <meta name="generator" content="Hexo 4.2.1"></head>

<body>

<!-- FIXED HEADER BECAUSE SCROLLING -->
<!--HEADER STARTS-->
<div class="WrapperHeader">
<div style="display:inline-block; text-align: center;">
<div class="Header">

  <div class="HeaderLogo">
    <a href="/"><img src="/images/header_logo_transparent.png" alt="WesternDevs" title="WesternDevs" border="0" style="width: 206px; height: 64px;" width="206" height="64"></a>
  </div>

  <div class="HeaderLinks">
      <a href="/posts" class="nav">POSTS</a>       
      <a href="/podcasts" class="nav">PODCASTS</a>       
      <a href="/whoweare" class="nav">ABOUT</a>  
      <a href="/whatwevedone" class="nav">WHAT WE'VE DONE</a>  
      <a href="/speaking" class="nav">SPEAKING</a>
      <div class="HeaderIcons">
        <a href="mailto:info@westerndevs.com"><img src="/images/icon_email.png" border="0" alt="Email" title="Email" height="26" width="26"></a>
        <a href="/feed.xml"><img src="/images/icon_subscribe.png" border="0" alt="Subscribe" title="Subscribe" height="26" width="27"></a>
        <a href="http://twitter.com/westerndevs" target="_blank"><img src="/images/icon_twitter.png" border="0" alt="Twitter" title="Twitter" height="26" width="27"></a>
        <a href="http://github.com/westerndevs" target="_blank"><img src="/images/icon_github.png" border="0" alt="GitHub" title="GitHub" height="26" width="27"></a>     
      </div>
  </div>
  
</div>
</div>
</div>
<!--HEADER ENDS-->    



<!--WRAPPER STARTS-->
<div class="Wrapper" style="">

<!--SUBHEAD STARTS-->
<div class="WrapperSubHeaderSubpage">
<center>
	<div class="SubHeader">
		<H1 class="title"><img class="icon" src="/images/icon_posts.png" alt="POST" title="POST" border="0"> POST</H1>
	</div>
</center>
</div>
<!--SUBHEAD ENDS-->

<!--PAGE CONTENT STARTS-->
<center>
<div class="WrapperContent">

<!--MAIN CONTENT STARTS-->
	<div class="SubpageBoxSubLrg">
		<div class="SubpageBoxSubLrgContent">
		    <div class='postTitle'>
  <div class="ListLrgDateBG">
    <div class="ListLrgDateMonth">JUN</div>
    <div class="ListLrgDateDay">4</div>
    <div class="ListLrgDateYear">2015</div>
  </div>
  <h2>MVC 6 cache tag helper</h2>
</div>

		    

<p class="TXTsm">ORIGINALLY POSTED TO: <a href="http://www.davepaquette.com/archive/2015/06/03/mvc-6-cache-tag-helper.aspx" target="_blank" rel="noopener" class='originalurl'>http://www.davepaquette.com/archive/2015/06/03/mvc-6-cache-tag-helper.aspx</a></p>



			<div id="mainPostContent">
	        <p>In this post in my series exploring the ASP.NET 5 MVC 6 tag helpers, I will dig into the Cache Tag Helper. The Cache Tag Helper is a little different than most of the other tag helpers we talked about because it doesn't target a standard HTML tag. Instead, it wraps arbitrary content and allows those contents to be cached in memory based on the parameters you specify.</p>
<a id="more"></a>
<h2>How it works?</h2>
<p>Simply wrap the contents you want cached with a __ tag and the contents of the tag will be cached in memory. Before processing the contents of the cache tag, the tag helper will check to see if the contents have been stored in the MemoryCache. If the contents are found in the cache, then the cached contents are sent to Razor. If the contents are not found, then Razor will process the contents and the tag helper will store it in the memory cache for next time. By default, the cache tag helper is able to generate a unique ID based on the context of the cache tag helper.</p>
<p>Here is a simply example that would cache the output of a view component for 10 minutes.</p>
<pre><code>&lt;cache expires-after=&quot;@TimeSpan.FromMinutes(10)&quot;&gt;    
    @Html.Partial(&quot;_WhatsNew&quot;)
    *last updated  @DateTime.Now.ToLongTimeString()
&lt;/cache&gt;
</code></pre>
<p>The Cache tag will not be included in the generated HTML. It is purely a server side tag. In the example above, only the results of the <em>WhatsNew</em> partial view and the _*last updated _text would be sent to the browser. Any subsequent requests within the 10 minute span simply return the cached contents instead of calling the partial view again. On the first request after the 10 minutes has passed, the contents would be regenerated and cached again for another10 minutes.</p>
<blockquote>
<p>Note, this should work out-of-the box but there is a strange bug with the way the memory cache is initialized in MVC 6 beta 4. For the cache to work properly in this version, add _services.AddSingleton(); _to the end of your Startup.ConfigurServices method.</p>
</blockquote>
<h2>Cache Expiry</h2>
<p>If no specific expiry is specified, the contents will be cached as long as the memory cache decides to hang on to the item which is likely the lifetime of the application. Chances are this is not the behaviour you want. You will likely want to use one of the 3 options for expiring the cached contents for the Cache Tag Helper: expires-after, expires-on and expires-sliding.</p>
<h4>expires-after</h4>
<p>Use the <em>expires-after</em> attribute to expire the cache entry after a specific amount of time has passed since it was added to the cache. This attribute expects a TimeSpan value. For example, you expire an item 5 seconds after it was cached:</p>
<pre><code>&lt;cache expires-after=&quot;@TimeSpan.FromSeconds(5)&quot;&gt;
    &lt;!--View Component or something that gets data from the database--&gt;
    *last updated  @DateTime.Now.ToLongTimeString()
&lt;/cache&gt;  
</code></pre>
<h4>expires-on</h4>
<p>Use the _expires-on _attribute to expire the cache entry at a specific time. This attribute expects a DateTime value. For example, imagine your system has some backend processing that you know will be updated by the end of each day. You could specify the cache to expire at the end of the day as follows:</p>
<pre><code>&lt;cache expires-on=&quot;@DateTime.Today.AddDays(1).AddTicks(-1)&quot;&gt;
    &lt;!--View Component or something that gets data from the database--&gt;
    *last updated  @DateTime.Now.ToLongTimeString()
&lt;/cache&gt;  
</code></pre>
<h4>expires-sliding</h4>
<p>Use the <em>expires-sliding</em> attribute to expire the cache entry after it has not been accessed for a specified amount of time. This attribute expects a TimeSpan value.</p>
<pre><code>&lt;cache expires-sliding=&quot;@TimeSpan.FromMinutes(5)&quot;&gt;
    &lt;!--View Component or something that gets data from the database--&gt;
    *last updated  @DateTime.Now.ToLongTimeString()
&lt;/cache&gt;   
</code></pre>
<h2>Vary-by / Complex Cache Keys</h2>
<p>The cache tag helper builds cache keys by generating an id that is unique to the context of the cache tag. This ensures that you can have multiple cache tags on a single page and the contents will not override each other in the cache. You can also tell the tag helper to build more complex cache keys using a combination of the <em>vary-by</em> attributes. Building these complex keys allows the cache tag helper to cache different contents for different requests based on nearly any criteria you can conceive. A very simple example is caching different contents for each user by adding the <em>vary-by-user</em> attribute:</p>
<pre><code>&lt;cache vary-by-user=&quot;true&quot;&gt;
    &lt;!--View Component or something that gets data from the database--&gt;
    *last updated @DateTime.Now.ToLongTimeString()
&lt;/cache&gt;
</code></pre>
<p>You can specify any combination of <em>vary-by</em> attributes. The cache tag helper will build a key that is a composite of the generated unique id for that tag plus all the values from the <em>vary-by</em> attributes.</p>
<h4>vary-by-user</h4>
<p>Use this attribute to cache different contents for each logged in user. The username for the logged in user will be added to the cache key. This attribute expects a boolean value. <em>See example above.</em></p>
<h4>vary-by-route</h4>
<p>Use this attribute to cache different contents based on a set of route data parameters. This attribute expects a comma-separated list of route data parameter names. The values of those route parameters will be added to the cache key.</p>
<p>For example, the following cache tag would cache different contents based on the <em>id</em> route parameter:</p>
<pre><code>&lt;cache vary-by-route=&quot;id&quot;&gt;
    &lt;!--View Component or something that gets data from the database--&gt;
    *last updated  @DateTime.Now.ToLongTimeString()
&lt;/cache&gt;  
</code></pre>
<h4>vary-by-query</h4>
<p>The <em>vary-by-query</em> attribute allows you to cache different contents based on the query parameters for the current request. This attribute expects a comma-separated list of query string parameter names. The value of those query string parameters will be added to the cache key.</p>
<p>For example, the following cache tag would cache different contents for each unique value of the <em>search</em> query parameter:</p>
<pre><code>&lt;cache vary-by-query=&quot;search&quot;&gt;
    &lt;!--View Component or something that gets data from the database--&gt;
    *last updated  @DateTime.Now.ToLongTimeString()
&lt;/cache&gt;
</code></pre>
<h4>vary-by-cookie</h4>
<p>The <em>vary-by-cookie</em> attributes allows you to cache different contents based on values stored in a cookie. This attribute expects a comma-separated list of cookie names. The values of the specified cookie names will be added to the cache key.</p>
<p>For example, the following cache tag would cache different contents based on the value of the <em>MyAppCookie</em>.</p>
<pre><code>&lt;cache vary-by-cookie=&quot;MyAppCookie&quot;&gt;
    &lt;!--View Component or something that gets data from the database--&gt;
    *last updated  @DateTime.Now.ToLongTimeString()
&lt;/cache&gt;
</code></pre>
<h4>vary-by-header</h4>
<p>The <em>vary-by-header</em> attribute allows you to cache different contents based on the value of a specific request header. This attribute expects a single header name. For example, the following cache tag would cache different results based on the User-Agent header:</p>
<pre><code>&lt;cache vary-by-header=&quot;User-Agent&quot;&gt;
    &lt;!--View Component or something that gets data from the database--&gt;
    *last updated  @DateTime.Now.ToLongTimeString()
&lt;/cache&gt;
</code></pre>
<h4>vary-by</h4>
<p>Finally, the <em>vary-by</em> attribute allows you to cache different contents based on any arbitrary string value. This attribute can be used as a fall-back in case any of the other vary-by attributes do not meet your needs.</p>
<p>For example, the following cache tag would cache different results based on the value of a ProductId that is available on the ViewBag:</p>
<pre><code>&lt;cache vary-by=&quot;@ViewBag.ProductId&quot;&gt;
    &lt;!--View Component or something that gets data from the database--&gt;
    *last updated  @DateTime.Now.ToLongTimeString()
&lt;/cache&gt;  
</code></pre>
<h4>Complex Keys</h4>
<p>As mentioned earlier, you can specify any number of vary-by parameters and the cache tag helper will build a composite key. Here is an example of a cache tag that will cache different results for each user and <em>id</em> route parameter:</p>
<pre><code>&lt;cache vary-by-user=&quot;true&quot; vary-by-route=&quot;id&quot;&gt;
    &lt;!--View Component or something that gets data from the database--&gt;
    *last updated  @DateTime.Now.ToLongTimeString()
&lt;/cache&gt;  
</code></pre>
<h2>Cache Priority</h2>
<p>The contents of a cache tag are stored in an IMemoryCache which is limited by the amount of available memory. If the host process starts to run out of memory, the memory cache might purge items from the cache to release memory. In cases like this, you can tell the memory cache which items are considered a lower priority using the _priority _attribute. For example, the following cache tag is specified as low priority:</p>
<pre><code>@using Microsoft.Framework.Caching.Memory

&lt;cache vary-by-user=&quot;true&quot;
       priority=&quot;@CachePreservationPriority.Low&quot;&gt;
    &lt;!--View Component or something that gets data from the database--&gt;
    *last updated  @DateTime.Now.ToLongTimeString()
&lt;/cache&gt;
</code></pre>
<p>Possible values for CacheItemPriority are Low, Normal, High and NeverRemove.</p>
<p>The <a href="https://github.com/aspnet/Mvc/blob/dev/src/Microsoft.AspNetCore.Mvc.TagHelpers/CacheTagHelper.cs" target="_blank" rel="noopener">CacheTagHelper implementation</a> uses an instance of an IMemoryCache which stores cache entries in memory in the local process. Anything that causes the host process to shutdown / restart will cause a full loss of all entries in the cache. For example, restarting an IIS App Pool or scaling down an Azure instance would cause the memory cache to reset. In this case, the CacheTagHelper would rebuild the contents on the next request. In a cloud service like Azure you never know when your website might get moved to a new server so this could happen at any time. The <a href="https://github.com/aspnet/Caching/blob/dev/src/Microsoft.Extensions.Caching.Memory/MemoryCache.cs" target="_blank" rel="noopener">MemoryCache</a> is not a durable storage mechanism so it is important not to treat it as one.</p>
<p>Another important scenario to consider is when you have multiple load balanced servers. You might get strange / unexpected results if you have <a href="https://technet.microsoft.com/en-us/library/dd443543(v=ws.10).aspx" target="_blank" rel="noopener">server affinity / application request routing</a> turned off. The <a href="https://github.com/aspnet/Caching/blob/dev/src/Microsoft.Extensions.Caching.Memory/MemoryCache.cs" target="_blank" rel="noopener">MemoryCache</a> is not a distributed cache. Each server would have it's own memory cache with potentially different contents for each cache tag helper. If the client refreshes a page 3 times and those requests are routed to 3 different servers, then the client could potentially see 3 different contents. Depending on the scenario, this could be very confusing for the user. The solution here would be to avoid turning off ARR / server affinity in a load balanced deployment scenario. By turning this feature on you will ensure that a specific client's requests are always routed to the same server.</p>
<p>The Cache cache tag helper is one of the more unique tag helpers in MVC 6. It provides a flexible and convenient approach to caching the output of a portion of a page and can be a useful tool for improving performance of MVC 6 applications.</p>
<p><em>May 4, 2015: Updated with Limitations sections as suggested by Rick Anderson in the comments</em></p>

	        </div>

            
            <section id="comments">
            <div id="disqus_thread">
                <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript" target="_blank" rel="noopener">comments powered by Disqus.</a></noscript>
            </div>
            </section>
            
		</div>
	</div>
<!--MAIN CONTENT ENDS-->

<!--SIDEBAR CONTENT STARTS-->
	<div class="SubpageBoxSubSm">
		<div class="SubpageBoxSubSmContent">
			
			

			<div class="ProfileImg">
				
				<a href="/bios/dave_paquette">
				
					<img src='/images/avatars/DavePaquette_241x241.jpg' />
				
				</a>
				
			</div>

			<BR clear="all">

			<h2><a href="/bios/dave_paquette">Dave Paquette</a></h2>
			
			<a href="mailto:contactme@davepaquette.com"><img class="ProfileIcon" src="/images/icon_email.png" border="0" alt="Email" title="Email"> Email</a><BR>
			
			
			<a href="http://www.davepaquette.com/" target="_blank"><img class="ProfileIcon" src="/images/icon_web.png" border="0" alt="Web" title="Web"> Web</a><BR>
			
			
			<a href="http://twitter.com/Dave_Paquette" target="_blank"><img class="ProfileIcon" src="/images/icon_twitter.png" border="0" alt="Twitter" title="Twitter"> Twitter</a><BR>
			
			
			<a href="https://github.com/dpaquette" target="_blank"><img class="ProfileIcon" src="/images/icon_github.png" border="0" alt="GitHub" title="GitHub"> GitHub</a><br>
			
			
			
 			<a href="/feeds/dave_paquette.xml"><img class="ProfileIcon" src="/images/icon_subscribe.png" /> RSS</a>
			

			<hr />
			<h4>Looking for someone else?</h4>
			<p>You can find the rest of the Western Devs Crew <a href="/whoweare">here</a>.</p>
		</div>
	</div>
<!--SIDEBAR CONTENT ENDS-->


</div>
</center>
<!--PAGE CONTENT ENDS-->


<!--FOOTER STARTS-->
<center>
  <div class="FooterBarTxt">&copy; 2015 Western Devs. All Rights Reserved. Design by <a href="http://www.karenchudobiak.ca" target="_blank">Karen Chudobiak, Graphic Designer</a></div>
</center>
<!--FOOTER ENDS-->

<!-- NAV FOOTER STARTS -->
<div class="NavFooter">
  <a href="/posts" alt="Posts"><i class="fa fa-newspaper-o fa-2x"></i><span>Posts</span></a>
  <a href="/podcasts" alt="Podcasts"><i class="fa fa-volume-up fa-2x"></i><span>Podcasts</span></a>
  <a href="/whoweare" alt="About"><i class="fa fa-star fa-2x"></i><span>About</span></a>
  <a href="/whatwevedone" alt="What We've Done"><i class="fa fa-trophy fa-2x"></i><span>Work</span></a>
  <a href="/speaking" alt="Speaking"><i class="fa fa-comment-o fa-2x fa-flip-horizontal"></i><span>Speaking</span></a>
</div>
<!-- NAV FOOTER ENDS -->




</div>
<!--WRAPPER ENDS-->


<script>
  var disqus_shortname = 'westerndevs';
  
  var disqus_url = 'https://westerndevs.com/_/mvc-6-cache-tag-helper/'.replace(".com//", ".com/");
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
  
function shuffle(array) {
  var currentIndex = array.length, temporaryValue, randomIndex;

  // While there remain elements to shuffle...
  while (0 !== currentIndex) {

    // Pick a remaining element...
    randomIndex = Math.floor(Math.random() * currentIndex);
    currentIndex -= 1;

    // And swap it with the current element.
    temporaryValue = array[currentIndex];
    array[currentIndex] = array[randomIndex];
    array[randomIndex] = temporaryValue;
  }

  return array;
}

</script>


</body>

  
<!-- Google Analytics -->
<script type="text/javascript">
if (document.location.hostname.search("westerndevs.com") !== -1 || document.location.hostname.search("www.westerndevs.com") !== -1) {
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-37617956-2', 'auto');

ga('set', 'contentGroup1', 'dave_paquette');

ga('send', 'pageview');
}
</script>
<!-- End Google Analytics -->



</html>
