<!DOCTYPE html>
<html lang="en" xml:lang="en">

  <head>
  
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>Azure AD B2C Web Testing | Western Devs</title>
  <meta name="description" content="Login Azure AD B2C User with Postman Recently a customer asked how to load test a web application that uses Azure AD B2C (OpenIdConnect) for authentication. Even though there are lots of articles on c">
<meta property="og:type" content="article">
<meta property="og:title" content="Azure AD B2C Web Testing">
<meta property="og:url" content="https://westerndevs.com/_/Azure-AD-B2C-Web-Testing/index.html">
<meta property="og:site_name" content="Western Devs">
<meta property="og:description" content="Login Azure AD B2C User with Postman Recently a customer asked how to load test a web application that uses Azure AD B2C (OpenIdConnect) for authentication. Even though there are lots of articles on c">
<meta property="og:image" content="https://tylerdevblog.blob.core.windows.net/content/2019-11-14-Azure-AD-B2C-Web-Testing/1.png">
<meta property="og:image" content="https://tylerdevblog.blob.core.windows.net/content/2019-11-14-Azure-AD-B2C-Web-Testing/2.png">
<meta property="og:image" content="https://tylerdevblog.blob.core.windows.net/content/2019-11-14-Azure-AD-B2C-Web-Testing/3.png">
<meta property="og:image" content="https://tylerdevblog.blob.core.windows.net/content/2019-11-14-Azure-AD-B2C-Web-Testing/4.png">
<meta property="og:image" content="https://tylerdevblog.blob.core.windows.net/content/2019-11-14-Azure-AD-B2C-Web-Testing/5.png">
<meta property="article:published_time" content="2019-11-15T05:00:00.000Z">
<meta property="article:modified_time" content="2024-07-31T16:02:00.642Z">
<meta property="article:author" content="Western Devs">
<meta property="article:tag" content="Azure">
<meta property="article:tag" content="AzureAD">
<meta property="article:tag" content="Azure AD B2C">
<meta property="article:tag" content="Postman">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://tylerdevblog.blob.core.windows.net/content/2019-11-14-Azure-AD-B2C-Web-Testing/1.png">
<meta name="twitter:creator" content="@westerndevs">

    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="title" content="WesternDevs">   
    <meta name="keywords" content="software development,software,asp.net,blog">
    <meta name="description" content="We're all west of somewhere">
    <meta name="copyright" content="WesternDevs">
    <meta name="revisit-after" content="15 days">
    <meta name="robots" content="all">
    <meta name="MSSmartTagsPreventParsing" content="true">
  
  
    <link rel="alternate" href="/feed.xml" title="Western Devs" type="application/atom+xml">
  
  
<link rel="stylesheet" href="/css/style.css">

      
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <script src="//code.jquery.com/jquery-1.11.3.min.js"></script>  
  <meta name="generator" content="Hexo 4.2.1"></head>

<body>

<!-- FIXED HEADER BECAUSE SCROLLING -->
<!--HEADER STARTS-->
<div class="WrapperHeader">
<div style="display:inline-block; text-align: center;">
<div class="Header">

  <div class="HeaderLogo">
    <a href="/"><img src="/images/header_logo_transparent.png" alt="WesternDevs" title="WesternDevs" border="0" style="width: 206px; height: 64px;" width="206" height="64"></a>
  </div>

  <div class="HeaderLinks">
      <a href="/posts" class="nav">POSTS</a>       
      <a href="/podcasts" class="nav">PODCASTS</a>       
      <a href="/whoweare" class="nav">ABOUT</a>  
      <a href="/whatwevedone" class="nav">WHAT WE'VE DONE</a>  
      <a href="/speaking" class="nav">SPEAKING</a>
      <div class="HeaderIcons">
        <a href="mailto:info@westerndevs.com"><img src="/images/icon_email.png" border="0" alt="Email" title="Email" height="26" width="26"></a>
        <a href="/feed.xml"><img src="/images/icon_subscribe.png" border="0" alt="Subscribe" title="Subscribe" height="26" width="27"></a>
        <a href="http://twitter.com/westerndevs" target="_blank"><img src="/images/icon_twitter.png" border="0" alt="Twitter" title="Twitter" height="26" width="27"></a>
        <a href="http://github.com/westerndevs" target="_blank"><img src="/images/icon_github.png" border="0" alt="GitHub" title="GitHub" height="26" width="27"></a>     
      </div>
  </div>
  
</div>
</div>
</div>
<!--HEADER ENDS-->    



<!--WRAPPER STARTS-->
<div class="Wrapper" style="">

<!--SUBHEAD STARTS-->
<div class="WrapperSubHeaderSubpage">
<center>
	<div class="SubHeader">
		<H1 class="title"><img class="icon" src="/images/icon_posts.png" alt="POST" title="POST" border="0"> POST</H1>
	</div>
</center>
</div>
<!--SUBHEAD ENDS-->

<!--PAGE CONTENT STARTS-->
<center>
<div class="WrapperContent">

<!--MAIN CONTENT STARTS-->
	<div class="SubpageBoxSubLrg">
		<div class="SubpageBoxSubLrgContent">
		    <div class='postTitle'>
  <div class="ListLrgDateBG">
    <div class="ListLrgDateMonth">NOV</div>
    <div class="ListLrgDateDay">15</div>
    <div class="ListLrgDateYear">2019</div>
  </div>
  <h2>Azure AD B2C Web Testing</h2>
</div>

		    

			<div id="mainPostContent">
	        <h2>Login Azure AD B2C User with Postman</h2>
<p>Recently a customer asked how to load test a web application that uses Azure AD B2C (OpenIdConnect) for authentication. Even though there are lots of articles on calling Web APIs with OAuth tokens, I could not find much info on automating the <a href="https://docs.microsoft.com/en-us/azure/active-directory/develop/v2-protocols-oidc" target="_blank" rel="noopener">OpenIdConnect authentication flow</a>.</p>
<p>I thought that if I could execute the correct requests in Postman I should be able to create an automated web/load test.</p>
<a id="more"></a>
<p><strong>Problem:</strong> Azure AD B2C login pages rely on Javascript. Postman (and most load testing frameworks like JMeter) do not run client-side Javascript.</p>
<p>In order to get around this, you need to &quot;fake&quot; the functionality of the Javascript code to create the subsequent requests.</p>
<p>Lets break down the auth flow into 5 steps, and outline how to craft the request in Postman. Specifically, I want to test a &quot;username and password&quot; type B2C user, not a &quot;social login (MS Live, Google, Facebook)&quot; type user.</p>
<blockquote>
<p>Note: This article is based on the <a href="https://github.com/Azure-Samples/active-directory-b2c-dotnetcore-webapp" target="_blank" rel="noopener">Azure AD B2C ASP.NET Core Web App Sample</a> on Github, as of Nov 2019. To setup the sample just clone the repo, execute <code>dotnet run</code>, and sign up a new user.</p>
</blockquote>
<h3>Step 1: Initial GET Request</h3>
<p>First, <strong>turn off auto-redirect</strong> and send an initial GET request to your site root or signin route.</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET http:<span class="regexp">//</span>localhost:<span class="number">5000</span><span class="regexp">/Session/</span>SignIn</span><br></pre></td></tr></table></figure>
<p>The response should have a <strong>Location</strong> header with the full URL and query string for the Authorize request.</p>
<p>Specifically, we are interested in the <strong>state</strong> and <strong>nonce</strong> values, which will be different each time.</p>
<h3>Step 2: AAD Authorize Request</h3>
<p>If you grab the <strong>Location</strong> redirect header from the previous step it should look like this</p>
<p><a href="https://tylerdevblog.blob.core.windows.net/content/2019-11-14-Azure-AD-B2C-Web-Testing/1.png" target="_blank" rel="noopener"><img src="https://tylerdevblog.blob.core.windows.net/content/2019-11-14-Azure-AD-B2C-Web-Testing/1.png" alt="Postman screenshot of authorize request"></a></p>
<p>While some information may be different based on your application, the following should be standard for OpenIdConnect</p>
<ul>
<li>response_type is &quot;code id_token&quot;</li>
<li>scope includes &quot;openid&quot;</li>
</ul>
<p>The <strong>response_mode</strong> is important to note, this will setup the flow to send the code back to your application using either a query string or form post mechanism.</p>
<p>When you execute this request you should get a <strong>200 OK</strong> response, even though the content will say that you need Javascript to continue.</p>
<p><img src="https://tylerdevblog.blob.core.windows.net/content/2019-11-14-Azure-AD-B2C-Web-Testing/2.png" alt="Postman screenshot of authorize result viewing the preview tab"></p>
<p>Don't panic. It did work as expected.</p>
<p>From here we need to extract some information from the body of the response, which I will outline in the next step.</p>
<h3>Step 3: Login Request</h3>
<p>To build the Login request and pass the username+password, we need some information from the body of the Authorize request.</p>
<p>Scroll down in Postman until you find <code>var SETTINGS = { ...</code> in a <strong>&lt;script&gt;</strong> tag.</p>
<p>Copy the <strong>csrf</strong> and <strong>transId</strong> values from the SETTINGS JSON object.</p>
<p><a href="https://tylerdevblog.blob.core.windows.net/content/2019-11-14-Azure-AD-B2C-Web-Testing/3.png" target="_blank" rel="noopener"><img src="https://tylerdevblog.blob.core.windows.net/content/2019-11-14-Azure-AD-B2C-Web-Testing/3.png" alt="Postman screenshot of SETTINGS variable highlighting csrf and transId values"></a></p>
<p>You can add them to the Postman environment or global variables, so in the future I will refer to these values with <strong>csrf</strong> and <strong>transId</strong></p>
<p>Create a new POST request with this url and header</p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">POST <span class="symbol">https:</span>/<span class="regexp">/fabrikamb2c.b2clogin.com/fabrikamb</span>2c.onmicrosoft.com/B2C_1_SUSI/SelfAsserted?tx=<span class="template-variable">&#123;&#123;transId&#125;&#125;</span>&amp;p=B2C_1_SUSI</span><br><span class="line">X-CSRF-<span class="symbol">TOKEN:</span> <span class="template-variable">&#123;&#123;csrf&#125;&#125;</span></span><br></pre></td></tr></table></figure>
<p>Note that <code>B2C_1_SUSI</code> is the policy name defined in B2C for the &quot;sign-in sign up&quot; auth flow, this may be different for your application.</p>
<p>In the message body, set to <strong>x-www-form-urlencoded</strong> and enter the following info.</p>
<ul>
<li>request_type RESPONSE</li>
<li>logonIdentifier </li>
<li>password </li>
</ul>
<p><img src="https://tylerdevblog.blob.core.windows.net/content/2019-11-14-Azure-AD-B2C-Web-Testing/4.png" alt="Postman screenshot of form body, request_type, loginIdentifier, and password"></p>
<p>Note: The <strong>logonIdentifier</strong> key is configurable in the B2C policy. This may be a different key like &quot;signInName&quot; or &quot;emailAddress&quot; depending on your configuration. Fiddler is your friend here.</p>
<p>Once you execute this request you should receive a <strong>200 OK</strong> with the following response body:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"status"</span>: <span class="string">"200"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>This response also set cookies in Postman which means that other requests are authenticated.  Which is important for the next step.</p>
<h3>Step 4: Generate Auth code and ID Token</h3>
<p>This is fairly straight forward. Now that the session is authenticated we need to request the <strong>code</strong> and <strong>id_token</strong>.</p>
<p>Create a new request with the following URL</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="regexp">//</span>fabrikamb2c.b2clogin.com<span class="regexp">/fabrikamb2c.onmicrosoft.com/</span>B2C_1_SUSI<span class="regexp">/api/</span>CombinedSigninAndSignup<span class="regexp">/confirmed?csrf_token=&#123;&#123;csrf&#125;&#125;&amp;tx=&#123;&#123;tx&#125;&#125;&amp;p=B2C_1_SUSI</span></span><br></pre></td></tr></table></figure>
<p>Note: <strong>CombinedSigninAndSignup</strong> is the name of the configured flow in Azure AD B2C, if you are using a different flow you will need to change this url. Again, try it yourself, Fiddler is your friend here.</p>
<p>If in Step 2 you used <strong>form_post</strong> as the <strong>response_mode</strong> you should recieve a basic HTML site with a form and hidden fields <strong>state</strong>, <strong>code</strong>, <strong>id_token</strong>, and maybe a few others.</p>
<p><img src="https://tylerdevblog.blob.core.windows.net/content/2019-11-14-Azure-AD-B2C-Web-Testing/5.png" alt="Postman screenshot of code and id_token response"></p>
<p>Copy the <strong>state</strong>, <strong>code</strong>, and <strong>id_token</strong> values.</p>
<h3>Step 5: POST Request to site</h3>
<p>Finally, create a POST request to your site with the <strong>state</strong>, <strong>code</strong>, and <strong>id_token</strong> values in <strong>x-www-form-urlencoded</strong></p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">POST <span class="string">http:</span><span class="comment">//localhost:5000/signin-oidc</span></span><br></pre></td></tr></table></figure>
<p>At this point you should be able to load your site as an authenticated user.</p>
<p>If you are getting <strong>Correlation failed</strong> errors, the <strong>state</strong> value does not match an existing OpenIdConnect cookie, you may need to restart the process with an initial Login request to reset the proper cookies, and use the new state though the authentication process.</p>
<p>The good news is that once you have the B2C auth cookie, the /authorize request will return the <strong>state</strong>, <strong>code</strong>, and <strong>id_token</strong> values in form post HTML.</p>
<p>I hope this helps you run end-to-end web tests on your B2C site!</p>
<p><strong>Mileage may vary:</strong> As you can tell, B2C is a highly configurable solution, this article is based on the .NET Core B2C sample found <a href="https://github.com/Azure-Samples/active-directory-b2c-dotnetcore-webapp" target="_blank" rel="noopener">here</a>. Your app will likely have a different configuration. Use Fiddler to capture a login flow and use that as a guide.</p>

	        </div>

            
            <section id="comments">
            <div id="disqus_thread">
                <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript" target="_blank" rel="noopener">comments powered by Disqus.</a></noscript>
            </div>
            </section>
            
		</div>
	</div>
<!--MAIN CONTENT ENDS-->

<!--SIDEBAR CONTENT STARTS-->
	<div class="SubpageBoxSubSm">
		<div class="SubpageBoxSubSmContent">
			
			

			<div class="ProfileImg">
				
				<a href="/bios/tyler_doerksen">
				
					<img src='https://www.gravatar.com/avatar/b7e3ea9b56c49deaf34a3392508ff732?s=200' />
				
				</a>
				
			</div>

			<BR clear="all">

			<h2><a href="/bios/tyler_doerksen">Tyler Doerksen</a></h2>
			
			<a href="mailto:tylergd@outlook.com"><img class="ProfileIcon" src="/images/icon_email.png" border="0" alt="Email" title="Email"> Email</a><BR>
			
			
			<a href="http://blog.tylerdoerksen.ca" target="_blank"><img class="ProfileIcon" src="/images/icon_web.png" border="0" alt="Web" title="Web"> Web</a><BR>
			
			
			<a href="http://twitter.com/tyler_gd" target="_blank"><img class="ProfileIcon" src="/images/icon_twitter.png" border="0" alt="Twitter" title="Twitter"> Twitter</a><BR>
			
			
			<a href="https://github.com/tylerd" target="_blank"><img class="ProfileIcon" src="/images/icon_github.png" border="0" alt="GitHub" title="GitHub"> GitHub</a><br>
			
			
			<a href="https://www.linkedin.com/in/tdoerksen" target="_blank"><img class="ProfileIcon" src="/images/icon_linkedin.png" border="0" alt="LinkedIN" title="LinkedIN"> LinkedIn</a><br>
			
			
 			<a href="/feeds/tyler_doerksen.xml"><img class="ProfileIcon" src="/images/icon_subscribe.png" /> RSS</a>
			

			<hr />
			<h4>Looking for someone else?</h4>
			<p>You can find the rest of the Western Devs Crew <a href="/whoweare">here</a>.</p>
		</div>
	</div>
<!--SIDEBAR CONTENT ENDS-->


</div>
</center>
<!--PAGE CONTENT ENDS-->


<!--FOOTER STARTS-->
<center>
  <div class="FooterBarTxt">&copy; 2015 Western Devs. All Rights Reserved. Design by <a href="http://www.karenchudobiak.ca" target="_blank">Karen Chudobiak, Graphic Designer</a></div>
</center>
<!--FOOTER ENDS-->

<!-- NAV FOOTER STARTS -->
<div class="NavFooter">
  <a href="/posts" alt="Posts"><i class="fa fa-newspaper-o fa-2x"></i><span>Posts</span></a>
  <a href="/podcasts" alt="Podcasts"><i class="fa fa-volume-up fa-2x"></i><span>Podcasts</span></a>
  <a href="/whoweare" alt="About"><i class="fa fa-star fa-2x"></i><span>About</span></a>
  <a href="/whatwevedone" alt="What We've Done"><i class="fa fa-trophy fa-2x"></i><span>Work</span></a>
  <a href="/speaking" alt="Speaking"><i class="fa fa-comment-o fa-2x fa-flip-horizontal"></i><span>Speaking</span></a>
</div>
<!-- NAV FOOTER ENDS -->




</div>
<!--WRAPPER ENDS-->


<script>
  var disqus_shortname = 'westerndevs';
  
  var disqus_url = 'https://westerndevs.com/_/Azure-AD-B2C-Web-Testing/'.replace(".com//", ".com/");
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
  
function shuffle(array) {
  var currentIndex = array.length, temporaryValue, randomIndex;

  // While there remain elements to shuffle...
  while (0 !== currentIndex) {

    // Pick a remaining element...
    randomIndex = Math.floor(Math.random() * currentIndex);
    currentIndex -= 1;

    // And swap it with the current element.
    temporaryValue = array[currentIndex];
    array[currentIndex] = array[randomIndex];
    array[randomIndex] = temporaryValue;
  }

  return array;
}

</script>


</body>

  
<!-- Google Analytics -->
<script type="text/javascript">
if (document.location.hostname.search("westerndevs.com") !== -1 || document.location.hostname.search("www.westerndevs.com") !== -1) {
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-37617956-2', 'auto');

ga('set', 'contentGroup1', 'tyler_doerksen');

ga('send', 'pageview');
}
</script>
<!-- End Google Analytics -->



</html>
