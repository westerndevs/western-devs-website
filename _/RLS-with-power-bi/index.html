<!DOCTYPE html>
<html lang="en" xml:lang="en">

  <head>
  
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>Using RLS in Power BI Embedded | Western Devs</title>
  <meta name="description" content="Power BI is a funny animal. On some levels it is a logical successor to SSRS but on other levels it is a totally different beast. One of the ways it differs greatly from SSRS is in handling parameters">
<meta property="og:type" content="article">
<meta property="og:title" content="Using RLS in Power BI Embedded">
<meta property="og:url" content="https://westerndevs.com/_/RLS-with-power-bi/index.html">
<meta property="og:site_name" content="Western Devs">
<meta property="og:description" content="Power BI is a funny animal. On some levels it is a logical successor to SSRS but on other levels it is a totally different beast. One of the ways it differs greatly from SSRS is in handling parameters">
<meta property="og:image" content="https://westerndevs.com/images/2021-10-22-RLS_with_power_bi.md/2021-10-22-15-55-31.png">
<meta property="og:image" content="https://westerndevs.com/images/2021-10-22-RLS_with_power_bi.md/2021-10-22-15-59-46.png">
<meta property="og:image" content="https://westerndevs.com/images/2022-07-06-RLS_with_power_bi.md/2022-07-06-07-11-52.png">
<meta property="article:published_time" content="2021-10-22T04:00:00.000Z">
<meta property="article:modified_time" content="2024-09-10T11:55:58.745Z">
<meta property="article:author" content="Western Devs">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://westerndevs.com/images/2021-10-22-RLS_with_power_bi.md/2021-10-22-15-55-31.png">
<meta name="twitter:creator" content="@westerndevs">

    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="title" content="WesternDevs">   
    <meta name="keywords" content="software development,software,asp.net,blog">
    <meta name="description" content="We're all west of somewhere">
    <meta name="copyright" content="WesternDevs">
    <meta name="revisit-after" content="15 days">
    <meta name="robots" content="all">
    <meta name="MSSmartTagsPreventParsing" content="true">
  
    <link rel="canonical" href="https://blog.simontimms.com/2021/10/22/RLS_with_power_bi">
  
  
    <link rel="alternate" href="/feed.xml" title="Western Devs" type="application/atom+xml">
  
  
<link rel="stylesheet" href="/css/style.css">

      
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <script src="//code.jquery.com/jquery-1.11.3.min.js"></script>  
  <meta name="generator" content="Hexo 4.2.1"></head>

<body>

<!-- FIXED HEADER BECAUSE SCROLLING -->
<!--HEADER STARTS-->
<div class="WrapperHeader">
<div style="display:inline-block; text-align: center;">
<div class="Header">

  <div class="HeaderLogo">
    <a href="/"><img src="/images/header_logo_transparent.png" alt="WesternDevs" title="WesternDevs" border="0" style="width: 206px; height: 64px;" width="206" height="64"></a>
  </div>

  <div class="HeaderLinks">
      <a href="/posts" class="nav">POSTS</a>       
      <a href="/podcasts" class="nav">PODCASTS</a>       
      <a href="/whoweare" class="nav">ABOUT</a>  
      <a href="/whatwevedone" class="nav">WHAT WE'VE DONE</a>  
      <a href="/speaking" class="nav">SPEAKING</a>
      <div class="HeaderIcons">
        <a href="mailto:info@westerndevs.com"><img src="/images/icon_email.png" border="0" alt="Email" title="Email" height="26" width="26"></a>
        <a href="/feed.xml"><img src="/images/icon_subscribe.png" border="0" alt="Subscribe" title="Subscribe" height="26" width="27"></a>
        <a href="http://twitter.com/westerndevs" target="_blank"><img src="/images/icon_twitter.png" border="0" alt="Twitter" title="Twitter" height="26" width="27"></a>
        <a href="http://github.com/westerndevs" target="_blank"><img src="/images/icon_github.png" border="0" alt="GitHub" title="GitHub" height="26" width="27"></a>     
      </div>
  </div>
  
</div>
</div>
</div>
<!--HEADER ENDS-->    



<!--WRAPPER STARTS-->
<div class="Wrapper" style="">

<!--SUBHEAD STARTS-->
<div class="WrapperSubHeaderSubpage">
<center>
	<div class="SubHeader">
		<H1 class="title"><img class="icon" src="/images/icon_posts.png" alt="POST" title="POST" border="0"> POST</H1>
	</div>
</center>
</div>
<!--SUBHEAD ENDS-->

<!--PAGE CONTENT STARTS-->
<center>
<div class="WrapperContent">

<!--MAIN CONTENT STARTS-->
	<div class="SubpageBoxSubLrg">
		<div class="SubpageBoxSubLrgContent">
		    <div class='postTitle'>
  <div class="ListLrgDateBG">
    <div class="ListLrgDateMonth">OCT</div>
    <div class="ListLrgDateDay">22</div>
    <div class="ListLrgDateYear">2021</div>
  </div>
  <h2>Using RLS in Power BI Embedded</h2>
</div>

		    

<p class="TXTsm">ORIGINALLY POSTED TO: <a href="https://blog.simontimms.com/2021/10/22/RLS_with_power_bi" target="_blank" rel="noopener" class='originalurl'>https://blog.simontimms.com/2021/10/22/RLS_with_power_bi</a></p>



			<div id="mainPostContent">
	        <p>Power BI is a funny animal. On some levels it is a logical successor to SSRS but on other levels it is a totally different beast. One of the ways it differs greatly from SSRS is in handling parameters, especially secure parameters. When embedding an SSRS report you could specify the parameter value in a secure fashion and then now show the selector to end users.</p>
<p>In many cases there is a need to use row level security (RLS) to restrict the data that a user can see in Power BI. There are a myriad of ways to do this wrong and I think I've explored most of them over the last few days. There is also at least one way that works.</p>
<p>A tempting approach is to use a filter. These can be applied at render time in the browser by adding to the config when embedding the report.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> config = &#123;</span><br><span class="line">      visualName: <span class="string">''</span>,</span><br><span class="line">      type: <span class="string">'report'</span>,</span><br><span class="line">      accessToken: token, </span><br><span class="line">      embedUrl: token.embedUrl,</span><br><span class="line">      tokenType: powerbi.models.TokenType.Embed,</span><br><span class="line">      permissions: permissions,</span><br><span class="line">      <span class="comment">// üëá filters</span></span><br><span class="line">      filters: [</span><br><span class="line">        &#123;</span><br><span class="line">          $schema: <span class="string">"http://powerbi.com/product/schema#basic"</span>,</span><br><span class="line">          target: &#123;</span><br><span class="line">              table: <span class="string">"monthlyProducts"</span>,</span><br><span class="line">              column: <span class="string">"userId"</span></span><br><span class="line">          &#125;,</span><br><span class="line">          operator: <span class="string">"In"</span>,</span><br><span class="line">          values: [<span class="string">"stimms"</span>]</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      <span class="comment">// ‚òùÔ∏è</span></span><br><span class="line">      settings: &#123;</span><br><span class="line">        panes: &#123;</span><br><span class="line">          filters: &#123;</span><br><span class="line">            visible: <span class="literal">true</span>,</span><br><span class="line">          &#125;,</span><br><span class="line">          pageNavigation: &#123;</span><br><span class="line">            visible: <span class="literal">true</span>,</span><br><span class="line">          &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>This class of parameter is fine for providing filters that can be updated later by the user. However, it should not be used for parameters that require some degree of security like a user name. These parameters are easily changed and, unless your parameter are in some way cryptographically secure there is a good chance you're introducing a broken access control - <a href="https://owasp.org/Top10/A01_2021-Broken_Access_Control/" target="_blank" rel="noopener">#1</a> on the <a href="https://owasp.org/www-project-top-ten/" target="_blank" rel="noopener">OWASP top 10</a>.</p>
<p>Instead of this approach you can use the manage roles functionality in Power BI.</p>
<p><img src="/images/2021-10-22-RLS_with_power_bi.md/2021-10-22-15-55-31.png" alt="">)</p>
<p>This functionality is designed to provide high level filters for data. A lot of the examples I see are for things like restricting a user in the <code>East</code> region from seeing the data of a user in the <code>West</code> region. This is done by assigning a role to that user when generating the embedding token. Then you'd set up a role for each region (see 1) and apply a filter expression to your tables so the only records with a region of <code>East</code> would show up.</p>
<p><img src="/images/2021-10-22-RLS_with_power_bi.md/2021-10-22-15-59-46.png" alt="">)</p>
<p>This is a simplistic and somewhat tiresome approach to adding a role mapping. What if a new region like <code>SouthEast</code> is introduced? What isn't, perhaps, as clear is that DAX expression can contain dynamic functions like <code>UserName()</code> which make filtering more powerful. This <code>UserName()</code> will be bound to the effective identity passed in</p>
<p><img src="/images/2022-07-06-RLS_with_power_bi.md/2022-07-06-07-11-52.png" alt="">)</p>
<p>What I settled on for my filtering was to have a single role which I enforce at the embedded token generation level and then filter my data by the UserName() which I also set at the embedded token level. Because these are set at the embedded token generation time which occurs on the server I can be confident that I'm not providing a way for somebody to view data they shouldn't.</p>
<p>The code for generation looks like this:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> tokenRequest = <span class="keyword">new</span> GenerateTokenRequestV2(</span><br><span class="line">                    reports: <span class="keyword">new</span> List&lt;GenerateTokenRequestV2Report&gt;</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">new</span> GenerateTokenRequestV2Report(reportId)</span><br><span class="line">                    &#125;,</span><br><span class="line">                    datasets: <span class="keyword">new</span> List&lt;GenerateTokenRequestV2Dataset&gt; &#123; <span class="keyword">new</span> GenerateTokenRequestV2Dataset(report.DatasetId) &#125;,</span><br><span class="line">                    identities: <span class="keyword">new</span> List&lt;EffectiveIdentity&gt; &#123; <span class="keyword">new</span> EffectiveIdentity(user.ContactId.ToString(),</span><br><span class="line">                                                                roles: <span class="keyword">new</span> List&lt;<span class="keyword">string</span>&gt; &#123; <span class="string">"Users"</span> &#125;,</span><br><span class="line">                                                                datasets: <span class="keyword">new</span> List&lt;String&gt;&#123;report.DatasetId &#125;)</span><br><span class="line">                    &#125;</span><br><span class="line">                );</span><br><span class="line"><span class="keyword">var</span> embedToken = <span class="keyword">await</span> client.EmbedToken.GenerateTokenAsync(tokenRequest);</span><br></pre></td></tr></table></figure>
<p>In this particular case the data I was returning from the database could be accessed by a number of different people depending on to which group they belonged. Initially I tried crossing the data against the user/group matrix but the cardinality of the resulting set was in the billions and totally overwhelmed both SQL Server and Power BI. Instead what I did was pull in the user/group matrix and the dataset that exposed the group id. In Power BI I did a merge of the datasets along with applying the row level filtering. This was necessary because, as far as I know, there is no way to pass the user name down to the actual query running against the server.</p>
<p>With all this in place I got good security and good performance. But, wow, did it take me a long time to get there.</p>

	        </div>

            
            <section id="comments">
            <div id="disqus_thread">
                <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript" target="_blank" rel="noopener">comments powered by Disqus.</a></noscript>
            </div>
            </section>
            
		</div>
	</div>
<!--MAIN CONTENT ENDS-->

<!--SIDEBAR CONTENT STARTS-->
	<div class="SubpageBoxSubSm">
		<div class="SubpageBoxSubSmContent">
			
			

			<div class="ProfileImg">
				
				<a href="/bios/simon_timms">
				
					<img src='/images/avatars/simon.jpg' />
				
				</a>
				
			</div>

			<BR clear="all">

			<h2><a href="/bios/simon_timms">Simon Timms</a></h2>
			
			<a href="mailto:stimms@gmail.com"><img class="ProfileIcon" src="/images/icon_email.png" border="0" alt="Email" title="Email"> Email</a><BR>
			
			
			<a href="http://blog.simontimms.com/" target="_blank"><img class="ProfileIcon" src="/images/icon_web.png" border="0" alt="Web" title="Web"> Web</a><BR>
			
			
			<a href="http://twitter.com/stimms" target="_blank"><img class="ProfileIcon" src="/images/icon_twitter.png" border="0" alt="Twitter" title="Twitter"> Twitter</a><BR>
			
			
			<a href="https://github.com/stimms" target="_blank"><img class="ProfileIcon" src="/images/icon_github.png" border="0" alt="GitHub" title="GitHub"> GitHub</a><br>
			
			
			
 			<a href="/feeds/simon_timms.xml"><img class="ProfileIcon" src="/images/icon_subscribe.png" /> RSS</a>
			

			<hr />
			<h4>Looking for someone else?</h4>
			<p>You can find the rest of the Western Devs Crew <a href="/whoweare">here</a>.</p>
		</div>
	</div>
<!--SIDEBAR CONTENT ENDS-->


</div>
</center>
<!--PAGE CONTENT ENDS-->


<!--FOOTER STARTS-->
<center>
  <div class="FooterBarTxt">&copy; 2015 Western Devs. All Rights Reserved. Design by <a href="http://www.karenchudobiak.ca" target="_blank">Karen Chudobiak, Graphic Designer</a></div>
</center>
<!--FOOTER ENDS-->

<!-- NAV FOOTER STARTS -->
<div class="NavFooter">
  <a href="/posts" alt="Posts"><i class="fa fa-newspaper-o fa-2x"></i><span>Posts</span></a>
  <a href="/podcasts" alt="Podcasts"><i class="fa fa-volume-up fa-2x"></i><span>Podcasts</span></a>
  <a href="/whoweare" alt="About"><i class="fa fa-star fa-2x"></i><span>About</span></a>
  <a href="/whatwevedone" alt="What We've Done"><i class="fa fa-trophy fa-2x"></i><span>Work</span></a>
  <a href="/speaking" alt="Speaking"><i class="fa fa-comment-o fa-2x fa-flip-horizontal"></i><span>Speaking</span></a>
</div>
<!-- NAV FOOTER ENDS -->




</div>
<!--WRAPPER ENDS-->


<script>
  var disqus_shortname = 'westerndevs';
  
  var disqus_url = 'https://westerndevs.com/_/RLS-with-power-bi/'.replace(".com//", ".com/");
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
  
function shuffle(array) {
  var currentIndex = array.length, temporaryValue, randomIndex;

  // While there remain elements to shuffle...
  while (0 !== currentIndex) {

    // Pick a remaining element...
    randomIndex = Math.floor(Math.random() * currentIndex);
    currentIndex -= 1;

    // And swap it with the current element.
    temporaryValue = array[currentIndex];
    array[currentIndex] = array[randomIndex];
    array[randomIndex] = temporaryValue;
  }

  return array;
}

</script>


</body>

  
<!-- Google Analytics -->
<script type="text/javascript">
if (document.location.hostname.search("westerndevs.com") !== -1 || document.location.hostname.search("www.westerndevs.com") !== -1) {
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-37617956-2', 'auto');

ga('set', 'contentGroup1', 'simon_timms');

ga('send', 'pageview');
}
</script>
<!-- End Google Analytics -->



</html>
