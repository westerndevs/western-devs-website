<!DOCTYPE html>
<html lang="en" xml:lang="en">

  <head>
  
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>RavenDB on Kubernetes | Western Devs</title>
  <meta name="description" content="I needed to get Particular Service Control up and running on our k8s cluster this week. Part of that is to get an instance of RavenDB running in the cluster and this actually caused me a bit of troubl">
<meta property="og:type" content="article">
<meta property="og:title" content="RavenDB on Kubernetes">
<meta property="og:url" content="https://westerndevs.com/_/ravendb-on-k8s/index.html">
<meta property="og:site_name" content="Western Devs">
<meta property="og:description" content="I needed to get Particular Service Control up and running on our k8s cluster this week. Part of that is to get an instance of RavenDB running in the cluster and this actually caused me a bit of troubl">
<meta property="article:published_time" content="2024-11-14T05:00:00.000Z">
<meta property="article:modified_time" content="2025-02-12T23:15:39.261Z">
<meta property="article:author" content="Western Devs">
<meta name="twitter:card" content="summary">
<meta name="twitter:creator" content="@westerndevs">

    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="title" content="WesternDevs">   
    <meta name="keywords" content="software development,software,asp.net,blog">
    <meta name="description" content="We're all west of somewhere">
    <meta name="copyright" content="WesternDevs">
    <meta name="revisit-after" content="15 days">
    <meta name="robots" content="all">
    <meta name="MSSmartTagsPreventParsing" content="true">
  
    <link rel="canonical" href="https://blog.simontimms.com/2024/11/14/ravendb-on-k8s">
  
  
    <link rel="alternate" href="/feed.xml" title="Western Devs" type="application/atom+xml">
  
  
<link rel="stylesheet" href="/css/style.css">

      
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <script src="//code.jquery.com/jquery-1.11.3.min.js"></script>  
  <meta name="generator" content="Hexo 4.2.1"></head>

<body>

<!-- FIXED HEADER BECAUSE SCROLLING -->
<!--HEADER STARTS-->
<div class="WrapperHeader">
<div style="display:inline-block; text-align: center;">
<div class="Header">

  <div class="HeaderLogo">
    <a href="/"><img src="/images/header_logo_transparent.png" alt="WesternDevs" title="WesternDevs" border="0" style="width: 206px; height: 64px;" width="206" height="64"></a>
  </div>

  <div class="HeaderLinks">
      <a href="/posts" class="nav">POSTS</a>       
      <a href="/podcasts" class="nav">PODCASTS</a>       
      <a href="/whoweare" class="nav">ABOUT</a>  
      <a href="/whatwevedone" class="nav">WHAT WE'VE DONE</a>  
      <a href="/speaking" class="nav">SPEAKING</a>
      <div class="HeaderIcons">
        <a href="mailto:info@westerndevs.com"><img src="/images/icon_email.png" border="0" alt="Email" title="Email" height="26" width="26"></a>
        <a href="/feed.xml"><img src="/images/icon_subscribe.png" border="0" alt="Subscribe" title="Subscribe" height="26" width="27"></a>
        <a href="http://twitter.com/westerndevs" target="_blank"><img src="/images/icon_twitter.png" border="0" alt="Twitter" title="Twitter" height="26" width="27"></a>
        <a href="http://github.com/westerndevs" target="_blank"><img src="/images/icon_github.png" border="0" alt="GitHub" title="GitHub" height="26" width="27"></a>     
      </div>
  </div>
  
</div>
</div>
</div>
<!--HEADER ENDS-->    



<!--WRAPPER STARTS-->
<div class="Wrapper" style="">

<!--SUBHEAD STARTS-->
<div class="WrapperSubHeaderSubpage">
<center>
	<div class="SubHeader">
		<H1 class="title"><img class="icon" src="/images/icon_posts.png" alt="POST" title="POST" border="0"> POST</H1>
	</div>
</center>
</div>
<!--SUBHEAD ENDS-->

<!--PAGE CONTENT STARTS-->
<center>
<div class="WrapperContent">

<!--MAIN CONTENT STARTS-->
	<div class="SubpageBoxSubLrg">
		<div class="SubpageBoxSubLrgContent">
		    <div class='postTitle'>
  <div class="ListLrgDateBG">
    <div class="ListLrgDateMonth">NOV</div>
    <div class="ListLrgDateDay">14</div>
    <div class="ListLrgDateYear">2024</div>
  </div>
  <h2>RavenDB on Kubernetes</h2>
</div>

		    

<p class="TXTsm">ORIGINALLY POSTED TO: <a href="https://blog.simontimms.com/2024/11/14/ravendb-on-k8s" target="_blank" rel="noopener" class='originalurl'>https://blog.simontimms.com/2024/11/14/ravendb-on-k8s</a></p>



			<div id="mainPostContent">
	        <p>I needed to get Particular Service Control up and running on our k8s cluster this week. Part of that is to get an instance of RavenDB running in the cluster and this actually caused me a bit of trouble. I kept running into problems where RavenDB would start up but then report that it couuld not access the data directory. What was up?</p>
<p>I tried overriding the entry point for the container and attaching to it to see what was going on but I couldn't see anything wrong. I was able to write to the directory without issue. Eventually I stumbled on a note in the <a href="https://ravendb.net/docs/article-page/6.0/csharp/migration/server/docker" target="_blank" rel="noopener">RavenDB documentation</a> which mentioned a change in the 6.x version of RavenDB which meant that Raven no longer ran as root inside the container.</p>
<p>K8S has the ability to change the ownership of the volume to the user that the container is running as. This is done by setting the <code>fsGroup</code> property in the pod spec. In this case Raven runs as UID 999. So I updated my tanka spec to include the <code>fsGroup</code> property and the problem was solved.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">...</span></span><br><span class="line"><span class="attr">deployment:</span> <span class="string">deployment.new($._config.containers.ravendb.name)</span> <span class="string">&#123;</span></span><br><span class="line">      <span class="string">metadata+:</span> <span class="string">&#123;</span></span><br><span class="line">        <span class="attr">namespace:</span> <span class="string">'wigglepiggle-'</span> <span class="string">+</span> <span class="string">$._config.environment,</span></span><br><span class="line">        <span class="attr">labels:</span> <span class="string">&#123;</span></span><br><span class="line">          <span class="attr">app:</span> <span class="string">$._config.containers.ravendb.name,</span></span><br><span class="line">        <span class="string">&#125;,</span></span><br><span class="line">      <span class="string">&#125;,</span></span><br><span class="line">      <span class="string">spec+:</span> <span class="string">&#123;</span></span><br><span class="line">        <span class="attr">replicas:</span> <span class="number">1</span><span class="string">,</span></span><br><span class="line">        <span class="attr">selector:</span> <span class="string">&#123;</span></span><br><span class="line">          <span class="attr">matchLabels:</span> <span class="string">$._config.labels,</span></span><br><span class="line">        <span class="string">&#125;,</span></span><br><span class="line">        <span class="attr">template:</span> <span class="string">&#123;</span></span><br><span class="line">          <span class="string">metadata+:</span> <span class="string">&#123;</span></span><br><span class="line">            <span class="attr">labels:</span> <span class="string">$._config.labels,</span></span><br><span class="line">          <span class="string">&#125;,</span></span><br><span class="line">          <span class="string">spec+:</span> <span class="string">&#123;</span></span><br><span class="line">            <span class="attr">securityContext:</span> <span class="string">&#123;</span></span><br><span class="line">              <span class="attr">fsGroup:</span> <span class="number">999</span><span class="string">,</span></span><br><span class="line">              <span class="attr">fsGroupChangePolicy:</span> <span class="string">'OnRootMismatch'</span><span class="string">,</span></span><br><span class="line">            <span class="string">&#125;,</span></span><br><span class="line">            <span class="attr">containers:</span> <span class="string">[</span></span><br><span class="line">              <span class="string">&#123;</span></span><br><span class="line">                <span class="attr">name:</span> <span class="string">$._config.containers.ravendb.name,</span></span><br><span class="line">                <span class="attr">image:</span> <span class="string">$._config.containers.ravendb.image,</span></span><br><span class="line">                <span class="attr">ports:</span> <span class="string">[&#123;</span> <span class="attr">containerPort:</span> <span class="number">8080</span> <span class="string">&#125;,</span> <span class="string">&#123;</span> <span class="attr">containerPort:</span> <span class="number">38888</span> <span class="string">&#125;],</span></span><br><span class="line">                <span class="attr">volumeMounts:</span> <span class="string">[</span></span><br><span class="line">                  <span class="string">&#123;</span></span><br><span class="line">                    <span class="attr">name:</span> <span class="string">'data'</span><span class="string">,</span></span><br><span class="line">                    <span class="attr">mountPath:</span> <span class="string">'/var/lib/ravendb/data'</span><span class="string">,</span></span><br><span class="line">                  <span class="string">&#125;,</span></span><br><span class="line">                <span class="string">],</span></span><br><span class="line">                <span class="attr">env:</span> <span class="string">[</span></span><br><span class="line">                  <span class="string">&#123;</span></span><br><span class="line">                    <span class="attr">name:</span> <span class="string">'RAVEN_Setup_Mode'</span><span class="string">,</span></span><br><span class="line">                    <span class="attr">value:</span> <span class="string">'None'</span><span class="string">,</span></span><br><span class="line">                  <span class="string">&#125;,</span></span><br><span class="line">                  <span class="string">&#123;</span></span><br><span class="line">                    <span class="attr">name:</span> <span class="string">'RAVEN_License_Eula_Accepted'</span><span class="string">,</span></span><br><span class="line">                    <span class="attr">value:</span> <span class="string">'true'</span><span class="string">,</span></span><br><span class="line">                  <span class="string">&#125;,</span></span><br><span class="line">                  <span class="string">&#123;</span></span><br><span class="line">                    <span class="attr">name:</span> <span class="string">'RAVEN_ARGS'</span><span class="string">,</span></span><br><span class="line">                    <span class="attr">value:</span> <span class="string">'--log-to-console'</span><span class="string">,</span></span><br><span class="line">                  <span class="string">&#125;,</span></span><br><span class="line">                  <span class="string">&#123;</span></span><br><span class="line">                    <span class="attr">name:</span> <span class="string">'RAVEN_Security_UnsecuredAccessAllowed'</span><span class="string">,</span></span><br><span class="line">                    <span class="attr">value:</span> <span class="string">'PrivateNetwork'</span><span class="string">,</span></span><br><span class="line">                  <span class="string">&#125;,</span></span><br><span class="line">                <span class="string">],</span></span><br><span class="line">              <span class="string">&#125;,</span></span><br><span class="line">            <span class="string">],</span></span><br><span class="line">            <span class="attr">volumes:</span> <span class="string">[</span></span><br><span class="line">              <span class="string">&#123;</span></span><br><span class="line">                <span class="attr">name:</span> <span class="string">'data'</span><span class="string">,</span></span><br><span class="line">                <span class="attr">persistentVolumeClaim:</span> <span class="string">&#123;</span></span><br><span class="line">                  <span class="attr">claimName:</span> <span class="string">$._config.containers.ravendb.name,</span></span><br><span class="line">                <span class="string">&#125;,</span></span><br><span class="line">              <span class="string">&#125;,</span></span><br><span class="line">            <span class="string">],</span></span><br><span class="line">          <span class="string">&#125;,</span></span><br><span class="line">        <span class="string">&#125;,</span></span><br><span class="line">      <span class="string">&#125;,</span></span><br><span class="line">    <span class="string">&#125;,</span></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure>
<p>This generated yml like</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">service-control-ravendb</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">service-control-ravendb</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">wigglepiggle-dev</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">service-control</span></span><br><span class="line">      <span class="attr">environment:</span> <span class="string">dev</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">service-control</span></span><br><span class="line">        <span class="attr">environment:</span> <span class="string">dev</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">RAVEN_Setup_Mode</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">None</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">RAVEN_License_Eula_Accepted</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">"true"</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">RAVEN_ARGS</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">--log-to-console</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">RAVEN_Security_UnsecuredAccessAllowed</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">PrivateNetwork</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">ravendb/ravendb:6.0-latest</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">service-control-ravendb</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">38888</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/var/lib/ravendb/data</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line">      <span class="attr">securityContext:</span></span><br><span class="line">        <span class="attr">fsGroup:</span> <span class="number">999</span></span><br><span class="line">        <span class="attr">fsGroupChangePolicy:</span> <span class="string">OnRootMismatch</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line">        <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">          <span class="attr">claimName:</span> <span class="string">service-control-ravendb</span></span><br></pre></td></tr></table></figure>

	        </div>

            
            <section id="comments">
            <div id="disqus_thread">
                <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript" target="_blank" rel="noopener">comments powered by Disqus.</a></noscript>
            </div>
            </section>
            
		</div>
	</div>
<!--MAIN CONTENT ENDS-->

<!--SIDEBAR CONTENT STARTS-->
	<div class="SubpageBoxSubSm">
		<div class="SubpageBoxSubSmContent">
			
			

			<div class="ProfileImg">
				
				<a href="/bios/simon_timms">
				
					<img src='/images/avatars/simon.jpg' />
				
				</a>
				
			</div>

			<BR clear="all">

			<h2><a href="/bios/simon_timms">Simon Timms</a></h2>
			
			<a href="mailto:stimms@gmail.com"><img class="ProfileIcon" src="/images/icon_email.png" border="0" alt="Email" title="Email"> Email</a><BR>
			
			
			<a href="http://blog.simontimms.com/" target="_blank"><img class="ProfileIcon" src="/images/icon_web.png" border="0" alt="Web" title="Web"> Web</a><BR>
			
			
			<a href="http://twitter.com/stimms" target="_blank"><img class="ProfileIcon" src="/images/icon_twitter.png" border="0" alt="Twitter" title="Twitter"> Twitter</a><BR>
			
			
			<a href="https://github.com/stimms" target="_blank"><img class="ProfileIcon" src="/images/icon_github.png" border="0" alt="GitHub" title="GitHub"> GitHub</a><br>
			
			
			
 			<a href="/feeds/simon_timms.xml"><img class="ProfileIcon" src="/images/icon_subscribe.png" /> RSS</a>
			

			<hr />
			<h4>Looking for someone else?</h4>
			<p>You can find the rest of the Western Devs Crew <a href="/whoweare">here</a>.</p>
		</div>
	</div>
<!--SIDEBAR CONTENT ENDS-->


</div>
</center>
<!--PAGE CONTENT ENDS-->


<!--FOOTER STARTS-->
<center>
  <div class="FooterBarTxt">&copy; 2015 Western Devs. All Rights Reserved. Design by <a href="http://www.karenchudobiak.ca" target="_blank">Karen Chudobiak, Graphic Designer</a></div>
</center>
<!--FOOTER ENDS-->

<!-- NAV FOOTER STARTS -->
<div class="NavFooter">
  <a href="/posts" alt="Posts"><i class="fa fa-newspaper-o fa-2x"></i><span>Posts</span></a>
  <a href="/podcasts" alt="Podcasts"><i class="fa fa-volume-up fa-2x"></i><span>Podcasts</span></a>
  <a href="/whoweare" alt="About"><i class="fa fa-star fa-2x"></i><span>About</span></a>
  <a href="/whatwevedone" alt="What We've Done"><i class="fa fa-trophy fa-2x"></i><span>Work</span></a>
  <a href="/speaking" alt="Speaking"><i class="fa fa-comment-o fa-2x fa-flip-horizontal"></i><span>Speaking</span></a>
</div>
<!-- NAV FOOTER ENDS -->




</div>
<!--WRAPPER ENDS-->


<script>
  var disqus_shortname = 'westerndevs';
  
  var disqus_url = 'https://westerndevs.com/_/ravendb-on-k8s/'.replace(".com//", ".com/");
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
  
function shuffle(array) {
  var currentIndex = array.length, temporaryValue, randomIndex;

  // While there remain elements to shuffle...
  while (0 !== currentIndex) {

    // Pick a remaining element...
    randomIndex = Math.floor(Math.random() * currentIndex);
    currentIndex -= 1;

    // And swap it with the current element.
    temporaryValue = array[currentIndex];
    array[currentIndex] = array[randomIndex];
    array[randomIndex] = temporaryValue;
  }

  return array;
}

</script>


</body>

  
<!-- Google Analytics -->
<script type="text/javascript">
if (document.location.hostname.search("westerndevs.com") !== -1 || document.location.hostname.search("www.westerndevs.com") !== -1) {
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-37617956-2', 'auto');

ga('set', 'contentGroup1', 'simon_timms');

ga('send', 'pageview');
}
</script>
<!-- End Google Analytics -->



</html>
