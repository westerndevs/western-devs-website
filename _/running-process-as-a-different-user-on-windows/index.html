<!DOCTYPE html>
<html lang="en" xml:lang="en">

  <head>
  
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>Running Process as a Different User on Windows | Western Devs</title>
  <meta name="description" content="Running commands as another user on Windows can be a bit tricky, but this is a method that worked for me.">
<meta property="og:type" content="article">
<meta property="og:title" content="Running Process as a Different User on Windows">
<meta property="og:url" content="https://westerndevs.com/_/running-process-as-a-different-user-on-windows/index.html">
<meta property="og:site_name" content="Western Devs">
<meta property="og:description" content="Running commands as another user on Windows can be a bit tricky, but this is a method that worked for me.">
<meta property="article:published_time" content="2015-08-28T00:26:10.000Z">
<meta property="article:modified_time" content="2022-12-07T15:37:34.237Z">
<meta property="article:author" content="Western Devs">
<meta name="twitter:card" content="summary">
<meta name="twitter:creator" content="@westerndevs">

    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="title" content="WesternDevs">   
    <meta name="keywords" content="software development,software,asp.net,blog">
    <meta name="description" content="We're all west of somewhere">
    <meta name="copyright" content="WesternDevs">
    <meta name="revisit-after" content="15 days">
    <meta name="robots" content="all">
    <meta name="MSSmartTagsPreventParsing" content="true">
  
    <link rel="canonical" href="http://blog.simontimms.com/2015/09/02/running-process-as-a-different-user-on-windows/">
  
  
    <link rel="alternate" href="/feed.xml" title="Western Devs" type="application/atom+xml">
  
  
<link rel="stylesheet" href="/css/style.css">

      
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <script src="//code.jquery.com/jquery-1.11.3.min.js"></script>  
  <meta name="generator" content="Hexo 4.2.1"></head>

<body>

<!-- FIXED HEADER BECAUSE SCROLLING -->
<!--HEADER STARTS-->
<div class="WrapperHeader">
<div style="display:inline-block; text-align: center;">
<div class="Header">

  <div class="HeaderLogo">
    <a href="/"><img src="/images/header_logo_transparent.png" alt="WesternDevs" title="WesternDevs" border="0" style="width: 206px; height: 64px;" width="206" height="64"></a>
  </div>

  <div class="HeaderLinks">
      <a href="/posts" class="nav">POSTS</a>       
      <a href="/podcasts" class="nav">PODCASTS</a>       
      <a href="/whoweare" class="nav">ABOUT</a>  
      <a href="/whatwevedone" class="nav">WHAT WE'VE DONE</a>  
      <a href="/speaking" class="nav">SPEAKING</a>
      <div class="HeaderIcons">
        <a href="mailto:info@westerndevs.com"><img src="/images/icon_email.png" border="0" alt="Email" title="Email" height="26" width="26"></a>
        <a href="/feed.xml"><img src="/images/icon_subscribe.png" border="0" alt="Subscribe" title="Subscribe" height="26" width="27"></a>
        <a href="http://twitter.com/westerndevs" target="_blank"><img src="/images/icon_twitter.png" border="0" alt="Twitter" title="Twitter" height="26" width="27"></a>
        <a href="http://github.com/westerndevs" target="_blank"><img src="/images/icon_github.png" border="0" alt="GitHub" title="GitHub" height="26" width="27"></a>     
      </div>
  </div>
  
</div>
</div>
</div>
<!--HEADER ENDS-->    



<!--WRAPPER STARTS-->
<div class="Wrapper" style="">

<!--SUBHEAD STARTS-->
<div class="WrapperSubHeaderSubpage">
<center>
	<div class="SubHeader">
		<H1 class="title"><img class="icon" src="/images/icon_posts.png" alt="POST" title="POST" border="0"> POST</H1>
	</div>
</center>
</div>
<!--SUBHEAD ENDS-->

<!--PAGE CONTENT STARTS-->
<center>
<div class="WrapperContent">

<!--MAIN CONTENT STARTS-->
	<div class="SubpageBoxSubLrg">
		<div class="SubpageBoxSubLrgContent">
		    <div class='postTitle'>
  <div class="ListLrgDateBG">
    <div class="ListLrgDateMonth">AUG</div>
    <div class="ListLrgDateDay">28</div>
    <div class="ListLrgDateYear">2015</div>
  </div>
  <h2>Running Process as a Different User on Windows</h2>
</div>

		    

<p class="TXTsm">ORIGINALLY POSTED TO: <a href="http://blog.simontimms.com/2015/09/02/running-process-as-a-different-user-on-windows/" target="_blank" rel="noopener" class='originalurl'>http://blog.simontimms.com/2015/09/02/running-process-as-a-different-user-on-windows/</a></p>



			<div id="mainPostContent">
	        <p>As part of a build pipeline I'm working on the octopus deploy process needs to talk to the database using roundhouse as a different user from the one running the deployment. This is done because the database uses integrated AD authentication, which I quite like. If this build were running on Linux then it would be as simple as editing the sudoers file and calling the command using sudo. Unfortunately this is Windows and the command line has long been a secondary concern.</p>
<p>I started by asking on the <a href="http://westerndevs.com">western devs</a> slack channel to see if anybody else had done this and how. <a href="http://www.westerndevs.com/bios/dave_paquette/" target="_blank" rel="noopener">Dave Paquette</a> suggested using <a href="https://technet.microsoft.com/en-us/sysinternals/bb897553.aspx" target="_blank" rel="noopener">psexec</a>. This is a tool designed for running commands on a remote computer but if you leave the computer name off it will run on the local machine. This sounded perfect.</p>
<p>However I had a great deal of trouble getting psexec to work in the way I wanted. The command I wanted to run seemed to fail all the time giving an confusing error code <a href="https://social.technet.microsoft.com/forums/en-US/db8ce5e5-988c-4f1c-93f4-5ff1f2fa29e8/psexec-on-remote-server-giving-program-exit-code1073741502" target="_blank" rel="noopener">-1073741502</a>. The fix provided didn't seem to work for me so after an afternoon of bashing my head against psexec I went looking for another solution. Running remote processes gave me an idea: what about powershell remoting?</p>
<p>Some investigation suggested that the command I wanted to run would look like</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Invoke-command</span> localhost <span class="literal">-scriptblock</span> &#123; rh.exe -<span class="literal">-some</span><span class="literal">-parameters</span> &#125;</span><br></pre></td></tr></table></figure>
<p>This would remote to localhost and run the roundhouse command as the current user. To get it to work using a different user then the command needed credentials passed into it. I had the credentials stored as <a href="http://docs.octopusdeploy.com/display/OD/Sensitive+variables" target="_blank" rel="noopener">sensitive variables</a> in Octopus which set them up as variables in powershell. To turn these into credentials you need to do</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">    </span><br><span class="line">	<span class="variable">$pwd</span> = <span class="built_in">ConvertTo-SecureString</span> <span class="variable">$deployPassword</span> <span class="literal">-asplaintext</span> <span class="literal">-force</span></span><br><span class="line"><span class="variable">$cred</span> =<span class="built_in">new-object</span> <span class="literal">-TypeName</span> System.Management.Automation.PSCredential <span class="literal">-argumentlist</span> <span class="variable">$deployUser</span>,<span class="variable">$pwd</span></span><br></pre></td></tr></table></figure>
<p>Now these can be passed into invoke command as</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">    <span class="built_in">Invoke-command</span> localhost <span class="literal">-authentication</span> credssp <span class="literal">-Credential</span> <span class="variable">$cred</span> <span class="literal">-scriptblock</span> &#123;</span><br><span class="line">	rh.exe -<span class="literal">-some</span><span class="literal">-parameters</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>You might notice that authentication flag, this tells powershell the sort of authentication and cor credssp you also need to enable <a href="http://blogs.technet.com/b/heyscriptingguy/archive/2012/11/14/enable-powershell-quot-second-hop-quot-functionality-with-credssp.aspx" target="_blank" rel="noopener">Credential Security Service Provider</a>. To do this we run</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">    <span class="built_in">Enable-WSManCredSSP</span> <span class="literal">-Role</span> server</span><br><span class="line"><span class="built_in">Enable-WSManCredSSP</span> <span class="literal">-Role</span> client <span class="literal">-DelegateComputer</span> <span class="string">"*"</span></span><br></pre></td></tr></table></figure>
<p>From an admin powershell session on the machine. Normally you would run these on different machines but we're remoting to local host so it is both the client and the server. I've enabled client for all machines but you might want to lock this down a bit more.</p>
<p>Finally I needed to pass some parameters to roundhouse proper. This can be done by passing them into the script block and then receiving them as parameters inside the block</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">    <span class="built_in">Invoke-command</span> localhost <span class="literal">-authentication</span> credssp <span class="literal">-Credential</span> <span class="variable">$cred</span> <span class="literal">-scriptblock</span> &#123;</span><br><span class="line">	<span class="keyword">param</span>(<span class="variable">$roundHouseExe</span>,<span class="variable">$databaseServer</span>,<span class="variable">$targetDb</span>,<span class="variable">$databaseEnvironment</span>,<span class="variable">$fName</span>)</span><br><span class="line">	&amp; <span class="string">"<span class="variable">$roundHouseExe</span>"</span> -<span class="literal">-s</span>=<span class="variable">$databaseServer</span> -<span class="literal">-d</span>=<span class="string">"<span class="variable">$</span>&#123;targetDb&#125;"</span> -<span class="operator">-f</span>=<span class="variable">$fName</span> /ni</span><br><span class="line">&#125; <span class="literal">-argumentlist</span> <span class="variable">$roundHouseExe</span>,<span class="variable">$databaseServer</span>,<span class="variable">$targetDb</span>,<span class="variable">$databaseEnvironment</span>,<span class="variable">$fName</span></span><br></pre></td></tr></table></figure>
<p>The whole process is pretty convoluted but that's Windows command line for you. What would this look like in bash on Linux?</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="variable">$roundHouseExe</span> --s=<span class="variable">$databaseServer</span> --d=<span class="string">"<span class="variable">$targetDb</span>"</span> --f=<span class="variable">$fName</span> /ni</span><br></pre></td></tr></table></figure>   
<p>So yeah.</p>

	        </div>

            
            <section id="comments">
            <div id="disqus_thread">
                <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript" target="_blank" rel="noopener">comments powered by Disqus.</a></noscript>
            </div>
            </section>
            
		</div>
	</div>
<!--MAIN CONTENT ENDS-->

<!--SIDEBAR CONTENT STARTS-->
	<div class="SubpageBoxSubSm">
		<div class="SubpageBoxSubSmContent">
			
			

			<div class="ProfileImg">
				
				<a href="/bios/simon_timms">
				
					<img src='/images/avatars/simon.jpg' />
				
				</a>
				
			</div>

			<BR clear="all">

			<h2><a href="/bios/simon_timms">Simon Timms</a></h2>
			
			<a href="mailto:stimms@gmail.com"><img class="ProfileIcon" src="/images/icon_email.png" border="0" alt="Email" title="Email"> Email</a><BR>
			
			
			<a href="http://blog.simontimms.com/" target="_blank"><img class="ProfileIcon" src="/images/icon_web.png" border="0" alt="Web" title="Web"> Web</a><BR>
			
			
			<a href="http://twitter.com/stimms" target="_blank"><img class="ProfileIcon" src="/images/icon_twitter.png" border="0" alt="Twitter" title="Twitter"> Twitter</a><BR>
			
			
			<a href="https://github.com/stimms" target="_blank"><img class="ProfileIcon" src="/images/icon_github.png" border="0" alt="GitHub" title="GitHub"> GitHub</a><br>
			
			
			
 			<a href="/feeds/simon_timms.xml"><img class="ProfileIcon" src="/images/icon_subscribe.png" /> RSS</a>
			

			<hr />
			<h4>Looking for someone else?</h4>
			<p>You can find the rest of the Western Devs Crew <a href="/whoweare">here</a>.</p>
		</div>
	</div>
<!--SIDEBAR CONTENT ENDS-->


</div>
</center>
<!--PAGE CONTENT ENDS-->


<!--FOOTER STARTS-->
<center>
  <div class="FooterBarTxt">&copy; 2015 Western Devs. All Rights Reserved. Design by <a href="http://www.karenchudobiak.ca" target="_blank">Karen Chudobiak, Graphic Designer</a></div>
</center>
<!--FOOTER ENDS-->

<!-- NAV FOOTER STARTS -->
<div class="NavFooter">
  <a href="/posts" alt="Posts"><i class="fa fa-newspaper-o fa-2x"></i><span>Posts</span></a>
  <a href="/podcasts" alt="Podcasts"><i class="fa fa-volume-up fa-2x"></i><span>Podcasts</span></a>
  <a href="/whoweare" alt="About"><i class="fa fa-star fa-2x"></i><span>About</span></a>
  <a href="/whatwevedone" alt="What We've Done"><i class="fa fa-trophy fa-2x"></i><span>Work</span></a>
  <a href="/speaking" alt="Speaking"><i class="fa fa-comment-o fa-2x fa-flip-horizontal"></i><span>Speaking</span></a>
</div>
<!-- NAV FOOTER ENDS -->




</div>
<!--WRAPPER ENDS-->


<script>
  var disqus_shortname = 'westerndevs';
  
  var disqus_url = 'https://westerndevs.com/_/running-process-as-a-different-user-on-windows/'.replace(".com//", ".com/");
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
  
function shuffle(array) {
  var currentIndex = array.length, temporaryValue, randomIndex;

  // While there remain elements to shuffle...
  while (0 !== currentIndex) {

    // Pick a remaining element...
    randomIndex = Math.floor(Math.random() * currentIndex);
    currentIndex -= 1;

    // And swap it with the current element.
    temporaryValue = array[currentIndex];
    array[currentIndex] = array[randomIndex];
    array[randomIndex] = temporaryValue;
  }

  return array;
}

</script>


</body>

  
<!-- Google Analytics -->
<script type="text/javascript">
if (document.location.hostname.search("westerndevs.com") !== -1 || document.location.hostname.search("www.westerndevs.com") !== -1) {
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-37617956-2', 'auto');

ga('set', 'contentGroup1', 'simon_timms');

ga('send', 'pageview');
}
</script>
<!-- End Google Analytics -->



</html>
