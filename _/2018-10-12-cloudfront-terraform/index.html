<!DOCTYPE html>
<html lang="en" xml:lang="en">

  <head>
  
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>Terraform for a statically hosted AWS site | Western Devs</title>
  <meta name="description" content="Just the other day somebody was mentioning to me that they were having trouble setting up a statically hosted site on AWS. That was the kick in the nose I needed to get this article written as it&#39;s be">
<meta property="og:type" content="article">
<meta property="og:title" content="Terraform for a statically hosted AWS site">
<meta property="og:url" content="https://westerndevs.com/_/2018-10-12-cloudfront-terraform/index.html">
<meta property="og:site_name" content="Western Devs">
<meta property="og:description" content="Just the other day somebody was mentioning to me that they were having trouble setting up a statically hosted site on AWS. That was the kick in the nose I needed to get this article written as it&#39;s be">
<meta property="article:published_time" content="2018-10-12T04:00:00.000Z">
<meta property="article:modified_time" content="2021-07-06T22:04:48.948Z">
<meta property="article:author" content="Western Devs">
<meta name="twitter:card" content="summary">
<meta name="twitter:creator" content="@westerndevs">

    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="title" content="WesternDevs">   
    <meta name="keywords" content="software development,software,asp.net,blog">
    <meta name="description" content="We're all west of somewhere">
    <meta name="copyright" content="WesternDevs">
    <meta name="revisit-after" content="15 days">
    <meta name="robots" content="all">
    <meta name="MSSmartTagsPreventParsing" content="true">
  
    <link rel="canonical" href="https://blog.simontimms.com/2018/10/12/cloudfront_terraform/#more">
  
  
    <link rel="alternate" href="/feed.xml" title="Western Devs" type="application/atom+xml">
  
  
<link rel="stylesheet" href="/css/style.css">

      
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <script src="//code.jquery.com/jquery-1.11.3.min.js"></script>  
  <meta name="generator" content="Hexo 4.2.0"></head>

<body>

<!-- FIXED HEADER BECAUSE SCROLLING -->
<!--HEADER STARTS-->
<div class="WrapperHeader">
<div style="display:inline-block; text-align: center;">
<div class="Header">

  <div class="HeaderLogo">
    <a href="/"><img src="/images/header_logo_transparent.png" alt="WesternDevs" title="WesternDevs" border="0" style="width: 206px; height: 64px;" width="206" height="64"></a>
  </div>

  <div class="HeaderLinks">
      <a href="/posts" class="nav">POSTS</a>       
      <a href="/podcasts" class="nav">PODCASTS</a>       
      <a href="/whoweare" class="nav">ABOUT</a>  
      <a href="/whatwevedone" class="nav">WHAT WE'VE DONE</a>  
      <a href="/speaking" class="nav">SPEAKING</a>
      <div class="HeaderIcons">
        <a href="mailto:info@westerndevs.com"><img src="/images/icon_email.png" border="0" alt="Email" title="Email" height="26" width="26"></a>
        <a href="/feed.xml"><img src="/images/icon_subscribe.png" border="0" alt="Subscribe" title="Subscribe" height="26" width="27"></a>
        <a href="http://twitter.com/westerndevs" target="_blank"><img src="/images/icon_twitter.png" border="0" alt="Twitter" title="Twitter" height="26" width="27"></a>
        <a href="http://github.com/westerndevs" target="_blank"><img src="/images/icon_github.png" border="0" alt="GitHub" title="GitHub" height="26" width="27"></a>     
      </div>
  </div>
  
</div>
</div>
</div>
<!--HEADER ENDS-->    



<!--WRAPPER STARTS-->
<div class="Wrapper" style="">

<!--SUBHEAD STARTS-->
<div class="WrapperSubHeaderSubpage">
<center>
	<div class="SubHeader">
		<H1 class="title"><img class="icon" src="/images/icon_posts.png" alt="POST" title="POST" border="0"> POST</H1>
	</div>
</center>
</div>
<!--SUBHEAD ENDS-->

<!--PAGE CONTENT STARTS-->
<center>
<div class="WrapperContent">

<!--MAIN CONTENT STARTS-->
	<div class="SubpageBoxSubLrg">
		<div class="SubpageBoxSubLrgContent">
		    <div class='postTitle'>
  <div class="ListLrgDateBG">
    <div class="ListLrgDateMonth">OCT</div>
    <div class="ListLrgDateDay">12</div>
    <div class="ListLrgDateYear">2018</div>
  </div>
  <h2>Terraform for a statically hosted AWS site</h2>
</div>

		    

<p class="TXTsm">ORIGINALLY POSTED TO: <a href="https://blog.simontimms.com/2018/10/12/cloudfront_terraform/#more" target="_blank" rel="noopener" class='originalurl'>https://blog.simontimms.com/2018/10/12/cloudfront_terraform/#more</a></p>



			<div id="mainPostContent">
	        <p>Just the other day somebody was mentioning to me that they were having trouble setting up a statically hosted site on AWS. That was the kick in the nose I needed to get this article written as it's been on my back-burner for a while. Terraform makes the whole process easy.</p>
<a id="more"></a>
<p>AWS, just like the other cloud platforms, offers a myriad of ways to host a website. Frequently, though, what you need is the simplest approach and that is using S3 to do your hosting. S3 doesn't have any smarts behind it so it is really only useful for static sites. However you can do an awful lot with static sites. This blog is statically generated and hosted but you can also do static hosting for most rich JavasScript applications  be they written in Angular, React, Vue, whatever. The one place where S3 falls down is that it cannot do SSL for custom domains. There is <a href="https://www.troyhunt.com/heres-why-your-static-website-needs-https/" target="_blank" rel="noopener">no excuse</a> for not doing SSL these days so we need to make sure our static site has it.</p>
<p>In front of the S3 bucket we need to put something to do SSL termination. Of course, there is a service for that in the shape of CloudFront. CloudFront is a content delivery network which means that in addition to doing SSL termination it can improve performance through geo-distribution, caching and load balancing. It can even put in restrictions to disallow certain geographic regions from reaching the site. We're just interested in SSL termination right now.</p>
<p>Probably the hardest part of getting going on static hosting is setting up all the pieces. You can click through the, frankly, terrible AWS UI or you can cut out the mouse and use <a href="https://www.terraform.io/" target="_blank" rel="noopener">Terraform</a>. Terraform is a tool for writing infrastructure descriptions and it has adapters for all the major cloud providers and <a href="https://www.terraform.io/docs/providers/index.html" target="_blank" rel="noopener">a bunch which aren't major</a>. The descriptions are called templates.</p>
<p>Let's take a look at a template for setting up a statically hosted site. We'll include a few services in this template</p>
<ul>
<li>S3 - holds our files</li>
<li>CloudFront - does SSL termination for S3</li>
<li>Route53 - DNS to get our domain to point at CloudFront</li>
</ul>
<h2>Preamble</h2>
<p>This section sets up the provider (the plugin for terraform which tells it how to talk with a cloud provider) and a storage location for the state. Terraform maintains a state of the deployment so it knows how to update resources instead of just destroying them and recreating them.</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">provider</span> <span class="string">"aws"</span> &#123;</span><br><span class="line">  <span class="attribute">region</span> = <span class="string">"<span class="variable">$&#123;var.region&#125;</span>"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">terraform &#123;</span><br><span class="line">  <span class="attribute">backend</span> <span class="string">"s3"</span> &#123;</span><br><span class="line">    <span class="attribute">bucket</span> = <span class="string">"my-awesome-terraform"</span></span><br><span class="line">    key    = <span class="string">"environment"</span></span><br><span class="line">    region = <span class="string">"us-east-1"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2>S3</h2>
<p>Next we set up the S3 bucket to hold our files. By now you might have noticed that we're using some variables denoted by the <code>${variable.name}</code> syntax. These variables can be defined in a file passed into the terraform tool. It is nice to make these things configurable so they can be reused.</p>
<p>The S3 is a little complicated because we need to allow public reading and add some CORS rules. The rules here are in place to allow the site to call out to an API. I've left the rules really open here and you probably shouldn't do that in real life.</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># s3 for sites</span></span><br><span class="line">resource <span class="string">"aws_s3_bucket"</span> <span class="string">"website"</span> &#123;</span><br><span class="line">  bucket = <span class="string">"<span class="variable">$&#123;var.domain-name&#125;</span>"</span></span><br><span class="line">  acl    = <span class="string">"public-read"</span></span><br><span class="line"></span><br><span class="line"> <span class="built_in"> policy </span>= &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"Version"</span>:<span class="string">"2008-10-17"</span>,</span><br><span class="line">    <span class="string">"Statement"</span>:[&#123;</span><br><span class="line">    <span class="string">"Sid"</span>:<span class="string">"AllowPublicRead"</span>,</span><br><span class="line">    <span class="string">"Effect"</span>:<span class="string">"Allow"</span>,</span><br><span class="line">    <span class="string">"Principal"</span>: &#123;<span class="string">"AWS"</span>: <span class="string">"*"</span>&#125;,</span><br><span class="line">    <span class="string">"Action"</span>:[<span class="string">"s3:GetObject"</span>],</span><br><span class="line">    <span class="string">"Resource"</span>:[<span class="string">"arn:aws:s3:::<span class="variable">$&#123;var.domain-name&#125;</span>/*"</span>]</span><br><span class="line">    &#125;]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">  website &#123;</span><br><span class="line">    index_document = <span class="string">"index.html"</span></span><br><span class="line">    error_document = <span class="string">"error.html"</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  cors_rule &#123;</span><br><span class="line">    allowed_headers = [<span class="string">"*"</span>]</span><br><span class="line">    allowed_methods = [<span class="string">"PUT"</span>, <span class="string">"POST"</span>]</span><br><span class="line">    allowed_origins = [<span class="string">"*"</span>]</span><br><span class="line">    expose_headers  = [<span class="string">"ETag"</span>]</span><br><span class="line">    max_age_seconds = 3000</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2>CloudFront</h2>
<p>Next we'll set up the CloudFront. This is a very bare-bones set up of CloudFront and doesn't make use of any of the cool advanced features. However, Terraform can do all that configuration for you. You may notice here that we're using that same variable syntax to reference other resources defined in the template. Specifically check out <code>domain_name = &quot;${aws_s3_bucket.website.bucket_domain_name}&quot;</code> which references back to the S3 container we set up just above.</p>
<p>Another thing to note here is that I've skipped creating the SSL certificate as part of this tutorial. I assume you've either got your own or you've set up one in AWS already; we just reference it by ARN.</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cloudfront</span></span><br><span class="line"></span><br><span class="line">resource <span class="string">"aws_cloudfront_origin_access_identity"</span> <span class="string">"access_identity"</span> &#123;</span><br><span class="line">  comment = <span class="string">"Access for cloudfront"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource <span class="string">"aws_cloudfront_distribution"</span> <span class="string">"distribution"</span> &#123;</span><br><span class="line">  origin &#123;</span><br><span class="line">    domain_name = <span class="string">"<span class="variable">$&#123;aws_s3_bucket.website.bucket_domain_name&#125;</span>"</span></span><br><span class="line">    origin_id   = <span class="string">"origin"</span></span><br><span class="line"></span><br><span class="line">    s3_origin_config &#123;</span><br><span class="line">      origin_access_identity = <span class="string">"<span class="variable">$&#123;aws_cloudfront_origin_access_identity.access_identity.cloudfront_access_identity_path&#125;</span>"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  aliases             = [<span class="string">"<span class="variable">$&#123;var.domain-name&#125;</span>"</span>, <span class="string">"www.<span class="variable">$&#123;var.domain-name&#125;</span>"</span>]</span><br><span class="line">  enabled             = <span class="string">"true"</span></span><br><span class="line">  default_root_object = <span class="string">"index.html"</span></span><br><span class="line"></span><br><span class="line">  default_cache_behavior &#123;</span><br><span class="line">    allowed_methods  = [<span class="string">"DELETE"</span>, <span class="string">"GET"</span>, <span class="string">"HEAD"</span>, <span class="string">"OPTIONS"</span>, <span class="string">"PATCH"</span>, <span class="string">"POST"</span>, <span class="string">"PUT"</span>]</span><br><span class="line">    cached_methods   = [<span class="string">"GET"</span>, <span class="string">"HEAD"</span>]</span><br><span class="line">    target_origin_id = <span class="string">"origin"</span></span><br><span class="line"></span><br><span class="line">    forwarded_values &#123;</span><br><span class="line">      query_string = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">      cookies &#123;</span><br><span class="line">        forward = <span class="string">"none"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    viewer_protocol_policy = <span class="string">"redirect-to-https"</span></span><br><span class="line">    min_ttl                = 0</span><br><span class="line">    default_ttl            = 3600</span><br><span class="line">    max_ttl                = 86400</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  viewer_certificate &#123;</span><br><span class="line">    acm_certificate_arn = <span class="string">"<span class="variable">$&#123;var.ssl-arn&#125;</span>"</span></span><br><span class="line">    ssl_support_method  = <span class="string">"sni-only"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2>Route53</h2>
<p>We're almost there. This part sets up the domain routing in route 53. We have both bare and www prefixed domains here</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># route 53</span></span><br><span class="line">data <span class="string">"aws_route53_zone"</span> <span class="string">"route53zone"</span> &#123;</span><br><span class="line">  name = <span class="string">"<span class="variable">$&#123;var.domain-name&#125;</span>."</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># bare domain</span></span><br><span class="line">resource <span class="string">"aws_route53_record"</span> <span class="string">"domain"</span> &#123;</span><br><span class="line">  zone_id = <span class="string">"<span class="variable">$&#123;data.aws_route53_zone.route53zone.zone_id&#125;</span>"</span></span><br><span class="line">  name    = <span class="string">"<span class="variable">$&#123;var.domain-name&#125;</span>"</span></span><br><span class="line"> <span class="built_in"> type </span>   = <span class="string">"A"</span></span><br><span class="line"></span><br><span class="line">  alias &#123;</span><br><span class="line">    name                   = <span class="string">"<span class="variable">$&#123;aws_cloudfront_distribution.distribution.domain_name&#125;</span>"</span></span><br><span class="line">    zone_id                = <span class="string">"<span class="variable">$&#123;aws_cloudfront_distribution.distribution.hosted_zone_id&#125;</span>"</span></span><br><span class="line">    evaluate_target_health = <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#www domain</span></span><br><span class="line">resource <span class="string">"aws_route53_record"</span> <span class="string">"www-domain"</span> &#123;</span><br><span class="line">  zone_id = <span class="string">"<span class="variable">$&#123;data.aws_route53_zone.route53zone.zone_id&#125;</span>"</span></span><br><span class="line">  name    = <span class="string">"www.<span class="variable">$&#123;var.domain-name&#125;</span>"</span></span><br><span class="line"> <span class="built_in"> type </span>   = <span class="string">"A"</span></span><br><span class="line"></span><br><span class="line">  alias &#123;</span><br><span class="line">    name                   = <span class="string">"<span class="variable">$&#123;aws_cloudfront_distribution.distribution.domain_name&#125;</span>"</span></span><br><span class="line">    zone_id                = <span class="string">"<span class="variable">$&#123;aws_cloudfront_distribution.distribution.hosted_zone_id&#125;</span>"</span></span><br><span class="line">    evaluate_target_health = <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Finally we set up an output from the template which will be printed to the console when we deploy the template. Here we're printing out the name servers from Route53, these can be added to our domain.</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">output</span> <span class="string">"name servers"</span> &#123;</span><br><span class="line">  <span class="attribute">value</span> = <span class="string">"<span class="variable">$&#123;data.aws_route53_zone.route53zone.name_servers&#125;</span>"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2>Variables</h2>
<p>Our variables file looks like.</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">region</span> = <span class="string">"us-east-1"</span></span><br><span class="line"><span class="attr">domain-name</span> = <span class="string">"simontimms.com"</span></span><br><span class="line"><span class="attr">ssl-arn</span>=<span class="string">"arn:aws:acm:us-east-1:194820576566:certificate/aabcd5b3-4f32-4cbf-abd4-3b7e5385018a"</span></span><br></pre></td></tr></table></figure>
<p>To run the terraform we need just do something like</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">terraform init <span class="comment">#only needed on the first run</span></span><br><span class="line">terraform apply -var-file dev.variables.tfvars</span><br></pre></td></tr></table></figure>
<p>Terraform will spin up a CloudFormation stack containing all the resources you've defined. If you need to make changes you can change the template and run the apply command again.</p>
<p>The whole thing together looks like:</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line">provider <span class="string">"aws"</span> &#123;</span><br><span class="line">  region = <span class="string">"<span class="variable">$&#123;var.region&#125;</span>"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">terraform &#123;</span><br><span class="line">  backend <span class="string">"s3"</span> &#123;</span><br><span class="line">    bucket = <span class="string">"my-awesome-terraform"</span></span><br><span class="line">    key    = <span class="string">"environment"</span></span><br><span class="line">    region = <span class="string">"us-east-1"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># s3 for sites</span></span><br><span class="line">resource <span class="string">"aws_s3_bucket"</span> <span class="string">"website"</span> &#123;</span><br><span class="line">  bucket = <span class="string">"<span class="variable">$&#123;var.domain-name&#125;</span>"</span></span><br><span class="line">  acl    = <span class="string">"public-read"</span></span><br><span class="line"></span><br><span class="line"> <span class="built_in"> policy </span>= &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"Version"</span>:<span class="string">"2008-10-17"</span>,</span><br><span class="line">    <span class="string">"Statement"</span>:[&#123;</span><br><span class="line">    <span class="string">"Sid"</span>:<span class="string">"AllowPublicRead"</span>,</span><br><span class="line">    <span class="string">"Effect"</span>:<span class="string">"Allow"</span>,</span><br><span class="line">    <span class="string">"Principal"</span>: &#123;<span class="string">"AWS"</span>: <span class="string">"*"</span>&#125;,</span><br><span class="line">    <span class="string">"Action"</span>:[<span class="string">"s3:GetObject"</span>],</span><br><span class="line">    <span class="string">"Resource"</span>:[<span class="string">"arn:aws:s3:::<span class="variable">$&#123;var.domain-name&#125;</span>/*"</span>]</span><br><span class="line">    &#125;]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">  website &#123;</span><br><span class="line">    index_document = <span class="string">"index.html"</span></span><br><span class="line">    error_document = <span class="string">"error.html"</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  cors_rule &#123;</span><br><span class="line">    allowed_headers = [<span class="string">"*"</span>]</span><br><span class="line">    allowed_methods = [<span class="string">"PUT"</span>, <span class="string">"POST"</span>]</span><br><span class="line">    allowed_origins = [<span class="string">"*"</span>]</span><br><span class="line">    expose_headers  = [<span class="string">"ETag"</span>]</span><br><span class="line">    max_age_seconds = 3000</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># cloudfront</span></span><br><span class="line"></span><br><span class="line">resource <span class="string">"aws_cloudfront_origin_access_identity"</span> <span class="string">"access_identity"</span> &#123;</span><br><span class="line">  comment = <span class="string">"Access for cloudfront"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource <span class="string">"aws_cloudfront_distribution"</span> <span class="string">"distribution"</span> &#123;</span><br><span class="line">  origin &#123;</span><br><span class="line">    domain_name = <span class="string">"<span class="variable">$&#123;aws_s3_bucket.website.bucket_domain_name&#125;</span>"</span></span><br><span class="line">    origin_id   = <span class="string">"origin"</span></span><br><span class="line"></span><br><span class="line">    s3_origin_config &#123;</span><br><span class="line">      origin_access_identity = <span class="string">"<span class="variable">$&#123;aws_cloudfront_origin_access_identity.access_identity.cloudfront_access_identity_path&#125;</span>"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  aliases             = [<span class="string">"<span class="variable">$&#123;var.domain-name&#125;</span>"</span>, <span class="string">"www.<span class="variable">$&#123;var.domain-name&#125;</span>"</span>]</span><br><span class="line">  enabled             = <span class="string">"true"</span></span><br><span class="line">  default_root_object = <span class="string">"index.html"</span></span><br><span class="line"></span><br><span class="line">  default_cache_behavior &#123;</span><br><span class="line">    allowed_methods  = [<span class="string">"DELETE"</span>, <span class="string">"GET"</span>, <span class="string">"HEAD"</span>, <span class="string">"OPTIONS"</span>, <span class="string">"PATCH"</span>, <span class="string">"POST"</span>, <span class="string">"PUT"</span>]</span><br><span class="line">    cached_methods   = [<span class="string">"GET"</span>, <span class="string">"HEAD"</span>]</span><br><span class="line">    target_origin_id = <span class="string">"origin"</span></span><br><span class="line"></span><br><span class="line">    forwarded_values &#123;</span><br><span class="line">      query_string = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">      cookies &#123;</span><br><span class="line">        forward = <span class="string">"none"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    viewer_protocol_policy = <span class="string">"redirect-to-https"</span></span><br><span class="line">    min_ttl                = 0</span><br><span class="line">    default_ttl            = 3600</span><br><span class="line">    max_ttl                = 86400</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  viewer_certificate &#123;</span><br><span class="line">    acm_certificate_arn = <span class="string">"<span class="variable">$&#123;var.ssl-arn&#125;</span>"</span></span><br><span class="line">    ssl_support_method  = <span class="string">"sni-only"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># route 53</span></span><br><span class="line">data <span class="string">"aws_route53_zone"</span> <span class="string">"route53zone"</span> &#123;</span><br><span class="line">  name = <span class="string">"<span class="variable">$&#123;var.domain-name&#125;</span>."</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># bare domain</span></span><br><span class="line">resource <span class="string">"aws_route53_record"</span> <span class="string">"domain"</span> &#123;</span><br><span class="line">  zone_id = <span class="string">"<span class="variable">$&#123;data.aws_route53_zone.route53zone.zone_id&#125;</span>"</span></span><br><span class="line">  name    = <span class="string">"<span class="variable">$&#123;var.domain-name&#125;</span>"</span></span><br><span class="line"> <span class="built_in"> type </span>   = <span class="string">"A"</span></span><br><span class="line"></span><br><span class="line">  alias &#123;</span><br><span class="line">    name                   = <span class="string">"<span class="variable">$&#123;aws_cloudfront_distribution.distribution.domain_name&#125;</span>"</span></span><br><span class="line">    zone_id                = <span class="string">"<span class="variable">$&#123;aws_cloudfront_distribution.distribution.hosted_zone_id&#125;</span>"</span></span><br><span class="line">    evaluate_target_health = <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#www domain</span></span><br><span class="line">resource <span class="string">"aws_route53_record"</span> <span class="string">"www-domain"</span> &#123;</span><br><span class="line">  zone_id = <span class="string">"<span class="variable">$&#123;data.aws_route53_zone.route53zone.zone_id&#125;</span>"</span></span><br><span class="line">  name    = <span class="string">"www.<span class="variable">$&#123;var.domain-name&#125;</span>"</span></span><br><span class="line"> <span class="built_in"> type </span>   = <span class="string">"A"</span></span><br><span class="line"></span><br><span class="line">  alias &#123;</span><br><span class="line">    name                   = <span class="string">"<span class="variable">$&#123;aws_cloudfront_distribution.distribution.domain_name&#125;</span>"</span></span><br><span class="line">    zone_id                = <span class="string">"<span class="variable">$&#123;aws_cloudfront_distribution.distribution.hosted_zone_id&#125;</span>"</span></span><br><span class="line">    evaluate_target_health = <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output <span class="string">"name servers"</span> &#123;</span><br><span class="line">  value = <span class="string">"<span class="variable">$&#123;data.aws_route53_zone.route53zone.name_servers&#125;</span>"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

	        </div>

            
            <section id="comments">
            <div id="disqus_thread">
                <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript" target="_blank" rel="noopener">comments powered by Disqus.</a></noscript>
            </div>
            </section>
            
		</div>
	</div>
<!--MAIN CONTENT ENDS-->

<!--SIDEBAR CONTENT STARTS-->
	<div class="SubpageBoxSubSm">
		<div class="SubpageBoxSubSmContent">
			
			

			<div class="ProfileImg">
				
				<a href="/bios/simon_timms">
				
					<img src='/images/avatars/simon.jpg' />
				
				</a>
				
			</div>

			<BR clear="all">

			<h2><a href="/bios/simon_timms">Simon Timms</a></h2>
			
			<a href="mailto:stimms@gmail.com"><img class="ProfileIcon" src="/images/icon_email.png" border="0" alt="Email" title="Email"> Email</a><BR>
			
			
			<a href="http://blog.simontimms.com/" target="_blank"><img class="ProfileIcon" src="/images/icon_web.png" border="0" alt="Web" title="Web"> Web</a><BR>
			
			
			<a href="http://twitter.com/stimms" target="_blank"><img class="ProfileIcon" src="/images/icon_twitter.png" border="0" alt="Twitter" title="Twitter"> Twitter</a><BR>
			
			
			<a href="https://github.com/stimms" target="_blank"><img class="ProfileIcon" src="/images/icon_github.png" border="0" alt="GitHub" title="GitHub"> GitHub</a><br>
			
			
			
 			<a href="/feeds/simon_timms.xml"><img class="ProfileIcon" src="/images/icon_subscribe.png" /> RSS</a>
			

			<hr />
			<h4>Looking for someone else?</h4>
			<p>You can find the rest of the Western Devs Crew <a href="/whoweare">here</a>.</p>
		</div>
	</div>
<!--SIDEBAR CONTENT ENDS-->


</div>
</center>
<!--PAGE CONTENT ENDS-->


<!--FOOTER STARTS-->
<center>
  <div class="FooterBarTxt">&copy; 2015 Western Devs. All Rights Reserved. Design by <a href="http://www.karenchudobiak.ca" target="_blank">Karen Chudobiak, Graphic Designer</a></div>
</center>
<!--FOOTER ENDS-->

<!-- NAV FOOTER STARTS -->
<div class="NavFooter">
  <a href="/posts" alt="Posts"><i class="fa fa-newspaper-o fa-2x"></i><span>Posts</span></a>
  <a href="/podcasts" alt="Podcasts"><i class="fa fa-volume-up fa-2x"></i><span>Podcasts</span></a>
  <a href="/whoweare" alt="About"><i class="fa fa-star fa-2x"></i><span>About</span></a>
  <a href="/whatwevedone" alt="What We've Done"><i class="fa fa-trophy fa-2x"></i><span>Work</span></a>
  <a href="/speaking" alt="Speaking"><i class="fa fa-comment-o fa-2x fa-flip-horizontal"></i><span>Speaking</span></a>
</div>
<!-- NAV FOOTER ENDS -->




</div>
<!--WRAPPER ENDS-->


<script>
  var disqus_shortname = 'westerndevs';
  
  var disqus_url = 'https://westerndevs.com/_/2018-10-12-cloudfront-terraform/'.replace(".com//", ".com/");
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
  
function shuffle(array) {
  var currentIndex = array.length, temporaryValue, randomIndex;

  // While there remain elements to shuffle...
  while (0 !== currentIndex) {

    // Pick a remaining element...
    randomIndex = Math.floor(Math.random() * currentIndex);
    currentIndex -= 1;

    // And swap it with the current element.
    temporaryValue = array[currentIndex];
    array[currentIndex] = array[randomIndex];
    array[randomIndex] = temporaryValue;
  }

  return array;
}

</script>


</body>

  
<!-- Google Analytics -->
<script type="text/javascript">
if (document.location.hostname.search("westerndevs.com") !== -1 || document.location.hostname.search("www.westerndevs.com") !== -1) {
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-37617956-2', 'auto');

ga('set', 'contentGroup1', 'simon_timms');

ga('send', 'pageview');
}
</script>
<!-- End Google Analytics -->



</html>
