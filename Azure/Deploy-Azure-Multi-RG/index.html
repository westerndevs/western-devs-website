<!DOCTYPE html>
<html lang="en" xml:lang="en">

  <head>
  
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>Deploying Azure resources to multiple resource groups | Western Devs</title>
  <meta name="description" content="Advanced ARM Template Development Azure Resource Manager (ARM) templates provide an excellent, built-in resource configuration and deployment solution. You can find a wealth of templates for deploying">
<meta property="og:type" content="article">
<meta property="og:title" content="Deploying Azure resources to multiple resource groups">
<meta property="og:url" content="https://westerndevs.com/Azure/Deploy-Azure-Multi-RG/index.html">
<meta property="og:site_name" content="Western Devs">
<meta property="og:description" content="Advanced ARM Template Development Azure Resource Manager (ARM) templates provide an excellent, built-in resource configuration and deployment solution. You can find a wealth of templates for deploying">
<meta property="article:published_time" content="2019-08-07T18:49:25.000Z">
<meta property="article:modified_time" content="2022-04-07T14:21:18.807Z">
<meta property="article:author" content="Western Devs">
<meta property="article:tag" content="Azure">
<meta property="article:tag" content="ARM">
<meta property="article:tag" content="Configuration-as-Code">
<meta name="twitter:card" content="summary">
<meta name="twitter:creator" content="@westerndevs">

    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="title" content="WesternDevs">   
    <meta name="keywords" content="software development,software,asp.net,blog">
    <meta name="description" content="We're all west of somewhere">
    <meta name="copyright" content="WesternDevs">
    <meta name="revisit-after" content="15 days">
    <meta name="robots" content="all">
    <meta name="MSSmartTagsPreventParsing" content="true">
  
  
    <link rel="alternate" href="/feed.xml" title="Western Devs" type="application/atom+xml">
  
  
<link rel="stylesheet" href="/css/style.css">

      
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <script src="//code.jquery.com/jquery-1.11.3.min.js"></script>  
  <meta name="generator" content="Hexo 4.2.1"></head>

<body>

<!-- FIXED HEADER BECAUSE SCROLLING -->
<!--HEADER STARTS-->
<div class="WrapperHeader">
<div style="display:inline-block; text-align: center;">
<div class="Header">

  <div class="HeaderLogo">
    <a href="/"><img src="/images/header_logo_transparent.png" alt="WesternDevs" title="WesternDevs" border="0" style="width: 206px; height: 64px;" width="206" height="64"></a>
  </div>

  <div class="HeaderLinks">
      <a href="/posts" class="nav">POSTS</a>       
      <a href="/podcasts" class="nav">PODCASTS</a>       
      <a href="/whoweare" class="nav">ABOUT</a>  
      <a href="/whatwevedone" class="nav">WHAT WE'VE DONE</a>  
      <a href="/speaking" class="nav">SPEAKING</a>
      <div class="HeaderIcons">
        <a href="mailto:info@westerndevs.com"><img src="/images/icon_email.png" border="0" alt="Email" title="Email" height="26" width="26"></a>
        <a href="/feed.xml"><img src="/images/icon_subscribe.png" border="0" alt="Subscribe" title="Subscribe" height="26" width="27"></a>
        <a href="http://twitter.com/westerndevs" target="_blank"><img src="/images/icon_twitter.png" border="0" alt="Twitter" title="Twitter" height="26" width="27"></a>
        <a href="http://github.com/westerndevs" target="_blank"><img src="/images/icon_github.png" border="0" alt="GitHub" title="GitHub" height="26" width="27"></a>     
      </div>
  </div>
  
</div>
</div>
</div>
<!--HEADER ENDS-->    



<!--WRAPPER STARTS-->
<div class="Wrapper" style="">

<!--SUBHEAD STARTS-->
<div class="WrapperSubHeaderSubpage">
<center>
	<div class="SubHeader">
		<H1 class="title"><img class="icon" src="/images/icon_posts.png" alt="POST" title="POST" border="0"> POST</H1>
	</div>
</center>
</div>
<!--SUBHEAD ENDS-->

<!--PAGE CONTENT STARTS-->
<center>
<div class="WrapperContent">

<!--MAIN CONTENT STARTS-->
	<div class="SubpageBoxSubLrg">
		<div class="SubpageBoxSubLrgContent">
		    <div class='postTitle'>
  <div class="ListLrgDateBG">
    <div class="ListLrgDateMonth">AUG</div>
    <div class="ListLrgDateDay">7</div>
    <div class="ListLrgDateYear">2019</div>
  </div>
  <h2>Deploying Azure resources to multiple resource groups</h2>
</div>

		    

			<div id="mainPostContent">
	        <h2>Advanced ARM Template Development</h2>
<p>Azure Resource Manager (ARM) templates provide an excellent, built-in resource configuration and deployment solution. You can find a wealth of templates for deploying anything from a <a href="https://github.com/Azure/azure-quickstart-templates/tree/master/wordpress-app-service-mysql-inapp" target="_blank" rel="noopener">Wordpress site on Azure App Service</a>, to a full <a href="https://github.com/Azure/azure-quickstart-templates/tree/master/101-hdinsight-secure-vnet" target="_blank" rel="noopener">HDInsight cluster on a private VNET</a>.</p>
<a id="more"></a>
<p>Often I work with customers that need to go beyond the basics of ARM Templates, deploying complex solutions across multiple Resource Groups, with different RBAC permissions.</p>
<p>So here I will share some tips-and-tricks you may find helpful when authoring complex templates.</p>
<h2>Deploying to multiple Azure Resource Groups</h2>
<p>First, a very common question, and the title of this post, deploying Azure resources across multiple Resource Groups. You can accomplish this in 3 ways:</p>
<ol>
<li>Deploy multiple times using a script or deployment engine (Azure DevOps Pipeline)</li>
<li>Deploy to a &quot;primary&quot; Resource Group <a href="https://docs.microsoft.com/en-us/azure/azure-resource-manager/resource-manager-cross-resource-group-deployment" target="_blank" rel="noopener" title="Deploy Azure resources to more than one subscription or resource group">with nested templates deploying to other Resource Groups</a></li>
<li>Use a <a href="https://docs.microsoft.com/en-us/azure/azure-resource-manager/deploy-to-subscription" target="_blank" rel="noopener" title="Create resource groups and resources at the subscription level">Subscription-level resource template</a> to define all Resource Groups and nested templates</li>
</ol>
<h3>Using a script (#1)</h3>
<p>This is by far the simplest solution, however it is also the most error-prone. You will have to code features that the Azure deployment system would otherwise handle for you, like dependencies, failures, and ordering. Most likely need a script, however it is best to keep it as simple as possible, adding all of the configuration into the ARM Template.</p>
<h3>Resource Group deploying other Resource Groups (#2)</h3>
<p>This is accomplished using the <code>&quot;resourceGroup&quot;</code> property which you can set on the <code>&quot;Microsoft.Resources/deployments&quot;</code> type, otherwise known as a nested template. Overall this is a minimal change if you are already using nested templates.</p>
<p>You can also deploy to multiple subscriptions using the <code>&quot;subscriptionId&quot;</code> property.</p>
<p>There are a couple of gotchas here, one is that the child Resource Groups need to exist before the nested deployment (just like how you need to define an existing RG when executing a template deployment). You can either script the creation of all of the RGs before running the deployment on the &quot;primary&quot; RG, or use the <code>&quot;Microsoft.Resources/resourceGroups&quot;</code> resource type, with the <code>dependsOn</code> property on the nested template.</p>
<p>Here is an example</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"type"</span>: <span class="string">"Microsoft.Resources/resourceGroups"</span>,</span><br><span class="line">    <span class="attr">"apiVersion"</span>: <span class="string">"2018-05-01"</span>,</span><br><span class="line">    <span class="attr">"location"</span>: <span class="string">"[parameters('location')]"</span>,</span><br><span class="line">    <span class="attr">"name"</span>: <span class="string">"[parameters('msiResourceGroup')]"</span>,</span><br><span class="line">    <span class="attr">"properties"</span>: &#123;&#125;</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">"name"</span>: <span class="string">"msiDeployment"</span>,</span><br><span class="line">    <span class="attr">"type"</span>: <span class="string">"Microsoft.Resources/deployments"</span>,</span><br><span class="line">    <span class="attr">"apiVersion"</span>: <span class="string">"2017-05-10"</span>,</span><br><span class="line">    <span class="attr">"resourceGroup"</span>: <span class="string">"[parameters('msiResourceGroup')]"</span>,</span><br><span class="line">    <span class="attr">"dependsOn"</span>: [</span><br><span class="line">        <span class="string">"[resourceId('Microsoft.Resources/resourceGroups/', parameters('msiResourceGroup'))]"</span></span><br><span class="line">    ],</span><br><span class="line">    "properties": &#123; ... &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Also, depending on how you nest templates, the <code>resourceGroup()</code> function will behave differently. If you have an embedded template <code>&quot;template&quot;: {}</code> the <code>resourceGroup()</code> function will refer to the parent RG. Alternatively, if you have a linked template <code>&quot;templateLink&quot;: { &quot;uri&quot;: &quot;...&quot;}</code> the <code>resourceGroup()</code> function will refer to the child RG. The same applies to the <code>subscription()</code> function.</p>
<h3>Subscription-level Templates (#3)</h3>
<p>This may be my preferred method of deploying complex, multi-RG solutions. Most of the concepts are the same as cross-RG deployments, however there is no &quot;primary&quot; RG. With this method you can deploy to a completely blank Subscription, which is why this is often used in combination with <a href="https://docs.microsoft.com/en-us/azure/governance/blueprints/overview" target="_blank" rel="noopener" title="Overview of the Azure Blueprints service">Azure Blueprints</a> as a &quot;Subscription Factory&quot; pattern.</p>
<p>To author Subscription Templates, you need to use a different template schema <code>https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#</code> and execute the deployment using the <code>New-AzDeployment</code> or <code>az deployment create</code> command.</p>
<p>Here is an Azure docs article for the details: <a href="https://docs.microsoft.com/en-us/azure/azure-resource-manager/deploy-to-subscription" target="_blank" rel="noopener" title="Create resource groups and resources at the subscription level">Create resource groups and resources at the subscription level</a></p>
<p>The Subscription template will be fairly light, with most of the heavy lifting in the nested templates. There are a few functions that are not available in the Subscription Template, like <code>resourceGroup()</code> which means you can't use <code>resourceGroup().location</code> as a default deployment location.</p>
<p>You will need to add a <code>&quot;location&quot;</code> parameter to the template, and use the value when creating the Resource Groups.</p>
<p>Here is an example:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"$schema"</span>: <span class="string">"https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#"</span>,</span><br><span class="line">    <span class="attr">"contentVersion"</span>: <span class="string">"1.0.0.1"</span>,</span><br><span class="line">    <span class="attr">"parameters"</span>: &#123; </span><br><span class="line">        <span class="attr">"hdiResourceGroup"</span>: &#123;</span><br><span class="line">            <span class="attr">"type"</span>: <span class="string">"string"</span>,</span><br><span class="line">            <span class="attr">"defaultValue"</span>: <span class="string">"DL-HDI"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"msiResourceGroup"</span>: &#123;</span><br><span class="line">           <span class="attr">"type"</span>: <span class="string">"string"</span>,</span><br><span class="line">           <span class="attr">"defaultValue"</span>: <span class="string">"DL-MSI"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"location"</span>: &#123;</span><br><span class="line">            <span class="attr">"type"</span>: <span class="string">"string"</span>,</span><br><span class="line">            <span class="attr">"defaultValue"</span>: <span class="string">"westus2"</span></span><br><span class="line">        &#125; ...</span><br><span class="line">    &#125;,</span><br><span class="line">    "variables": &#123;...&#125;,</span><br><span class="line">    "resources": &#123;</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"type"</span>: <span class="string">"Microsoft.Resources/resourceGroups"</span>,</span><br><span class="line">            <span class="attr">"apiVersion"</span>: <span class="string">"2018-05-01"</span>,</span><br><span class="line">            <span class="attr">"location"</span>: <span class="string">"[parameters('location')]"</span>,</span><br><span class="line">            <span class="attr">"name"</span>: <span class="string">"[parameters('hdiResourceGroup')]"</span>,</span><br><span class="line">            <span class="attr">"properties"</span>: &#123;&#125;</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">    ....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2>Extra Tip: Using the <code>templateLink.uri</code> property</h2>
<p>I am not a big fan of using additional parameters for Nested Template URLs and SAS Tokens. You may have seen them in examples with underscores in front, like <code>&quot;_sasToken&quot;</code> or <code>&quot;_templateRoot&quot;</code></p>
<p>When you create a deployment using a template link URL (on <code>raw.githubusercontent.com</code> or Azure Blob Storage) you have access to a <code>templateLink</code> property on <a href="https://docs.microsoft.com/en-us/azure/azure-resource-manager/resource-group-template-functions-deployment#deployment" target="_blank" rel="noopener" title="Deployment functions for Azure Resource Manager templates">the Deployment model</a></p>
<p>If you are using public urls, you can just use the <code>uri()</code> function for nested templates.</p>
<p><code>&quot;msiTemplate&quot;: &quot;[uri(deployment().properties.templateLink.uri, 'dl-msi.json')]</code></p>
<p>If you want to <a href="https://docs.microsoft.com/en-us/azure/azure-resource-manager/resource-manager-powershell-sas-token" target="_blank" rel="noopener" title="Deploy private Resource Manager template with SAS token and Azure PowerShell">secure the templates using Azure Blob Storage SAS Tokens</a>, you can use some String functions to pull the SAS token out of the TemplateLink property.</p>
<p>For example:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">"variables": &#123;</span><br><span class="line">  "templateRoot":"[deployment().properties.templateLink.uri]",</span><br><span class="line">  "hasToken":"[not(equals(indexOf(variables('templateRoot'),'?'), -1))]",</span><br><span class="line">  "sasToken":"[if(variables('hasToken'),substring(variables('templateRoot'),indexOf(variables('templateRoot'),'?')),'')]",</span><br><span class="line">  "msiTemplate": "[concat(uri(deployment().properties.templateLink.uri, 'dl-msi.json'), variables('sasToken'))]",</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Note that this example supports both public and access token URLs, which adds complexity with conditional statements. I tried to keep it as simple as possible.</p>
<p>This practice assumes that you are deploying the templates before running any deployments. This does not work with local files or inline JSON deployments.</p>

	        </div>

            
            <section id="comments">
            <div id="disqus_thread">
                <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript" target="_blank" rel="noopener">comments powered by Disqus.</a></noscript>
            </div>
            </section>
            
		</div>
	</div>
<!--MAIN CONTENT ENDS-->

<!--SIDEBAR CONTENT STARTS-->
	<div class="SubpageBoxSubSm">
		<div class="SubpageBoxSubSmContent">
			
			

			<div class="ProfileImg">
				
				<a href="/bios/tyler_doerksen">
				
					<img src='https://www.gravatar.com/avatar/b7e3ea9b56c49deaf34a3392508ff732?s=200' />
				
				</a>
				
			</div>

			<BR clear="all">

			<h2><a href="/bios/tyler_doerksen">Tyler Doerksen</a></h2>
			
			<a href="mailto:tylergd@outlook.com"><img class="ProfileIcon" src="/images/icon_email.png" border="0" alt="Email" title="Email"> Email</a><BR>
			
			
			<a href="http://blog.tylerdoerksen.ca" target="_blank"><img class="ProfileIcon" src="/images/icon_web.png" border="0" alt="Web" title="Web"> Web</a><BR>
			
			
			<a href="http://twitter.com/tyler_gd" target="_blank"><img class="ProfileIcon" src="/images/icon_twitter.png" border="0" alt="Twitter" title="Twitter"> Twitter</a><BR>
			
			
			<a href="https://github.com/tylerd" target="_blank"><img class="ProfileIcon" src="/images/icon_github.png" border="0" alt="GitHub" title="GitHub"> GitHub</a><br>
			
			
			<a href="https://www.linkedin.com/in/tdoerksen" target="_blank"><img class="ProfileIcon" src="/images/icon_linkedin.png" border="0" alt="LinkedIN" title="LinkedIN"> LinkedIn</a><br>
			
			
 			<a href="/feeds/tyler_doerksen.xml"><img class="ProfileIcon" src="/images/icon_subscribe.png" /> RSS</a>
			

			<hr />
			<h4>Looking for someone else?</h4>
			<p>You can find the rest of the Western Devs Crew <a href="/whoweare">here</a>.</p>
		</div>
	</div>
<!--SIDEBAR CONTENT ENDS-->


</div>
</center>
<!--PAGE CONTENT ENDS-->


<!--FOOTER STARTS-->
<center>
  <div class="FooterBarTxt">&copy; 2015 Western Devs. All Rights Reserved. Design by <a href="http://www.karenchudobiak.ca" target="_blank">Karen Chudobiak, Graphic Designer</a></div>
</center>
<!--FOOTER ENDS-->

<!-- NAV FOOTER STARTS -->
<div class="NavFooter">
  <a href="/posts" alt="Posts"><i class="fa fa-newspaper-o fa-2x"></i><span>Posts</span></a>
  <a href="/podcasts" alt="Podcasts"><i class="fa fa-volume-up fa-2x"></i><span>Podcasts</span></a>
  <a href="/whoweare" alt="About"><i class="fa fa-star fa-2x"></i><span>About</span></a>
  <a href="/whatwevedone" alt="What We've Done"><i class="fa fa-trophy fa-2x"></i><span>Work</span></a>
  <a href="/speaking" alt="Speaking"><i class="fa fa-comment-o fa-2x fa-flip-horizontal"></i><span>Speaking</span></a>
</div>
<!-- NAV FOOTER ENDS -->




</div>
<!--WRAPPER ENDS-->


<script>
  var disqus_shortname = 'westerndevs';
  
  var disqus_url = 'https://westerndevs.com/Azure/Deploy-Azure-Multi-RG/'.replace(".com//", ".com/");
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
  
function shuffle(array) {
  var currentIndex = array.length, temporaryValue, randomIndex;

  // While there remain elements to shuffle...
  while (0 !== currentIndex) {

    // Pick a remaining element...
    randomIndex = Math.floor(Math.random() * currentIndex);
    currentIndex -= 1;

    // And swap it with the current element.
    temporaryValue = array[currentIndex];
    array[currentIndex] = array[randomIndex];
    array[randomIndex] = temporaryValue;
  }

  return array;
}

</script>


</body>

  
<!-- Google Analytics -->
<script type="text/javascript">
if (document.location.hostname.search("westerndevs.com") !== -1 || document.location.hostname.search("www.westerndevs.com") !== -1) {
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-37617956-2', 'auto');

ga('set', 'contentGroup1', 'tyler_doerksen');

ga('send', 'pageview');
}
</script>
<!-- End Google Analytics -->



</html>
